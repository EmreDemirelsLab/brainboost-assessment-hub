<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D2 Dikkat Testi Raporu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #1e3a8a;
            text-align: center;
            font-size: 36px;
            margin-bottom: 30px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-item {
            margin-bottom: 15px;
        }
        
        .info-label {
            color: #dc2626;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 16px;
            color: #333;
        }
        
        .performance-table {
            background-color: #1e3a8a;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        
        .score-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            width: 50px;
        }
        
        .score-table .header-row {
            background-color: #dc2626;
            color: white;
        }
        
        .chart-container {
            margin: 30px 0;
            height: 300px;
            position: relative;
        }
        
        .section-header {
            color: #1e3a8a;
            font-size: 24px;
            font-weight: bold;
            margin: 30px 0 20px 0;
        }
        
        .content-section {
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .metrics-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }
        
        .metrics-table td {
            padding: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .metrics-table .metric-label {
            background-color: #fecaca;
            font-weight: bold;
            width: 100px;
            text-align: center;
        }
        
        .metrics-table .metric-value {
            background-color: #ddd6fe;
            text-align: center;
            width: 100px;
        }
        
        .metrics-table .metric-desc {
            background-color: #e0e7ff;
        }
        
        .observations-box {
            background-color: #e0e7ff;
            padding: 30px;
            border-radius: 8px;
            margin-top: 30px;
            min-height: 150px;
        }
        
        .logo {
            text-align: center;
            margin-top: 40px;
        }
        
        .logo span {
            font-size: 28px;
            font-weight: bold;
        }
        
        .logo .for {
            color: #3b82f6;
        }
        
        .logo .test {
            color: #333;
        }
        
        .logo .check {
            color: #10b981;
        }
        
        ul {
            margin-left: 20px;
        }
        
        canvas {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>D2 Dikkat Testi Raporu</h1>
        
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Ad Soyad</div>
                <div class="info-value" id="user-name">YÃ¼kleniyor...</div>
            </div>
            <div class="info-item">
                <div class="info-label">YaÅŸ</div>
                <div class="info-value" id="user-age">YÃ¼kleniyor...</div>
            </div>
            <div class="info-item">
                <div class="info-label">DeÄŸerlendirme Tarihi</div>
                <div class="info-value" id="test-date">YÃ¼kleniyor...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Cinsiyet</div>
                <div class="info-value" id="user-gender">YÃ¼kleniyor...</div>
            </div>
            <div class="info-item">
                <div class="info-label">DoÄŸum Tarihi</div>
                <div class="info-value" id="user-birthdate">YÃ¼kleniyor...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Uygulayan</div>
                <div class="info-value" id="conductor-name">YÃ¼kleniyor...</div>
            </div>
        </div>
        
        <div class="performance-table">Psikomotor Performans Tablosu</div>
        
        <table class="score-table">
            <tr class="header-row">
                <td>SÄ±ra</td>
                <td>1</td>
                <td>2</td>
                <td>3</td>
                <td>4</td>
                <td>5</td>
                <td>6</td>
                <td>7</td>
                <td>8</td>
                <td>9</td>
                <td>10</td>
                <td>11</td>
                <td>12</td>
                <td>13</td>
                <td>14</td>
            </tr>
            <tr id="performance-scores">
                <td class="header-row">Puan</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
        </table>
        
        <div class="chart-container">
            <canvas id="performanceChart"></canvas>
        </div>
        
        <div class="section-header">D2 Testinin AmacÄ±</div>
        <div class="content-section">
            D2 Dikkat Testi bireyin seÃ§ici dikkat, sÃ¼rdÃ¼rÃ¼lebilir dikkat ve iÅŸleme hÄ±zÄ± gibi biliÅŸsel becerileri deÄŸerlendirmek amacÄ±yla uygulanÄ±r.
        </div>
        
        <div class="section-header">Hedeflenen KullanÄ±m AlanlarÄ±</div>
        <div class="content-section">
            <ul>
                <li>9 yaÅŸ ve Ã¼zeri bireylerde Ã¶ÄŸrenme sÃ¼recini zorlaÅŸtÄ±ran dikkat ve odaklanma problemlerini tanÄ±mak</li>
                <li>Zihinsel performansÄ± etkileyen dikkat ve odaklanma becerilerini deÄŸerlendirmek</li>
                <li>BiliÅŸsel becerileri geliÅŸtirme programlarÄ±nda eÄŸitim Ã¶ncesi ve sonrasÄ±nda geliÅŸimi izlemek</li>
            </ul>
        </div>
        
        <div class="section-header">Ã–nemli Notlar</div>
        <div class="content-section">
            <ul>
                <li>Rapor bireyin dikkat ve odaklanma becerilerindeki gÃ¼Ã§lÃ¼ ve desteklenmesi gereken yÃ¶nleri belirlemek iÃ§indir. TanÄ± koymak iÃ§in deÄŸildir.</li>
                <li>Test sonuÃ§larÄ± sadece test anÄ±ndaki durumu yansÄ±tÄ±r. Uyku, stres, heyecan gibi deÄŸiÅŸkenler bireyin performansÄ±nÄ± etkileyebilir.</li>
            </ul>
        </div>
        
        <div class="logo">
            <span class="for">for</span><span class="test">TEST</span><span class="check">âœ“</span>
        </div>
        
        <!-- Sayfa 2 -->
        <div style="page-break-before: always; margin-top: 50px;">
            <h1>D2 Dikkat Testi Raporu</h1>
            
            <div class="section-header">Ã–lÃ§Ã¼len BiliÅŸsel Alanlar</div>
            <div class="content-section">
                <strong>SeÃ§ici Dikkat:</strong> Hedef veya gÃ¶reve odaklanma, uyaranlarÄ± yok sayma<br>
                <strong>Psikomotor HÄ±z (Ä°ÅŸlem HÄ±zÄ±):</strong> Bilgiyi hÄ±zlÄ±ca algÄ±layÄ±p doÄŸru ÅŸekilde tepki verebilme hÄ±zÄ±<br>
                <strong>SÃ¼rdÃ¼rÃ¼lebilir Dikkat:</strong> Dikkati belirli bir sÃ¼re aynÄ± hedef Ã¼zerinde daÄŸÄ±lmadan devam ettirebilme<br>
                <strong>TutarlÄ±lÄ±k:</strong> FarklÄ± satÄ±rlardaki performans dalgalanma oranÄ±<br>
                <strong>Hata EÄŸilimi:</strong> Atlama ve yanlÄ±ÅŸ iÅŸaretleme davranÄ±ÅŸlarÄ±<br>
                <strong>Odaklanma:</strong> Konsantrasyon PerformansÄ± (CP)
            </div>
            
            <table class="metrics-table">
                <tr>
                    <td class="metric-label">Puan TÃ¼rÃ¼</td>
                    <td class="metric-value">DeÄŸer</td>
                    <td class="metric-desc">AÃ§Ä±klama</td>
                </tr>
                <tr>
                    <td class="metric-label">TN</td>
                    <td class="metric-value" id="tn-value">-</td>
                    <td class="metric-desc">Toplam Ä°ÅŸaretleme</td>
                </tr>
                <tr>
                    <td class="metric-label">E1</td>
                    <td class="metric-value" id="e1-value">-</td>
                    <td class="metric-desc">YanlÄ±ÅŸ Ä°ÅŸaretleme</td>
                </tr>
                <tr>
                    <td class="metric-label">E2</td>
                    <td class="metric-value" id="e2-value">-</td>
                    <td class="metric-desc">BoÅŸ BÄ±rakÄ±lan</td>
                </tr>
                <tr>
                    <td class="metric-label">TN-E</td>
                    <td class="metric-value" id="tne-value">-</td>
                    <td class="metric-desc">Net Ä°ÅŸaretleme</td>
                </tr>
                <tr>
                    <td class="metric-label">CP</td>
                    <td class="metric-value" id="cp-value">-</td>
                    <td class="metric-desc">Konsantrasyon PerformansÄ±</td>
                </tr>
                <tr>
                    <td class="metric-label">%Hata</td>
                    <td class="metric-value" id="error-percentage">-</td>
                    <td class="metric-desc">Toplam Hata OranÄ±</td>
                </tr>
                <tr>
                    <td class="metric-label">SP</td>
                    <td class="metric-value" id="sp-value">-</td>
                    <td class="metric-desc">Norm KarÅŸÄ±lÄ±ÄŸÄ±</td>
                </tr>
            </table>
            
            <div class="section-header">Yorum</div>
            <div class="content-section" id="comments-section">
                <div id="psikomotor-comment"><strong>Psikomotor HÄ±z:</strong> YÃ¼kleniyor...</div><br>
                <div id="secci-dikkat-comment"><strong>SeÃ§ici Dikkat:</strong> YÃ¼kleniyor...</div><br>
                <div id="hata-egilimi-comment"><strong>Hata EÄŸilimi:</strong> YÃ¼kleniyor...</div><br>
                <div id="tutarlilik-comment"><strong>TutarlÄ±lÄ±k:</strong> YÃ¼kleniyor...</div><br>
                <div id="dikkat-dalgalanma-comment"><strong>Dikkat DalgalanmasÄ±:</strong> YÃ¼kleniyor...</div>
            </div>
            
            <div class="section-header">Beyin AntrenÃ¶rÃ¼ GÃ¶zlem ve GÃ¶rÃ¼ÅŸleri</div>
            <div class="observations-box">
                <!-- Bu alan boÅŸ bÄ±rakÄ±lmÄ±ÅŸ -->
            </div>
            
            <div class="logo">
                <span class="for">for</span><span class="test">TEST</span><span class="check">âœ“</span>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ===============================================
        // D2 TEST YORUM KRÄ°TERLERÄ° (Excel TablolarÄ±ndan)
        // ===============================================
        
        // TN (Toplam Ä°ÅŸaretleme) Yorum Kriterleri
        const TN_CRITERIA = [
            { min: 0, max: 154, category: 'TN_Ã‡OK_DÃœÅÃœK', comment: 'Psikomotor hÄ±zÄ±nda belirgin yavaÅŸlÄ±k gÃ¶zlenmiÅŸtir. Ä°ÅŸlem hÄ±zÄ±nÄ± geliÅŸtirmeye yÃ¶nelik dikkat ve odaklanma Ã§alÄ±ÅŸmalarÄ± ile desteklenmelidir.' },
            { min: 155, max: 201, category: 'TN_DÃœÅÃœK', comment: 'Psikomotor hÄ±zÄ±nda yavaÅŸlÄ±k gÃ¶zlenmiÅŸtir. Ä°ÅŸlem hÄ±zÄ±nÄ± artÄ±rmaya yÃ¶nelik dikkat ve odaklanma becerileri geliÅŸtirilebilir.' },
            { min: 202, max: 248, category: 'TN_DÃœÅÃœK', comment: 'Psikomotor hÄ±zÄ±nda yavaÅŸlÄ±k gÃ¶zlenmiÅŸtir. Ä°ÅŸlem hÄ±zÄ±nÄ± artÄ±rmaya yÃ¶nelik dikkat ve odaklanma becerileri geliÅŸtirilebilir.' },
            { min: 249, max: 295, category: 'TN_ORTA', comment: 'Psikomotor hÄ±zÄ± genel olarak yeterlidir. BazÄ± anlarda dikkat yoÄŸunluÄŸu deÄŸiÅŸkenlik gÃ¶sterebilir. Ä°ÅŸlem hÄ±zÄ±nÄ± artÄ±rmaya yÃ¶nelik dikkat ve odaklanma becerileri geliÅŸtirilebilir.' },
            { min: 296, max: 342, category: 'TN_ORTA', comment: 'Psikomotor hÄ±zÄ± genel olarak yeterlidir. BazÄ± anlarda dikkat yoÄŸunluÄŸu deÄŸiÅŸkenlik gÃ¶sterebilir. Ä°ÅŸlem hÄ±zÄ±nÄ± artÄ±rmaya yÃ¶nelik dikkat ve odaklanma becerileri geliÅŸtirilebilir.' },
            { min: 343, max: 389, category: 'TN_NORMAL', comment: 'Psikomotor hÄ±zÄ± normaldir. GÃ¶revi uygun sÃ¼rede ve dikkatini koruyarak tamamlamÄ±ÅŸtÄ±r. Hz ve dikkat dengesini saÄŸlayabilmiÅŸtir. Ä°ÅŸlem hÄ±zÄ±nÄ± artÄ±rmaya yÃ¶nelik dikkat ve odaklanma becerileri geliÅŸtirilebilir.' },
            { min: 390, max: 436, category: 'TN_NORMAL', comment: 'Psikomotor hÄ±zÄ± normaldir. GÃ¶revi uygun sÃ¼rede ve dikkatini koruyarak tamamlamÄ±ÅŸtÄ±r. Hz ve dikkat dengesini saÄŸlayabilmiÅŸtir. Ä°ÅŸlem hÄ±zÄ±nÄ± artÄ±rmaya yÃ¶nelik dikkat ve odaklanma becerileri geliÅŸtirilebilir.' },
            { min: 437, max: 483, category: 'TN_Ä°YÄ°', comment: 'Psikomotor hÄ±zÄ± iyidir. Bileyi hÄ±zlÄ± anlayÄ±p gÃ¶revi biÃ§imde uygulayabilmektedir. Dikkat ve odaklanma becerileri geliÅŸtirilmelidir. Ä°ÅŸlem hÄ±zÄ± daha da artÄ±rÄ±labilir.' },
            { min: 484, max: 530, category: 'TN_Ä°YÄ°', comment: 'Psikomotor hÄ±zÄ± iyidir. Bileyi hÄ±zlÄ± anlayÄ±p gÃ¶revi biÃ§imde uygulayabilmektedir. Dikkat ve odaklanma becerileri geliÅŸtirilmelidir. Ä°ÅŸlem hÄ±zÄ± daha da artÄ±rÄ±labilir.' },
            { min: 531, max: 577, category: 'TN_Ã‡OK_Ä°YÄ°', comment: 'Psikomotor hÄ±zÄ± Ã§ok iyidir. GÃ¶revi hÄ±zlÄ± bir ÅŸekilde tamamlamÄ±ÅŸtÄ±r. Uygulama becerisi oldukÃ§a geliÅŸmiÅŸtir.' },
            { min: 578, max: 9999, category: 'TN_Ã‡OK_Ä°YÄ°', comment: 'Psikomotor hÄ±zÄ± Ã§ok iyidir. GÃ¶revi hÄ±zlÄ± bir ÅŸekilde tamamlamÄ±ÅŸtÄ±r. Uygulama becerisi oldukÃ§a geliÅŸmiÅŸtir.' }
        ];

        // TN-E (Net Ä°ÅŸaretleme) Yorum Kriterleri
        const TN_E_CRITERIA = [
            { min: 0, max: 150, category: 'TN_E_Ã‡OK_DÃœÅÃœK', comment: 'Dikkatini toplayamta zorlandÄ±ÄŸÄ± gÃ¶zlenmiÅŸitir. Dikkat ve odaklanma Ã§alÄ±ÅŸmalarÄ± ile biliÅŸsel geliÅŸim desteklenmelidir.' },
            { min: 151, max: 200, category: 'TN_E_DÃœÅÃœK', comment: 'Dikkatini uzun sÃ¼re sÃ¼rdÃ¼remediÄŸi ve gÃ¶revde doÄŸru ÅŸekilde yapamakta zorlandÄ±ÄŸÄ± gÃ¶zlenmiÅŸitir. YapÄ±landÄ±rÄ±lmÄ±ÅŸ dikkat ve odaklanma Ã§alÄ±ÅŸmalarÄ± ile biliÅŸsel geliÅŸim desteklenmelidir.' },
            { min: 201, max: 250, category: 'TN_E_VASAT', comment: 'Dikkatini genel olarak sÃ¼rdÃ¼rebilmiÅŸ ve odaklanma becerisi kullanabilmiÅŸtir. BiliÅŸsel becerileri gÃ¼Ã§lendirilebilir daha da geliÅŸtirilebilir.' },
            { min: 251, max: 300, category: 'TN_E_ORTA', comment: 'Dikkatini gÃ¶rev sÄ±rasÄ±nda sÃ¼rdÃ¼rebilmiÅŸ ve odaklanma becerilerini kullanabilmiÅŸtir. BiliÅŸsel becerileri gÃ¼Ã§lendirilebilir.' },
            { min: 301, max: 350, category: 'TN_E_Ä°YÄ°', comment: 'Dikkatini gÃ¶rev sÄ±rasÄ±nda sÃ¼rdÃ¼rebilmiÅŸ, odaklanma becerilerini etkili ÅŸekilde kullanabilmiÅŸtir. BiliÅŸsel becerileri gÃ¼Ã§lendirilmelidir daha da geliÅŸtirilir.' },
            { min: 351, max: 9999, category: 'TN_E_Ã‡OK_Ä°YÄ°', comment: 'Dikkatini gÃ¶rev sÄ±rasÄ±nda sÃ¼rdÃ¼rebilmiÅŸ, odaklanma becerilerini etkili ÅŸekilde kullanabilmiÅŸtir.' }
        ];

        // E% (Hata OranÄ±) Yorum Kriterleri
        const ERROR_CRITERIA = [
            { min: 0.0, max: 2.5, category: 'E_1', comment: 'Hata oranÄ± dÃ¼ÅŸÃ¼ktÃ¼r. Dikkatini sÃ¼rÃ¼mdede belirgin gÃ¼Ã§lÃ¼k yaÅŸamaktadÄ±r; bu durum Ã¶ÄŸrenme sÃ¼recini olumsuz etkileyebilir.' },
            { min: 2.6, max: 5.0, category: 'E_2', comment: 'Hata oranÄ± artÄ±ÅŸ gÃ¶stermiÅŸtir. Zaman zaman dikkat hatalarÄ± yapabilmektedir.' },
            { min: 5.1, max: 10.0, category: 'E_3', comment: 'Dikkat hatalarÄ± belirginleÅŸmiÅŸtir. Odaklanmada zorlanabilir.' },
            { min: 10.1, max: 20.0, category: 'E_4', comment: 'Dikkat salnmÄ±nÄ± yoktur. Performans tutarlÄ±dÄ±r.' },
            { min: 20.1, max: 100.0, category: 'E_5', comment: 'Hata oranÄ± yÃ¼ksektir. Dikkatini sÃ¼rdÃ¼rmdde belirgin gÃ¼Ã§lÃ¼k yaÅŸatmaktadÄ±r; bu durum Ã¶ÄŸrenme sÃ¼recini olumsuz etkileyebilir.' }
        ];

        // FR (Dalgalanma OranÄ±) Yorum Kriterleri
        const FLUCTUATION_CRITERIA = [
            { min: 0, max: 6, category: 'FR_1', comment: 'Dikkat salÄ±nÄ±mÄ± yoktur. Performans tutarlÄ±dÄ±r.' },
            { min: 7, max: 10, category: 'FR_2', comment: 'Dikkat dÃ¼zeyinde dalgalanmalar gÃ¶zlenmiÅŸtir. Ä°ÅŸlem hÄ±zÄ±nda zihinsel sÃ¼relikte dalgalanma gÃ¶rÃ¼lmektedir.' },
            { min: 11, max: 15, category: 'FR_3', comment: 'Dikkat salnmÄ± genel olarak yeterlidir. BazÄ± anlarda dikkat yoÄŸunluÄŸu deÄŸiÅŸkenlik gÃ¶sterebilir. Ä°ÅŸlem hÄ±zÄ±nda zihinsel sÃ¼relikte dalgalanma gÃ¶rÃ¼lmektedir.' },
            { min: 16, max: 999, category: 'FR_4', comment: 'Dikkat salÄ±nmÄ± yÃ¼ksektir. Dikkatini sÃ¼rÃ¼mdede belirgin gÃ¼Ã§lÃ¼k yaÅŸamaktadÄ±r. Ä°ÅŸlem hÄ±zÄ±nÄ± artÄ±rmaya yÃ¶nelik dikkat ve odaklanma becerilereri geliÅŸtirilebiilir.' }
        ];

        // Supabase Configuration - Ana uygulamadan veri al
        let supabaseClient = null;
        
        // Ana uygulamadan Supabase instance'Ä±nÄ± al
        const getSupabaseClient = () => {
            // EÄŸer parent window varsa oradan al
            if (window.opener && window.opener.supabase) {
                console.log('âœ… Parent window Supabase client bulundu');
                return window.opener.supabase;
            }
            
            // LocalStorage'dan config al
            try {
                const storedUrl = localStorage.getItem('sb-url');
                const storedKey = localStorage.getItem('sb-anon-key');
                
                if (storedUrl && storedKey) {
                    console.log('âœ… localStorage Supabase config bulundu:', { 
                        url: storedUrl.substring(0, 30) + '...', 
                        key: storedKey.substring(0, 50) + '...' 
                    });
                    return supabase.createClient(storedUrl, storedKey);
                }
            } catch (error) {
                console.warn('âš ï¸ localStorage config okunamadÄ±:', error);
            }
            
            // Son Ã§are: Production Supabase values
            const SUPABASE_URL = 'https://gamjzzomkosvqhficabt.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhbWp6em9ta29zdnFoZmljYWJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4ODc3MDAsImV4cCI6MjA2ODQ2MzcwMH0.r8KkywdhNSP1hxzSAlKo8SB5jOEb0KQRUBfZ9Va0p9I';
            
            console.log('âš ï¸ Fallback Supabase config kullanÄ±lÄ±yor');
            return supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        };

        // Supabase client'Ä± initialize et
        supabaseClient = getSupabaseClient();

        // Global variables
        let testData = null;
        let userData = null;
        let conductorData = null;

        // ===============================================
        // DATABASE VERÄ° Ã‡EKME FONKSÄ°YONLARI
        // ===============================================

        // KullanÄ±cÄ± bilgilerini Ã§ek
        async function fetchUserData(userId) {
            try {
                console.log('ğŸ‘¤ KullanÄ±cÄ± bilgileri Ã§ekiliyor:', userId);
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) {
                    console.error('âŒ KullanÄ±cÄ± bilgileri hatasÄ±:', error);
                    throw error;
                }
                console.log('âœ… KullanÄ±cÄ± bilgileri alÄ±ndÄ±:', data);
                return data;
            } catch (error) {
                console.error('âŒ KullanÄ±cÄ± bilgileri alÄ±namadÄ±:', error);
                return null;
            }
        }

        // Test yapan kiÅŸinin bilgilerini Ã§ek
        async function fetchConductorData(conductorId) {
            try {
                console.log('ğŸ‘¨â€ğŸ« Test yapan kiÅŸi bilgileri Ã§ekiliyor:', conductorId);
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('first_name, last_name')
                    .eq('id', conductorId)
                    .single();
                
                if (error) {
                    console.error('âŒ Test yapan kiÅŸi hatasÄ±:', error);
                    throw error;
                }
                console.log('âœ… Test yapan kiÅŸi bilgileri alÄ±ndÄ±:', data);
                return data;
            } catch (error) {
                console.error('âŒ Test yapan kiÅŸi bilgileri alÄ±namadÄ±:', error);
                return null;
            }
        }

        // D2 test sonuÃ§larÄ±nÄ± Ã§ek
        async function fetchD2TestResults(testId) {
            try {
                console.log('ğŸ“Š D2 test sonuÃ§larÄ± Ã§ekiliyor:', testId);
                const { data, error } = await supabaseClient
                    .from('d2_test_results')
                    .select('*')
                    .eq('id', testId)
                    .single();
                
                if (error) {
                    console.error('âŒ D2 test sonuÃ§larÄ± hatasÄ±:', error);
                    throw error;
                }
                console.log('âœ… D2 test sonuÃ§larÄ± alÄ±ndÄ±:', data);
                return data;
            } catch (error) {
                console.error('âŒ D2 test sonuÃ§larÄ± alÄ±namadÄ±:', error);
                return null;
            }
        }

        // En son D2 test sonucunu Ã§ek (kullanÄ±cÄ± ID'ye gÃ¶re)
        async function fetchLatestD2TestByUser(userId) {
            try {
                console.log('ğŸ“Š En son D2 test sonucu Ã§ekiliyor:', userId);
                const { data, error } = await supabaseClient
                    .from('d2_test_results')
                    .select('*')
                    .eq('student_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();
                
                if (error) {
                    console.error('âŒ En son D2 test sonucu hatasÄ±:', error);
                    throw error;
                }
                console.log('âœ… En son D2 test sonucu alÄ±ndÄ±:', data);
                return data;
            } catch (error) {
                console.error('âŒ En son D2 test sonucu alÄ±namadÄ±:', error);
                return null;
            }
        }

        // ===============================================
        // YORUM ÃœRETÄ°MÄ° FONKSÄ°YONLARI
        // ===============================================

        // TN deÄŸerine gÃ¶re yorum Ã¼ret
        function generateTNComment(tnValue) {
            const criteria = TN_CRITERIA.find(c => tnValue >= c.min && tnValue <= c.max);
            return criteria ? criteria.comment : 'DeÄŸer aralÄ±k dÄ±ÅŸÄ±nda.';
        }

        // TN-E deÄŸerine gÃ¶re yorum Ã¼ret
        function generateTNEComment(tneValue) {
            const criteria = TN_E_CRITERIA.find(c => tneValue >= c.min && tneValue <= c.max);
            return criteria ? criteria.comment : 'DeÄŸer aralÄ±k dÄ±ÅŸÄ±nda.';
        }

        // Hata oranÄ±na gÃ¶re yorum Ã¼ret
        function generateErrorComment(errorPercentage) {
            const criteria = ERROR_CRITERIA.find(c => errorPercentage >= c.min && errorPercentage <= c.max);
            return criteria ? criteria.comment : 'DeÄŸer aralÄ±k dÄ±ÅŸÄ±nda.';
        }

        // Dalgalanma oranÄ±na gÃ¶re yorum Ã¼ret (TutarlÄ±lÄ±k)
        function generateFluctuationComment(frValue) {
            const criteria = FLUCTUATION_CRITERIA.find(c => frValue >= c.min && frValue <= c.max);
            return criteria ? criteria.comment : 'DeÄŸer aralÄ±k dÄ±ÅŸÄ±nda.';
        }

        // KapsamlÄ± yorum Ã¼ret
        function generateComprehensiveComment(testData) {
            const tnComment = generateTNComment(testData.total_items_processed);
            const tneComment = generateTNEComment(testData.total_net_performance);
            const errorPercentage = ((testData.commission_errors + testData.omission_errors) / testData.total_items_processed) * 100;
            const errorComment = generateErrorComment(errorPercentage);
            const fluctuationComment = generateFluctuationComment(testData.fluctuation_rate);

            return {
                psikomotorHiz: tnComment,
                secciDikkat: tneComment,
                hataEgilimi: errorComment,
                tutarlilik: fluctuationComment,
                dikkatDalgalanmasi: `BoÅŸ bÄ±rakma oranÄ±: %${((testData.omission_errors / testData.total_items_processed) * 100).toFixed(2)}. ${errorComment}`
            };
        }

        // ===============================================
        // YARDIMCI FONKSÄ°YONLAR
        // ===============================================

        // YaÅŸ hesaplama fonksiyonu
        function calculateAge(birthDate) {
            const birth = new Date(birthDate);
            const now = new Date();
            
            let years = now.getFullYear() - birth.getFullYear();
            let months = now.getMonth() - birth.getMonth();
            let days = now.getDate() - birth.getDate();
            
            if (days < 0) {
                months--;
                days += new Date(now.getFullYear(), now.getMonth(), 0).getDate();
            }
            
            if (months < 0) {
                years--;
                months += 12;
            }
            
            return `${years} YÄ±l ${months} Ay ${days} GÃ¼n`;
        }

        // Tarih formatla
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR');
        }

        // Cinsiyet formatla
        function formatGender(gender) {
            const genderMap = {
                'male': 'Erkek',
                'female': 'KadÄ±n',
                'other': 'DiÄŸer'
            };
            return genderMap[gender] || gender || 'BelirtilmemiÅŸ';
        }

        // ===============================================
        // VERÄ° DOLDURMA FONKSÄ°YONLARI
        // ===============================================

        // KullanÄ±cÄ± bilgilerini DOM'a doldur
        function populateUserData(userData, conductorData, testData) {
            // KullanÄ±cÄ± bilgileri
            if (userData) {
                document.getElementById('user-name').textContent = 
                    `${userData.first_name || ''} ${userData.last_name || ''}`.trim() || 'Bilinmiyor';
                
                if (userData.birth_date) {
                    document.getElementById('user-age').textContent = calculateAge(userData.birth_date);
                    document.getElementById('user-birthdate').textContent = formatDate(userData.birth_date);
                } else {
                    document.getElementById('user-age').textContent = 'Bilinmiyor';
                    document.getElementById('user-birthdate').textContent = 'Bilinmiyor';
                }

                document.getElementById('user-gender').textContent = formatGender(userData.gender);
            }

            // Test yapan kiÅŸi
            if (conductorData) {
                document.getElementById('conductor-name').textContent = 
                    `${conductorData.first_name || ''} ${conductorData.last_name || ''}`.trim() || 'Bilinmiyor';
            }

            // Test tarihi
            if (testData && testData.test_start_time) {
                document.getElementById('test-date').textContent = formatDate(testData.test_start_time);
            }
        }

        // Test metriklerini DOM'a doldur
        function populateTestMetrics(testData) {
            if (!testData) return;

            document.getElementById('tn-value').textContent = testData.total_items_processed || 0;
            document.getElementById('e1-value').textContent = testData.commission_errors || 0;
            document.getElementById('e2-value').textContent = testData.omission_errors || 0;
            document.getElementById('tne-value').textContent = testData.total_net_performance || 0;
            document.getElementById('cp-value').textContent = testData.concentration_performance || 0;
            
            // Hata yÃ¼zdesi hesapla
            const errorPercentage = testData.total_items_processed > 0 
                ? (((testData.commission_errors + testData.omission_errors) / testData.total_items_processed) * 100).toFixed(2)
                : 0;
            document.getElementById('error-percentage').textContent = `%${errorPercentage}`;
            
            // SP (Ä°ÅŸlem hÄ±zÄ±) - processing_speed kullan
            document.getElementById('sp-value').textContent = testData.processing_speed || 0;
        }

        // YorumlarÄ± DOM'a doldur
        function populateComments(testData) {
            if (!testData) return;

            const comments = generateComprehensiveComment(testData);
            
            document.getElementById('psikomotor-comment').innerHTML = 
                `<strong>Psikomotor HÄ±z:</strong> ${comments.psikomotorHiz}`;
            document.getElementById('secci-dikkat-comment').innerHTML = 
                `<strong>SeÃ§ici Dikkat:</strong> ${comments.secciDikkat}`;
            document.getElementById('hata-egilimi-comment').innerHTML = 
                `<strong>Hata EÄŸilimi:</strong> ${comments.hataEgilimi}`;
            document.getElementById('tutarlilik-comment').innerHTML = 
                `<strong>TutarlÄ±lÄ±k:</strong> ${comments.tutarlilik}`;
            document.getElementById('dikkat-dalgalanma-comment').innerHTML = 
                `<strong>Dikkat DalgalanmasÄ±:</strong> ${comments.dikkatDalgalanmasi}`;
        }

        // Performans tablosunu doldur
        function populatePerformanceTable(testData) {
            if (!testData || !testData.line_results) return;

            const performanceRow = document.getElementById('performance-scores');
            const cells = performanceRow.querySelectorAll('td');
            
            // Ä°lk cell "Puan" baÅŸlÄ±ÄŸÄ±, ondan sonrakiler performans deÄŸerleri
            const lineResults = Array.isArray(testData.line_results) ? testData.line_results : [];
            
            for (let i = 1; i < cells.length && i <= 14; i++) {
                if (lineResults[i-1] && lineResults[i-1].correct !== undefined) {
                    cells[i].textContent = lineResults[i-1].correct || 0;
                } else {
                    cells[i].textContent = '0';
                }
            }
        }

        // Chart'Ä± gÃ¼ncelle
        function updateChart(testData) {
            if (!testData || !testData.line_results) return;

            const lineResults = Array.isArray(testData.line_results) ? testData.line_results : [];
            const performanceData = [];
            
            for (let i = 0; i < 14; i++) {
                if (lineResults[i] && lineResults[i].correct !== undefined) {
                    performanceData.push(lineResults[i].correct || 0);
                } else {
                    performanceData.push(0);
                }
            }

            // Chart verilerini gÃ¼ncelle
            chart.data.datasets[0].data = performanceData;
            chart.update();
        }

        // ===============================================
        // ANA Ä°NÄ°T FONKSÄ°YONU
        // ===============================================

        // Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸacak ana fonksiyon
        async function initializeD2Report() {
            try {
                console.log('ğŸš€ D2 raporu initialize ediliyor...');
                
                // URL parametrelerinden test ID'sini al
                const urlParams = new URLSearchParams(window.location.search);
                const testId = urlParams.get('testId');
                const userId = urlParams.get('userId');

                console.log('ğŸ“‹ URL Parametreleri:', { testId, userId });

                if (!testId && !userId) {
                    console.error('âŒ Test ID veya User ID parametresi bulunamadÄ±');
                    showError('URL parametresi eksik. testId veya userId gerekli.');
                    return;
                }

                // Supabase client kontrolÃ¼
                if (!supabaseClient) {
                    console.error('âŒ Supabase client baÅŸlatÄ±lamadÄ±');
                    showError('Database baÄŸlantÄ±sÄ± kurulamadÄ±.');
                    return;
                }

                let testData;
                
                // Test ID varsa direkt Ã§ek, yoksa kullanÄ±cÄ±nÄ±n en son testini Ã§ek
                if (testId) {
                    console.log('ğŸ” Test ID ile veri Ã§ekiliyor:', testId);
                    testData = await fetchD2TestResults(testId);
                } else if (userId) {
                    console.log('ğŸ” User ID ile en son test Ã§ekiliyor:', userId);
                    testData = await fetchLatestD2TestByUser(userId);
                }

                if (!testData) {
                    console.error('âŒ Test verileri alÄ±namadÄ±');
                    showError('Test verileri bulunamadÄ±.');
                    return;
                }

                console.log('âœ… Test verileri baÅŸarÄ±yla alÄ±ndÄ±:', testData);

                // KullanÄ±cÄ± ve test yapan kiÅŸi bilgilerini Ã§ek
                console.log('ğŸ‘¤ KullanÄ±cÄ± bilgileri Ã§ekiliyor...');
                const userData = await fetchUserData(testData.student_id);
                const conductorData = await fetchConductorData(testData.conducted_by);

                // Global deÄŸiÅŸkenlere ata
                window.testData = testData;
                window.userData = userData;
                window.conductorData = conductorData;

                // DOM elementlerini doldur
                console.log('ğŸ¨ DOM elemanlarÄ± doldurluyor...');
                populateUserData(userData, conductorData, testData);
                populateTestMetrics(testData);
                populateComments(testData);
                populatePerformanceTable(testData);
                updateChart(testData);

                console.log('ğŸ‰ D2 raporu baÅŸarÄ±yla yÃ¼klendi!');

            } catch (error) {
                console.error('âŒ D2 raporu yÃ¼klenirken hata oluÅŸtu:', error);
                showError(`Rapor yÃ¼klenirken hata: ${error.message}`);
            }
        }

        // Hata mesajÄ± gÃ¶sterme fonksiyonu
        function showError(message) {
            // TÃ¼m "YÃ¼kleniyor..." yazÄ±larÄ±nÄ± hata mesajÄ± ile deÄŸiÅŸtir
            const loadingElements = document.querySelectorAll('[id*="user-"], [id*="test-"], [id*="conductor-"], [id*="tn-"], [id*="e1-"], [id*="e2-"], [id*="cp-"], [id*="sp-"], [id*="tne-"], [id*="error-"]');
            loadingElements.forEach(element => {
                if (element.textContent === 'YÃ¼kleniyor...' || element.textContent === '-') {
                    element.textContent = 'Hata!';
                    element.style.color = '#dc2626';
                }
            });

            // Yorum bÃ¶lÃ¼mlerini gÃ¼ncelle
            const commentElements = document.querySelectorAll('[id*="comment"]');
            commentElements.forEach(element => {
                if (element.innerHTML.includes('YÃ¼kleniyor...')) {
                    element.innerHTML = `<strong style="color: #dc2626;">Hata:</strong> ${message}`;
                }
            });

            // Console'a detaylÄ± hata bilgisi yaz
            console.error('ğŸš¨ D2 Template HatasÄ±:', message);
        }

        // Production'dan Supabase config yÃ¼kleme (alternatif yÃ¶ntem)
        async function loadSupabaseConfig() {
            try {
                console.log('ğŸ”§ Supabase config yÃ¼kleniyor...');
                
                // Ana uygulamadan window.supabase al
                if (window.opener && window.opener.supabase) {
                    console.log('âœ… Ana uygulamadan Supabase alÄ±ndÄ±');
                    supabaseClient = window.opener.supabase;
                    return true;
                }

                // localStorage'dan bilgileri Ã§ek (main app tarafÄ±ndan set edilmiÅŸse)
                const sbUrl = localStorage.getItem('sb-url');
                const sbKey = localStorage.getItem('sb-anon-key');
                
                if (sbUrl && sbKey) {
                    console.log('âœ… localStorage Supabase config kullanÄ±lÄ±yor');
                    supabaseClient = supabase.createClient(sbUrl, sbKey);
                    return true;
                }

                // Config API endpoint'i dene
                try {
                    const response = await fetch('/api/supabase-config');
                    if (response.ok) {
                        const config = await response.json();
                        console.log('âœ… API'den Supabase config alÄ±ndÄ±');
                        supabaseClient = supabase.createClient(config.url, config.key);
                        return true;
                    }
                } catch (apiError) {
                    console.warn('âš ï¸ Config API Ã§alÄ±ÅŸmÄ±yor:', apiError.message);
                }

                console.warn('âš ï¸ Supabase config bulunamadÄ±, client zaten initialize edildi');
                return false;
            } catch (error) {
                console.warn('âš ï¸ Supabase config yÃ¼klenemedi:', error);
                return false;
            }
        }

        // Grafik oluÅŸturma
        const ctx = document.getElementById('performanceChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14'],
                datasets: [{
                    label: 'Performans',
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], // BaÅŸlangÄ±Ã§ta sÄ±fÄ±r
                    borderColor: '#dc2626',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointBackgroundColor: '#dc2626',
                    pointRadius: 5,
                    tension: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 30 // Dinamik olarak ayarlanabilir
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // ===============================================
        // SAYFA YÃœKLENDÄ°ÄÄ°NDE Ã‡ALIÅACAK KODLAR
        // ===============================================

        // DOM iÃ§eriÄŸi yÃ¼klendiÄŸinde init fonksiyonunu Ã§alÄ±ÅŸtÄ±r
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ“„ D2 Rapor sayfasÄ± yÃ¼klendi');
            
            try {
                // Ã–nce Supabase config'ini kontrol et
                console.log('ğŸ” Supabase client durumu:', supabaseClient ? 'Mevcut' : 'BoÅŸ');
                
                // Config yÃ¼klemeyi dene
                await loadSupabaseConfig();
                
                // Son kontrol
                if (!supabaseClient) {
                    console.error('âŒ Supabase client hala yok, initialization durduruldu');
                    showError('Database baÄŸlantÄ±sÄ± kurulamadÄ±. LÃ¼tfen ana uygulamadan aÃ§Ä±n.');
                    return;
                }
                
                // Raporu initialize et
                await initializeD2Report();
                
            } catch (error) {
                console.error('âŒ Initialization hatasÄ±:', error);
                showError(`BaÅŸlatma hatasÄ±: ${error.message}`);
            }
        });

        // Test amaÃ§lÄ± window objelerine eriÅŸim
        window.D2_TEST_FUNCTIONS = {
            initializeD2Report,
            fetchD2TestResults,
            fetchUserData,
            generateComprehensiveComment,
            populateUserData,
            populateTestMetrics,
            populateComments,
            updateChart
        };

    </script>
</body>
</html>