<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ForTest Akıl ve Mantık Testi</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js" onload="window.__initSupabase && window.__initSupabase()"></script>
    <script>
      (function () {
        const MAX_TRIES = 15;
        const DELAY_MS = 300;
        let tries = 0;

        function ns() { return window.supabase || window.Supabase || null; }

        function tryInit() {
          try {
            const url = localStorage.getItem('sb-url');
            const key = localStorage.getItem('sb-anon-key');
            if (!url || !key) return false;
            const lib = ns();
            if (!lib || typeof lib.createClient !== 'function') return false;
            if (!window.supabaseClient) {
              window.supabaseClient = lib.createClient(url, key);
              console.log('✅ Supabase client (Akıl-Mantık) oluşturuldu');
            }
            return true;
          } catch { return false; }
        }

        window.__initSupabase = function () {
          if (tryInit()) return;
          const t = setInterval(() => {
            tries++;
            if (tryInit() || tries >= MAX_TRIES) clearInterval(t);
          }, DELAY_MS);
        };
        if (!window.supabaseClient) setTimeout(() => window.__initSupabase && window.__initSupabase(), 0);
      })();
    </script>
    <style>
        :root {
            --primary: #60a5fa;
            --primary-dark: #2563eb;
            --secondary: #f43f5e;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #0f172a;
            --gray: #94a3b8;
            --gray-light: #e2e8f0;
            --border-radius: 8px;
            --font-main: 'Segoe UI', Roboto, Arial, sans-serif;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
            
            /* Responsive değişkenler - dikkat testinden alınmış */
            --container-padding: clamp(15px, 4vw, 50px);
            --font-size-base: clamp(14px, 2vw, 18px);
            --font-size-large: clamp(18px, 3vw, 24px);
            --font-size-xlarge: clamp(24px, 4vw, 48px);
            --font-size-xxlarge: clamp(32px, 6vw, 64px);
            --button-padding: clamp(12px, 2vw, 18px) clamp(20px, 4vw, 40px);
            --gap-size: clamp(10px, 2vw, 20px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            line-height: 1.6;
            color: var(--dark);
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #1d4ed8 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            font-size: var(--font-size-base);
            margin: 0;
        }

        /* Container 1200x800 aspect ratio - dikkat testinden alınmış */
        .container {
            background: linear-gradient(145deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            border-radius: clamp(15px, 3vw, 20px);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                0 15px 30px rgba(0, 0, 0, 0.3),
                inset 0 2px 5px rgba(255, 255, 255, 0.1);
            padding: var(--container-padding);
            /* Dynamic sizing: clamp width and maintain 3:2 aspect ratio */
            width: clamp(320px, 90vw, 1200px);
            aspect-ratio: 3 / 2;
            height: auto;
            text-align: center;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
        }

        /* Loading overlay - dikkat testinden alınmış */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 58, 138, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: white;
            font-size: var(--font-size-large);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error message - dikkat testinden alınmış */
        .error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(239, 68, 68, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            flex-direction: column;
            text-align: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .error-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .error-message {
            color: white;
            font-size: var(--font-size-large);
            text-align: center;
            padding: 20px;
            line-height: 1.6;
        }

        .screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: var(--container-padding);
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Örnek gösterim ekranı için özel düzenleme - orijinal yapıyı koru */
        #exampleDemoScreen.active {
            justify-content: center;
            align-items: center;
        }
        
        /* Örnek sorular ekranı için düzenleme - orijinal yapıyı koru */
        #exampleScreen.active {
            justify-content: center;
            align-items: center;
        }

        /* Başlangıç ekranı - dikkat testinden alınmış */
        .title-screen h1 {
            font-size: var(--font-size-xxlarge);
            color: white;
            font-weight: 700;
            margin-bottom: clamp(25px, 6vw, 50px);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            line-height: 1.2;
        }

        .instruction-box {
            background: transparent;
            border-radius: 0;
            padding: clamp(10px, 3vw, 20px);
            margin: clamp(15px, 4vw, 30px) auto;
            max-width: min(90%, 800px);
            box-shadow: none;
            border: none;
        }

        .instruction-text {
            font-size: var(--font-size-large);
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: clamp(10px, 3vw, 20px);
            line-height: 1.8;
        }

        .highlight-text {
            color: white;
            font-weight: bold;
            font-size: clamp(20px, 3.5vw, 28px);
            margin: clamp(10px, 3vw, 20px) 0;
            line-height: 1.8;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .btn {
            display: inline-block;
            font-weight: 500;
            color: white;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            padding: var(--button-padding);
            font-size: clamp(16px, 2.5vw, 22px);
            line-height: 1.5;
            border-radius: var(--border-radius);
            transition: opacity 0.5s ease, transform 0.5s ease, background 0.3s ease, box-shadow 0.3s ease;
            border: none;
            box-shadow: 
                0 4px 6px rgba(30, 64, 175, 0.3),
                0 0 15px rgba(255, 255, 255, 0.3),
                0 0 25px rgba(255, 255, 255, 0.1);
            text-decoration: none;
            margin: clamp(5px, 1vw, 10px);
            opacity: 0;
            transform: translateY(20px);
            min-width: clamp(100px, 20vw, 150px);
            position: relative;
            overflow: hidden;
            min-height: clamp(44px, 8vw, 56px);
        }

        .btn.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn:hover:not(.disabled) {
            background: linear-gradient(135deg, #1e3d9f 0%, #2454d6 100%);
            box-shadow: 
                0 6px 8px rgba(30, 58, 138, 0.4),
                0 0 20px rgba(255, 255, 255, 0.4),
                0 0 35px rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .btn-bottom-right {
            position: absolute;
            bottom: clamp(20px, 4vw, 40px);
            right: clamp(20px, 4vw, 40px);
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .btn-bottom-right.visible {
            opacity: 1;
        }

        /* Sonuç ekranı - dikkat testinden alınmış */
        .result-message {
            font-size: clamp(28px, 5vw, 48px);
            color: white;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: clamp(15px, 4vw, 30px);
            line-height: 1.2;
        }

        .result-info {
            font-size: var(--font-size-large);
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        /* Test alanı */
        .test-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            overflow: hidden;
            padding: 20px;
        }

        #exampleDemoScreen .test-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            overflow: hidden;
            padding: 10px;
        }
        
        #exampleScreen .test-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            overflow: hidden;
            padding: 10px;
        }

        /* Soru gösterimi */
        .question-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 30px;
        }

        .question-image {
            width: 600px;
            height: 300px;
            object-fit: contain;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            background: #f9fafb;
            padding: 15px;
            image-rendering: auto;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        #exampleDemoScreen .question-image {
            width: clamp(400px, 60vw, 500px);
            height: clamp(200px, 30vw, 250px);
            object-fit: contain;
            margin-bottom: 15px;
        }
        
        #exampleScreen .question-image {
            width: clamp(400px, 60vw, 500px);
            height: clamp(200px, 30vw, 250px);
            object-fit: contain;
            margin-bottom: 20px;
        }

        #exampleDemoScreen .question-display {
            margin-bottom: 10px;
        }

        /* Seçenekler - Tüm sorular için tek düzen */
        .options-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: nowrap;
            width: 100%;
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 10px;
        }

        #exampleDemoScreen .options-container {
            gap: clamp(8px, 2vw, 12px);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0 5px;
            max-width: 100%;
        }

        #exampleScreen .options-container {
            gap: clamp(8px, 2vw, 12px);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0 5px;
            max-width: 100%;
        }

        .option {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            background: #ffffff;
            padding: 10px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            flex: 0 0 auto;
            width: 135px;
        }

        #exampleDemoScreen .option {
            padding: 8px;
            width: clamp(100px, 15vw, 120px);
        }
        
        .option-label {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--primary-dark);
            background: #e8f4fd;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1;
        }

        #exampleDemoScreen .option-label {
            width: clamp(30px, 5vw, 35px);
            height: clamp(30px, 5vw, 35px);
            font-size: clamp(14px, 2.5vw, 18px);
        }
        

        
        .option.selected {
            background: linear-gradient(135deg, #90cdf4 0%, #60a5fa 100%) !important;
            color: black !important;
            border-color: #90cdf4 !important;
            box-shadow: 
                0 clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 6px) rgba(0, 0, 0, 0.2),
                0 1px 3px rgba(0, 0, 0, 0.15),
                inset 0 2px 2px rgba(255, 255, 255, 0.8) !important;
        }
        
        .option.selected .option-label {
            background: linear-gradient(135deg, #90cdf4 0%, #60a5fa 100%) !important;
            color: black !important;
            box-shadow: 
                0 clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 6px) rgba(0, 0, 0, 0.2),
                0 1px 3px rgba(0, 0, 0, 0.15),
                inset 0 2px 2px rgba(255, 255, 255, 0.8) !important;
        }

        .option img {
            width: 110px;
            height: 110px;
            object-fit: contain;
            display: block;
            border-radius: 8px;
            background: #f8f9fa;
            padding: 5px;
        }

        #exampleDemoScreen .option img {
            width: clamp(80px, 12vw, 100px);
            height: clamp(80px, 12vw, 100px);
        }

        .option.correct {
            border-color: #10b981;
            background: #ecfdf5;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .option.correct .option-label {
            background: #10b981;
            color: white;
        }

        .option.wrong {
            border-color: #ef4444;
            background: #fef2f2;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        
        .option.wrong .option-label {
            background: #ef4444;
            color: white;
        }

        /* DİSABLED kuralı EN SONDA olmalı - diğer kuralları ezsin */
        .option.disabled {
            opacity: 0.6 !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
            transform: none !important;
        }

        .option.disabled:hover {
            background: initial !important;
            border-color: initial !important;
            transform: none !important;
            box-shadow: initial !important;
        }

        /* Program gösterimi için animasyon */
        .demo-pointer {
            position: absolute;
            width: 20px;
            height: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><path d="M0,0 L0,16 L4,12 L7,19 L10,18 L7,11 L12,11 Z" fill="black" stroke="white" stroke-width="1"/></svg>');
            background-size: contain;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
        }

        /* Tıklama efekti */
        .click-effect {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #10b981;
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            z-index: 1001;
        }

        .click-effect::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #10b981;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: inherit;
        }
        
        .click-effect.active {
            animation: clickRipple 1s ease-out forwards;
        }
        
        .click-effect.active::before {
            animation: innerRipple 1s ease-out forwards;
        }

        @keyframes clickRipple {
            0% {
                opacity: 0.8;
                transform: scale(0.5);
            }
            50% {
                opacity: 1;
                transform: scale(1.5);
            }
            100% {
                opacity: 0;
                transform: scale(2.5);
            }
        }

        @keyframes innerRipple {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.3);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.5);
            }
        }

        /* Progress bar için animasyon */
        @keyframes fillProgress {
            from {
                width: 0%;
            }
            to {
                width: 100%;
            }
        }
        
        .progress-fill.animating {
            animation: fillProgress 300s linear forwards; /* 5 dakika = 300 saniye */
        }

        /* İlerleme göstergesi */
        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: clamp(6px, 1vw, 8px);
            background: rgba(255, 255, 255, 0.2);
            overflow: hidden;
            border-bottom-left-radius: clamp(15px, 3vw, 20px);
            border-bottom-right-radius: clamp(15px, 3vw, 20px);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
            width: 0%;
            position: relative;
            border-bottom-left-radius: clamp(15px, 3vw, 20px);
            border-bottom-right-radius: clamp(15px, 3vw, 20px);
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 60px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-50px); }
            100% { transform: translateX(50px); }
        }

        /* Memory text - hafıza testinden alınmış */
        .memory-text {
            font-size: clamp(16px, 2.5vw, 22px);
            color: white;
            font-weight: 500;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
            position: absolute;
            bottom: clamp(20px, 4vw, 40px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            text-align: center;
            width: max-content;
            max-width: 80%;
            padding: clamp(12px, 2vw, 18px) clamp(20px, 4vw, 40px);
            background: rgba(30, 64, 175, 0.8);
            backdrop-filter: blur(8px);
            border-radius: var(--border-radius);
            line-height: 1.5;
            margin: clamp(5px, 1vw, 10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .notification {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 30px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: var(--font-size-base);
        }

        .notification.success {
            background-color: var(--success);
        }

        .notification.error {
            background-color: var(--danger);
        }

        .notification.show {
            opacity: 1;
        }

        /* Responsive Media Queries - dikkat testinden alınmış */
        
        /* Çok küçük telefon ekranları */
        @media (max-width: 360px) {
            .container {
                padding: clamp(10px, 3vw, 15px);
            }
            
            #exampleDemoScreen .options-container {
                gap: 12px;
            }
            
            #exampleDemoScreen .option img {
                width: 90px;
                height: 90px;
            }
        }

        /* Küçük telefon ekranları */
        @media (max-width: 480px) {
            .btn-bottom-right {
                position: relative;
                bottom: auto;
                right: auto;
                margin-top: 20px;
            }
            
            .options-container {
                gap: 10px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .option {
                width: 110px;
                padding: 8px;
            }
            
            .option img {
                width: 85px;
                height: 85px;
            }
            
            .option-label {
                width: 35px;
                height: 35px;
                font-size: 1.1em;
            }
        }

        /* Tablet ve masaüstü */
        @media (min-width: 481px) {
            .container {
                height: min(100vh - 30px, 800px);
            }
        }

        /* Büyük ekranlar */
        @media (min-width: 1400px) {
            .container {
                width: min(90%, 1400px);
                height: min(100vh - 40px, 900px);
            }
        }

        /* Landscape mode mobil */
        @media (max-height: 500px) and (orientation: landscape) {
            .container {
                height: 95vh;
                padding: 15px;
            }
            .title-screen h1 {
                margin-bottom: 20px;
            }
            .instruction-box {
                padding: 20px;
                margin: 15px auto;
            }
        }

        /* High DPI ekranlar için font optimizasyonu */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .title-screen h1, .result-message {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            .loading-overlay, .error-overlay {
                transition: opacity 0.1s ease !important;
            }
        }

        /* Geri sayım ekranı - çok sade */
        .countdown-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        .countdown-number {
            font-size: clamp(80px, 12vw, 150px);
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            .option {
                border-width: 2px;
                border-color: black;
            }
            .btn {
                border: 2px solid white;
            }
        }

        @media (max-width: 1300px) {
            .container {
                width: 95%;
                max-width: 1280px;
            }
            
            #exampleDemoScreen .options-container {
                gap: 12px;
            }
            
            #exampleDemoScreen .option img {
                width: 90px;
                height: 90px;
            }
        }

        @media (max-width: 1100px) {
            .options-container {
                gap: 10px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .option {
                width: 130px;
            }
            
            .option img {
                width: 100px;
                height: 100px;
            }
        }
        
        @media (max-width: 900px) {
            .question-image {
                width: 500px;
                height: 250px;
            }
            
            .options-container {
                gap: 8px;
                max-width: 100%;
            }
            
            .option {
                width: 110px;
                padding: 8px;
            }
            
            .option img {
                width: 85px;
                height: 85px;
            }
            
            .option-label {
                width: 35px;
                height: 35px;
                font-size: 1.1em;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                height: 95vh;
                min-height: 650px;
                padding: 30px 20px;
            }
            
            #exampleDemoScreen.active {
                justify-content: center;
                align-items: center;
            }
            
            #exampleDemoScreen .question-image {
                width: clamp(300px, 80vw, 400px);
                height: clamp(150px, 40vw, 200px);
            }
            
            #exampleDemoScreen .option img {
                width: clamp(60px, 12vw, 80px);
                height: clamp(60px, 12vw, 80px);
            }
            
            #exampleDemoScreen .options-container {
                gap: 10px;
            }
            
            #exampleScreen .question-image {
                width: clamp(300px, 80vw, 400px);
                height: clamp(150px, 40vw, 200px);
                margin-bottom: 10px;
            }
            
            #exampleScreen .options-container {
                gap: 8px;
            }

            .title-screen h1 {
                font-size: 3em;
            }

            .question-image {
                width: 100%;
                max-width: 400px;
                height: 200px;
            }
            
            .options-container {
                gap: 6px;
                padding: 0 5px;
            }
            
            .option {
                width: 90px;
                padding: 6px;
            }

            .option img {
                width: 70px;
                height: 70px;
                padding: 3px;
            }
            
            .option-label {
                width: 30px;
                height: 30px;
                font-size: 1em;
            }

            .result-message {
                font-size: 2.5em;
            }
        }
        
        @media (max-width: 480px) {
            .options-container {
                gap: 4px;
            }
            
            .option {
                width: 70px;
                padding: 4px;
                gap: 5px;
            }
            
            .option img {
                width: 55px;
                height: 55px;
                padding: 2px;
            }
            
            .option-label {
                width: 26px;
                height: 26px;
                font-size: 0.85em;
            }

            .instruction-text {
                font-size: 1.2em;
            }

            .highlight-text {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Yükleniyor...</div>
        </div>

        <!-- Error Overlay -->
        <div class="error-overlay" id="errorOverlay">
            <div class="error-message" id="errorMessage">Bir hata oluştu</div>
        </div>

        <!-- 0. Başlangıç Title Ekranı -->
        <div id="titleScreen" class="screen active">
            <div class="title-screen">
                <h1>Akıl ve Mantık Testi</h1>
            </div>
            <button class="btn btn-bottom-right visible" onclick="stopCurrentAudio(); goToWelcome()">İleri</button>
        </div>

        <!-- 1. Giriş Ekranı -->
        <div id="welcomeScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Örüntüyü Tamamlayan Seçeneği İşaretle
                </div>
            </div>
            <button class="btn btn-bottom-right" id="welcomeNextBtn" onclick="stopCurrentAudio(); goToExampleDemo()">İleri</button>
        </div>

        <!-- 2. Örnek Gösterim Ekranı -->
        <div id="exampleDemoScreen" class="screen">
            <div class="test-area" id="demoArea">
                <!-- Program örneği gösterecek -->
            </div>
            <div class="memory-text">Örneği Dikkatle İzleyin!</div>
            <button class="btn btn-bottom-right" id="demoNextBtn" onclick="stopCurrentAudio(); goToExampleIntro()" style="display: none;">İleri</button>
        </div>

        <!-- 3. Örnek Uygulama Giriş Ekranı -->
        <div id="exampleIntroScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Örnek Uygulamaya Geçmek İçin "İleri" Butonuna Tıklayın!
                </div>
            </div>
            <button class="btn btn-bottom-right" id="exampleIntroNextBtn" onclick="stopCurrentAudio(); goToExampleReady()">İleri</button>
        </div>

        <!-- 4. Örnek Hazır Ekranı -->
        <div id="exampleReadyScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Örnek Uygulamaya Hazırsanız "Başla" Butonuna Tıklayın!
                </div>
            </div>
            <button class="btn btn-bottom-right" id="exampleReadyBtn" onclick="stopCurrentAudio(); showExampleCountdown()">Başla</button>
        </div>

        <!-- 5. Örnek Uygulama Geri Sayım Ekranı -->
        <div id="exampleCountdownScreen" class="screen">
            <div class="countdown-screen">
                <div id="exampleCountdownNumber" class="countdown-number">3</div>
            </div>
        </div>

        <!-- 6. Örnek Sorular Ekranı -->
        <div id="exampleScreen" class="screen">
            <div class="test-area">
                <div class="question-display">
                    <img id="exampleQuestionImg" class="question-image" src="" alt="Örnek soru">
                </div>
                <div class="options-container" id="exampleOptions">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
            </div>
        </div>

        <!-- 7. Örnek Bitiş Ekranı -->
        <div id="exampleCompleteScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Örnek Uygulamayı Tamamladınız!
                </div>
            </div>
            <button class="btn btn-bottom-right" id="exampleCompleteBtn" onclick="stopCurrentAudio(); goToMainTestIntro()">İleri</button>
        </div>

        <!-- 8. Ana Test Giriş Ekranı -->
        <div id="mainTestIntroScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Teste Hazırlanın!<br>
                    Testi Tamamlamak için 5 Dakikanız Var.
                </div>
            </div>
            <button class="btn btn-bottom-right" id="mainTestStartBtn" onclick="stopCurrentAudio(); showMainCountdown()">Başla</button>
        </div>

        <!-- 8. Ana Test Geri Sayım Ekranı -->
        <div id="mainCountdownScreen" class="screen">
            <div class="countdown-screen">
                <div id="mainCountdownNumber" class="countdown-number">3</div>
            </div>
        </div>

        <!-- 9. Ana Test Ekranı -->
        <div id="mainTestScreen" class="screen">
            <div class="test-area">
                <div class="question-display">
                    <img id="mainQuestionImg" class="question-image" src="" alt="Test sorusu">
                </div>
                <div class="options-container" id="mainOptions">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="timeProgressFill"></div>
            </div>
        </div>

        <!-- 10. Örnek Uygulama Başarısızlık Ekranı -->
        <div id="exampleFailScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Yeterli doğru cevabı vermediniz, örnek uygulama tekrar edilecektir.
                </div>
            </div>
            <button class="btn btn-bottom-right visible" onclick="retryExampleFromFail()">Tamam</button>
        </div>

        <!-- 11. Sonuç Ekranı -->
        <div id="resultsScreen" class="screen">
            <div class="result-message">Tüm Testi Tamamladınız!</div>
            <div class="result-info">Sıradaki Bölüme Geçmek İçin İleri Butonuna Tıklayın!</div>
            <button class="btn btn-bottom-right visible" onclick="stopCurrentAudio(); completeTest()">İleri</button>
        </div>
    </div>

    <!-- Demo pointer for example -->
    <div class="demo-pointer" id="demoPointer"></div>
    
    <!-- Tıklama efekti -->
    <div class="click-effect" id="clickEffect"></div>

    <script>
        // ===================================
        // AKIL VE MANTIK TESTİ SİSTEMİ - v2.1 CLEAN
        // Dikkat Testi Yapısında Adapte Edilmiş
        // ===================================

        'use strict';

        // Global hata yakalama - dikkat testinden alınmış
        window.addEventListener('error', function(e) {
            console.error('Global Error:', e.error);
            handleError('Beklenmeyen bir hata oluştu: ' + e.message, true);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled Promise Rejection:', e.reason);
            handleError('Promise hatası: ' + e.reason, true);
        });

        // Hata yönetimi - dikkat testinden alınmış
        function handleError(message, critical = false) {
            console.error('Test Error:', message);
            hideLoading();

            if (critical) {
                showError(message, 6000);
            } else {
                console.warn('Non-critical error handled:', message);
            }
        }

        // Loading göstergesi - flash engellemek için gecikmeli gösterim + minimum görünürlük
        let loadingTimeout = null;
        let loadingShowDelayTimer = null;
        let loadingShownAt = 0;
        let loadingMinDisplay = 0;
        const LOADING_SHOW_DELAY_MS = 300; // hızlı yüklemede spinner hiç görünmesin
        
        function showLoading(message = 'Yükleniyor...', minDisplayTime = 0) {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            
            if (!overlay) return;
            if (text) text.textContent = message;
            
            // Önceki zamanlayıcıları temizle
            if (loadingTimeout) { clearTimeout(loadingTimeout); loadingTimeout = null; }
            if (loadingShowDelayTimer) { clearTimeout(loadingShowDelayTimer); loadingShowDelayTimer = null; }
            
            loadingMinDisplay = typeof minDisplayTime === 'number' ? Math.max(0, minDisplayTime) : 0;
            
            // Spinner'ı gecikmeli göster: hızlı yüklemede hiç görünmesin
            loadingShowDelayTimer = setTimeout(() => {
                overlay.classList.add('show');
                loadingShownAt = Date.now();
                loadingShowDelayTimer = null;
            }, LOADING_SHOW_DELAY_MS);
        }

        function hideLoading(delay = 0) {
            const overlay = document.getElementById('loadingOverlay');
            if (!overlay) return;
            
            // Henüz gösterilmeden yükleme bittiyse: timer'ı iptal et, hiçbir şey gösterme
            if (loadingShowDelayTimer) {
                clearTimeout(loadingShowDelayTimer);
                loadingShowDelayTimer = null;
                return;
            }
            
            const elapsed = loadingShownAt ? (Date.now() - loadingShownAt) : 0;
            const needMore = Math.max(0, loadingMinDisplay - elapsed);
            const totalDelay = Math.max(delay || 0, needMore);
            
            if (totalDelay > 0) {
                loadingTimeout = setTimeout(() => {
                    overlay.classList.remove('show');
                    loadingTimeout = null;
                }, totalDelay);
            } else {
                overlay.classList.remove('show');
            }
        }

        // Error overlay - dikkat testinden alınmış
        let errorTimeout = null;

        function showError(message, duration = 4000) {
            const overlay = document.getElementById('errorOverlay');
            const messageEl = document.getElementById('errorMessage');
            
            if (overlay) {
                if (messageEl) messageEl.textContent = message;
                overlay.classList.add('show');
                
                if (errorTimeout) {
                    clearTimeout(errorTimeout);
                }
                
                errorTimeout = setTimeout(() => {
                    hideError();
                }, duration);
            }
        }

        function hideError() {
            const overlay = document.getElementById('errorOverlay');
            if (overlay) {
                overlay.classList.remove('show');
                if (errorTimeout) {
                    clearTimeout(errorTimeout);
                    errorTimeout = null;
                }
            }
        }

        // ==================== IMAGE PRELOADING SİSTEMİ ====================
        let preloadedImages = new Map();
        let preloadingPromises = [];

        function preloadImage(src) {
            if (preloadedImages.has(src)) {
                return Promise.resolve(preloadedImages.get(src));
            }

            const promise = new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    preloadedImages.set(src, img);
                    resolve(img);
                };
                img.onerror = (e) => {
                    console.error(`❌ Görsel yüklenemedi: ${src}`, e);
                    reject(new Error(`Görsel yüklenemedi: ${src}`));
                };
                img.src = src;
            });

            preloadingPromises.push(promise);
            return promise;
        }

        function preloadAllImages() {
            console.log('🖼️ Görsel ön yükleme başlatılıyor...');
            const imagesToPreload = [];

            // Örnek görselleri
            testData.examples.forEach(example => {
                const basePath = `/cognitive-tests/akil-mantik/${example.folder}`;
                imagesToPreload.push(`${basePath}/soru.png`);
                for (let i = 1; i <= 5; i++) {
                    imagesToPreload.push(`${basePath}/${i}.png`);
                }
            });

            // Ana test görselleri
            testData.mainQuestions.forEach(question => {
                const basePath = `/cognitive-tests/akil-mantik/${question.folder}`;
                imagesToPreload.push(`${basePath}/soru.png`);
                const optionCount = basePath.includes('4-ALTILI KARE FORMAT') ? 6 : 5;
                for (let i = 1; i <= optionCount; i++) {
                    imagesToPreload.push(`${basePath}/${i}.png`);
                }
            });

            return Promise.allSettled(imagesToPreload.map(src => preloadImage(src)));
        }

        // ==================== TEST VERİLERİ ====================
        const testData = {
            // Örnek sorular - 4 adet (1'i program gösterecek, 3'ü kullanıcı yapacak)
            examples: [
                {
                    folder: 'Oruntuler/1-ORNEK UYGULAMA/ORNEK-UYGULAMA-1',
                    correctAnswer: 2 // 3-DOĞRU
                },
                {
                    folder: 'Oruntuler/1-ORNEK UYGULAMA/ORNEK-UYGULAMA-2',
                    correctAnswer: 3 // 4-DOĞRU
                },
                {
                    folder: 'Oruntuler/1-ORNEK UYGULAMA/ORNEK-UYGULAMA-3',
                    correctAnswer: 1 // 2-DOĞRU
                },
                {
                    folder: 'Oruntuler/1-ORNEK UYGULAMA/ORNEK-UYGULAMA-4',
                    correctAnswer: 1 // 2-DOĞRU
                }
            ],
            
            // Ana test soruları
            mainQuestions: [
                // BÖLÜM 1 - Dörtlü Yatay Format (8 soru)
                { folder: 'Oruntuler/2-DORTLU YATAY/1', correctAnswer: 1, section: 1 }, // 2-DOĞRU
                { folder: 'Oruntuler/2-DORTLU YATAY/2', correctAnswer: 4, section: 1 }, // 5-DOĞRU
                { folder: 'Oruntuler/2-DORTLU YATAY/3', correctAnswer: 3, section: 1 }, // 4-DOĞRU
                { folder: 'Oruntuler/2-DORTLU YATAY/4', correctAnswer: 4, section: 1 }, // 5-DOĞRU
                { folder: 'Oruntuler/2-DORTLU YATAY/5', correctAnswer: 3, section: 1 }, // 4-DOĞRU
                { folder: 'Oruntuler/2-DORTLU YATAY/6', correctAnswer: 1, section: 1 }, // 2-DOĞRU
                { folder: 'Oruntuler/2-DORTLU YATAY/7', correctAnswer: 2, section: 1 }, // 3-DOGRU
                { folder: 'Oruntuler/2-DORTLU YATAY/8', correctAnswer: 1, section: 1 }, // 2-DOGRU
                
                // BÖLÜM 2 - Dörtlü Kare Format (6 soru) 
                { folder: 'Oruntuler/3-DORTLU KARE FORMAT/1', correctAnswer: 3, section: 2 }, // 4-DOĞRU
                { folder: 'Oruntuler/3-DORTLU KARE FORMAT/2', correctAnswer: 2, section: 2 }, // 3-DOĞRU
                { folder: 'Oruntuler/3-DORTLU KARE FORMAT/3', correctAnswer: 3, section: 2 }, // 4-DOĞRU
                { folder: 'Oruntuler/3-DORTLU KARE FORMAT/4', correctAnswer: 1, section: 2 }, // 2-DOĞRU
                { folder: 'Oruntuler/3-DORTLU KARE FORMAT/5', correctAnswer: 2, section: 2 }, // 3-DOĞRU
                { folder: 'Oruntuler/3-DORTLU KARE FORMAT/6', correctAnswer: 3, section: 2 }, // 4-DOĞRU
                
                // BÖLÜM 3 - Altılı Kare Format (3 soru)
                { folder: 'Oruntuler/4-ALTILI KARE FORMAT/1', correctAnswer: 5, section: 3 }, // 6-DOGRU
                { folder: 'Oruntuler/4-ALTILI KARE FORMAT/2', correctAnswer: 0, section: 3 }, // 1-DOGRU
                { folder: 'Oruntuler/4-ALTILI KARE FORMAT/3', correctAnswer: 2, section: 3 }, // 3-DOGRU
                
                // BÖLÜM 4 - L Format (3 soru)
                // Not: Görsel dosyalar henüz yok, placeholder olarak kullanılacak
                { folder: 'Oruntuler/5- L FORMAT/1', correctAnswer: 4, section: 4 }, // 5-DOGRU
                { folder: 'Oruntuler/5- L FORMAT/2', correctAnswer: 2, section: 4 }, // 3-DOGRU
                { folder: 'Oruntuler/5- L FORMAT/3', correctAnswer: 2, section: 4 }, // 3-DOGRU
                
                // BÖLÜM 5 - Dokuzlu Format (3 soru)
                { folder: 'Oruntuler/6-DOKUZLU FORMAT/1', correctAnswer: 2, section: 5 }, // 3-DOGRU
                { folder: 'Oruntuler/6-DOKUZLU FORMAT/2', correctAnswer: 3, section: 5 }, // 4-DOGRU
                { folder: 'Oruntuler/6-DOKUZLU FORMAT/3', correctAnswer: 0, section: 5 }  // 1-DOGRU
            ],
            
            // Bölüm adları
            sectionNames: {
                1: "Dörtlü Yatay Format",
                2: "Dörtlü Kare Format", 
                3: "Altılı Kare Format",
                4: "L Format",
                5: "Dokuzlu Format"
            },
            
            // Ses dosyaları (şimdilik placeholder)
            audioFiles: {
                welcome: 'akil_mantik_giris.mp3',
                exampleDemo: 'akil_mantik_ornek_gosterim.mp3',
                exampleIntro: 'akil_mantik_ornek_gecis.mp3',
                exampleReady: 'akil_mantik_ornek_hazir.mp3',
                exampleComplete: 'akil_mantik_ornek_bitis.mp3',
                mainTestIntro: 'akil_mantik_test_giris.mp3',
                testComplete: 'akil_mantik_test_bitis.mp3'
            }
        };

        // ==================== DURUM YÖNETİMİ ====================
        let testState = {
            currentScreen: 'title',
            currentAudio: null,
            currentExampleIndex: 0,
            exampleAttempts: 0,
            exampleCorrectCount: 0,
            currentQuestionIndex: 0,
            testStartTime: null,
            questionStartTime: null,
            sectionStartTimes: {},
            totalTimeLimit: 300, // 5 dakika
            remainingTime: 300,
            timerInterval: null,
            answers: [],
            sectionResults: {
                1: { 
                    name: "Dörtlü Yatay Format",
                    correct: 0, 
                    total: 8, 
                    time: 0,
                    accuracy_percentage: 0,
                    avg_response_time_per_question: 0,
                    responses: []
                },
                2: { 
                    name: "Dörtlü Kare Format",
                    correct: 0, 
                    total: 6, 
                    time: 0,
                    accuracy_percentage: 0,
                    avg_response_time_per_question: 0,
                    responses: []
                },
                3: { 
                    name: "Altılı Kare Format",
                    correct: 0, 
                    total: 3, 
                    time: 0,
                    accuracy_percentage: 0,
                    avg_response_time_per_question: 0,
                    responses: []
                },
                4: { 
                    name: "L Format",
                    correct: 0, 
                    total: 3, 
                    time: 0,
                    accuracy_percentage: 0,
                    avg_response_time_per_question: 0,
                    responses: []
                },
                5: { 
                    name: "Dokuzlu Format",
                    correct: 0, 
                    total: 3, 
                    time: 0,
                    accuracy_percentage: 0,
                    avg_response_time_per_question: 0,
                    responses: []
                }
            },
            locked: false,
            isTransitioning: false
        };

        // Debouncing utility - çift tıklama önleme
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        // State lock/unlock fonksiyonları
        function lockState() {
            testState.locked = true;
        }

        function unlockState() {
            testState.locked = false;
        }

        function safeLock() {
            if (testState.locked) {
                console.warn('State already locked, ignoring operation');
                return false;
            }
            lockState();
            return true;
        }

        // ==================== SES YÖNETİMİ ====================
        function playAudio(filename, callback) {
            // Önceki sesi tamamen durdur ve temizle
            if (testState.currentAudio) {
                testState.currentAudio.pause();
                testState.currentAudio.currentTime = 0;
                testState.currentAudio.onended = null;
                testState.currentAudio.onerror = null;
                testState.currentAudio = null;
            }
            
            const audio = new Audio(`mp3/${filename}`);
            testState.currentAudio = audio;
            
            audio.addEventListener('ended', () => {
                testState.currentAudio = null;
                if (callback) callback();
            });
            
            audio.addEventListener('error', (e) => {
                testState.currentAudio = null;
                if (callback) callback();
            });
            
            audio.play().catch(error => {
                testState.currentAudio = null;
                if (callback) callback();
            });
        }

        function stopCurrentAudio() {
            if (testState.currentAudio) {
                testState.currentAudio.pause();
                testState.currentAudio.currentTime = 0;
                testState.currentAudio.onended = null;
                testState.currentAudio.onerror = null;
                testState.currentAudio = null;
            }
        }

        // ==================== EKRAN YÖNETİMİ ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            testState.currentScreen = screenId;
        }

        function showButton(buttonId) {
            setTimeout(() => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.classList.add('visible');
                }
            }, 100);
        }

        // ==================== GİRİŞ EKRANLARI ====================
        function goToWelcome() {
            stopCurrentAudio(); // Önceki sesi durdur
            
            // 🧹 DEEP CLEANUP - Önceki testlerden kalan verileri temizle
            performDeepCleanup();
            
            // 🧹 ADDITIONAL MEMORY CLEANUP - Önceki testlerden kalan verileri temizle
            try {
                // Global değişkenleri temizle
                if (window.testState) delete window.testState;
                if (window.testData) delete window.testData;
                if (window.currentTest) delete window.currentTest;
                
                // Event listener'ları temizle
                const allElements = document.querySelectorAll('*');
                allElements.forEach(el => {
                    if (el.cloneNode) {
                        const newEl = el.cloneNode(true);
                        if (el.parentNode) {
                            el.parentNode.replaceChild(newEl, el);
                        }
                    }
                });
                
                // Garbage collection'a yardım et
                if (window.gc) window.gc();
                
                console.log('🧹 Memory cleanup tamamlandı');
            } catch (e) {
                console.warn('Memory cleanup kısmen başarısız:', e);
            }
            
            showScreen('welcomeScreen');
            
            // 🖼️ GÖRSEL ÖN YÜKLEME BAŞLAT (flash engelleme: min görünürlük 600ms, gösterim 300ms gecikmeli)
            showLoading('Görseller yükleniyor...', 600);
            preloadAllImages().then((results) => {
                const successful = results.filter(r => r.status === 'fulfilled').length;
                const failed = results.filter(r => r.status === 'rejected').length;
                
                console.log(`🖼️ Görsel yükleme tamamlandı: ✅${successful} başarılı, ❌${failed} başarısız`);
                
                if (failed > 0) {
                    console.warn('⚠️ Görsel yükleme uyarısı: Bazı görseller yüklenemedi');
                    const failedImages = results
                        .filter(r => r.status === 'rejected')
                        .map(r => r.reason?.message || 'Bilinmeyen hata');
                    console.log('❌ Başarısız görseller:', failedImages);
                }
                
                hideLoading();
                playAudio(testData.audioFiles.welcome, () => {
                    showButton('welcomeNextBtn');
                });
            }).catch(error => {
                console.error('❌ Kritik görsel yükleme hatası:', error);
                hideLoading();
                showError('Görseller yüklenirken bir sorun oluştu. Test devam edecek.', 3000);
                playAudio(testData.audioFiles.welcome, () => {
                    showButton('welcomeNextBtn');
                });
            });
        }

        function goToExampleDemo() {
            stopCurrentAudio(); // Önceki sesi durdur
            showScreen('exampleDemoScreen');
            
            // Ses çalarken örneği göster
            playAudio(testData.audioFiles.exampleDemo);
            
            // Hemen örnek gösterimini başlat
            setTimeout(showProgramDemo, 500);
        }

        // Program örnek gösterimi - GÜÇLENDIRILMIŞ GÖRSEL YÜKLEME
        function showProgramDemo() {
            const demoArea = document.getElementById('demoArea');
            
            const example = testData.examples[0];
            const basePath = `/cognitive-tests/akil-mantik/${example.folder}`;
            
            // Soru görselini kontrollü yükle
            const questionImgSrc = `${basePath}/soru.png`;
            
            // Preloaded görseli kullan veya fallback
            let questionImgElement = '';
            if (preloadedImages.has(questionImgSrc)) {
                questionImgElement = `<img class="question-image" src="${questionImgSrc}" alt="Örnek soru">`;
            } else {
                questionImgElement = `<img class="question-image" src="${questionImgSrc}" alt="Örnek soru" 
                    onerror="console.error('Demo soru görseli yüklenemedi: ${questionImgSrc}'); this.style.background='#f0f0f0'; this.style.border='2px dashed #ccc'; this.alt='Görsel yüklenemedi';">`;
            }
            
            // Soru ve seçenekleri göster
            demoArea.innerHTML = `
                <div class="question-display">
                    ${questionImgElement}
                </div>
                <div class="options-container" id="demoOptions">
                    ${generateOptionsWithPreload(basePath, 'demo')}
                </div>
            `;
            
            // 2 saniye sonra mouse animasyonunu başlat
            setTimeout(() => {
                const pointer = document.getElementById('demoPointer');
                const clickEffect = document.getElementById('clickEffect');
                const correctOption = document.querySelectorAll('#demoOptions .option')[example.correctAnswer];
                
                if (correctOption) {
                    const rect = correctOption.getBoundingClientRect();
                    const targetX = rect.left + rect.width / 2;
                    const targetY = rect.top + rect.height / 2;
                    
                    // Mouse'u sağ üstten başlat (daha doğal görünüm için)
                    pointer.style.left = (window.innerWidth * 0.7) + 'px';
                    pointer.style.top = (window.innerHeight * 0.3) + 'px';
                    pointer.style.opacity = '1';
                    
                    // Mouse'u hedefe doğru hareket ettir
                    pointer.style.transition = 'left 1.5s ease-in-out, top 1.5s ease-in-out';
                    
                    setTimeout(() => {
                        pointer.style.left = (targetX - 10) + 'px'; // Mouse cursor SVG offset
                        pointer.style.top = (targetY - 10) + 'px';
                    }, 100);
                    
                    // 1.5 saniye sonra hover efekti ekle
                    setTimeout(() => {
                        correctOption.style.transition = 'all 0.3s ease';
                        correctOption.style.border = '3px solid #60a5fa';
                        correctOption.style.transform = 'scale(1.05)';
                        correctOption.style.boxShadow = '0 4px 15px rgba(59, 130, 246, 0.3)';
                    }, 1600);
                    
                    // 2 saniye sonra tıklama efekti ve seçim
                    setTimeout(() => {
                        // Tıklama efekti
                        clickEffect.style.left = (targetX - 15) + 'px';
                        clickEffect.style.top = (targetY - 15) + 'px';
                        clickEffect.classList.add('active');
                        
                        // Seçimi yap
                        correctOption.classList.add('correct');
                        
                        // Mouse'u gizle ve efektleri temizle
                        setTimeout(() => {
                            pointer.style.opacity = '0';
                            
                            // Click efektini ve pointer'ı temizle
                            setTimeout(() => {
                                clickEffect.classList.remove('active');
                                clickEffect.style.left = '';
                                clickEffect.style.top = '';
                                
                                // Pointer'ı sıfırla
                                pointer.style.transition = '';
                                pointer.style.left = '';
                                pointer.style.top = '';
                            }, 1000);
                            
                            // Demo bitince ileri butonunu göster
                            setTimeout(() => {
                                const demoBtn = document.getElementById('demoNextBtn');
                                demoBtn.style.display = 'block';
                                setTimeout(() => {
                                    demoBtn.classList.add('visible');
                                }, 100);
                            }, 1000);
                        }, 1000);
                    }, 2000);
                }
            }, 2000);
        }

        function goToExampleIntro() {
            stopCurrentAudio(); // Önceki sesi durdur
            
            // Demo butonunu gizle
            const demoBtn = document.getElementById('demoNextBtn');
            if (demoBtn) {
                demoBtn.style.display = 'none';
                demoBtn.classList.remove('visible');
            }
            
            // Demo ekranını temizle
            const demoOptions = document.querySelectorAll('#demoOptions .option');
            demoOptions.forEach(option => {
                option.style.transition = '';
                option.style.border = '';
                option.style.transform = '';
                option.style.boxShadow = '';
            });
            
            showScreen('exampleIntroScreen');
            playAudio(testData.audioFiles.exampleIntro, () => {
                showButton('exampleIntroNextBtn');
            });
        }

        function goToExampleReady() {
            stopCurrentAudio(); // Önceki sesi durdur
            showScreen('exampleReadyScreen');
            playAudio(testData.audioFiles.exampleReady, () => {
                showButton('exampleReadyBtn');
            });
        }

        // ==================== GERİ SAYIM EKRANLARI ====================
        function showExampleCountdown() {
            if (testState.isTransitioning) {
                console.warn('Countdown ignored - already transitioning');
                return;
            }
            testState.isTransitioning = true;
            
            stopCurrentAudio();
            showScreen('exampleCountdownScreen');
            
            const numberEl = document.getElementById('exampleCountdownNumber');
            if (!numberEl) {
                startExampleSection();
                return;
            }
            
            let count = 3;
            numberEl.textContent = count;
            
            const countdownInterval = setInterval(() => {
                count--;
                
                if (count > 0) {
                    numberEl.textContent = count;
                } else {
                    clearInterval(countdownInterval);
                    testState.isTransitioning = false;
                    startExampleSection();
                }
            }, 1000);
        }

        function showMainCountdown() {
            if (testState.isTransitioning) {
                console.warn('Main countdown ignored - already transitioning');
                return;
            }
            testState.isTransitioning = true;
            
            stopCurrentAudio();
            showScreen('mainCountdownScreen');
            
            const numberEl = document.getElementById('mainCountdownNumber');
            if (!numberEl) {
                startMainTest();
                return;
            }
            
            let count = 3;
            numberEl.textContent = count;
            
            const countdownInterval = setInterval(() => {
                count--;
                
                if (count > 0) {
                    numberEl.textContent = count;
                } else {
                    clearInterval(countdownInterval);
                    testState.isTransitioning = false;
                    startMainTest();
                }
            }, 1000);
        }

        // ==================== ÖRNEK BÖLÜMÜ ====================
        function startExampleSection() {
            stopCurrentAudio(); // Önceki sesi durdur
            testState.currentExampleIndex = 1; // İlk soru program tarafından gösterildi
            testState.exampleCorrectCount = 0;
            showExampleQuestion();
        }

        function showExampleQuestion() {
            if (testState.currentExampleIndex >= 4) { // 2, 3, 4. sorular = 3 soru
                evaluateExampleResults();
                return;
            }
            
            showScreen('exampleScreen');
            
            const example = testData.examples[testState.currentExampleIndex];
            const basePath = `/cognitive-tests/akil-mantik/${example.folder}`;
            
            // Soru görselini güvenli yükle
            const questionImgSrc = `${basePath}/soru.png`;
            const questionImg = document.getElementById('exampleQuestionImg');
            
            if (preloadedImages.has(questionImgSrc)) {
                questionImg.src = questionImgSrc;
            } else {
                questionImg.src = questionImgSrc;
                questionImg.onerror = function() {
                    console.error(`❌ Örnek soru görseli yüklenemedi: ${questionImgSrc}`);
                    this.style.background = '#f0f0f0';
                    this.style.border = '2px dashed #ccc';
                    this.alt = 'Görsel yüklenemedi';
                };
            }
            
            // Seçenekleri preload ile göster
            document.getElementById('exampleOptions').innerHTML = 
                generateOptionsWithPreload(basePath, 'example');
            
            // Debounced event listener'ları ekle
            const options = document.querySelectorAll('#exampleOptions .option');
            options.forEach(option => {
                const optionIndex = parseInt(option.dataset.optionIndex);
                const optionType = option.dataset.optionType;
                
                const debouncedHandler = debounce((e) => {
                    selectAnswer(optionType, optionIndex);
                }, 300);
                
                option.addEventListener('click', debouncedHandler);
                option.style.pointerEvents = 'auto';
                option.classList.remove('disabled');
            });
            
            testState.questionStartTime = Date.now();
        }

        function generateOptions(basePath, type) {
            let html = '';
            const letters = ['A', 'B', 'C', 'D', 'E'];
            
            // 5 seçenek için
            for (let i = 1; i <= 5; i++) {
                const imgSrc = `${basePath}/${i}.png`;
                html += `
                    <div class="option" data-option-index="${i-1}" data-option-type="${type}">
                        <div class="option-label">${letters[i-1]}</div>
                        <img src="${imgSrc}" alt="Seçenek ${i}" 
                             onerror="console.error('Seçenek görseli yüklenemedi: ${imgSrc}'); this.style.background='#f0f0f0'; this.style.border='2px dashed #ccc'; this.alt='Görsel yüklenemedi';">
                    </div>
                `;
            }
            
            return html;
        }

        function generateOptionsWithPreload(basePath, type) {
            let html = '';
            const letters = ['A', 'B', 'C', 'D', 'E'];
            
            // 5 seçenek için
            for (let i = 1; i <= 5; i++) {
                const imgSrc = `${basePath}/${i}.png`;
                
                // Preloaded görsel kontrolü
                let imgElement = '';
                if (preloadedImages.has(imgSrc)) {
                    imgElement = `<img src="${imgSrc}" alt="Seçenek ${i}">`;
                } else {
                    imgElement = `<img src="${imgSrc}" alt="Seçenek ${i}" 
                        onerror="console.error('Seçenek görseli yüklenemedi: ${imgSrc}'); this.style.background='#f0f0f0'; this.style.border='2px dashed #ccc'; this.alt='Görsel yüklenemedi';">`;
                }
                
                html += `
                    <div class="option" data-option-index="${i-1}" data-option-type="${type}">
                        <div class="option-label">${letters[i-1]}</div>
                        ${imgElement}
                    </div>
                `;
            }
            
            return html;
        }

        function selectAnswer(type, selectedIndex) {
            // Çift tıklama önleme - state locked ise işlemi reddet
            if (!safeLock()) {
                console.warn('Answer selection ignored - state locked');
                return;
            }

            try {
                const responseTime = (Date.now() - testState.questionStartTime) / 1000;
                
                if (type === 'example') {
                    const example = testData.examples[testState.currentExampleIndex];
                    const isCorrect = selectedIndex === example.correctAnswer;
                    
                    if (isCorrect) {
                        testState.exampleCorrectCount++;
                    }
                    
                    // Tüm seçenekleri disable et
                    const options = document.querySelectorAll('#exampleOptions .option');
                    options.forEach((option, index) => {
                        option.classList.add('disabled');
                        option.style.pointerEvents = 'none';
                        option.onclick = null;
                        // Event listener'ları temizle
                        option.replaceWith(option.cloneNode(true));
                        
                        if (index === selectedIndex) {
                            const newOption = document.querySelectorAll('#exampleOptions .option')[index];
                            newOption.classList.add('selected');
                        }
                    });
                    
                    setTimeout(() => {
                        unlockState();
                        testState.currentExampleIndex++;
                        showExampleQuestion();
                    }, 1000);
                    
                } else if (type === 'main') {
                    const question = testData.mainQuestions[testState.currentQuestionIndex];
                    const isCorrect = selectedIndex === question.correctAnswer;
                    
                    // Cevabı kaydet
                    testState.answers.push({
                        questionNo: testState.currentQuestionIndex + 1,
                        section: question.section,
                        selectedAnswer: selectedIndex,
                        correctAnswer: question.correctAnswer,
                        isCorrect: isCorrect,
                        responseTime: responseTime,
                        timestamp: Date.now()
                    });
                    
                    // Bölüm sonuçlarını güncelle
                    if (isCorrect) {
                        testState.sectionResults[question.section].correct++;
                    }
                    
                    // Bölüm tepki sürelerini kaydet
                    testState.sectionResults[question.section].responses.push(responseTime);
                    
                    // Soru detayını logla
                    const sectionName = testState.sectionResults[question.section].name;
                    logQuestionDetails(
                        testState.currentQuestionIndex + 1,
                        question.section,
                        sectionName,
                        responseTime,
                        isCorrect,
                        selectedIndex,
                        question.correctAnswer
                    );
                    
                    // Tüm seçenekleri disable et
                    const options = document.querySelectorAll('#mainOptions .option');
                    options.forEach((option, index) => {
                        option.classList.add('disabled');
                        option.style.pointerEvents = 'none';
                        option.onclick = null;
                        // Event listener'ları temizle
                        option.replaceWith(option.cloneNode(true));
                        
                        if (index === selectedIndex) {
                            const newOption = document.querySelectorAll('#mainOptions .option')[index];
                            newOption.classList.add('selected');
                        }
                    });
                    
                    setTimeout(() => {
                        unlockState();
                        testState.currentQuestionIndex++;
                        showMainQuestion();
                    }, 1000);
                }
            } catch (e) {
                console.error('Select answer error:', e);
                unlockState(); // Hata durumunda unlock et
                handleError(`Cevap seçimi hatası: ${e.message}`, false);
            }
        }

        function evaluateExampleResults() {
            // Örnek test sonucu logu
            console.log(`\n📝 ================= ÖRNEK TEST SONUCU =================`);
            console.log(`🎯 Doğru: ${testState.exampleCorrectCount}/3`);
            console.log(`📊 Durum: ${testState.exampleCorrectCount >= 2 ? '✅ BAŞARILI' : '❌ BAŞARISIZ'}`);
            console.log(`🔄 Deneme: ${testState.exampleAttempts + 1}`);
            console.log(`➡️ Sonuç: ${testState.exampleCorrectCount >= 2 ? '🚀 Ana teste geçiliyor' : '🔄 Örnek test tekrarlanacak'}`);
            
            if (testState.exampleCorrectCount >= 2) { // 3 sorudan 2 doğru
                stopCurrentAudio(); // Önceki sesi durdur
                showScreen('exampleCompleteScreen');
                playAudio(testData.audioFiles.exampleComplete, () => {
                    showButton('exampleCompleteBtn');
                });
            } else {
                testState.exampleAttempts++;
                showScreen('exampleFailScreen');
            }
        }

        function goToMainTestIntro() {
            stopCurrentAudio(); // Önceki sesi durdur
            showScreen('mainTestIntroScreen');
            playAudio(testData.audioFiles.mainTestIntro, () => {
                showButton('mainTestStartBtn');
            });
        }

        // ==================== ANA TEST ====================
        function startMainTest() {
            stopCurrentAudio(); // Önceki sesi durdur
            testState.currentQuestionIndex = 0;
            testState.testStartTime = Date.now();
            testState.sectionStartTimes[1] = Date.now();
            testState.answers = [];
            
            // Test başlangıç logu
            console.log(`\n🚀 ================= AKIL MANTIK TESTİ BAŞLADI =================`);
            console.log(`📅 Başlangıç: ${new Date(testState.testStartTime).toLocaleString('tr-TR')}`);
            console.log(`📊 Toplam Soru: ${testData.mainQuestions.length}`);
            console.log(`⏰ Süre Limiti: 5 dakika (300 saniye)`);
            console.log(`📋 Bölüm Yapısı:`);
            console.log(`   1️⃣ Dörtlü Yatay Format: 8 soru`);
            console.log(`   2️⃣ Dörtlü Kare Format: 6 soru`);
            console.log(`   3️⃣ Altılı Kare Format: 3 soru`);
            console.log(`   4️⃣ L Format: 3 soru`);
            console.log(`   5️⃣ Dokuzlu Format: 3 soru`);
            
            // Progress bar'ı sıfırla ve timer'ı başlat
            const progressBar = document.getElementById('timeProgressFill');
            progressBar.classList.remove('animating');
            progressBar.style.width = '0%';
            
            // Bir sonraki frame'de animasyonu başlat (reflow için)
            requestAnimationFrame(() => {
                startTestTimer();
            });
            
            showMainQuestion();
        }

        function showMainQuestion() {
            if (testState.currentQuestionIndex >= testData.mainQuestions.length) {
                endTest();
                return;
            }
            
            showScreen('mainTestScreen');
            
            const question = testData.mainQuestions[testState.currentQuestionIndex];
            const currentSection = question.section;
            
            // Yeni bölüme geçiş kontrolü
            const prevQuestion = testState.currentQuestionIndex > 0 ? 
                testData.mainQuestions[testState.currentQuestionIndex - 1] : null;
            
            if (prevQuestion && prevQuestion.section !== currentSection) {
                // Önceki bölümün süresini kaydet
                testState.sectionResults[prevQuestion.section].time = 
                    (Date.now() - testState.sectionStartTimes[prevQuestion.section]) / 1000;
                
                // Bölüm geçiş logu
                console.log(`\n🔄 ================= BÖLÜM GEÇİŞİ =================`);
                console.log(`✅ Tamamlanan: Bölüm ${prevQuestion.section} - ${testState.sectionResults[prevQuestion.section].name}`);
                console.log(`⏱️ Süre: ${testState.sectionResults[prevQuestion.section].time.toFixed(2)} saniye`);
                console.log(`➡️ Yeni Bölüm: Bölüm ${currentSection} - ${testState.sectionResults[currentSection].name}`);
                
                // Yeni bölümün başlangıç zamanını kaydet
                testState.sectionStartTimes[currentSection] = Date.now();
            }
            
            // Progress bar artık otomatik animasyonla ilerliyor
            
            const basePath = `/cognitive-tests/akil-mantik/${question.folder}`;
            
            // Soru görselini güvenli yükle
            const questionImgSrc = `${basePath}/soru.png`;
            const mainQuestionImg = document.getElementById('mainQuestionImg');
            
            if (preloadedImages.has(questionImgSrc)) {
                mainQuestionImg.src = questionImgSrc;
            } else {
                mainQuestionImg.src = questionImgSrc;
                mainQuestionImg.onerror = function() {
                    console.error(`❌ Ana test görseli yüklenemedi: ${questionImgSrc}`);
                    this.style.background = '#f0f0f0';
                    this.style.border = '2px dashed #ccc';
                    this.alt = 'Görsel yüklenemedi';
                    // Fallback placeholder dene
                    this.src = './placeholder-pattern.png';
                };
            }
            
            // Seçenekleri preload ile göster
            document.getElementById('mainOptions').innerHTML = 
                generateMainOptionsWithPreload(basePath);
            
            // Debounced event listener'ları ekle
            const options = document.querySelectorAll('#mainOptions .option');
            options.forEach(option => {
                const optionIndex = parseInt(option.dataset.optionIndex);
                const optionType = option.dataset.optionType;
                
                const debouncedHandler = debounce((e) => {
                    selectAnswer(optionType, optionIndex);
                }, 300);
                
                option.addEventListener('click', debouncedHandler);
                option.style.pointerEvents = 'auto';
                option.classList.remove('disabled');
            });
            
            testState.questionStartTime = Date.now();
        }

        function generateMainOptions(basePath) {
            let html = '';
            const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
            
            // 4-ALTILI KARE FORMAT klasörleri 6 seçenekli
            const is6Option = basePath.includes('4-ALTILI KARE FORMAT');
            const optionCount = is6Option ? 6 : 5;
            
            for (let i = 1; i <= optionCount; i++) {
                const imgSrc = `${basePath}/${i}.png`;
                html += `
                    <div class="option" data-option-index="${i-1}" data-option-type="main">
                        <div class="option-label">${letters[i-1]}</div>
                        <img src="${imgSrc}" 
                             alt="Seçenek ${i}"
                             onerror="console.error('Görsel yüklenemedi: ${imgSrc}'); this.style.background='#f0f0f0'; this.style.border='2px dashed #ccc';">
                    </div>
                `;
            }
            
            return html;
        }

        function generateMainOptionsWithPreload(basePath) {
            let html = '';
            const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
            
            // 4-ALTILI KARE FORMAT klasörleri 6 seçenekli
            const is6Option = basePath.includes('4-ALTILI KARE FORMAT');
            const optionCount = is6Option ? 6 : 5;
            
            for (let i = 1; i <= optionCount; i++) {
                const imgSrc = `${basePath}/${i}.png`;
                
                // Preloaded görsel kontrolü
                let imgElement = '';
                if (preloadedImages.has(imgSrc)) {
                    imgElement = `<img src="${imgSrc}" alt="Seçenek ${i}">`;
                } else {
                    imgElement = `<img src="${imgSrc}" alt="Seçenek ${i}" 
                        onerror="console.error('Ana test seçenek görseli yüklenemedi: ${imgSrc}'); this.style.background='#f0f0f0'; this.style.border='2px dashed #ccc'; this.alt='Görsel yüklenemedi';">`;
                }
                
                html += `
                    <div class="option" data-option-index="${i-1}" data-option-type="main">
                        <div class="option-label">${letters[i-1]}</div>
                        ${imgElement}
                    </div>
                `;
            }
            
            return html;
        }

        function updateProgressBar() {
            // Bu fonksiyon artık kullanılmıyor - progress bar otomatik animasyonla ilerliyor
        }

        // Timer fonksiyonları
        function startTestTimer() {
            // Progress bar animasyonunu başlat
            const progressBar = document.getElementById('timeProgressFill');
            progressBar.classList.add('animating');
            
            // 5 dakika sonra testi bitir
            testState.timerInterval = setTimeout(() => {
                endTest();
            }, 300000); // 5 dakika = 300000 ms
        }

        // ==================== LOGLAMA SİSTEMİ (PUZZLE STİLİ) ====================
        function logQuestionDetails(questionNo, section, sectionName, responseTime, isCorrect, selectedAnswer, correctAnswer) {
            const speedCategory = responseTime < 1 ? 'ÇOK HIZLI' : responseTime < 2 ? 'HIZLI' : responseTime < 5 ? 'NORMAL' : 'YAVAŞ';
            const statusEmoji = isCorrect ? '✅' : '❌';
            
            console.log(`\n🧠 ================= SORU ${questionNo} CEVAPLANDI =================`);
            console.log(`📝 Bölüm: ${section} - ${sectionName}`);
            console.log(`${statusEmoji} Sonuç: ${isCorrect ? 'DOĞRU' : 'YANLIŞ'}`);
            console.log(`⏱️ Tepki Süresi: ${responseTime.toFixed(3)} saniye (${speedCategory})`);
            console.log(`🎯 Seçilen: ${selectedAnswer} | Doğru: ${correctAnswer}`);
        }

        function logSectionSummary(sectionId, sectionData) {
            const wrongCount = sectionData.total - sectionData.correct;
            
            console.log(`\n📊 ================= BÖLÜM ${sectionId} ÖZET =================`);
            console.log(`📋 Bölüm Adı: ${sectionData.name}`);
            console.log(`🎯 Doğruluk: ${sectionData.correct}/${sectionData.total} = %${sectionData.accuracy_percentage}`);
            console.log(`❌ Yanlış: ${wrongCount} soru`);
            console.log(`⏱️ Bölüm Süresi: ${sectionData.time.toFixed(2)} saniye`);
            console.log(`📈 Ortalama Tepki: ${sectionData.avg_response_time_per_question.toFixed(2)} saniye/soru`);
            
            if (sectionData.responses.length > 0) {
                const minTime = Math.min(...sectionData.responses);
                const maxTime = Math.max(...sectionData.responses);
                console.log(`   🚀 En Hızlı: ${minTime.toFixed(2)}s | 🐌 En Yavaş: ${maxTime.toFixed(2)}s`);
            }
        }

        function logDetailedStatistics(stats) {
            console.log(`\n📈 ================= İSTATİSTİKSEL ANALİZ =================`);
            console.log(`📊 GENEL İSTATİSTİKLER:`);
            console.log(`   📝 Toplam Yanıt: ${stats.total_responses}`);
            console.log(`   🚀 En Hızlı: ${stats.fastest_response.toFixed(3)}s`);
            console.log(`   🐌 En Yavaş: ${stats.slowest_response.toFixed(3)}s`);
            console.log(`   📊 Medyan: ${stats.median_response_time.toFixed(3)}s`);
            
            console.log(`\n✅ DOĞRU CEVAP İSTATİSTİKLERİ:`);
            console.log(`   📊 Sayı: ${stats.correct_count}`);
            console.log(`   🚀 En Hızlı Doğru: ${stats.fastest_correct_response.toFixed(3)}s`);
            console.log(`   🐌 En Yavaş Doğru: ${stats.slowest_correct_response.toFixed(3)}s`);
            console.log(`   📈 Ortalama Doğru: ${stats.avg_correct_response_time.toFixed(3)}s`);
            
            console.log(`\n❌ YANLIŞ CEVAP İSTATİSTİKLERİ:`);
            console.log(`   📊 Sayı: ${stats.wrong_count}`);
            if (stats.wrong_count > 0) {
                console.log(`   🚀 En Hızlı Yanlış: ${stats.fastest_wrong_response.toFixed(3)}s`);
                console.log(`   🐌 En Yavaş Yanlış: ${stats.slowest_wrong_response.toFixed(3)}s`);
                console.log(`   📈 Ortalama Yanlış: ${stats.avg_wrong_response_time.toFixed(3)}s`);
            }
            
            console.log(`\n📋 HAM VERİ:`);
            console.log(`   ✅ Denenen: ${stats.questions_attempted} soru`);
            console.log(`   ⏭️ Atlanan: ${stats.questions_skipped} soru`);
        }

        function logImpulsivityAnalysis(analysis) {
            console.log(`\n⚠️ ================= DÜRTÜSELLIK ANALİZİ =================`);
            console.log(`🚨 Hızlı Yanlış Cevaplar (>2sn): ${analysis.fast_wrong_answers}`);
            console.log(`🔥 Çok Hızlı Yanlış Cevaplar (>1sn): ${analysis.very_fast_wrong_answers}`);
            console.log(`📊 Dürtüsellik Skoru: %${analysis.impulsivity_score}`);
            console.log(`⚠️ Normal Uyarı: ${analysis.warning_triggered ? '🔴 AKTİF' : '🟢 KAPALI'}`);
            console.log(`🚨 Ciddi Uyarı: ${analysis.severe_warning ? '🔴 AKTİF' : '🟢 KAPALI'}`);
            
            if (analysis.fast_wrong_details.length > 0) {
                console.log(`\n🔍 Hızlı Yanlış Cevap Detayları:`);
                analysis.fast_wrong_details.forEach(detail => {
                    console.log(`   📝 Soru ${detail.questionNo} (Bölüm ${detail.section}): ${detail.responseTime.toFixed(3)}s - Seçilen: ${detail.selectedAnswer}, Doğru: ${detail.correctAnswer}`);
                });
            }
        }

        function logFinalResults(results) {
            console.log(`\n🎯 ================= FINAL SONUÇLAR =================`);
            console.log(`📋 Test Türü: Akıl ve Mantık Testi`);
            console.log(`⏱️ Toplam Süre: ${results.totalTime} saniye (${(results.totalTime/60).toFixed(1)} dakika)`);
            console.log(`📊 Sorular: ${results.answeredQuestions}/${results.totalQuestions} yanıtlandı`);
            console.log(`✅ Doğru: ${results.correctAnswers} | ❌ Yanlış: ${results.wrongAnswers} | ⏭️ Atlandı: ${results.unansweredQuestions}`);
            console.log(`📈 Başarı Oranı: %${results.successRate}`);
            console.log(`🚀 Hız Skoru: %${results.speedScore}`);
            console.log(`⏱️ Ortalama Tepki: ${results.avgResponseTime.toFixed(3)} saniye`);
            console.log(`📊 Örnek Test: ${results.exampleCorrectCount}/3 doğru (${results.exampleAttempts} deneme)`);
            console.log(`🏁 Son Soru: ${results.lastQuestionReached}/23`);
        }

        // ==================== İSTATİSTİKSEL ANALİZ FONKSİYONLARI ====================
        function calculateSectionStatistics() {
            // Her bölüm için istatistikleri hesapla
            for (let sectionId = 1; sectionId <= 5; sectionId++) {
                const section = testState.sectionResults[sectionId];
                
                // Doğruluk yüzdesi
                section.accuracy_percentage = section.total > 0 ? 
                    Math.round((section.correct / section.total) * 100) : 0;
                
                // Ortalama tepki süresi (bu bölümdeki sorular için)
                if (section.responses.length > 0) {
                    const totalResponseTime = section.responses.reduce((sum, time) => sum + time, 0);
                    section.avg_response_time_per_question = totalResponseTime / section.responses.length;
                } else {
                    section.avg_response_time_per_question = 0;
                }
            }
        }

        function calculateDetailedStatistics() {
            const allResponses = testState.answers.map(a => a.responseTime);
            const correctResponses = testState.answers.filter(a => a.isCorrect).map(a => a.responseTime);
            const wrongResponses = testState.answers.filter(a => !a.isCorrect).map(a => a.responseTime);
            
            return {
                // Genel istatistikler
                total_responses: allResponses.length,
                fastest_response: allResponses.length > 0 ? Math.min(...allResponses) : 0,
                slowest_response: allResponses.length > 0 ? Math.max(...allResponses) : 0,
                median_response_time: calculateMedian(allResponses),
                
                // Doğru cevap istatistikleri
                fastest_correct_response: correctResponses.length > 0 ? Math.min(...correctResponses) : 0,
                slowest_correct_response: correctResponses.length > 0 ? Math.max(...correctResponses) : 0,
                avg_correct_response_time: correctResponses.length > 0 ? 
                    correctResponses.reduce((sum, time) => sum + time, 0) / correctResponses.length : 0,
                
                // Yanlış cevap istatistikleri
                fastest_wrong_response: wrongResponses.length > 0 ? Math.min(...wrongResponses) : 0,
                slowest_wrong_response: wrongResponses.length > 0 ? Math.max(...wrongResponses) : 0,
                avg_wrong_response_time: wrongResponses.length > 0 ? 
                    wrongResponses.reduce((sum, time) => sum + time, 0) / wrongResponses.length : 0,
                
                // Ham veri
                questions_attempted: testState.answers.length,
                questions_skipped: 23 - testState.answers.length,
                correct_count: correctResponses.length,
                wrong_count: wrongResponses.length
            };
        }

        function calculateMedian(numbers) {
            if (numbers.length === 0) return 0;
            const sorted = [...numbers].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        function calculateImpulsivityAnalysis() {
            const fastWrongAnswers = testState.answers.filter(a => !a.isCorrect && a.responseTime < 2);
            const fastThreshold = 2; // saniye
            const veryFastThreshold = 1; // saniye
            
            const veryFastWrongAnswers = testState.answers.filter(a => !a.isCorrect && a.responseTime < veryFastThreshold);
            const totalAnswers = testState.answers.length;
            
            return {
                fast_wrong_answers: fastWrongAnswers.length,
                very_fast_wrong_answers: veryFastWrongAnswers.length,
                fast_response_threshold: fastThreshold,
                very_fast_response_threshold: veryFastThreshold,
                impulsivity_score: totalAnswers > 0 ? Math.round((fastWrongAnswers.length / totalAnswers) * 100) : 0,
                warning_triggered: fastWrongAnswers.length > 3,
                severe_warning: veryFastWrongAnswers.length > 2,
                fast_wrong_details: fastWrongAnswers.map(a => ({
                    questionNo: a.questionNo,
                    section: a.section,
                    responseTime: a.responseTime,
                    selectedAnswer: a.selectedAnswer,
                    correctAnswer: a.correctAnswer
                }))
            };
        }

        // ==================== TEST SONU VE RAPORLAMA ====================
        function endTest() {
            stopCurrentAudio(); // Test bitince önceki sesi durdur
            
            // State'i temizle
            unlockState();
            testState.isTransitioning = false;
            
            if (testState.timerInterval) {
                clearTimeout(testState.timerInterval);
            }
            
            const endTime = Date.now();
            const totalTime = Math.round((endTime - testState.testStartTime) / 1000);
            
            // Son bölümün süresini kaydet
            const lastQuestion = testData.mainQuestions[testState.currentQuestionIndex - 1];
            if (lastQuestion) {
                testState.sectionResults[lastQuestion.section].time = 
                    (endTime - testState.sectionStartTimes[lastQuestion.section]) / 1000;
            }
            
            // Bölüm istatistiklerini hesapla
            calculateSectionStatistics();
            
            // Hesaplamalar
            const totalQuestions = 23;
            const answeredQuestions = testState.answers.length;
            const correctAnswers = testState.answers.filter(a => a.isCorrect).length;
            const wrongAnswers = answeredQuestions - correctAnswers;
            const unansweredQuestions = totalQuestions - answeredQuestions;
            const successRate = answeredQuestions > 0 ? 
                Math.round((correctAnswers / answeredQuestions) * 100) : 0;
            
            // İşlem hızı hesaplama
            const totalResponseTime = testState.answers.reduce((sum, answer) => sum + answer.responseTime, 0);
            const avgResponseTime = answeredQuestions > 0 ? totalResponseTime / answeredQuestions : 0;
            const speedScore = Math.round(((300 - totalTime) / 300) * 100); // Max 5 dakika
            
            // Detaylı istatistikler
            const detailedStats = calculateDetailedStatistics();
            
            // Gelişmiş dürtüsellik analizi
            const impulsivityAnalysis = calculateImpulsivityAnalysis();
            
            // Test bitiş logu
            console.log(`\n🏁 ================= TEST BİTTİ =================`);
            console.log(`📅 Bitiş: ${new Date(endTime).toLocaleString('tr-TR')}`);
            console.log(`⏱️ Toplam Süre: ${totalTime} saniye (${(totalTime/60).toFixed(1)} dakika)`);
            console.log(`⏰ Kalan Süre: ${300 - totalTime} saniye`);
            console.log(`📝 Son Soru: ${testState.currentQuestionIndex}/23`);
            console.log(`🎯 Durum: ${testState.currentQuestionIndex >= 23 ? '✅ TAMAMLANDI' : '⏰ SÜRESİ BİTTİ'}`);
            
            // Her bölüm için özet logla
            for (let sectionId = 1; sectionId <= 5; sectionId++) {
                logSectionSummary(sectionId, testState.sectionResults[sectionId]);
            }
            
            // Detaylı istatistikleri logla
            logDetailedStatistics(detailedStats);
            
            // Dürtüsellik analizini logla
            logImpulsivityAnalysis(impulsivityAnalysis);
            
            // Final sonuçları logla
            logFinalResults({
                totalTime,
                totalQuestions,
                answeredQuestions,
                correctAnswers,
                wrongAnswers,
                unansweredQuestions,
                successRate,
                speedScore,
                avgResponseTime,
                totalResponseTime,
                exampleAttempts: testState.exampleAttempts,
                exampleCorrectCount: testState.exampleCorrectCount,
                lastQuestionReached: testState.currentQuestionIndex
            });
            
            // Sonuç ekranını göster
            showScreen('resultsScreen');
            
            // Test bitiş sesini çal (biraz gecikmeyle)
            setTimeout(() => {
                playAudio(testData.audioFiles.testComplete);
            }, 500);
            
            // Veritabanına kaydet
            saveTestResults({
                totalTime,
                totalQuestions,
                answeredQuestions,
                correctAnswers,
                wrongAnswers,
                unansweredQuestions,
                successRate,
                speedScore,
                avgResponseTime,
                totalResponseTime,
                sectionResults: testState.sectionResults,
                detailedAnswers: testState.answers,
                exampleAttempts: testState.exampleAttempts,
                exampleCorrectCount: testState.exampleCorrectCount,
                impulsivityWarning: impulsivityAnalysis.warning_triggered, // Geriye uyumluluk için
                impulsivityAnalysis: impulsivityAnalysis,
                detailedStatistics: detailedStats,
                lastQuestionReached: testState.currentQuestionIndex
            });
        }

        // ==================== VERİTABANI KAYIT (Supabase) ====================
        async function saveTestResults(results) {
          try {
            console.log('\n💾 AKIL-MANTIK → Supabase kayıt başlıyor');

            let supabase = window.supabaseClient;
            if (!supabase) {
              const url = localStorage.getItem('sb-url');
              const key = localStorage.getItem('sb-anon-key');
              if (!url || !key || !window.supabase) {
                console.error('Supabase config/UMD eksik; sonuçlar pendingAkilMantik olarak saklanıyor');
                localStorage.setItem('pendingAkilMantik', JSON.stringify(results));
                showNotification('Oturum kapalı veya bağlantı yok. Sonuçlar geçici kaydedildi.', 'warning');
                return false;
              }
              supabase = window.supabase.createClient(url, key);
            }

            // 1) URL parametrelerini localStorage'a senkronize et (ilk yüklemede)
            try {
              const url = new URL(window.location.href);
              const qp = url.searchParams;
              const sessionIdQP = qp.get('session_id');
              const studentIdQP = qp.get('student_id');
              const conductedByQP = qp.get('conducted_by');
              const sbUrlQP = qp.get('sb_url');
              const sbAnonQP = qp.get('sb_anon');
              if (sessionIdQP) localStorage.setItem('bb-session-id', sessionIdQP);
              if (studentIdQP) localStorage.setItem('bb-student-id', studentIdQP);
              if (conductedByQP) localStorage.setItem('bb-conducted-by', conductedByQP);
              if (sbUrlQP) localStorage.setItem('sb-url', sbUrlQP);
              if (sbAnonQP) localStorage.setItem('sb-anon-key', sbAnonQP);
            } catch (e) { console.warn('Query sync failed:', e); }

            // localStorage bridge - session bilgilerini al
            console.log('🔍 AKIL-MANTIK: localStorage bridge kontrol...');
            const sessionId = localStorage.getItem('bb-session-id');
            const studentId = localStorage.getItem('bb-student-id');
            const conductedBy = localStorage.getItem('bb-conducted-by');
            
            console.log('📦 localStorage bridge bilgileri:', {
                sessionId: sessionId ? sessionId.slice(0, 8) + '...' : 'YOK',
                studentId: studentId ? studentId.slice(0, 8) + '...' : 'YOK',
                conductedBy: conductedBy ? conductedBy.slice(0, 8) + '...' : 'YOK'
            });
            
            if (!sessionId || !studentId || !conductedBy) {
                console.error('❌ AKIL-MANTIK HATA: localStorage bridge eksik');
                console.error('Eksik bilgiler:', {
                    sessionId: !sessionId,
                    studentId: !studentId,
                    conductedBy: !conductedBy
                });
                localStorage.setItem('pendingAkilMantik', JSON.stringify(results));
                showNotification('Session bilgileri eksik. Sonuçlar geçici kaydedildi.', 'warning');
                return false;
            }
            
            console.log('✅ AKIL-MANTIK: localStorage bridge aktif');
            console.log(`🆔 Session ID: ${sessionId.slice(0, 8)}...`);
            console.log(`👤 Student ID: ${studentId.slice(0, 8)}...`);
            console.log(`👨‍🏫 Conducted By: ${conductedBy.slice(0, 8)}...`);

            const sr = results.sectionResults || {};
            function secVal(s, k, def = 0) {
              const v = sr[s]?.[k];
              return typeof v === 'number' ? v : (typeof v === 'string' ? Number(v) || def : def);
            }

            const mapped = {
              session_id: sessionId,  // 🆔 Session ID eklendi
              student_id: studentId,   // localStorage'dan
              conducted_by: conductedBy, // localStorage'dan
              test_start_time: new Date(testState.testStartTime).toISOString(),
              test_end_time: new Date().toISOString(),
              test_duration_seconds: Math.round(results.totalTime || 0),
              total_questions: 23,
              answered_questions: results.answeredQuestions || 0,
              correct_answers: results.correctAnswers || 0,
              wrong_answers: results.wrongAnswers || 0,
              unanswered_questions: results.unansweredQuestions || 0,
              success_rate: Number((results.successRate || 0).toFixed(2)),
              speed_score: Number((results.speedScore || 0).toFixed(2)),
              avg_response_time_ms: Math.round((results.avgResponseTime || 0) * 1000),
              total_response_time_ms: Math.round((results.totalResponseTime || 0) * 1000),

              dortlu_yatay_correct: sr[1]?.correct || 0,
              dortlu_yatay_wrong: (sr[1]?.total || 0) - (sr[1]?.correct || 0),
              dortlu_yatay_total: sr[1]?.total || 8,
              dortlu_yatay_accuracy_percentage: Number((sr[1]?.accuracy_percentage || 0).toFixed(2)),
              dortlu_yatay_avg_response_time_ms: Math.round((sr[1]?.avg_response_time_per_question || 0) * 1000),
              dortlu_yatay_completion_time_seconds: Math.round(sr[1]?.time || 0),

              dortlu_kare_correct: sr[2]?.correct || 0,
              dortlu_kare_wrong: (sr[2]?.total || 0) - (sr[2]?.correct || 0),
              dortlu_kare_total: sr[2]?.total || 6,
              dortlu_kare_accuracy_percentage: Number((sr[2]?.accuracy_percentage || 0).toFixed(2)),
              dortlu_kare_avg_response_time_ms: Math.round((sr[2]?.avg_response_time_per_question || 0) * 1000),
              dortlu_kare_completion_time_seconds: Math.round(sr[2]?.time || 0),

              altili_kare_correct: sr[3]?.correct || 0,
              altili_kare_wrong: (sr[3]?.total || 0) - (sr[3]?.correct || 0),
              altili_kare_total: sr[3]?.total || 3,
              altili_kare_accuracy_percentage: Number((sr[3]?.accuracy_percentage || 0).toFixed(2)),
              altili_kare_avg_response_time_ms: Math.round((sr[3]?.avg_response_time_per_question || 0) * 1000),
              altili_kare_completion_time_seconds: Math.round(sr[3]?.time || 0),

              l_format_correct: sr[4]?.correct || 0,
              l_format_wrong: (sr[4]?.total || 0) - (sr[4]?.correct || 0),
              l_format_total: sr[4]?.total || 3,
              l_format_accuracy_percentage: Number((sr[4]?.accuracy_percentage || 0).toFixed(2)),
              l_format_avg_response_time_ms: Math.round((sr[4]?.avg_response_time_per_question || 0) * 1000),
              l_format_completion_time_seconds: Math.round(sr[4]?.time || 0),

              dokuzlu_format_correct: sr[5]?.correct || 0,
              dokuzlu_format_wrong: (sr[5]?.total || 0) - (sr[5]?.correct || 0),
              dokuzlu_format_total: sr[5]?.total || 3,
              dokuzlu_format_accuracy_percentage: Number((sr[5]?.accuracy_percentage || 0).toFixed(2)),
              dokuzlu_format_avg_response_time_ms: Math.round((sr[5]?.avg_response_time_per_question || 0) * 1000),
              dokuzlu_format_completion_time_seconds: Math.round(sr[5]?.time || 0),

              last_question_reached: results.lastQuestionReached || 0,
              example_attempts: results.exampleAttempts || 0,
              example_correct_count: results.exampleCorrectCount || 0,

              section_results: results.sectionResults || {},
              detailed_answers: results.detailedAnswers || [],
              impulsivity_analysis: results.impulsivityAnalysis || {},
              detailed_statistics: results.detailedStatistics || {}
            };

            console.log('📝 Akıl-Mantık Supabase insert payload:', mapped);

            const { data: ins, error: insErr } = await supabase
              .from('akil_mantik_test_results')
              .insert([mapped])
              .select();

            if (insErr) {
              console.error('❌ Supabase insert hatası:', insErr);
              localStorage.setItem('failedAkilMantik', JSON.stringify({ mapped, error: insErr, at: new Date().toISOString() }));
              showNotification('Kayıt sırasında hata oluştu.', 'error');
              return false;
            }

            console.log('🎉 Akıl-Mantık Supabase kayıt başarılı:', ins);
            localStorage.removeItem('pendingAkilMantik');
            localStorage.removeItem('failedAkilMantik');
            
            // 🔥 SON TEST - AGGREGATOR DİREKT ÇALIŞTIR
            console.log('🔍 AGGREGATOR: Son test tamamlandı, aggregator direkt çalıştırılıyor...');
            try {
              localStorage.setItem('bb-session-end', new Date().toISOString());
              
              // Aggregator'ı direkt çalıştır
              const aggregatorResult = await runCognitiveAggregator();
              
              if (aggregatorResult.ok) {
                console.log('✅ AGGREGATOR BAŞARILI! Cognitive result ID:', aggregatorResult.id);
                console.log('📊 Bilişsel skorlar:', aggregatorResult.scores);
                showNotification('✅ Bilişsel değerlendirme tamamlandı!', 'success');
                
                // Başarılı olunca localStorage'ı temizle
                localStorage.removeItem('bb-session-id');
                localStorage.removeItem('bb-session-start');
                localStorage.removeItem('bb-session-end');
                localStorage.removeItem('bb-student-id');
                localStorage.removeItem('bb-conducted-by');
              } else {
                console.error('❌ AGGREGATOR BAŞARISIZ:', aggregatorResult);
                showNotification(`Analiz hatası: ${aggregatorResult.reason}`, 'error');
                
                // Parent'a da haber vermeyi dene (fallback)
                if (window.opener && typeof window.opener.postMessage === 'function') {
                  window.opener.postMessage({ type: 'run-aggregator' }, '*');
                }
              }
            } catch (aggError) {
              console.error('❌ Aggregator hatası:', aggError);
              showNotification('Test sonuçları kaydedildi, analiz başlatılamadı.', 'warning');
              
              // Parent'a da haber vermeyi dene (fallback)
              if (window.opener && typeof window.opener.postMessage === 'function') {
                window.opener.postMessage({ type: 'run-aggregator' }, '*');
              }
            }
            
            return true;

          } catch (error) {
            console.error('❌ Akıl-Mantık genel kayıt hatası:', error);
            localStorage.setItem('failedAkilMantik', JSON.stringify({ error: String(error), at: new Date().toISOString() }));
            showNotification('Test sonuçları kaydedilirken bir hata oluştu.', 'error');
            return false;
          }
        }

        // Inline Aggregator Fonksiyonu
        async function runCognitiveAggregator() {
          try {
            const sessionId = localStorage.getItem('bb-session-id') || '';
            const studentId = localStorage.getItem('bb-student-id') || '';
            const conductedBy = localStorage.getItem('bb-conducted-by') || '';
            const startISO = localStorage.getItem('bb-session-start') || '';
            const endISO = localStorage.getItem('bb-session-end') || '';

            if (!sessionId || !studentId || !conductedBy || !startISO || !endISO) {
              return { ok: false, reason: 'missing_session_info' };
            }

            // Tarih doğrulama
            const startMs = new Date(startISO).getTime();
            const endMs = new Date(endISO).getTime();
            if (!isFinite(startMs) || !isFinite(endMs)) {
              return { ok: false, reason: 'invalid_time', details: { startISO, endISO } };
            }

            const durationSeconds = Math.max(0, Math.round((endMs - startMs) / 1000));

            // Supabase client al
            const supabase = window.supabase || window.Supabase;
            if (!supabase || !supabase.createClient) {
              return { ok: false, reason: 'supabase_not_loaded' };
            }

            const sbUrl = localStorage.getItem('sb-url');
            const sbKey = localStorage.getItem('sb-anon-key');
            if (!sbUrl || !sbKey) {
              return { ok: false, reason: 'missing_supabase_config' };
            }

            const client = supabase.createClient(sbUrl, sbKey);

            // 5 test sonucunu oku (son kaydı)
            console.log('📖 Alt test sonuçları okunuyor...');
            const [attResult, memResult, strResult, pzlResult, logicResult] = await Promise.all([
              client.from('attention_test_results').select('*').eq('session_id', sessionId).order('test_end_time', { ascending: false }).limit(1).maybeSingle(),
              client.from('memory_test_results').select('*').eq('session_id', sessionId).order('test_end_time', { ascending: false }).limit(1).maybeSingle(),
              client.from('stroop_test_results').select('*').eq('session_id', sessionId).order('test_end_time', { ascending: false }).limit(1).maybeSingle(),
              client.from('puzzle_test_results').select('*').eq('session_id', sessionId).order('test_end_time', { ascending: false }).limit(1).maybeSingle(),
              client.from('akil_mantik_test_results').select('*').eq('session_id', sessionId).order('test_end_time', { ascending: false }).limit(1).maybeSingle()
            ]);

            // Hata kontrolü
            const missing = [];
            if (attResult.error || !attResult.data) missing.push('attention');
            if (memResult.error || !memResult.data) missing.push('memory');
            if (strResult.error || !strResult.data) missing.push('stroop');
            if (pzlResult.error || !pzlResult.data) missing.push('puzzle');
            if (logicResult.error || !logicResult.data) missing.push('akil_mantik');

            if (missing.length > 0) {
              return { ok: false, reason: 'missing_subtests', details: { missing } };
            }

            console.log('✅ Tüm alt test sonuçları bulundu');

            // Skorları hesapla
            const scores = computeCognitiveScores(
              attResult.data,
              memResult.data,
              strResult.data,
              pzlResult.data,
              logicResult.data
            );

            // Alt test özetleri
            const altOzet = {
              attention_id: attResult.data.id,
              memory_id: memResult.data.id,
              stroop_id: strResult.data.id,
              puzzle_id: pzlResult.data.id,
              akil_mantik_id: logicResult.data.id,
              attention_summary: {
                accuracy: attResult.data.accuracy_percentage || attResult.data.success_rate,
                avg_rt_ms: attResult.data.avg_response_time_ms || attResult.data.average_response_time_ms,
              },
              memory_summary: {
                overall: memResult.data.success_rate || memResult.data.accuracy_percentage,
                short_visual: memResult.data.short_visual_accuracy,
                short_auditory: memResult.data.short_auditory_accuracy,
                long_visual: memResult.data.long_visual_accuracy,
                long_auditory: memResult.data.long_auditory_accuracy,
              },
              stroop_summary: {
                accuracy: strResult.data.accuracy_percentage || strResult.data.success_rate,
                avg_rt_ms: strResult.data.avg_response_time_ms || strResult.data.average_response_time_ms,
                interference_ms: strResult.data.interference_ms,
              },
              puzzle_summary: {
                avg_rt_ms: pzlResult.data.average_response_time_ms,
                four: pzlResult.data.four_piece_score,
                six: pzlResult.data.six_piece_score,
                nine: pzlResult.data.nine_piece_score,
                sixteen: pzlResult.data.sixteen_piece_score,
                spatial: pzlResult.data.spatial_reasoning_score,
                pattern: pzlResult.data.pattern_recognition_score,
                problem: pzlResult.data.problem_solving_score,
                flexibility: pzlResult.data.cognitive_flexibility_score,
                rt_variance: pzlResult.data.response_time_variance,
              },
              logic_summary: {
                success_rate: logicResult.data.success_rate,
                avg_rt_ms: logicResult.data.avg_response_time_ms,
                section_acc: {
                  dortlu_yatay: logicResult.data.dortlu_yatay_accuracy_percentage,
                  dortlu_kare: logicResult.data.dortlu_kare_accuracy_percentage,
                  altili_kare: logicResult.data.altili_kare_accuracy_percentage,
                  l_format: logicResult.data.l_format_accuracy_percentage,
                  dokuzlu_format: logicResult.data.dokuzlu_format_accuracy_percentage,
                },
              },
            };

            // cognitive_test_result tablosuna kaydet (upsert)
            console.log('💾 Bilişsel test sonucu kaydediliyor...');
            console.log('Gönderilecek veri:', {
              student_id: studentId,
              conducted_by: conductedBy,
              session_id: sessionId,
              test_start_time: startISO,
              test_end_time: endISO,
              duration_seconds: durationSeconds,
              scores: scores
            });
            
            const { data: insertData, error: insertError } = await client
              .from('cognitive_test_result')
              .insert([{
                student_id: studentId,
                conducted_by: conductedBy,
                session_id: sessionId,
                test_start_time: startISO,
                test_end_time: endISO,
                duration_seconds: durationSeconds,
                dikkat_skoru: scores.dikkat_skoru,
                hafiza_skoru: scores.hafiza_skoru,
                isleme_hizi_skoru: scores.isleme_hizi_skoru,
                gorsel_isleme_skoru: scores.gorsel_isleme_skoru,
                akil_mantik_yurutme_skoru: scores.akil_mantik_yurutme_skoru,
                bilissel_esneklik_skoru: scores.bilissel_esneklik_skoru,
                alt_test_ozetleri: altOzet,
              }])
              .select();

            if (insertError) {
              console.error('❌ cognitive_test_result INSERT HATASI:', insertError);
              console.error('Hata detayları:', {
                code: insertError.code,
                message: insertError.message,
                details: insertError.details,
                hint: insertError.hint
              });
              return { ok: false, reason: 'insert_error', details: insertError };
            }

            console.log('🎉 Bilişsel değerlendirme başarıyla tamamlandı!', insertData);
            return { ok: true, id: insertData?.[0]?.id, scores };

          } catch (e) {
            return { ok: false, reason: 'unexpected_error', details: String(e?.message || e) };
          }
        }

        // Bilişsel skorları hesaplama fonksiyonu
        function computeCognitiveScores(att, mem, str, pzl, logic) {
          // Helper fonksiyonlar
          const clamp01 = (x) => Math.max(0, Math.min(1, x));
          const toPct = (x) => Math.round(x * 10000) / 100;
          const pct = (x) => Math.round(x * 100) / 100;
          const normalize = (value, minVal, maxVal, reverse = false) => {
            if (maxVal === minVal) return 0;
            const t = clamp01((value - minVal) / (maxVal - minVal));
            return reverse ? 1 - t : t;
          };
          const num = (v, def = 0) => {
            if (v == null) return def;
            if (typeof v === 'number' && isFinite(v)) return v;
            const n = Number(v);
            return isFinite(n) ? n : def;
          };

          // Attention core
          const attAcc = num(att?.overall_accuracy ?? att?.accuracy_percentage ?? att?.success_rate, 0);
          const attAvgRtMs = num(att?.avg_response_time_ms ?? att?.average_response_time_ms, 0);
          const attSpeedN = normalize(attAvgRtMs, 300, 3000, true);
          const attentionCore = 0.6 * clamp01(attAcc / 100) + 0.4 * attSpeedN;

          // Stroop
          const strAcc = num(str?.accuracy_percentage ?? str?.success_rate, 0);
          const strAvgRt = num(str?.avg_response_time_ms ?? str?.average_response_time_ms, 0);
          const strSpeedN = normalize(strAvgRt, 300, 3000, true);
          const interference = num(str?.interference_ms ?? 0);
          const interN = normalize(interference, 0, 1000, true);
          const stroopComp = 0.7 * clamp01(strAcc / 100) + 0.15 * strSpeedN + 0.15 * interN;

          // Memory
          const shortVis = num(mem?.short_visual_accuracy ?? 0);
          const shortAud = num(mem?.short_auditory_accuracy ?? 0);
          const longVis = num(mem?.long_visual_accuracy ?? 0);
          const longAud = num(mem?.long_auditory_accuracy ?? 0);
          const memOverall = num(mem?.success_rate ?? mem?.accuracy_percentage, 0);
          const providedCount = [shortVis, shortAud, longVis, longAud].filter(v => v > 0).length;
          const memoryCore = providedCount > 0
            ? clamp01((shortVis + shortAud + longVis + longAud) / (providedCount * 100))
            : clamp01(memOverall / 100);

          // Puzzle
          const pFour = num(pzl?.four_piece_score ?? 0);
          const pSix = num(pzl?.six_piece_score ?? 0);
          const pNine = num(pzl?.nine_piece_score ?? 0);
          const pSixteen = num(pzl?.sixteen_piece_score ?? 0);
          const pAvgRT = num(pzl?.average_response_time_ms ?? 0);
          const pSpeedN = normalize(pAvgRT, 300, 4000, true);
          const pSpatial = num(pzl?.spatial_reasoning_score ?? 0);
          const pPattern = num(pzl?.pattern_recognition_score ?? 0);
          const pProblem = num(pzl?.problem_solving_score ?? 0);
          const pFlex = num(pzl?.cognitive_flexibility_score ?? 0);
          const pAccAvgProvided = [pFour, pSix, pNine, pSixteen].filter(v => v > 0).length;
          const puzzleAcc = pAccAvgProvided > 0 
            ? clamp01((pFour + pSix + pNine + pSixteen) / (pAccAvgProvided * 100)) 
            : 0;

          // Logic (Akıl-Mantık)
          const logicSR = num(logic?.success_rate ?? 0);
          const logicAvgRt = num(logic?.avg_response_time_ms ?? 0);
          const logicSpeedN = normalize(logicAvgRt, 300, 4000, true);
          const logicFour = num(logic?.dortlu_yatay_accuracy_percentage ?? 0);
          const logicSquare = num(logic?.dortlu_kare_accuracy_percentage ?? 0);
          const logicSixAcc = num(logic?.altili_kare_accuracy_percentage ?? 0);
          const logicLAcc = num(logic?.l_format_accuracy_percentage ?? 0);
          const logicNineAcc = num(logic?.dokuzlu_format_accuracy_percentage ?? 0);
          const logicVisProvided = [logicFour, logicSquare, logicSixAcc, logicLAcc, logicNineAcc].filter(v => v > 0).length;
          const logicVisualAcc = logicVisProvided > 0
            ? clamp01((logicFour + logicSquare + logicSixAcc + logicLAcc + logicNineAcc) / (logicVisProvided * 100))
            : 0;

          // 1) Dikkat Skoru
          const dikkat = toPct(0.6 * attentionCore + 0.4 * stroopComp);

          // 2) Hafıza Skoru
          const hafiza = toPct(0.85 * memoryCore + 0.15 * clamp01(logicSR / 100));

          // 3) İşleme Hızı Skoru
          const islemeHizi = toPct(0.4 * attSpeedN + 0.3 * strSpeedN + 0.3 * pSpeedN);

          // 4) Görsel İşleme Skoru
          const gorselIsleme = toPct(0.7 * puzzleAcc + 0.3 * logicVisualAcc);

          // 5) Akıl ve Mantık Yürütme Skoru
          const puzzleReasoningSupport = clamp01((pSpatial + pPattern + pProblem) / (3 * 100));
          const akilMantik = toPct(0.7 * clamp01(logicSR / 100) + 0.3 * puzzleReasoningSupport);

          // 6) Bilişsel Esneklik
          const stroopFlexN = interN;
          const rtVar = num(pzl?.response_time_variance ?? 0);
          const rtVarN = normalize(rtVar, 0, 2_000_000, true);
          const bilisselEsneklik = toPct(0.5 * clamp01(pFlex / 100) + 0.3 * stroopFlexN + 0.2 * rtVarN);

          return {
            dikkat_skoru: pct(dikkat),
            hafiza_skoru: pct(hafiza),
            isleme_hizi_skoru: pct(islemeHizi),
            gorsel_isleme_skoru: pct(gorselIsleme),
            akil_mantik_yurutme_skoru: pct(akilMantik),
            bilissel_esneklik_skoru: pct(bilisselEsneklik),
          };
        }
        
        // Örnek uygulama tekrar fonksiyonu
        function retryExampleFromFail() {
            console.log('🔄 Örnek uygulama tekrar edilecek...');
            
            // State'i unlock et
            unlockState();
            testState.isTransitioning = false;
            
            // Tüm ses ve timer'ları temizle
            stopCurrentAudio();
            if (testState.timerInterval) {
                clearTimeout(testState.timerInterval);
                testState.timerInterval = null;
            }
            
            // Örnek test durumlarını sıfırla
            testState.currentExampleIndex = 0;
            testState.exampleCorrectCount = 0;
            testState.exampleAttempts = Math.max(0, testState.exampleAttempts); // Sayacı koruyoruz
            
            // Demo ekranındaki butonları temizle
            const demoOptions = document.querySelectorAll('#demoOptions .option');
            demoOptions.forEach(option => {
                option.classList.remove('selected', 'correct');
                option.style.transition = '';
                option.style.border = '';
                option.style.transform = '';
                option.style.boxShadow = '';
            });
            
            // Mouse pointer'ı temizle
            const pointer = document.getElementById('demoPointer');
            const clickEffect = document.getElementById('clickEffect');
            if (pointer) {
                pointer.style.opacity = '0';
                pointer.style.transition = '';
                pointer.style.left = '';
                pointer.style.top = '';
            }
            if (clickEffect) {
                clickEffect.classList.remove('active');
                clickEffect.style.left = '';
                clickEffect.style.top = '';
            }
            
            // Demo butonunu gizle
            const demoBtn = document.getElementById('demoNextBtn');
            if (demoBtn) {
                demoBtn.style.display = 'none';
                demoBtn.classList.remove('visible');
            }
            
            // Örnek sorular ekranındaki butonları da temizle
            const exampleOptions = document.querySelectorAll('#exampleOptions .option');
            exampleOptions.forEach(option => {
                option.classList.remove('selected', 'correct', 'wrong');
                option.style.transition = '';
                option.style.border = '';
                option.style.transform = '';
                option.style.boxShadow = '';
            });
            
            // Örnek demo ekranına geri dön
            goToExampleDemo();
        }

        function completeTest() {
            // State'i temizle
            unlockState();
            testState.isTransitioning = false;
            
            // Sesi durdur
            stopCurrentAudio();
            
            // Test tamamlandı mesajı
            console.log('Akıl-Mantık testi tamamlandı!');
            
            // Ana pencereye test tamamlandığını bildir
            try {
                // localStorage'dan test sonuçlarını al veya temel sonuçları oluştur
                let testResults = {};
                
                try {
                    const savedResults = localStorage.getItem('akilMantikTestResults');
                    if (savedResults) {
                        testResults = JSON.parse(savedResults);
                    } else {
                        // Fallback - temel sonuçları oluştur
                        testResults = {
                            correctAnswers: window.testState?.correctAnswers || 0,
                            totalQuestions: window.testData?.mainQuestions?.length || 0,
                            testDuration: window.testState?.testStartTime ? 
                                (Date.now() - window.testState.testStartTime) : 0,
                            currentQuestionIndex: window.testState?.currentQuestionIndex || 0,
                            userAnswers: window.testState?.userAnswers || []
                        };
                    }
                } catch (e) {
                    console.warn('Akıl-Mantık test sonuçları alınamadı:', e);
                    testResults = { error: 'Sonuçlar alınamadı' };
                }
                
                const messageData = {
                    type: 'all-tests-complete',
                    testName: 'akil-mantik',
                    results: testResults,
                    timestamp: new Date().toISOString()
                };
                
                console.log('✅ Tüm testler tamamlandı! Ana pencereye bilgi gönderiliyor...');
                
                // Ana pencereye mesaj gönder (window.opener kullan)
                if (window.opener) {
                    window.opener.postMessage(messageData, window.location.origin);
                    console.log('✅ Test süreci tamamlandı - ana pencereye bilgi gönderildi');
                    
                    // Kısa bir gecikme sonra pencereyi kapat
                    setTimeout(() => {
                        window.close();
                    }, 1000);
                } else {
                    console.error('❌ window.opener mevcut değil - ana pencereye mesaj gönderilemedi');
                    // Yine de pencereyi kapat
                    setTimeout(() => {
                        window.close();
                    }, 1000);
                }
            } catch (error) {
                console.error('❌ Test completion hatası:', error);
                // Hata durumunda da ana pencereye hata mesajı gönder
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'test-complete',
                        testName: 'akil-mantik',
                        results: { error: 'Test completion hatası' },
                        timestamp: new Date().toISOString()
                    }, window.location.origin);
                }
            }
        }

        // ==================== YARDIMCI FONKSİYONLAR ====================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // ==================== ENHANCED CLEANUP & EVENT LISTENERS ====================
        
        // Test başlangıcında çağrılacak cleanup fonksiyonu
        function performDeepCleanup() {
            console.log('🧹 Derin temizlik başlatılıyor...');
            
            try {
                // 1. Tüm timeout/interval'ları temizle
                const highestId = setTimeout(() => {}, 0);
                for (let i = 0; i < highestId; i++) {
                    clearTimeout(i);
                    clearInterval(i);
                }
                
                // 2. Memory cleanup
                if (window.testResults) delete window.testResults;
                if (window.currentTestData) delete window.currentTestData; 
                if (window.gameState) delete window.gameState;
                if (window.stroopTestData) delete window.stroopTestData;
                if (window.puzzleResults) delete window.puzzleResults;
                
                // 3. CSS Animation cleanup  
                document.querySelectorAll('*').forEach(el => {
                    if (el.style) {
                        el.style.animation = '';
                        el.style.transition = '';
                        el.style.transform = '';
                    }
                });
                
                // 4. Force garbage collection
                if (window.gc) {
                    window.gc();
                    console.log('🗑️ Garbage collection çalıştırıldı');
                }
                
                console.log('✅ Derin temizlik tamamlandı');
            } catch (e) {
                console.warn('⚠️ Cleanup kısmen başarısız:', e);
            }
        }
        
        window.addEventListener('beforeunload', function(e) {
            try {
                // Eğer test devam ediyorsa uyar
                if (testState.testStartTime && testState.currentQuestionIndex < testData.mainQuestions.length) {
                    // Kullanıcıya uyarı (modern tarayıcılarda generic mesaj çıkar)
                    const confirmationMessage = 'Akıl ve mantık testi devam ediyor! Sayfayı kapatırsanız test verileri kaybolabilir.';
                    e.returnValue = confirmationMessage; // Chrome
                    return confirmationMessage; // Firefox
                }
                
                stopCurrentAudio();
                if (testState.timerInterval) {
                    clearTimeout(testState.timerInterval);
                }
                // State'i temizle
                unlockState();
                testState.isTransitioning = false;
                console.log('Normal cleanup completed');
            } catch (e) {
                console.error('Beforeunload error:', e);
            }
        });

        // Visibility change - akışa müdahale yok, sadece log
        document.addEventListener('visibilitychange', function() {
            console.log('👁️ Akıl-Mantık görünürlük:', document.hidden ? 'gizli' : 'görünür');
        });

        // Klavye kısayolları
        document.addEventListener('keydown', function(e) {
            // ESC tuşu ile hata overlay'ini kapat
            if (e.key === 'Escape') {
                const errorOverlay = document.getElementById('errorOverlay');
                if (errorOverlay && errorOverlay.classList.contains('show')) {
                    errorOverlay.classList.remove('show');
                }
            }
            
            // Spacebar ile ses durdurma (debug için)
            if (e.key === ' ' && e.ctrlKey) {
                e.preventDefault();
                stopCurrentAudio();
            }
            
            // Ctrl+R ile state temizleme (debug için)
            if (e.key === 'r' && e.ctrlKey) {
                unlockState();
                testState.isTransitioning = false;
                console.log('🔄 State temizlendi');
            }
        });

        // Global fonksiyonları expose et
        window.retryExampleFromFail = retryExampleFromFail;
        window.showExampleCountdown = showExampleCountdown;
        window.showMainCountdown = showMainCountdown;

        // Sayfa yüklendi
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Akıl ve Mantık Testi başlatılıyor...');
            console.log('📱 Cihaz:', navigator.userAgent);
            console.log('🖥️ Ekran:', window.innerWidth + 'x' + window.innerHeight);
            
            // Sistem başlangıç logu
            console.log(`\n🧠 ================= AKIL MANTIK TESTİ SİSTEMİ =================`);
            console.log(`📋 Test: Akıl ve Mantık Testi`);
            console.log(`🔧 Versiyon: v2.1 CLEAN + Puzzle Style Logging`);
            console.log(`🌐 Tarayıcı: ${navigator.userAgent.split(' ')[0]}`);
            console.log(`🖥️ Ekran: ${window.innerWidth}x${window.innerHeight}`);
            console.log(`🌍 Dil: ${navigator.language}`);
            console.log(`⏰ Zaman Dilimi: ${Intl.DateTimeFormat().resolvedOptions().timeZone}`);
            console.log(`🔗 URL: ${window.location.href}`);
            console.log(`📤 Referrer: ${document.referrer || 'Direkt erişim'}`);
            console.log(`📊 Loglama: Puzzle testi stilinde aktif`);
        });
    </script>
</body>
</html>
