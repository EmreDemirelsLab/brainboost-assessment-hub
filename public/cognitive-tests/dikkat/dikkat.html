<!DOCTYPE html>
<html lang="tr">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>ForTest Dikkat Algoritması - Sağlam Versiyon</title>
   <!-- Supabase Client -->
   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
   <style>
       :root {
           --primary: #60a5fa;
           --primary-dark: #2563eb;
           --secondary: #f43f5e;
           --success: #10b981;
           --warning: #f59e0b;
           --danger: #ef4444;
           --light: #f8fafc;
           --dark: #0f172a;
           --gray: #94a3b8;
           --gray-light: #e2e8f0;
           --border-radius: 8px;
           --font-main: 'Segoe UI', Roboto, Arial, sans-serif;
           --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
           --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.15);
           --transition: all 0.3s ease;
           
           /* Responsive değişkenler */
           --container-padding: clamp(15px, 4vw, 50px);
           --font-size-base: clamp(14px, 2vw, 18px);
           --font-size-large: clamp(18px, 3vw, 24px);
           --font-size-xlarge: clamp(24px, 4vw, 48px);
           --font-size-xxlarge: clamp(32px, 6vw, 64px);
           --button-padding: clamp(12px, 2vw, 18px) clamp(20px, 4vw, 40px);
           --gap-size: clamp(10px, 2vw, 20px);
       }

       * {
           margin: 0;
           padding: 0;
           box-sizing: border-box;
       }

       body {
           font-family: var(--font-main);
           line-height: 1.6;
           color: var(--dark);
           background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #1d4ed8 100%);
           min-height: 100vh;
           display: flex;
           justify-content: center;
           align-items: center;
           padding: 0;
           font-size: var(--font-size-base);
           margin: 0;
       }

       /* Container 1200x800 aspect ratio - yukarı-aşağı tam dolu */
       .container {
           background: linear-gradient(145deg, #1e3a8a 0%, #1e40af 100%);
           color: white;
           border-radius: clamp(15px, 3vw, 20px);
           box-shadow: 
               0 25px 50px rgba(0, 0, 0, 0.4),
               0 15px 30px rgba(0, 0, 0, 0.3),
               inset 0 2px 5px rgba(255, 255, 255, 0.1);
           padding: var(--container-padding);
           /* Dynamic sizing: clamp width and maintain 3:2 aspect ratio */
           width: clamp(320px, 90vw, 1200px);
           aspect-ratio: 3 / 2;
           height: auto;
           text-align: center;
           position: relative;
           border: 1px solid rgba(255, 255, 255, 0.2);
           overflow: hidden;
           display: flex;
           flex-direction: column;
           margin: 0 auto;
       }

       /* Loading overlay - smooth transitions */
       .loading-overlay {
           position: absolute;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background: rgba(30, 58, 138, 0.9);
           display: flex;
           justify-content: center;
           align-items: center;
           z-index: 1000;
           flex-direction: column;
           opacity: 0;
           visibility: hidden;
           transition: opacity 0.3s ease, visibility 0.3s ease;
       }

       .loading-overlay.show {
           opacity: 1;
           visibility: visible;
       }

       .loading-spinner {
           width: 50px;
           height: 50px;
           border: 4px solid rgba(255, 255, 255, 0.3);
           border-top: 4px solid white;
           border-radius: 50%;
           animation: spin 1s linear infinite;
           margin-bottom: 20px;
       }

       .loading-text {
           color: white;
           font-size: var(--font-size-large);
       }

       @keyframes spin {
           0% { transform: rotate(0deg); }
           100% { transform: rotate(360deg); }
       }

       /* Error message */
       .error-overlay {
           position: absolute;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background: rgba(239, 68, 68, 0.9);
           display: flex;
           justify-content: center;
           align-items: center;
           z-index: 1001;
           flex-direction: column;
           text-align: center;
           padding: 20px;
           opacity: 0;
           visibility: hidden;
           transition: opacity 0.3s ease, visibility 0.3s ease;
       }

       .error-overlay.show {
           opacity: 1;
           visibility: visible;
       }

       .error-message {
           color: white;
           font-size: var(--font-size-large);
           text-align: center;
           padding: 20px;
           line-height: 1.6;
       }

       .header {
           margin-bottom: clamp(15px, 4vw, 30px);
       }

       .header h1 {
           color: white;
           margin-bottom: clamp(5px, 2vw, 10px);
           font-size: var(--font-size-xxlarge);
           font-weight: 700;
           letter-spacing: -0.5px;
           text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
           line-height: 1.2;
       }

       .header p {
           color: rgba(255, 255, 255, 0.8);
           font-size: var(--font-size-large);
           line-height: 1.8;
       }

       .screen {
           display: none;
           position: absolute;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           padding: var(--container-padding);
       }

       .screen.active {
           display: flex;
           flex-direction: column;
           justify-content: center;
           align-items: center;
       }

       /* Başlangıç ekranı */
       .title-screen h1 {
           font-size: var(--font-size-xxlarge);
           color: white;
           font-weight: 700;
           margin-bottom: clamp(25px, 6vw, 50px);
           text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
           line-height: 1.2;
       }

       .instruction-box {
           background: transparent;
           border-radius: 0;
           padding: clamp(10px, 3vw, 20px);
           margin: clamp(15px, 4vw, 30px) auto;
           max-width: min(90%, 800px);
           box-shadow: none;
           border: none;
       }

       .instruction-text {
           font-size: var(--font-size-large);
           color: rgba(255, 255, 255, 0.9);
           margin-bottom: clamp(10px, 3vw, 20px);
           line-height: 1.8;
       }

       .highlight-text {
           color: white;
           font-weight: bold;
           font-size: clamp(20px, 3.5vw, 28px);
           margin: clamp(10px, 3vw, 20px) 0;
           line-height: 1.8;
           text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
       }

       .btn {
           display: inline-block;
           font-weight: 500;
           color: white;
           text-align: center;
           vertical-align: middle;
           cursor: pointer;
           background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
           padding: var(--button-padding);
           font-size: clamp(16px, 2.5vw, 22px);
           line-height: 1.5;
           border-radius: var(--border-radius);
           transition: opacity 0.5s ease, transform 0.5s ease, background 0.3s ease, box-shadow 0.3s ease;
           border: none;
           box-shadow: 
               0 4px 6px rgba(30, 64, 175, 0.3),
               0 0 15px rgba(255, 255, 255, 0.3),
               0 0 25px rgba(255, 255, 255, 0.1);
           text-decoration: none;
           margin: clamp(5px, 1vw, 10px);
           opacity: 0;
           transform: translateY(20px);
           min-width: clamp(100px, 20vw, 150px);
           position: relative;
           overflow: hidden;
           min-height: clamp(44px, 8vw, 56px);
       }

       .btn.visible {
           opacity: 1;
           transform: translateY(0);
       }

       .btn.disabled {
           opacity: 0.5;
           cursor: not-allowed;
           pointer-events: none;
       }

       .btn:hover:not(.disabled) {
           background: linear-gradient(135deg, #1e3d9f 0%, #2454d6 100%);
           box-shadow: 
               0 6px 8px rgba(30, 58, 138, 0.4),
               0 0 20px rgba(255, 255, 255, 0.4),
               0 0 35px rgba(255, 255, 255, 0.15);
           transform: translateY(-2px);
       }

       .btn-bottom-right {
           position: absolute;
           bottom: clamp(20px, 4vw, 40px);
           right: clamp(20px, 4vw, 40px);
           opacity: 0;
           transition: opacity 0.5s ease;
       }

       .btn-bottom-right.visible {
           opacity: 1;
       }

       /* Sonuç ekranı */
       .result-message {
           font-size: clamp(28px, 5vw, 48px);
           color: white;
           font-weight: 600;
           text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
           margin-bottom: clamp(15px, 4vw, 30px);
           line-height: 1.2;
       }

       .result-info {
           font-size: var(--font-size-large);
           color: rgba(255, 255, 255, 0.8);
           font-weight: 500;
       }

       .numbers-display, .letters-display, .question-display {
           display: flex;
           flex-wrap: wrap;
           justify-content: center;
           align-items: center;
           gap: clamp(8px, 2vw, 16px);
           margin: clamp(15px, 4vw, 30px) auto;
           opacity: 1;
           transition: opacity 1s ease;
           position: relative;
           perspective: 1000px;
           transform-style: preserve-3d;
           width: 100%;
           max-width: min(95%, 700px);
           min-height: clamp(60px, 12vh, 120px);
           padding: clamp(5px, 1vw, 15px);
       }

       .option-btn {
           width: clamp(48px, 12vw, 80px);
           height: clamp(48px, 12vw, 80px);
           padding: 0;
           font-size: clamp(15px, 3.5vw, 22px);
           font-weight: bold;
           border: clamp(1px, 0.3vw, 2px) solid rgba(255, 255, 255, 0.3);
           background: rgba(255, 255, 255, 0.9);
           color: black;
           border-radius: clamp(6px, 1.5vw, 12px);
           cursor: pointer;
           transition: all 0.3s ease;
           font-family: Arial, sans-serif;
           display: flex;
           align-items: center;
           justify-content: center;
           box-shadow: 
               0 clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 6px) rgba(0, 0, 0, 0.2),
               0 1px 3px rgba(0, 0, 0, 0.15),
               inset 0 2px 2px rgba(255, 255, 255, 0.8);
           transform: translateZ(0);
           backface-visibility: hidden;
           position: relative;
           flex-shrink: 0;
           aspect-ratio: 1 / 1;
           user-select: none;
           -webkit-tap-highlight-color: transparent;
           transform-origin: center;
       }

       .option-btn:hover:not(.disabled) {
           background: rgba(255, 255, 255, 0.9);
           border-color: rgba(255, 255, 255, 0.3);
           color: black;
           box-shadow: 
               0 clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 6px) rgba(0, 0, 0, 0.2),
               0 1px 3px rgba(0, 0, 0, 0.15),
               inset 0 2px 2px rgba(255, 255, 255, 0.8);
       }

       .option-btn:active {
           transition: transform 0.1s ease;
       }

       .option-btn.selected {
           background: linear-gradient(135deg, #90cdf4 0%, #60a5fa 100%) !important;
           color: black !important;
           border-color: #90cdf4 !important;
           box-shadow: 
               0 clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 6px) rgba(0, 0, 0, 0.2),
               0 1px 3px rgba(0, 0, 0, 0.15),
               inset 0 2px 2px rgba(255, 255, 255, 0.8) !important;
       }

       /* DİSABLED kuralı EN SONDA olmalı - diğer kuralları ezsin */
       .option-btn.disabled {
           opacity: 0.5 !important;
           cursor: not-allowed !important;
           pointer-events: none !important;
       }

       .option-btn.clicked {
           background: linear-gradient(135deg, #90cdf4 0%, #60a5fa 100%) !important;
           color: black !important;
           border-color: #90cdf4 !important;
           box-shadow: 
               0 clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 6px) rgba(0, 0, 0, 0.2),
               0 1px 3px rgba(0, 0, 0, 0.15),
               inset 0 2px 2px rgba(255, 255, 255, 0.8);
           transform: scale(0.95);
       }

       .fake-cursor {
           position: absolute;
           width: clamp(18px, 3vw, 22px);
           height: clamp(18px, 3vw, 22px);
           background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><path d="M0,0 L0,16 L4,12 L7,19 L10,18 L7,11 L12,11 Z" fill="black" stroke="white" stroke-width="1"/></svg>');
           background-size: contain;
           background-repeat: no-repeat;
           pointer-events: none;
           z-index: 1000;
           opacity: 0;
           transition: all 1.5s ease;
           transform: scale(1);
           transform-origin: top left;
           filter: none;
       }

       .example-text {
           font-size: clamp(16px, 2.5vw, 22px);
           color: white;
           font-weight: 500;
           text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
           position: absolute;
           bottom: clamp(20px, 4vw, 40px);
           left: 50%;
           transform: translateX(-50%);
           z-index: 100;
           text-align: center;
           width: max-content;
           max-width: 80%;
           padding: clamp(12px, 2vw, 18px) clamp(20px, 4vw, 40px);
           background: rgba(30, 64, 175, 0.8);
           backdrop-filter: blur(8px);
           border-radius: var(--border-radius);
           line-height: 1.5;
           margin: clamp(5px, 1vw, 10px);
           border: 1px solid rgba(255, 255, 255, 0.2);
           animation: fadeInUp 0.8s ease-out;
       }

       @keyframes fadeInUp {
           from {
               opacity: 0;
               transform: translateX(-50%) translateY(20px);
           }
           to {
               opacity: 1;
               transform: translateX(-50%) translateY(0);
           }
       }

       .timer {
           position: fixed;
           top: clamp(10px, 2vw, 20px);
           right: clamp(10px, 2vw, 20px);
           background-color: var(--primary);
           color: white;
           padding: clamp(8px, 1.5vw, 10px) clamp(12px, 2vw, 15px);
           border-radius: var(--border-radius);
           font-weight: bold;
           box-shadow: var(--shadow-md);
           z-index: 100;
           font-size: clamp(14px, 2vw, 18px);
       }

       .progress-container {
           position: absolute;
           bottom: 0;
           left: 0;
           width: 100%;
           height: clamp(6px, 1vw, 8px);
           background-color: #e2e8f0;
           border-bottom-left-radius: clamp(15px, 3vw, 20px);
           border-bottom-right-radius: clamp(15px, 3vw, 20px);
           overflow: hidden;
       }

       .progress-bar {
           height: 100%;
           width: 100%;
           background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
           transition: transform 1s linear;
           transform-origin: left;
           transform: scaleX(0);
           border-bottom-left-radius: clamp(15px, 3vw, 20px);
           border-bottom-right-radius: clamp(15px, 3vw, 20px);
       }

       /* Geri sayım ekranı - çok sade */
       .countdown-screen {
           display: flex;
           justify-content: center;
           align-items: center;
           height: 100%;
       }

       .countdown-number {
           font-size: clamp(80px, 12vw, 150px);
           font-weight: bold;
           color: white;
           text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
       }

       .question-counter {
           font-size: clamp(14px, 2vw, 18px);
           color: rgba(255, 255, 255, 0.8);
           margin-bottom: clamp(10px, 3vw, 20px);
       }

       /* Responsive Media Queries - Birleştirilmiş */
       
       /* Çok küçük telefon ekranları */
       @media (max-width: 360px) {
           .container {
               padding: clamp(10px, 3vw, 15px);
           }
           .numbers-display, .letters-display, .question-display {
               gap: clamp(4px, 1vw, 8px);
               max-width: 100%;
               padding: clamp(3px, 0.5vw, 10px);
           }
           .option-btn {
               width: clamp(45px, 14vw, 60px);
               height: clamp(45px, 14vw, 60px);
               font-size: clamp(14px, 4vw, 18px);
           }
       }

       /* Küçük telefon ekranları */
       @media (max-width: 480px) {
           .btn-bottom-right {
               position: relative;
               bottom: auto;
               right: auto;
               margin-top: 20px;
           }
           .numbers-display, .letters-display, .question-display {
               gap: clamp(6px, 1.5vw, 12px);
               justify-content: space-evenly;
               max-width: 100%;
           }
       }

       /* Tablet ve masaüstü - birleştirilmiş kurallar */
       @media (min-width: 481px) {
           .numbers-display, .letters-display, .question-display {
               gap: clamp(10px, 2vw, 18px);
               max-width: min(85%, 700px);
           }
           .container {
               height: min(100vh - 30px, 800px);
           }
       }

       /* Büyük ekranlar */
       @media (min-width: 1400px) {
           .container {
               width: min(90%, 1400px);
               height: min(100vh - 40px, 900px);
           }
       }

       /* Landscape mode mobil */
       @media (max-height: 500px) and (orientation: landscape) {
           .container {
               height: 95vh;
               padding: 15px;
           }
           .title-screen h1 {
               margin-bottom: 20px;
           }
           .instruction-box {
               padding: 20px;
               margin: 15px auto;
           }
       }

       /* High DPI ekranlar için font optimizasyonu */
       @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
           .header h1, .title-screen h1, .result-message {
               -webkit-font-smoothing: antialiased;
               -moz-osx-font-smoothing: grayscale;
           }
       }

       /* Accessibility improvements */
       @media (prefers-reduced-motion: reduce) {
           *, *::before, *::after {
               animation-duration: 0.01ms !important;
               animation-iteration-count: 1 !important;
               transition-duration: 0.01ms !important;
           }
           .fake-cursor {
               transition: none !important;
           }
           .loading-overlay, .error-overlay {
               transition: opacity 0.1s ease !important;
           }
       }

       /* High contrast mode */
       @media (prefers-contrast: high) {
           .option-btn {
               border-width: 2px;
               border-color: black;
           }
           .btn {
               border: 2px solid white;
           }
       }
   </style>
</head>
<body>
   <div class="container">
       <!-- Loading Overlay -->
       <div class="loading-overlay" id="loadingOverlay">
           <div class="loading-spinner"></div>
           <div class="loading-text" id="loadingText">Yükleniyor...</div>
       </div>

       <!-- Error Overlay -->
       <div class="error-overlay" id="errorOverlay">
           <div class="error-message" id="errorMessage">Bir hata oluştu</div>
       </div>

       <!-- 1. Hoş Geldiniz Ekranı -->
       <div id="welcomeScreen" class="screen active">
           <div class="title-screen">
               <h1>Fortest Bilişsel Beceriler Testi</h1>
           </div>
           <button class="btn btn-bottom-right visible" onclick="DikkatTest.navigate('goToSoundSetup')">İleri</button>
       </div>

       <!-- 2. Ses Ayarlama Ekranı -->
       <div id="soundSetupScreen" class="screen">
           <div class="instruction-box">
               <div class="instruction-text">
                   Ses düzeyini anlatıcının 5'e kadar saydığını rahat ve net bir şekilde duyabileceğiniz şekilde ayarlayın.<br>
                   Böylece açıklamaları net bir şekilde anlayabilirsiniz.
               </div>
               <div class="highlight-text">
                   Teste başlamaya hazır olduğunuzda "İleri" butonuna basınız.
               </div>
           </div>
           <button class="btn btn-bottom-right" id="soundNextBtn" onclick="DikkatTest.navigate('goToTestInfo')">İleri</button>
       </div>

       <!-- 3. Test Bilgilendirme Ekranı -->
       <div id="testInfoScreen" class="screen">
           <div class="instruction-box">
               <div class="highlight-text">
                   Fortest bilişsel beceriler testi 5 alt testten oluşmaktadır.<br>
                   Ortalama 20 dakikada tamamlanacaktır.<br>
                   Hazır olduğunuzda "Başla" butonuna basınız.
               </div>
           </div>
           <button class="btn btn-bottom-right" id="testInfoBtn" onclick="DikkatTest.navigate('goToInstructions')">Başla</button>
       </div>

       <!-- 4. Talimatlar Ekranı -->
       <div id="instructionsScreen" class="screen">
           <div class="instruction-box">
               <div class="highlight-text">
                   Verilen satırda birbirinin aynı olan rakam veya harfleri<br>
                   en hızlı şekilde işaretle.
               </div>
           </div>
           <button class="btn btn-bottom-right" id="instructionsNextBtn" onclick="DikkatTest.navigate('goToIntroDemo')">İleri</button>
       </div>

       <!-- 5. Giriş Demonstrasyonu -->
       <div id="introDemoScreen" class="screen">
           <div id="introNumbers" class="numbers-display">
               <div class="option-btn">6</div>
               <div class="option-btn">3</div>
               <div class="option-btn" id="target-9-1">9</div>
               <div class="option-btn">5</div>
               <div class="option-btn" id="target-9-2">9</div>
               <div class="option-btn">2</div>
               <div class="fake-cursor" id="introCursor"></div>
           </div>
           <div class="example-text">Örneği dikkatle izleyin.</div>
           <button class="btn btn-bottom-right" id="introNextBtn" onclick="DikkatTest.navigate('goToLetterDemo')">İleri</button>
       </div>

       <!-- 6. Harf Demonstrasyonu -->
       <div id="letterDemoScreen" class="screen">
           <div id="letterDisplay" class="letters-display">
               <div class="option-btn">a</div>
               <div class="option-btn" id="target-c-1">c</div>
               <div class="option-btn">v</div>
               <div class="option-btn">d</div>
               <div class="option-btn" id="target-c-2">c</div>
               <div class="option-btn">z</div>
               <div class="fake-cursor" id="letterCursor"></div>
           </div>
           <div class="example-text">Örneği dikkatle izleyin.</div>
           <button class="btn btn-bottom-right" id="letterNextBtn" onclick="DikkatTest.navigate('goToExampleTransition')">İleri</button>
       </div>

       <!-- 7. Örnek Uygulama Geçiş -->
       <div id="exampleTransitionScreen" class="screen">
           <div class="instruction-box">
               <div class="highlight-text">
                   Örnek uygulamaya geçmek için "İleri" butonuna tıklayın!
               </div>
           </div>
           <button class="btn btn-bottom-right" id="exampleTransitionBtn" onclick="DikkatTest.navigate('goToExampleStart')">İleri</button>
       </div>

       <!-- 8. Örnek Uygulama Başlangıç -->
       <div id="exampleStartScreen" class="screen">
           <div class="instruction-box">
               <div class="highlight-text">
                   Örnek uygulamaya hazırsanız "Başla" butonuna tıklayın!
               </div>
           </div>
           <button class="btn btn-bottom-right" id="exampleStartBtn" onclick="DikkatTest.navigate('showCountdown', 'practice')">Başla</button>
       </div>

       <!-- 8.5. Geri Sayım Ekranı -->
       <div id="countdownScreen" class="screen">
           <div class="countdown-screen">
               <div id="countdownNumber" class="countdown-number">3</div>
           </div>
       </div>

       <!-- 9. Örnek Uygulama -->
       <div id="practiceTestScreen" class="screen">
           <div id="practiceDisplay" class="question-display"></div>
           <div class="progress-container">
               <div id="practiceProgressBar" class="progress-bar"></div>
           </div>
       </div>

       <!-- 10. Örnek Uygulama Tamamlandı -->
       <div id="exampleCompleteScreen" class="screen">
           <div class="instruction-box">
               <div class="highlight-text">
                   Örnek uygulamayı tamamladınız!
               </div>
           </div>
           <button class="btn btn-bottom-right" id="exampleCompleteBtn" onclick="DikkatTest.navigate('goToMainTestIntro')">İleri</button>
       </div>

       <!-- 11. Ana Test Hazırlık -->
       <div id="mainTestIntroScreen" class="screen">
           <div class="instruction-box">
               <div class="highlight-text">
                   Teste hazırlanın!<br>
                   testi tamamlamak için 3 dakikanız var.
               </div>
           </div>
           <button class="btn btn-bottom-right" id="mainTestIntroBtn" onclick="DikkatTest.navigate('showCountdown', 'main')">Başla</button>
       </div>

       <!-- 12. Ana Test -->
       <div id="mainTestScreen" class="screen">
           <div id="mainDisplay" class="question-display"></div>
           <div class="progress-container">
               <div id="mainProgressBar" class="progress-bar"></div>
           </div>
       </div>

       <!-- 13. Örnek Uygulama Başarısızlık Ekranı -->
       <div id="exampleFailScreen" class="screen">
           <div class="instruction-box">
               <div class="highlight-text">
                   Yeterli doğru cevabı vermediniz, örnek uygulama tekrar edilecektir.
               </div>
           </div>
           <button class="btn btn-bottom-right visible" onclick="retryExampleFromFail()">Tamam</button>
       </div>

       <!-- 14. Test Tamamlandı -->
       <div id="resultsScreen" class="screen">
           <div class="result-message">Testi tamamladınız!</div>
           <div class="result-info">Sıradaki bölüme geçmek için ileri butonuna tıklayın!</div>
           <button class="btn btn-bottom-right visible" onclick="DikkatTest.navigate('completeTest')">İleri</button>
       </div>
   </div>

   <script>
       // ===================================
       // SAĞLAM TEST SİSTEMİ - v2.1 CLEAN
       // Memory Leak'ler Düzeltildi
       // Global Namespace Temizlendi
       // ===================================

       'use strict';

       // Global hata yakalama
       window.addEventListener('error', function(e) {
           console.error('Global Error:', e.error);
           handleError('Beklenmeyen bir hata oluştu: ' + e.message, true);
       });

       window.addEventListener('unhandledrejection', function(e) {
           console.error('Unhandled Promise Rejection:', e.reason);
           handleError('Promise hatası: ' + e.reason, true);
       });

       // Test yapısı - bölüm ve tür bilgileri
       const TEST_STRUCTURE = {
           sections: {
               section1: { name: "1. BÖLÜM", start: 0, end: 12, maxTime: 60000 },    // 13 soru - 60 saniye
               section2: { name: "2. BÖLÜM", start: 13, end: 29, maxTime: 70000 },   // 17 soru - 70 saniye  
               section3: { name: "3. BÖLÜM", start: 30, end: 49, maxTime: 50000 }    // 20 soru - 50 saniye
           },
           questionTypes: {
               // 's' = sayı soruları
               's': [0, 2, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31, 33, 35, 37, 39, 41, 43, 45, 47, 49],
               // 'h' = harf soruları  
               'h': [1, 3, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 38, 40, 42, 44],
               // 's/h' = karma sorular (sayı+harf karışımı)
               's/h': [4, 36, 46, 48]
           }
       };

       // Test verileri - temiz ve sağlam
       const TEST_DATA = {
           practiceQuestions: [
               { question: ['o', 'k', 'o', 'm', 't', 'y'], target: 'o' },
               { question: ['56', '79', '27', '60', '23', '56'], target: '56' },
               { question: ['ke', 'me', 'em', 'ke', 'en', 'mn'], target: 'ke' },
               { question: ['5', '8', '3', '9', '2', '5'], target: '5' },
               { question: ['6k1', 'k61', 'k16', '61k', 'k16', '16k'], target: 'k16' }
           ],
           
           mainQuestions: [
               { question: ['5', '6', '2', '1', '5', '8'], target: '5' },
               { question: ['m', 't', 'k', 'a', 't', 'h'], target: 't' },
               { question: ['6', '1', '5', '2', '3', '3'], target: '3' },
               { question: ['y', 'd', 'u', 'v', 'u', 'p'], target: 'u' },
               { question: ['6', '1', '3', '1', '5', '8'], target: '1' },
               { question: ['7', '4', '2', '1', '8', '4'], target: '4' },
               { question: ['n', 'a', 'e', 'c', 'e', 'm'], target: 'e' },
               { question: ['7', '4', '6', '2', '5', '6'], target: '6' },
               { question: ['d', 'h', 'k', 'd', 'b', 'o'], target: 'd' },
               { question: ['2', '7', '5', '9', '4', '9'], target: '9' },
               { question: ['s', 'y', 'd', 'g', 's', 'p'], target: 's' },
               { question: ['3', '8', '5', '2', '5', '6'], target: '5' },
               { question: ['m', 'n', 'j', 'c', 'm', 'ç'], target: 'm' },
               { question: ['84', '56', '86', '45', '57', '45'], target: '45' },
               { question: ['ta', 'at', 'al', 'li', 'at', 'il'], target: 'at' },
               { question: ['68', '48', '86', '68', '84', '54'], target: '68' },
               { question: ['ık', 'na', 'ku', 'ok', 'ık', 'ka'], target: 'ık' },
               { question: ['24', '42', '74', '45', '27', '74'], target: '74' },
               { question: ['me', 'na', 'en', 'na', 'ma', 'ne'], target: 'na' },
               { question: ['69', '92', '26', '96', '62', '62'], target: '62' },
               { question: ['şı', 'ce', 'şe', 'ça', 'ca', 'ça'], target: 'ça' },
               { question: ['72', '27', '52', '22', '25', '72'], target: '72' },
               { question: ['hi', 'hı', 'ıh', 'ik', 'ik', 'ih'], target: 'ik' },
               { question: ['43', '48', '84', '38', '83', '43'], target: '43' },
               { question: ['ro', 'no', 'on', 'ru', 'ro', 'un'], target: 'ro' },
               { question: ['13', '31', '24', '24', '12', '35'], target: '24' },
               { question: ['bı', 'ıd', 'bi', 'ıd', 'ib', 'di'], target: 'ıd' },
               { question: ['52', '25', '55', '55', '22', '24'], target: '55' },
               { question: ['uç', 'aş', 'şi', 'uş', 'şe', 'uş'], target: 'uş' },
               { question: ['36', '23', '63', '32', '33', '36'], target: '36' },
               { question: ['yku', 'nkv', 'mac', 'yhg', 'ylg', 'yku'], target: 'yku' },
               { question: ['375', '562', '656', '756', '356', '656'], target: '656' },
               { question: ['cau', 'uau', 'cua', 'cuv', 'uca', 'cau'], target: 'cau' },
               { question: ['424', '243', '424', '342', '234', '324'], target: '424' },
               { question: ['lhm', 'hlm', 'hml', 'mlh', 'lmh', 'mlh'], target: 'mlh' },
               { question: ['852', '258', '285', '258', '825', '582'], target: '258' },
               { question: ['7ç1', 'ç71', 'ç17', '71ç', 'ç17', '17ç'], target: 'ç17' },
               { question: ['289', '298', '982', '928', '829', '982'], target: '982' },
               { question: ['sbv', 'nzı', 'sbm', 'sdg', 'sbm', 'sag'], target: 'sbm' },
               { question: ['636', '361', '636', '163', '316', '136'], target: '636' },
               { question: ['env', 'vzn', 'evn', 'evk', 'ven', 'evk'], target: 'evk' },
               { question: ['525', '528', '285', '582', '528', '825'], target: '528' },
               { question: ['ıvs', 'svs', 'ısv', 'ısh', 'sıv', 'ısh'], target: 'ısh' },
               { question: ['969', '964', '649', '694', '964', '946'], target: '964' },
               { question: ['mhm', 'hmm', 'hhm', 'hmh', 'mmh', 'mmh'], target: 'mmh' },
               { question: ['817', '187', '781', '718', '871', '718'], target: '718' },
               { question: ['2v5', 'v52', 'v25', '25v', 'v52', '52v'], target: 'v52' },
               { question: ['652', '256', '562', '526', '625', '256'], target: '256' },
               { question: ['4g4', '4gg', '44g', '4g4', 'g4g', 'g44'], target: '4g4' },
               { question: ['797', '797', '369', '697', '973', '396'], target: '797' }
           ]
       };

       // Konfigürasyon sabitleri
       const CONFIG = {
           PRACTICE_TIME_LIMIT: 30000, // 30 saniye
           MAIN_TIME_LIMIT: 180000,    // 3 dakika
           AUDIO_RETRY_ATTEMPTS: 3,
           DEBOUNCE_DELAY: 300,
           ANIMATION_DELAY: 100,
           MIN_PRACTICE_SCORE: 3,
                       AUDIO_PRELOAD_TIMEOUT: 10000
       };

       // Güvenli state yönetimi - Sadeleştirilmiş
       class SafeTestState {
           constructor() {
               this.reset();
               this.locked = false;
           }

           reset() {
               this.currentScreen = 'welcome';
               this.currentAudio = null;
               this.preloadedAudios = new Map();
               this.timers = new Set();
               this.intervals = new Set();
               this.isTransitioning = false;
               
               this.hasSeenIntro = false;
               this.hasSeenLetter = false;
               
               this.practiceIndex = 0;
               this.practiceAnswers = [];
               this.practiceStartTime = null;
               this.practiceTimeLeft = 0;
               
               this.mainIndex = 0;
               this.mainAnswers = [];
               this.mainStartTime = null;
               this.mainTimeLeft = 0;
               this.questionStartTime = null;
               this.reactionTimes = [];
               
               // Bölüm takibi
               this.currentSection = null;
               this.sectionStartTimes = {};
               this.sectionEndTimes = {};
               this.incompleteAtQuestion = null;
               
               // Detay takibi
               this.wrongSelections = [];    // Yanlış seçilen seçenekler
               this.questionTypeMistakes = {  // Tür bazlı hata sayıları
                   's': { correct: 0, wrong: 0 },   // Sayı soruları
                   'h': { correct: 0, wrong: 0 },   // Harf soruları
                   's/h': { correct: 0, wrong: 0 } // Karma sorular
               };
               
               this.errorCount = 0;
               this.lastError = null;
           }

           safeSet(key, value) {
               if (this.locked) {
                   console.warn('State locked, ignoring set operation:', key);
                   return false;
               }
               this[key] = value;
               return true;
           }

           lock() { this.locked = true; }
           unlock() { this.locked = false; }

           addTimer(timerId) {
               this.timers.add(timerId);
               return timerId;
           }

           addInterval(intervalId) {
               this.intervals.add(intervalId);
               return intervalId;
           }

           clearAllTimers() {
               this.timers.forEach(id => clearTimeout(id));
               this.intervals.forEach(id => clearInterval(id));
               this.timers.clear();
               this.intervals.clear();
           }

           cleanup() {
               this.clearAllTimers();
               this.stopAllAudio();
               this.unlock();
           }

           stopAllAudio() {
               if (this.currentAudio) {
                   try {
                       this.currentAudio.pause();
                       this.currentAudio.currentTime = 0;
                       this.currentAudio.src = '';
                       this.currentAudio = null;
                   } catch (e) {
                       console.warn('Audio cleanup error:', e);
                   }
               }
               
               this.preloadedAudios.forEach(audio => {
                   try {
                       audio.pause();
                       audio.src = '';
                   } catch (e) {
                       console.warn('Preloaded audio cleanup error:', e);
                   }
               });
               this.preloadedAudios.clear();
           }
       }

       // Global state instance
       const testState = new SafeTestState();

       // Debouncing utility
       const debounce = (func, wait) => {
           let timeout;
           return function executedFunction(...args) {
               const later = () => {
                   clearTimeout(timeout);
                   func(...args);
               };
               clearTimeout(timeout);
               timeout = setTimeout(later, wait);
           };
       };

       // Hata yönetimi
       function handleError(message, critical = false) {
           console.error('Test Error:', message);
           testState.errorCount++;
           testState.lastError = message;
           hideLoading();

           if (critical) {
               showError(message, 6000);
               testState.cleanup();
           } else {
               console.warn('Non-critical error handled:', message);
           }
       }

       // Güvenli element erişimi
       function safeGetElement(id) {
           try {
               const element = document.getElementById(id);
               if (!element) {
                   console.warn(`Element not found: ${id}`);
                   return null;
               }
               return element;
           } catch (e) {
               console.error(`Error accessing element ${id}:`, e);
               return null;
           }
       }

       // Loading göstergesi
       let loadingTimeout = null;
       
       function showLoading(message = 'Yükleniyor...', minDisplayTime = 500) {
           const overlay = safeGetElement('loadingOverlay');
           const text = safeGetElement('loadingText');
           
           if (overlay) {
               if (text) text.textContent = message;
               if (loadingTimeout) {
                   clearTimeout(loadingTimeout);
                   loadingTimeout = null;
               }
               overlay.classList.add('show');
           }
       }

       function hideLoading(delay = 0) {
           const overlay = safeGetElement('loadingOverlay');
           if (overlay) {
               if (delay > 0) {
                   loadingTimeout = setTimeout(() => {
                       overlay.classList.remove('show');
                       loadingTimeout = null;
                   }, delay);
               } else {
                   overlay.classList.remove('show');
               }
           }
       }

       // Error overlay
       let errorTimeout = null;

       function showError(message, duration = 4000) {
           const overlay = safeGetElement('errorOverlay');
           const messageEl = safeGetElement('errorMessage');
           
           if (overlay) {
               if (messageEl) messageEl.textContent = message;
               overlay.classList.add('show');
               
               if (errorTimeout) {
                   clearTimeout(errorTimeout);
               }
               
               errorTimeout = setTimeout(() => {
                   hideError();
               }, duration);
           }
       }

       function hideError() {
           const overlay = safeGetElement('errorOverlay');
           if (overlay) {
               overlay.classList.remove('show');
               if (errorTimeout) {
                   clearTimeout(errorTimeout);
                   errorTimeout = null;
               }
           }
       }

       // Yardımcı fonksiyonlar - Test yapısı
       function getQuestionType(questionIndex) {
           for (const [type, indices] of Object.entries(TEST_STRUCTURE.questionTypes)) {
               if (indices.includes(questionIndex)) {
                   return type;
               }
           }
           return 'unknown';
       }

       function getCurrentSection(questionIndex) {
           for (const [key, section] of Object.entries(TEST_STRUCTURE.sections)) {
               if (questionIndex >= section.start && questionIndex <= section.end) {
                   return { key, ...section };
               }
           }
           return null;
       }

       function getSectionStats(sectionKey) {
           const section = TEST_STRUCTURE.sections[sectionKey];
           const sectionAnswers = testState.mainAnswers.filter(answer => 
               answer.question >= section.start && answer.question <= section.end
           );
           
           return {
               totalQuestions: section.end - section.start + 1,
               answeredQuestions: sectionAnswers.length,
               correctAnswers: sectionAnswers.filter(a => a.isCorrect).length,
               wrongAnswers: sectionAnswers.filter(a => !a.isCorrect).length,
               averageTime: sectionAnswers.length > 0 ? 
                   sectionAnswers.reduce((sum, a) => sum + a.reactionTime, 0) / sectionAnswers.length : 0,
               startTime: testState.sectionStartTimes[sectionKey],
               endTime: testState.sectionEndTimes[sectionKey],
               duration: testState.sectionEndTimes[sectionKey] && testState.sectionStartTimes[sectionKey] ? 
                   testState.sectionEndTimes[sectionKey] - testState.sectionStartTimes[sectionKey] : 0
           };
       }

       // Güvenli navigasyon
       function safeNavigate(functionName, ...args) {
           if (testState.isTransitioning) {
               console.warn('Navigation ignored - already transitioning');
               return;
           }

           testState.isTransitioning = true;

           try {
               if (typeof DikkatTest[functionName] === 'function') {
                   DikkatTest[functionName](...args);
               } else {
                   throw new Error(`Function ${functionName} not found`);
               }
           } catch (e) {
               console.error('Navigation error:', e);
               handleError(`Navigasyon hatası: ${e.message}`, false);
           } finally {
               testState.addTimer(setTimeout(() => {
                   testState.isTransitioning = false;
               }, 500));
           }
       }

       // Ses yönetimi - iyileştirilmiş
       async function preloadAudio(filename) {
           return new Promise((resolve, reject) => {
               if (testState.preloadedAudios.has(filename)) {
                   resolve(testState.preloadedAudios.get(filename));
                   return;
               }

               const audio = new Audio();
               const timeout = testState.addTimer(setTimeout(() => {
                   resolve(null);
               }, CONFIG.AUDIO_PRELOAD_TIMEOUT));

               audio.addEventListener('canplaythrough', () => {
                   clearTimeout(timeout);
                   testState.preloadedAudios.set(filename, audio);
                   console.log(`🔊 Audio loaded: ${filename}`);
                   resolve(audio);
               }, { once: true });

               audio.addEventListener('error', (e) => {
                   clearTimeout(timeout);
                   resolve(null);
               }, { once: true });

               audio.preload = 'auto';
               audio.src = `mp3/${filename}`;
               audio.load();
           });
       }

       async function preloadAudios(filenames) {
           let successCount = 0;
           
           const promises = filenames.map(async (filename) => {
               const audio = await preloadAudio(filename);
               if (audio) {
                   successCount++;
                   return audio;
               }
               return null;
           });

           await Promise.allSettled(promises);
           
           if (successCount > 0) {
               console.log(`✅ Audio System: ${successCount}/${filenames.length} files loaded`);
           } else {
               console.info(`🔇 Audio System: Running silently (no audio files loaded)`);
           }
       }

       async function playAudio(filename, loop = false, volume = 1.0) {
           try {
               testState.stopAllAudio();

               let audio = testState.preloadedAudios.get(filename);
               
               if (!audio) {
                   audio = await preloadAudio(filename);
                   if (!audio) {
                       return Promise.resolve();
                   }
               }

               audio.loop = loop;
               audio.volume = Math.max(0, Math.min(1, volume));
               audio.currentTime = 0;

               testState.currentAudio = audio;

               const playPromise = audio.play();
               if (playPromise !== undefined) {
                   return playPromise.catch(e => Promise.resolve());
               }
               
               return Promise.resolve();
           } catch (e) {
               return Promise.resolve();
           }
       }

       // Ekran değiştirme
       function showScreen(screenId) {
           try {
               document.querySelectorAll('.screen').forEach(screen => {
                   screen.classList.remove('active');
               });

               const targetScreen = safeGetElement(screenId);
               if (!targetScreen) {
                   throw new Error(`Screen not found: ${screenId}`);
               }

               targetScreen.classList.add('active');
               testState.safeSet('currentScreen', screenId);
               
               console.log(`Screen changed to: ${screenId}`);
           } catch (e) {
               handleError(`Ekran değiştirme hatası: ${e.message}`, false);
               throw e;
           }
       }

       // Demo durumları
       function resetDemoStates() {
           try {
               testState.hasSeenIntro = false;
               testState.hasSeenLetter = false;
               
               const elements = [
                   'instructionsNextBtn', 'introNumbers', 'introNextBtn',
                   'letterDisplay', 'letterNextBtn', 'exampleTransitionBtn',
                   'exampleStartBtn', 'exampleCompleteBtn'
               ];

               elements.forEach(id => {
                   const element = safeGetElement(id);
                   if (element) {
                       element.classList.remove('visible');
                   }
               });

               // Seçili butonları temizle (intro ve letter demo)
               const targetButtons = ['target-9-1', 'target-9-2', 'target-c-1', 'target-c-2'];
               targetButtons.forEach(id => {
                   const element = safeGetElement(id);
                   if (element) {
                       element.classList.remove('selected', 'clicked');
                   }
               });

               // Tüm option-btn'leri temizle
               document.querySelectorAll('.option-btn').forEach(btn => {
                   btn.classList.remove('selected', 'clicked', 'disabled');
               });

               console.log('🔄 Demo durumları tamamen sıfırlandı');
           } catch (e) {
               console.error('Reset demo states error:', e);
               handleError(`Demo durumu sıfırlama hatası: ${e.message}`);
           }
       }

       // Button yönetimi
       function showButton(buttonId, delay = 0) {
           const button = safeGetElement(buttonId);
           if (!button) {
               console.warn(`Button not found: ${buttonId}`);
               return;
           }

           if (delay > 0) {
               testState.addTimer(setTimeout(() => {
                   button.classList.add('visible');
                   button.classList.remove('disabled');
               }, delay));
           } else {
               button.classList.add('visible');
               button.classList.remove('disabled');
           }
       }

       function hideButton(buttonId) {
           const button = safeGetElement(buttonId);
           if (button) {
               button.classList.remove('visible');
               button.classList.add('disabled');
           }
       }

       function addAudioEndedListener(audio, callback) {
           const handler = (e) => {
               try {
                   callback(e);
               } catch (error) {
                   console.error('Audio ended callback error:', error);
               }
           };

           audio.addEventListener('ended', handler, { once: true });
           return handler;
       }

       // === MAIN TEST FUNCTIONS - NAMESPACE ALTINDA ===
       
       const DikkatTest = {
           // Navigasyon wrapper
           navigate: safeNavigate,

           // 1. Ses ayarlama
           goToSoundSetup() {
               testState.cleanup();
               showScreen('soundSetupScreen');
               
               let retryCount = 0;
               const playCountingLoop = async () => {
                   try {
                       await playAudio('12345.mp3');
                       
                       if (testState.currentAudio) {
                           addAudioEndedListener(testState.currentAudio, () => {
                               if (testState.currentScreen === 'soundSetupScreen') {
                                   testState.addTimer(setTimeout(playCountingLoop, 1000));
                               }
                           });
                       }
                   } catch (e) {
                       retryCount++;
                       if (retryCount < CONFIG.AUDIO_RETRY_ATTEMPTS) {
                           console.warn(`Audio retry ${retryCount}:`, e);
                           testState.addTimer(setTimeout(playCountingLoop, 1000));
                       } else {
                           console.error('Audio failed after retries:', e);
                           showButton('soundNextBtn', 100);
                       }
                   }
               };
               
               playCountingLoop();
               showButton('soundNextBtn', 2000);
           },

           // 2. Test bilgilendirme
           goToTestInfo() {
               testState.cleanup();
               showScreen('testInfoScreen');
               showButton('testInfoBtn', 500);
           },

           // 3. Talimatlar
           async goToInstructions() {
               testState.cleanup();
               showScreen('instructionsScreen');
               
               try {
                   console.log('🎵 Playing giris.mp3...');
                   const audioPlayed = await playAudio('giris.mp3');
                   
                   if (testState.currentAudio && !testState.currentAudio.paused) {
                       console.log('✅ giris.mp3 başarıyla çalıyor');
                       addAudioEndedListener(testState.currentAudio, () => {
                           console.log('🎵 giris.mp3 tamamlandı');
                           showButton('instructionsNextBtn');
                       });
                   } else {
                       console.warn('⚠️ giris.mp3 çalmadı, button direkt gösteriliyor');
                       showButton('instructionsNextBtn', 500);
                   }
               } catch (e) {
                   console.error('Instructions audio error:', e);
                   showButton('instructionsNextBtn', 1000);
               }
           },

           // 4. Intro demo
           async goToIntroDemo() {
               testState.cleanup();
               showScreen('introDemoScreen');
               
               const numbersDisplay = safeGetElement('introNumbers');
               if (numbersDisplay) {
                   numbersDisplay.classList.add('visible');
               }
               
               if (testState.hasSeenIntro) {
                   showButton('introNextBtn');
                   this.startIntroAnimation();
                   return;
               }
               
               testState.hasSeenIntro = true;
               
               try {
                   console.log('🎵 Playing ornek1.mp3...');
                   const audioPlayed = await playAudio('ornek1.mp3');
                   this.startIntroAnimation();
                   
                   if (testState.currentAudio && !testState.currentAudio.paused) {
                       console.log('✅ ornek1.mp3 başarıyla çalıyor');
                       addAudioEndedListener(testState.currentAudio, () => {
                           console.log('🎵 ornek1.mp3 tamamlandı');
                           showButton('introNextBtn');
                       });
                   } else {
                       console.warn('⚠️ ornek1.mp3 çalmadı, button direkt gösteriliyor');
                       showButton('introNextBtn', 1000);
                   }
               } catch (e) {
                   console.error('Intro demo audio error:', e);
                   this.startIntroAnimation();
                   showButton('introNextBtn', 1000);
               }
           },

           // Intro animasyon
           startIntroAnimation() {
               const cursor = safeGetElement('introCursor');
               const targets = ['target-9-1', 'target-9-2'];
               
               if (!cursor) {
                   console.warn('Intro cursor not found');
                   return;
               }

               let currentTarget = 0;
               let isFirstAnimation = true;
               
               const animateToTarget = () => {
                   const targetElement = safeGetElement(targets[currentTarget]);
                   if (!targetElement) return;

                   const delay = isFirstAnimation ? CONFIG.ANIMATION_DELAY : 0;
                   
                   if (isFirstAnimation) {
                       cursor.style.opacity = '1';
                       cursor.style.left = '50px';
                       cursor.style.top = '50px';
                       cursor.style.transition = 'none';
                       isFirstAnimation = false;
                   }
                   
                   try {
                       const targetRect = targetElement.getBoundingClientRect();
                       const parentRect = targetElement.parentElement.getBoundingClientRect();
                       
                       const targetX = targetRect.left - parentRect.left + (targetElement.offsetWidth / 2) - 10;
                       const targetY = targetRect.top - parentRect.top + (targetElement.offsetHeight / 2) - 10;
                       
                       testState.addTimer(setTimeout(() => {
                           cursor.style.transition = 'left 1s ease-in-out, top 1s ease-in-out';
                           cursor.style.left = targetX + 'px';
                           cursor.style.top = targetY + 'px';
                       }, delay));
                       
                       testState.addTimer(setTimeout(() => {
                           targetElement.classList.add('clicked');
                           
                           testState.addTimer(setTimeout(() => {
                               targetElement.classList.remove('clicked');
                               currentTarget = (currentTarget + 1) % targets.length;
                           }, 1400));
                       }, 1500));
                   } catch (e) {
                       console.error('Animation positioning error:', e);
                   }
               };
               
                          animateToTarget();
           const intervalId = testState.addInterval(setInterval(animateToTarget, 3000));
       },

               // Örnek uygulama tekrar fonksiyonu
        retryExampleFromFail() {
            console.log('🔄 Örnek uygulama tekrar edilecek...');
            
            // Önce tüm animasyonları ve timerlari temizle
            testState.clearAllTimers();
            
            // Agresif button temizleme
            this.forceCleanAllButtons();
            
            // Demo durumlarını sıfırla
            resetDemoStates();
            
            // Intro demo'ya git
            this.goToIntroDemo();
        },

        // Agresif button temizleme fonksiyonu
        forceCleanAllButtons() {
            try {
                // Intro demo butonlarını temizle
                const introContainer = safeGetElement('introNumbers');
                if (introContainer) {
                    const buttons = introContainer.querySelectorAll('.option-btn');
                    buttons.forEach(btn => {
                        btn.classList.remove('selected', 'clicked', 'disabled');
                        btn.style.backgroundColor = '';
                        btn.style.color = '';
                        btn.style.borderColor = '';
                        btn.style.boxShadow = '';
                        btn.style.transform = '';
                    });
                }

                // Letter demo butonlarını temizle
                const letterContainer = safeGetElement('letterDisplay');
                if (letterContainer) {
                    const buttons = letterContainer.querySelectorAll('.option-btn');
                    buttons.forEach(btn => {
                        btn.classList.remove('selected', 'clicked', 'disabled');
                        btn.style.backgroundColor = '';
                        btn.style.color = '';
                        btn.style.borderColor = '';
                        btn.style.boxShadow = '';
                        btn.style.transform = '';
                    });
                }

                // Cursor'ları gizle
                const introCursor = safeGetElement('introCursor');
                const letterCursor = safeGetElement('letterCursor');
                if (introCursor) {
                    introCursor.style.opacity = '0';
                    introCursor.style.left = '50px';
                    introCursor.style.top = '50px';
                }
                if (letterCursor) {
                    letterCursor.style.opacity = '0';
                    letterCursor.style.left = '50px';
                    letterCursor.style.top = '50px';
                }

                console.log('🧹 Tüm butonlar agresif olarak temizlendi');
            } catch (e) {
                console.error('Force clean buttons error:', e);
            }
        },

       // 5. Harf demo
           async goToLetterDemo() {
               testState.cleanup();
               showScreen('letterDemoScreen');
               
               const letterDisplay = safeGetElement('letterDisplay');
               if (letterDisplay) {
                   letterDisplay.classList.add('visible');
               }
               
               if (testState.hasSeenLetter) {
                   showButton('letterNextBtn');
                   this.startLetterAnimation();
                   return;
               }
               
               testState.hasSeenLetter = true;
               
               try {
                   console.log('🎵 Playing ornek2.mp3...');
                   const audioPlayed = await playAudio('ornek2.mp3');
                   this.startLetterAnimation();
                   
                   if (testState.currentAudio && !testState.currentAudio.paused) {
                       console.log('✅ ornek2.mp3 başarıyla çalıyor');
                       addAudioEndedListener(testState.currentAudio, () => {
                           console.log('🎵 ornek2.mp3 tamamlandı');
                           showButton('letterNextBtn');
                       });
                   } else {
                       console.warn('⚠️ ornek2.mp3 çalmadı, button direkt gösteriliyor');
                       showButton('letterNextBtn', 1000);
                   }
               } catch (e) {
                   console.error('Letter demo audio error:', e);
                   this.startLetterAnimation();
                   showButton('letterNextBtn', 1000);
               }
           },

           // Harf animasyon
           startLetterAnimation() {
               const cursor = safeGetElement('letterCursor');
               const targets = ['target-c-1', 'target-c-2'];
               
               if (!cursor) {
                   console.warn('Letter cursor not found');
                   return;
               }

               let currentTarget = 0;
               let isFirstAnimation = true;
               
               const animateToTarget = () => {
                   const targetElement = safeGetElement(targets[currentTarget]);
                   if (!targetElement) return;

                   const delay = isFirstAnimation ? CONFIG.ANIMATION_DELAY : 0;
                   
                   if (isFirstAnimation) {
                       cursor.style.opacity = '1';
                       cursor.style.left = '50px';
                       cursor.style.top = '50px';
                       cursor.style.transition = 'none';
                       isFirstAnimation = false;
                   }
                   
                   try {
                       const targetRect = targetElement.getBoundingClientRect();
                       const parentRect = targetElement.parentElement.getBoundingClientRect();
                       
                       const targetX = targetRect.left - parentRect.left + (targetElement.offsetWidth / 2) - 10;
                       const targetY = targetRect.top - parentRect.top + (targetElement.offsetHeight / 2) - 10;
                       
                       testState.addTimer(setTimeout(() => {
                           cursor.style.transition = 'left 1s ease-in-out, top 1s ease-in-out';
                           cursor.style.left = targetX + 'px';
                           cursor.style.top = targetY + 'px';
                       }, delay));
                       
                       testState.addTimer(setTimeout(() => {
                           targetElement.classList.add('clicked');
                           
                           testState.addTimer(setTimeout(() => {
                               targetElement.classList.remove('clicked');
                               currentTarget = (currentTarget + 1) % targets.length;
                           }, 1400));
                       }, 1500));
                   } catch (e) {
                       console.error('Letter animation error:', e);
                   }
               };
               
               animateToTarget();
               const intervalId = testState.addInterval(setInterval(animateToTarget, 3000));
           },

           // 6. Örnek geçiş
           async goToExampleTransition() {
               testState.cleanup();
               showScreen('exampleTransitionScreen');
               
               try {
                   console.log('🎵 Playing ornekgecis.mp3...');
                   const audioPlayed = await playAudio('ornekgecis.mp3');
                   
                   if (testState.currentAudio && !testState.currentAudio.paused) {
                       console.log('✅ ornekgecis.mp3 başarıyla çalıyor');
                       addAudioEndedListener(testState.currentAudio, () => {
                           console.log('🎵 ornekgecis.mp3 tamamlandı');
                           showButton('exampleTransitionBtn');
                       });
                   } else {
                       console.warn('⚠️ ornekgecis.mp3 çalmadı, button direkt gösteriliyor');
                       showButton('exampleTransitionBtn', 1000);
                   }
               } catch (e) {
                   console.error('Example transition audio error:', e);
                   showButton('exampleTransitionBtn', 1000);
               }
           },

           // 7. Örnek başlangıç
           async goToExampleStart() {
               testState.cleanup();
               showScreen('exampleStartScreen');
               
               try {
                   console.log('🎵 Playing ornekbasla.mp3...');
                   console.log('🔍 Debug: ornekbasla.mp3 preloaded?', testState.preloadedAudios.has('ornekbasla.mp3'));
                   
                   const audioPlayed = await playAudio('ornekbasla.mp3');
                   
                   console.log('🔍 Debug: testState.currentAudio:', testState.currentAudio);
                   console.log('🔍 Debug: currentAudio.paused:', testState.currentAudio?.paused);
                   console.log('🔍 Debug: currentAudio.readyState:', testState.currentAudio?.readyState);
                   console.log('🔍 Debug: currentAudio.networkState:', testState.currentAudio?.networkState);
                   
                   if (testState.currentAudio && !testState.currentAudio.paused) {
                       console.log('✅ ornekbasla.mp3 başarıyla çalıyor');
                       addAudioEndedListener(testState.currentAudio, () => {
                           console.log('🎵 ornekbasla.mp3 tamamlandı');
                           showButton('exampleStartBtn');
                       });
                   } else {
                       console.warn('⚠️ ornekbasla.mp3 çalmadı, button direkt gösteriliyor');
                       console.warn('🔍 Debug: Fallback - zorla audio oluşturup çalmaya çalışıyorum');
                       
                       // Fallback: Yeni audio objesi oluştur ve çal
                       const fallbackAudio = new Audio('mp3/ornekbasla.mp3');
                       fallbackAudio.addEventListener('canplaythrough', () => {
                           console.log('🔍 Fallback audio yüklendi, çalıyor...');
                           fallbackAudio.play().then(() => {
                               console.log('✅ Fallback audio başarıyla çalıyor');
                               testState.currentAudio = fallbackAudio;
                               addAudioEndedListener(fallbackAudio, () => {
                                   console.log('🎵 Fallback ornekbasla.mp3 tamamlandı');
                                   showButton('exampleStartBtn');
                               });
                           }).catch(e => {
                               console.error('❌ Fallback audio play error:', e);
                               showButton('exampleStartBtn', 1000);
                           });
                       });
                       fallbackAudio.addEventListener('error', (e) => {
                           console.error('❌ Fallback audio load error:', e);
                           showButton('exampleStartBtn', 1000);
                       });
                       fallbackAudio.load();
                   }
               } catch (e) {
                   console.error('Example start audio error:', e);
                   showButton('exampleStartBtn', 1000);
               }
           },

           // Geri sayım - DÜZELTİLMİŞ TIMER MANAGEMENT
           showCountdown(testType) {
               testState.cleanup();
               showScreen('countdownScreen');
               
               const numberEl = safeGetElement('countdownNumber');
               if (!numberEl) {
                   if (testType === 'practice') {
                       this.startPracticeTest();
                   } else {
                       this.startMainTest();
                   }
                   return;
               }
               
               let count = 3;
               numberEl.textContent = count;
               
               // FİX: Timer'ı testState ile takip et
               const countdownInterval = setInterval(() => {
                   count--;
                   
                   if (count > 0) {
                       numberEl.textContent = count;
                   } else {
                       clearInterval(countdownInterval);
                       
                       if (testType === 'practice') {
                           DikkatTest.startPracticeTest();
                       } else {
                           DikkatTest.startMainTest();
                       }
                   }
               }, 1000);
               
               // FİX: Bu satır eksikti - memory leak'i düzeltildi
               testState.addInterval(countdownInterval);
           },

           // 8. Pratik test
           startPracticeTest() {
               try {
                   testState.cleanup();
                   showScreen('practiceTestScreen');
                   
                   testState.practiceIndex = 0;
                   testState.practiceAnswers = [];
                   testState.practiceTimeLeft = CONFIG.PRACTICE_TIME_LIMIT;
                   testState.practiceStartTime = Date.now();
                   
                   this.startPracticeTimer();
                   this.showPracticeQuestion();
               } catch (e) {
                   handleError(`Pratik test başlatma hatası: ${e.message}`, false);
               }
           },

           startPracticeTimer() {
               const totalTime = CONFIG.PRACTICE_TIME_LIMIT;
               const progressBar = safeGetElement('practiceProgressBar');
               
               if (!progressBar) {
                   console.error('Practice progress bar not found');
                   return;
               }

               const intervalId = setInterval(() => {
                   testState.practiceTimeLeft -= 1000;
                   
                   const progress = 1 - (testState.practiceTimeLeft / totalTime);
                   progressBar.style.transform = `scaleX(${Math.max(0, Math.min(1, progress))})`;
                   
                   if (testState.practiceTimeLeft <= 0) {
                       clearInterval(intervalId);
                       DikkatTest.endPracticeTest();
                   }
               }, 1000);
               
               testState.addInterval(intervalId);
           },

           showPracticeQuestion() {
               if (testState.practiceIndex >= TEST_DATA.practiceQuestions.length) {
                   this.endPracticeTest();
                   return;
               }

               try {
                   const question = TEST_DATA.practiceQuestions[testState.practiceIndex];
                   const display = safeGetElement('practiceDisplay');
                   
                   if (!display) {
                       throw new Error('Practice display not found');
                   }

                   display.innerHTML = '';
                   display.classList.remove('visible');
                   
                   question.question.forEach((option, index) => {
                       const btn = document.createElement('div');
                       btn.className = 'option-btn';
                       btn.textContent = option;
                       btn.setAttribute('data-option', option);
                       btn.setAttribute('data-target', question.target);
                       
                       const debouncedHandler = debounce((e) => {
                           DikkatTest.selectPracticeAnswer(e, option, question.target);
                       }, CONFIG.DEBOUNCE_DELAY);
                       
                       btn.onclick = debouncedHandler;
                       display.appendChild(btn);
                   });
                   
                   testState.addTimer(setTimeout(() => {
                       display.classList.add('visible');
                   }, 300));
               } catch (e) {
                   console.error('Show practice question error:', e);
                   handleError(`Soru gösterme hatası: ${e.message}`, false);
               }
           },

           selectPracticeAnswer(event, selected, correct) {
               if (testState.locked) {
                   console.warn('Practice answer selection ignored - state locked');
                   return;
               }

               testState.lock();

               try {
                   const buttons = document.querySelectorAll('#practiceDisplay .option-btn');
                   buttons.forEach(btn => {
                       btn.onclick = null;
                       btn.classList.add('disabled');
                       btn.classList.remove('selected');
                   });

                   if (event && event.target) {
                       event.target.classList.add('selected');
                   }
                   
                   testState.practiceAnswers.push({
                       question: testState.practiceIndex,
                       selected: selected,
                       correct: correct,
                       isCorrect: selected === correct,
                       timestamp: Date.now()
                   });
                   
                   testState.practiceIndex++;
                   
                   testState.addTimer(setTimeout(() => {
                       testState.unlock();
                       DikkatTest.showPracticeQuestion();
                   }, 350));
               } catch (e) {
                   testState.unlock();
                   console.error('Select practice answer error:', e);
                   handleError(`Cevap seçimi hatası: ${e.message}`, false);
               }
           },

           endPracticeTest() {
               testState.clearAllTimers();
               
               const correctCount = testState.practiceAnswers.filter(answer => answer.isCorrect).length;
               
               if (correctCount >= CONFIG.MIN_PRACTICE_SCORE) {
                   this.goToExampleComplete();
               } else {
                   showScreen('exampleFailScreen');
               }
           },

           // 9. Örnek tamamlandı
           async goToExampleComplete() {
               testState.cleanup();
               showScreen('exampleCompleteScreen');
               
               try {
                   console.log('🎵 Playing ornekok.mp3...');
                   await playAudio('ornekok.mp3');
                   if (testState.currentAudio && !testState.currentAudio.paused) {
                       console.log('✅ ornekok.mp3 başarıyla çalıyor');
                       addAudioEndedListener(testState.currentAudio, () => {
                           console.log('🎵 ornekok.mp3 tamamlandı');
                           showButton('exampleCompleteBtn');
                       });
                   } else {
                       console.warn('⚠️ ornekok.mp3 çalmadı, button direkt gösteriliyor');
                       showButton('exampleCompleteBtn', 1000);
                   }
               } catch (e) {
                   console.error('Example complete audio error:', e);
                   showButton('exampleCompleteBtn', 1000);
               }
           },

           // 10. Ana test hazırlık
           async goToMainTestIntro() {
               testState.cleanup();
               showScreen('mainTestIntroScreen');
               
               try {
                   await playAudio('testbasla.mp3');
                   if (testState.currentAudio) {
                       addAudioEndedListener(testState.currentAudio, () => {
                           showButton('mainTestIntroBtn');
                       });
                   }
               } catch (e) {
                   console.error('Main test intro audio error:', e);
                   showButton('mainTestIntroBtn', 1000);
               }
           },

           // 11. Ana test
           startMainTest() {
               try {
                   testState.cleanup();
                   showScreen('mainTestScreen');
                   
                                  testState.mainIndex = 0;
               testState.mainAnswers = [];
               testState.mainTimeLeft = CONFIG.MAIN_TIME_LIMIT;
               testState.mainStartTime = Date.now();
               testState.reactionTimes = [];
                   
                   // Test durumu işaretle
                   localStorage.setItem('attentionTestStatus', 'in_progress');
                   localStorage.setItem('attentionTestStartTime', testState.mainStartTime.toString());
                   
                   // İlk bölümü başlat
                   testState.currentSection = getCurrentSection(0);
                   testState.sectionStartTimes['section1'] = Date.now();
                   console.log('🏁 1. BÖLÜM başladı');
                   
                   this.startMainTimer();
                   this.startPeriodicSave(); // Periyodik kayıt başlat
                   this.showMainQuestion();
               } catch (e) {
                   handleError(`Ana test başlatma hatası: ${e.message}`, false);
               }
           },

           // Periyodik ara kayıt sistemi
           startPeriodicSave() {
               const saveInterval = setInterval(() => {
                   if (testState.mainStartTime && testState.mainIndex >= 0 && testState.mainIndex < TEST_DATA.mainQuestions.length) {
                       try {
                           const progressSave = {
                               type: 'periodic_save',
                               savedAt: new Date().toISOString(),
                               currentQuestion: testState.mainIndex + 1, // 1-based
                               completedQuestions: testState.mainIndex,
                               mainAnswers: testState.mainAnswers,
                               reactionTimes: testState.reactionTimes,
                               questionTypeMistakes: testState.questionTypeMistakes,
                               wrongSelections: testState.wrongSelections,
                               testDuration: Date.now() - testState.mainStartTime,
                               currentSection: testState.currentSection ? testState.currentSection.key : null,
                               sectionProgress: {
                                   section1: getSectionStats('section1'),
                                   section2: getSectionStats('section2'),
                                   section3: getSectionStats('section3')
                               }
                           };
                           
                           localStorage.setItem('attentionTestProgressSave', JSON.stringify(progressSave));
                           console.log(`🔄 Periyodik kayıt: ${testState.mainIndex + 1}/50 soru`);
                       } catch (e) {
                           console.warn('Periodic save failed:', e);
                       }
                   } else {
                       // Test bitmiş veya başlamamış, interval'ı temizle
                       clearInterval(saveInterval);
                       console.log('⏹️ Periyodik kayıt durduruldu');
                   }
               }, 10000); // Her 10 saniyede bir kaydet
               
               testState.addInterval(saveInterval);
           },

           startMainTimer() {
               const totalTime = CONFIG.MAIN_TIME_LIMIT;
               const progressBar = safeGetElement('mainProgressBar');
               
               if (!progressBar) {
                   console.error('Main progress bar not found');
                   return;
               }

               const intervalId = setInterval(() => {
                   testState.mainTimeLeft -= 1000;
                   
                   const progress = 1 - (testState.mainTimeLeft / totalTime);
                   progressBar.style.transform = `scaleX(${Math.max(0, Math.min(1, progress))})`;
                   
                   if (testState.mainTimeLeft <= 0) {
                       clearInterval(intervalId);
                       
                       // ⏰ ZAMAN AŞIMI LOGLAMA
                       const currentSection = getCurrentSection(testState.mainIndex);
                       console.log('⏰ TEST SÜRESİ DOLDU:', {
                           tamamlananSoru: testState.mainIndex,
                           toplamSoru: TEST_DATA.mainQuestions.length,
                           mevcutBolum: currentSection ? currentSection.name : 'Bilinmeyen',
                           dogruSayisi: testState.mainAnswers.filter(a => a.isCorrect).length,
                           yanlisSayisi: testState.mainAnswers.filter(a => !a.isCorrect).length,
                           gecenSure: `${Math.round((Date.now() - testState.mainStartTime) / 1000)} saniye`,
                           bitisZamani: new Date().toLocaleTimeString('tr-TR')
                       });
                       
                       DikkatTest.endMainTest();
                   }
               }, 1000);
               
               testState.addInterval(intervalId);
           },

           showMainQuestion() {
               if (testState.mainIndex >= TEST_DATA.mainQuestions.length) {
                   this.endMainTest();
                   return;
               }

               try {
                   const question = TEST_DATA.mainQuestions[testState.mainIndex];
                   const currentSection = getCurrentSection(testState.mainIndex);
                   const questionType = getQuestionType(testState.mainIndex);
                   
                   console.log(`📋 Soru ${testState.mainIndex + 1}/${TEST_DATA.mainQuestions.length} gösteriliyor`);
                   
                   const display = safeGetElement('mainDisplay');
                   
                   if (!display) {
                       throw new Error('Main display not found');
                   }

                   display.innerHTML = '';
                   display.classList.remove('visible');
                   
                   question.question.forEach((option, index) => {
                       const btn = document.createElement('div');
                       btn.className = 'option-btn';
                       btn.textContent = option;
                       btn.setAttribute('data-option', option);
                       btn.setAttribute('data-target', question.target);
                       
                       const debouncedHandler = debounce((e) => {
                           DikkatTest.selectMainAnswer(e, option, question.target);
                       }, CONFIG.DEBOUNCE_DELAY);
                       
                       btn.onclick = debouncedHandler;
                       display.appendChild(btn);
                   });
                   
                   testState.questionStartTime = Date.now();
                   
                   testState.addTimer(setTimeout(() => {
                       display.classList.add('visible');
                   }, 300));
               } catch (e) {
                   console.error('Show main question error:', e);
                   handleError(`Ana test soru hatası: ${e.message}`, false);
               }
           },

           selectMainAnswer(event, selected, correct) {
               if (testState.locked) {
                   console.warn('Main answer selection ignored - state locked');
                   return;
               }

               testState.lock();

               try {
                   const reactionTime = Date.now() - testState.questionStartTime;
                   const currentQuestionIndex = testState.mainIndex;
                   const isCorrect = selected === correct;
                   const questionType = getQuestionType(currentQuestionIndex);
                   const currentSection = getCurrentSection(currentQuestionIndex);
                   
                   testState.reactionTimes.push(reactionTime);
                   
                   const buttons = document.querySelectorAll('#mainDisplay .option-btn');
                   buttons.forEach(btn => {
                       btn.onclick = null;
                       btn.classList.add('disabled');
                       btn.classList.remove('selected');
                   });

                   if (event && event.target) {
                       event.target.classList.add('selected');
                   }
                   
                   // Detaylı cevap kayıt
                   const answerData = {
                       question: currentQuestionIndex,
                       selected: selected,
                       correct: correct,
                       isCorrect: isCorrect,
                       reactionTime: reactionTime,
                       timestamp: Date.now(),
                       questionType: questionType,
                       sectionKey: currentSection ? currentSection.key : null,
                       sectionName: currentSection ? currentSection.name : null
                   };
                   
                   // 📝 HER SORU İÇİN DETAYLI LOGLAMA
                   console.log(`📝 SORU ${currentQuestionIndex + 1}/${TEST_DATA.mainQuestions.length}:`, {
                       soruNumarasi: currentQuestionIndex + 1,
                       bolum: currentSection ? currentSection.name : 'Bilinmeyen',
                       soruTipi: questionType === 's' ? 'Sayı' : questionType === 'h' ? 'Harf' : 'Karma (s/h)',
                       soruIcerigi: TEST_DATA.mainQuestions[currentQuestionIndex].question.join('-'),
                       kullaniciSecimi: selected,
                       dogruCevap: correct,
                       durum: isCorrect ? '✅ DOĞRU' : '❌ YANLIŞ',
                       tepkiSuresi: `${reactionTime}ms`,
                       zaman: new Date().toLocaleTimeString('tr-TR')
                   });
                   
                   testState.mainAnswers.push(answerData);
                   
                   // Tür bazlı istatistik güncelle
                   if (testState.questionTypeMistakes[questionType]) {
                       if (isCorrect) {
                           testState.questionTypeMistakes[questionType].correct++;
                       } else {
                           testState.questionTypeMistakes[questionType].wrong++;
                           // Yanlış seçimi kaydet
                           testState.wrongSelections.push({
                               question: currentQuestionIndex,
                               selectedWrong: selected,
                               correctAnswer: correct,
                               questionType: questionType,
                               timestamp: Date.now()
                           });
                       }
                   }
                   
                   testState.mainIndex++;
                   
                   // Bölüm geçiş kontrolü
                   const nextSection = getCurrentSection(testState.mainIndex);
                   if (nextSection && nextSection.key !== currentSection?.key) {
                       // Mevcut bölümü bitir
                       if (currentSection) {
                           testState.sectionEndTimes[currentSection.key] = Date.now();
                           
                           // 🏁 BÖLÜM TAMAMLANDI LOGLAMA
                           const sectionStats = getSectionStats(currentSection.key);
                           const sectionDuration = Math.round((testState.sectionEndTimes[currentSection.key] - testState.sectionStartTimes[currentSection.key]) / 1000);
                           
                           console.log(`🏁 ${currentSection.name} TAMAMLANDI:`, {
                               bolumAdi: currentSection.name,
                               toplamSoru: sectionStats.totalQuestions,
                               cevaplanmisSoru: sectionStats.answeredQuestions,
                               dogruSayisi: sectionStats.correctAnswers,
                               yanlisSayisi: sectionStats.wrongAnswers,
                               basariOrani: `${Math.round((sectionStats.correctAnswers / sectionStats.totalQuestions) * 100)}%`,
                               ortalamaTepkiSuresi: `${Math.round(sectionStats.averageTime)}ms`,
                               bolumSuresi: `${sectionDuration} saniye`,
                               tamamlanmaZamani: new Date().toLocaleTimeString('tr-TR')
                           });
                           
                           console.log(`✅ ${currentSection.name} tamamlandı`);
                       }
                       
                       // Yeni bölümü başlat
                       testState.currentSection = nextSection;
                       testState.sectionStartTimes[nextSection.key] = Date.now();
                       
                       // 🚀 YENİ BÖLÜM BAŞLADI LOGLAMA
                       console.log(`🚀 ${nextSection.name} BAŞLADI:`, {
                           bolumAdi: nextSection.name,
                           baslangicSorusu: nextSection.start + 1,
                           bitisSorusu: nextSection.end + 1,
                           toplamSoru: nextSection.end - nextSection.start + 1,
                           baslangicZamani: new Date().toLocaleTimeString('tr-TR')
                       });
                       
                       console.log(`🏁 ${nextSection.name} başladı`);
                   }
                   
                   testState.addTimer(setTimeout(() => {
                       testState.unlock();
                       DikkatTest.showMainQuestion();
                   }, 350));
               } catch (e) {
                   testState.unlock();
                   console.error('Select main answer error:', e);
                   handleError(`Ana test cevap hatası: ${e.message}`, false);
               }
           },

           // Ana test bitir
           async endMainTest() {
               // 🎊 TEST BİTİŞ DURUMU LOGLAMA
               const testDuration = Date.now() - testState.mainStartTime;
               const completionRate = (testState.mainIndex / TEST_DATA.mainQuestions.length) * 100;
               const currentAnswers = testState.mainAnswers.length;
               const correctAnswers = testState.mainAnswers.filter(a => a.isCorrect).length;
               
               console.log('🎊 DİKKAT TESTİ SONA ERDİ:', {
                   bitisNedeni: testState.mainIndex >= TEST_DATA.mainQuestions.length ? 'Tüm sorular tamamlandı' : 'Süre doldu',
                   tamamlananSoru: testState.mainIndex,
                   toplamSoru: TEST_DATA.mainQuestions.length,
                   tamamlanmaOrani: `${Math.round(completionRate)}%`,
                   cevaplananSoru: currentAnswers,
                   dogruCevap: correctAnswers,
                   yanlisCevap: currentAnswers - correctAnswers,
                   gecenSure: `${Math.round(testDuration / 1000)} saniye`,
                   mevcutBolum: testState.currentSection ? testState.currentSection.name : 'Tamamlandı',
                   bitisZamani: new Date().toLocaleTimeString('tr-TR')
               });
               
               testState.clearAllTimers();
               
               // Son bölümü bitir (eğer devam ediyorsa)
               if (testState.currentSection) {
                   testState.sectionEndTimes[testState.currentSection.key] = Date.now();
                   console.log(`✅ ${testState.currentSection.name} tamamlandı (test sonu)`);
               }
               
               // Yarıda kalma durumu kontrol et
               if (testState.mainIndex < TEST_DATA.mainQuestions.length) {
                   testState.incompleteAtQuestion = testState.mainIndex + 1; // 1-based
                   console.log(`⚠️ Test ${testState.incompleteAtQuestion}. soruda kaldı`);
               }
               
               showScreen('resultsScreen');
               
               try {
                   await playAudio('testok.mp3');
                   this.calculateResults();
               } catch (e) {
                   console.error('End main test audio error:', e);
                   this.calculateResults();
               }
           },

           // Sonuç hesaplama - EXCEL UYUMLU DETAYLI VERSİYON
           calculateResults() {
               try {
                   const totalTestDuration = Date.now() - testState.mainStartTime;
                   const maxPossibleTime = CONFIG.MAIN_TIME_LIMIT;
                   
                   // Temel istatistikler
                   const basicStats = {
                       practiceScore: testState.practiceAnswers.filter(a => a.isCorrect).length,
                       practiceTotal: testState.practiceAnswers.length,
                       mainScore: testState.mainAnswers.filter(a => a.isCorrect).length,
                       mainTotal: testState.mainAnswers.length,
                       averageReactionTime: testState.reactionTimes.length > 0 ? 
                           testState.reactionTimes.reduce((a, b) => a + b, 0) / testState.reactionTimes.length : 0,
                       testDuration: totalTestDuration,
                       completedAt: new Date().toISOString(),
                       incompleteAtQuestion: testState.incompleteAtQuestion
                   };
                   
                   // Bölüm bazlı istatistikler - EXCEL FORMATINA UYGUN
                   const sectionStats = {
                       section1: getSectionStats('section1'),
                       section2: getSectionStats('section2'), 
                       section3: getSectionStats('section3')
                   };
                   
                   // Tür bazlı istatistikler (s/h/s_h)
                   const typeStats = {
                       numberQuestions: {
                           correct: testState.questionTypeMistakes['s'].correct,
                           wrong: testState.questionTypeMistakes['s'].wrong,
                           accuracy: testState.questionTypeMistakes['s'].correct + testState.questionTypeMistakes['s'].wrong > 0 ?
                               (testState.questionTypeMistakes['s'].correct / (testState.questionTypeMistakes['s'].correct + testState.questionTypeMistakes['s'].wrong)) * 100 : 0
                       },
                       letterQuestions: {
                           correct: testState.questionTypeMistakes['h'].correct,
                           wrong: testState.questionTypeMistakes['h'].wrong,
                           accuracy: testState.questionTypeMistakes['h'].correct + testState.questionTypeMistakes['h'].wrong > 0 ?
                               (testState.questionTypeMistakes['h'].correct / (testState.questionTypeMistakes['h'].correct + testState.questionTypeMistakes['h'].wrong)) * 100 : 0
                       },
                       mixedQuestions: {
                           correct: testState.questionTypeMistakes['s/h'].correct,
                           wrong: testState.questionTypeMistakes['s/h'].wrong,
                           accuracy: testState.questionTypeMistakes['s/h'].correct + testState.questionTypeMistakes['s/h'].wrong > 0 ?
                               (testState.questionTypeMistakes['s/h'].correct / (testState.questionTypeMistakes['s/h'].correct + testState.questionTypeMistakes['s/h'].wrong)) * 100 : 0
                       }
                   };
                   
                   // EXCEL için hız puanı hesaplama: (Max Süre - Kendi Süresi) / Max Süre x 100
                   const speedScore = totalTestDuration < maxPossibleTime ? 
                       ((maxPossibleTime - totalTestDuration) / maxPossibleTime) * 100 : 0;
                   
                   // Doğruluk skoru: Doğru Sayısı / Toplam Soru x 100
                   const accuracyScore = (basicStats.mainScore / basicStats.mainTotal) * 100;
                   
                   // EXCEL BEKLENTİSİNE UYGUN DETAYLI SONUÇLAR
                   const detailedResults = {
                       // Ham veri
                       rawData: {
                           ...basicStats,
                           speedScore: Math.round(speedScore * 100) / 100,
                           accuracyScore: Math.round(accuracyScore * 100) / 100
                       },
                       
                       // Bölüm analizleri (1, 2, 3. bölüm)
                       sections: {
                           section1: {
                               name: "1. BÖLÜM",
                               correctCount: sectionStats.section1.correctAnswers,
                               wrongCount: sectionStats.section1.wrongAnswers,
                               totalCount: sectionStats.section1.totalQuestions,
                               accuracy: sectionStats.section1.totalQuestions > 0 ? 
                                   (sectionStats.section1.correctAnswers / sectionStats.section1.totalQuestions) * 100 : 0,
                               duration: sectionStats.section1.duration,
                               averageTimePerQuestion: sectionStats.section1.averageTime,
                               completed: sectionStats.section1.answeredQuestions === sectionStats.section1.totalQuestions
                           },
                           section2: {
                               name: "2. BÖLÜM", 
                               correctCount: sectionStats.section2.correctAnswers,
                               wrongCount: sectionStats.section2.wrongAnswers,
                               totalCount: sectionStats.section2.totalQuestions,
                               accuracy: sectionStats.section2.totalQuestions > 0 ? 
                                   (sectionStats.section2.correctAnswers / sectionStats.section2.totalQuestions) * 100 : 0,
                               duration: sectionStats.section2.duration,
                               averageTimePerQuestion: sectionStats.section2.averageTime,
                               completed: sectionStats.section2.answeredQuestions === sectionStats.section2.totalQuestions
                           },
                           section3: {
                               name: "3. BÖLÜM",
                               correctCount: sectionStats.section3.correctAnswers,
                               wrongCount: sectionStats.section3.wrongAnswers, 
                               totalCount: sectionStats.section3.totalQuestions,
                               accuracy: sectionStats.section3.totalQuestions > 0 ? 
                                   (sectionStats.section3.correctAnswers / sectionStats.section3.totalQuestions) * 100 : 0,
                               duration: sectionStats.section3.duration,
                               averageTimePerQuestion: sectionStats.section3.averageTime,
                               completed: sectionStats.section3.answeredQuestions === sectionStats.section3.totalQuestions
                           }
                       },
                       
                       // Soru türü analizleri
                       questionTypes: typeStats,
                       
                       // Hata detayları
                       errorDetails: {
                           wrongSelections: testState.wrongSelections,
                           numberTypeErrors: testState.wrongSelections.filter(w => w.questionType === 's'),
                           letterTypeErrors: testState.wrongSelections.filter(w => w.questionType === 'h'),
                           mixedTypeErrors: testState.wrongSelections.filter(w => w.questionType === 's/h')
                       },
                       
                       // Soru bazlı detay veriler (tüm cevaplar)
                       questionDetails: testState.mainAnswers,
                       
                       // Excel formatı için özet
                       excelSummary: {
                           totalCorrect: basicStats.mainScore,
                           totalWrong: basicStats.mainTotal - basicStats.mainScore,
                           accuracyPercentage: accuracyScore,
                           speedScorePercentage: speedScore,
                           testDurationSeconds: Math.round(totalTestDuration / 1000),
                           averageReactionTimeMs: Math.round(basicStats.averageReactionTime),
                           incompleteAtQuestion: testState.incompleteAtQuestion,
                           completionStatus: testState.incompleteAtQuestion ? 'incomplete' : 'completed'
                       }
                   };

                   // Sonuçları kaydet ve durumu güncelle
                   localStorage.setItem('attentionTestResults', JSON.stringify(detailedResults));
                   localStorage.setItem('attentionTestStatus', 'completed');
                   
                   // Ara kayıt dosyalarını temizle (test başarıyla bitti)
                   localStorage.removeItem('attentionTestResults_INCOMPLETE');
                   localStorage.removeItem('attentionTestAutoSave');
                   localStorage.removeItem('attentionTestProgressSave');
                   
                   // Role'e göre konsol çıktısı sınırla
                   const isStudentTest = this.checkIfStudentTest();
                   
                   if (!isStudentTest) {
                       // Yönetici roller için detaylı konsol çıktısı
                       console.log('📊 DİKKAT TESTİ SONUÇLARI:');
                       console.log(`✅ Doğru: ${basicStats.mainScore}/${basicStats.mainTotal} (${Math.round(accuracyScore)}%)`);
                       console.log(`⚡ Hız Puanı: ${Math.round(speedScore)}%`);
                       console.log(`⏱️ Süre: ${Math.round(totalTestDuration/1000)} saniye`);
                       console.log(`📋 1.Bölüm: ${sectionStats.section1.correctAnswers}/${sectionStats.section1.totalQuestions}`);
                       console.log(`📋 2.Bölüm: ${sectionStats.section2.correctAnswers}/${sectionStats.section2.totalQuestions}`);
                       console.log(`📋 3.Bölüm: ${sectionStats.section3.correctAnswers}/${sectionStats.section3.totalQuestions}`);
                       console.log(`🔢 Sayı soruları: ${typeStats.numberQuestions.correct}/${typeStats.numberQuestions.correct + typeStats.numberQuestions.wrong}`);
                       console.log(`🔤 Harf soruları: ${typeStats.letterQuestions.correct}/${typeStats.letterQuestions.correct + typeStats.letterQuestions.wrong}`);
                       console.log('Full results:', detailedResults);
                   } else {
                       // Kullanıcı için sınırlı konsol çıktısı
                       console.log('✅ Test tamamlandı!');
                       console.log('📝 Verileriniz kaydediliyor...');
                   }
                   
                   // 🎉 DETAYLI FİNAL SONUÇLAR (Sadece Yönetici Roller için)
                   if (!isStudentTest) {
                       console.log('🎉 DİKKAT TESTİ DETAYLI SONUÇLAR:');
                       
                       // Genel Performans
                       console.log('🎯 GENEL PERFORMANS:', {
                           toplamDogruSayisi: basicStats.mainScore,
                           toplamSoruSayisi: basicStats.mainTotal,
                           dogrulukOrani: `${Math.round(accuracyScore)}%`,
                           hizPuani: `${Math.round(speedScore)}%`,
                           ortalamaTepkiSuresi: `${Math.round(basicStats.averageReactionTime)}ms`,
                           toplamTestSuresi: `${Math.round(totalTestDuration/1000)} saniye`,
                           testTamamlanmaZamani: new Date().toLocaleTimeString('tr-TR')
                       });
                       
                       // Bölüm Bazlı Detaylar
                       console.log('📋 BÖLÜM BAZLI PERFORMANS:');
                       Object.keys(sectionStats).forEach((key, index) => {
                           const section = sectionStats[key];
                           console.log(`  ${index + 1}. BÖLÜM:`, {
                               dogru: section.correctAnswers,
                               yanlis: section.wrongAnswers,
                               toplam: section.totalQuestions,
                               basariOrani: `${Math.round((section.correctAnswers / section.totalQuestions) * 100)}%`,
                               ortalamaSure: `${Math.round(section.averageTime)}ms`,
                               bolumSuresi: `${Math.round(section.duration / 1000)} saniye`
                           });
                       });
                       
                       // Soru Türü Bazlı Detaylar
                       console.log('🔍 SORU TÜRÜ BAZLI PERFORMANS:');
                       console.log('  🔢 SAYI SORULARI:', {
                           dogru: typeStats.numberQuestions.correct,
                           yanlis: typeStats.numberQuestions.wrong,
                           toplam: typeStats.numberQuestions.correct + typeStats.numberQuestions.wrong,
                           basariOrani: `${Math.round(typeStats.numberQuestions.accuracy)}%`
                       });
                       console.log('  🔤 HARF SORULARI:', {
                           dogru: typeStats.letterQuestions.correct,
                           yanlis: typeStats.letterQuestions.wrong,
                           toplam: typeStats.letterQuestions.correct + typeStats.letterQuestions.wrong,
                           basariOrani: `${Math.round(typeStats.letterQuestions.accuracy)}%`
                       });
                       console.log('  🔀 KARMA SORULAR:', {
                           dogru: typeStats.mixedQuestions.correct,
                           yanlis: typeStats.mixedQuestions.wrong,
                           toplam: typeStats.mixedQuestions.correct + typeStats.mixedQuestions.wrong,
                           basariOrani: `${Math.round(typeStats.mixedQuestions.accuracy)}%`
                       });
                       
                       // Excel Veri Uyumluluğu
                       console.log('📊 EXCEL VERİ UYUMLULUĞU:');
                       console.log('  ✅ Toplanan Veriler:', {
                           soruNumaralari: '1-50 (tam)',
                           bolumBilgisi: '3 bölüm (tam)',
                           harfSayiKodu: 's/h/s_h (tam)',
                           seiciDikkatPuani: 'Ham veri (tam)',
                           dogrulukSkoru: `${Math.round(accuracyScore)}% (hesaplandı)`,
                           islemHizi: 'Tepki süreleri (tam)',
                           islemHiziSkoru: `${Math.round(speedScore)}% (hesaplandı)`
                       });
                       
                       // Veritabanına Gönderilecek Veriler
                       console.log('📦 VERİTABANINA GÖNDERİLECEK VERİLER:', detailedResults);
                   }
                   
                   // 🎯 DATABASE MAPPING FONKSİYONU - %100 UYUMLULUK
                   const databaseMappedResults = this.mapResultsToDatabase(detailedResults);
                   
                   // Database formatında kaydet
                   localStorage.setItem('attentionTestResults_DatabaseFormat', JSON.stringify(databaseMappedResults));
                   
                   console.log('🎯 DATABASE UYUMLU SONUÇLAR:', databaseMappedResults);
                   console.log('✅ Database mapping tamamlandı - %100 uyumluluk sağlandı');
                   
                   // 🚀 SUPABASE PRODUCTION'A KAYDET
                   if (databaseMappedResults) {
                       this.saveToSupabaseProduction(databaseMappedResults);
                   }
                   
               } catch (e) {
                   console.error('Calculate results error:', e);
                   handleError(`Sonuç hesaplama hatası: ${e.message}`);
               }
           },

           // 🎯 DATABASE MAPPING FONKSİYONU - HTML → DATABASE
           mapResultsToDatabase(htmlResults) {
               try {
                   const { rawData, sections, questionTypes, errorDetails, questionDetails } = htmlResults;
                   
                   console.log('🔄 HTML → Database mapping başlatılıyor...');
                   
                   // Tepki sürelerini al (testState'den)
                   const reactionTimesArray = testState.reactionTimes || [];
                   console.log(`📊 Reaction times bulundu: ${reactionTimesArray.length} adet`);
                   
                   const mappedData = {
                       // ✅ TEMEL VERİLER - Mapping ile
                       total_questions_attempted: rawData.mainTotal || 0,
                       total_correct_answers: rawData.mainScore || 0,
                       accuracy_percentage: Math.round((rawData.accuracyScore || 0) * 100) / 100,
                       speed_score: Math.round((rawData.speedScore || 0) * 100) / 100,
                       average_reaction_time: Math.round(rawData.averageReactionTime || 0),
                       test_duration_seconds: Math.round((rawData.testDuration || 0) / 1000), // ms → saniye
                       completion_status: rawData.incompleteAtQuestion ? 'incomplete' : 'completed',
                       
                       // ✅ BÖLÜM VERİLERİ - Mapping ile
                       section1_correct: sections?.section1?.correctCount || 0,
                       section1_total: sections?.section1?.totalCount || 0,
                       section1_accuracy: Math.round((sections?.section1?.accuracy || 0) * 100) / 100,
                       
                       section2_correct: sections?.section2?.correctCount || 0,
                       section2_total: sections?.section2?.totalCount || 0,
                       section2_accuracy: Math.round((sections?.section2?.accuracy || 0) * 100) / 100,
                       
                       section3_correct: sections?.section3?.correctCount || 0,
                       section3_total: sections?.section3?.totalCount || 0,
                       section3_accuracy: Math.round((sections?.section3?.accuracy || 0) * 100) / 100,
                       
                       // ✅ SORU TİPİ VERİLERİ - Doğrudan uyumlu
                       number_questions_correct: questionTypes?.numberQuestions?.correct || 0,
                       number_questions_total: (questionTypes?.numberQuestions?.correct || 0) + (questionTypes?.numberQuestions?.wrong || 0),
                       number_questions_accuracy: Math.round((questionTypes?.numberQuestions?.accuracy || 0) * 100) / 100,
                       
                       letter_questions_correct: questionTypes?.letterQuestions?.correct || 0,
                       letter_questions_total: (questionTypes?.letterQuestions?.correct || 0) + (questionTypes?.letterQuestions?.wrong || 0),
                       letter_questions_accuracy: Math.round((questionTypes?.letterQuestions?.accuracy || 0) * 100) / 100,
                       
                       mixed_questions_correct: questionTypes?.mixedQuestions?.correct || 0,
                       mixed_questions_total: (questionTypes?.mixedQuestions?.correct || 0) + (questionTypes?.mixedQuestions?.wrong || 0),
                       mixed_questions_accuracy: Math.round((questionTypes?.mixedQuestions?.accuracy || 0) * 100) / 100,
                       
                       // ✅ JSONB VERİLER - Mapping ile
                       detailed_answers: questionDetails || [],
                       wrong_answers: errorDetails?.wrongSelections || [],
                       reaction_times: reactionTimesArray,
                       
                       // ✅ ZAMAN DAMGALARI
                       test_start_time: new Date(Date.now() - (rawData.testDuration || 0)).toISOString(),
                       test_end_time: new Date().toISOString(),
                       
                       // ✅ METAVERİ
                       notes: `Dikkat testi - ${rawData.incompleteAtQuestion ? 'Yarıda kesildi' : 'Tamamlandı'}`
                   };
                   
                   // Validation - Kritik alanları kontrol et
                   const validationResults = {
                       totalQuestions: mappedData.total_questions_attempted > 0,
                       hasCorrectAnswers: mappedData.total_correct_answers >= 0,
                       hasAccuracy: mappedData.accuracy_percentage >= 0,
                       hasSpeed: mappedData.speed_score >= 0,
                       hasSections: mappedData.section1_total > 0 || mappedData.section2_total > 0 || mappedData.section3_total > 0,
                       hasQuestionTypes: mappedData.number_questions_total > 0 || mappedData.letter_questions_total > 0 || mappedData.mixed_questions_total > 0,
                       hasReactionTimes: reactionTimesArray.length > 0
                   };
                   
                   console.log('🔍 DATABASE MAPPING VALIDATION:');
                   console.log('  ✅ Temel veriler:', validationResults.totalQuestions && validationResults.hasCorrectAnswers);
                   console.log('  ✅ Doğruluk-Hız:', validationResults.hasAccuracy && validationResults.hasSpeed);
                   console.log('  ✅ Bölümler:', validationResults.hasSections);
                   console.log('  ✅ Soru tipleri:', validationResults.hasQuestionTypes);
                   console.log('  ✅ Tepki süreleri:', validationResults.hasReactionTimes);
                   
                   // Mapping özeti
                   console.log('📋 MAPPING ÖZETİ:');
                   console.log(`  🔢 Toplam soru: ${mappedData.total_questions_attempted}`);
                   console.log(`  ✅ Doğru: ${mappedData.total_correct_answers}`);
                   console.log(`  📊 Doğruluk: %${mappedData.accuracy_percentage}`);
                   console.log(`  ⚡ Hız puanı: %${mappedData.speed_score}`);
                   console.log(`  ⏱️ Süre: ${mappedData.test_duration_seconds} saniye`);
                   console.log(`  🎯 Tepki sayısı: ${reactionTimesArray.length}`);
                   console.log(`  📂 Detay cevap: ${mappedData.detailed_answers.length} adet`);
                   console.log(`  ❌ Yanlış cevap: ${mappedData.wrong_answers.length} adet`);
                   
                                       return mappedData;
                    
                } catch (error) {
                    console.error('❌ Database mapping hatası:', error);
                    return null;
                }
            },

            // 👤 KULLANICI TEST KONTROLÜ
            checkIfStudentTest() {
                try {
                    // URL'de kullanıcı parametresi var mı?
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.has('kullanici') || urlParams.has('userMode')) {
                        return true;
                    }
                    
                    // localStorage'da kullanıcı flag'i var mı?
                    if (localStorage.getItem('userMode') === 'kullanici') {
                        return true;
                    }
                    
                    // Default olarak false (yönetici mode)
                    return false;
                } catch (error) {
                    return false;
                }
            },

            // 🎯 KULLANICI ROLÜ BELİRLEME FONKSİYONU
            getUserRole(roles) {
                if (!roles || !Array.isArray(roles)) {
                    return 'kullanici'; // Default role
                }
                
                // Priority order: admin > temsilci > beyin_antrenoru > kullanici
                if (roles.includes('admin')) return 'admin';
                if (roles.includes('temsilci')) return 'temsilci';
                if (roles.includes('beyin_antrenoru')) return 'beyin_antrenoru';
                if (roles.includes('kullanici')) return 'kullanici';
                
                return 'kullanici'; // Fallback
            },

            // 🏷️ ROL DISPLAY ETİKETLERİ
            getDisplayLabel(role) {
                const labels = {
                    'admin': 'Sistem Yöneticisi',
                    'temsilci': 'Temsilci',
                    'beyin_antrenoru': 'Beyin Antrenörü',
                    'kullanici': 'Kullanıcı'
                };
                return labels[role] || role;
            },

            // 🔍 GEÇERLİ KULLANICI ID BULMA FONKSİYONU (YENİ UNIFIED SYSTEM)
            async findValidStudentId() {
                try {
                    const supabase = window.supabase.createClient(
                        'https://gamjzzomkosvqhficabt.supabase.co',
                        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhbWp6em9ta29zdnFoZmljYWJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4ODc3MDAsImV4cCI6MjA2ODQ2MzcwMH0.r8KkywdhNSP1hxzSAlKo8SB5jOEb0KQRUBfZ9Va0p9I'
                    );
                    
                    // Aktif kullanıcıyı al
                    const { data: { user } } = await supabase.auth.getUser();
                    
                    if (user) {
                        // Kullanıcı bilgilerini al
                        const { data: userData } = await supabase
                            .from('users')
                            .select('id, roles, first_name, last_name')
                            .eq('auth_user_id', user.id)
                            .single();
                            
                        if (userData) {
                            const userRole = this.getUserRole(userData.roles);
                            console.log(`👤 Aktif kullanıcı: ${userData.first_name} ${userData.last_name} (${this.getDisplayLabel(userRole)})`);
                            
                            if (userRole === 'kullanici') {
                                // Kullanıcı rolü ise kendi ID'sini kullan
                                console.log('✅ Kullanıcı kendi testini yapıyor:', userData.id);
                                localStorage.setItem('currentStudentId', userData.id);
                                return userData.id;
                            } else {
                                // Admin/Temsilci/Beyin Antrenörü ise seçilen kullanıcı ID'sini al
                                const selectedUserId = localStorage.getItem('selectedUserId') || 
                                                     new URLSearchParams(window.location.search).get('userId');
                                
                                if (selectedUserId) {
                                    // Seçilen kullanıcının geçerli olduğunu kontrol et
                                    const { data: selectedUser } = await supabase
                                        .from('users')
                                        .select('id, first_name, last_name, roles')
                                        .eq('id', selectedUserId)
                                        .single();
                                        
                                    if (selectedUser && selectedUser.roles.includes('kullanici')) {
                                        console.log(`✅ ${this.getDisplayLabel(userRole)} seçilen kullanıcı için test yapıyor: ${selectedUser.first_name} ${selectedUser.last_name}`);
                                        localStorage.setItem('currentStudentId', selectedUserId);
                                        return selectedUserId;
                                    }
                                }
                                
                                console.warn(`⚠️ ${this.getDisplayLabel(userRole)} için test yapılacak kullanıcı seçilmemiş`);
                                return null;
                            }
                        }
                    }
                    
                    // Fallback: localStorage'dan al
                    let studentId = localStorage.getItem('currentStudentId');
                    
                    if (studentId) {
                        const { data: user } = await supabase
                            .from('users')
                            .select('id, first_name, last_name')
                            .eq('id', studentId)
                            .single();
                            
                        if (user) {
                            console.log('✅ localStorage\'dan kullanıcı ID geçerli:', `${user.first_name} ${user.last_name}`);
                            return studentId;
                        }
                    }
                    
                    console.warn('⚠️ Geçerli kullanıcı ID bulunamadı - Test çalışır ama kaydedilemez');
                    return null;
                    
                } catch (error) {
                    console.error('❌ Kullanıcı ID bulma hatası:', error);
                    return null;
                }
            },

            // 🚀 SUPABASE PRODUCTION KAYIT FONKSİYONU
            async saveToSupabaseProduction(mappedData) {
                try {
                    console.log('🚀 Supabase Production kayıt başlatılıyor...');
                    
                    // Supabase client'ı başlat
                    const supabaseUrl = 'https://gamjzzomkosvqhficabt.supabase.co';
                    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhbWp6em9ta29zdnFoZmljYWJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4ODc3MDAsImV4cCI6MjA2ODQ2MzcwMH0.r8KkywdhNSP1hxzSAlKo8SB5jOEb0KQRUBfZ9Va0p9I';
                    
                    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    
                    // Authentication kontrolü
                    const { data: { user }, error: authError } = await supabase.auth.getUser();
                    
                    if (authError || !user) {
                        console.warn('⚠️ Kullanıcı giriş yapmamış, localStorage\'a kaydediliyor');
                        localStorage.setItem('pendingAttentionResults', JSON.stringify(mappedData));
                        return false;
                    }
                    
                    console.log('👤 Aktif kullanıcı:', user.email);
                    
                    // Kullanıcı bilgilerini al ve yetki kontrolü yap
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .select('id, first_name, last_name, roles, supervisor_id')
                        .eq('auth_user_id', user.id)
                        .single();
                    
                    if (userError || !userData) {
                        console.error('❌ Kullanıcı bilgileri alınamadı:', userError);
                        localStorage.setItem('pendingAttentionResults', JSON.stringify(mappedData));
                        return false;
                    }
                    
                    // Role kontrolü - Tüm roller test yapabilir
                    const userRole = this.getUserRole(userData.roles);
                    console.log(`👤 Kullanıcı rolü: ${userRole} (${this.getDisplayLabel(userRole)})`);
                    
                    if (!['admin', 'temsilci', 'beyin_antrenoru', 'kullanici'].includes(userRole)) {
                        console.warn('⚠️ Geçersiz kullanıcı rolü - pending olarak kaydediliyor');
                        localStorage.setItem('pendingAttentionResults', JSON.stringify(mappedData));
                        return false;
                    }
                    
                    // Test edilen öğrenci ID'sini al (localStorage'dan veya context'ten)
                    let studentId = await this.findValidStudentId();
                    
                    if (!studentId) {
                        console.error('❌ Geçerli öğrenci ID bulunamadı');
                        return false;
                    }
                    
                    // conducted_by belirleme - Doğru mantık: supervisor varsa supervisor, yoksa kendisi
                    let conductedBy;
                    if (userData.supervisor_id) {
                        // Kullanıcının supervisor'ı varsa, test yapan supervisor'dür
                        conductedBy = userData.supervisor_id;
                        console.log(`👨‍🏫 Test yapan kişi: Supervisor (ID: ${conductedBy}) - Öğrenci: ${userData.first_name} ${userData.last_name}`);
                    } else {
                        // Supervisor yoksa (admin/trainer kendisi), kendisi yapmıştır
                        conductedBy = userData.id;
                        console.log(`👨‍🏫 Test yapan kişi: ${userData.first_name} ${userData.last_name} (${this.getDisplayLabel(userRole)}) - ID: ${conductedBy}`);
                    }
                    
                    // Final kayıt verisi
                    const finalData = {
                        ...mappedData,
                        student_id: studentId,
                        conducted_by: conductedBy,
                        test_start_time: mappedData.test_start_time,
                        test_end_time: mappedData.test_end_time || new Date().toISOString()
                    };
                    
                    console.log('📝 Supabase\'e kaydedilecek veri:', finalData);
                    
                    // Supabase'e kaydet
                    const { data: insertData, error: insertError } = await supabase
                        .from('attention_test_results')
                        .insert([finalData])
                        .select();
                    
                    if (insertError) {
                        console.error('❌ Supabase kayıt hatası:', insertError);
                        
                        // Hata detayları
                        if (insertError.code === '23503') {
                            console.error('🔗 Foreign key hatası - Student veya User ID geçersiz');
                        } else if (insertError.code === '42501') {
                            console.error('🔒 Yetki hatası - RLS policy ihlali');
                        }
                        
                        // Hata durumunda localStorage'a kaydet
                        localStorage.setItem('failedAttentionResults', JSON.stringify({
                            data: finalData,
                            error: insertError,
                            timestamp: new Date().toISOString()
                        }));
                        
                        return false;
                    }
                    
                    console.log('✅ Supabase kayıt başarılı!', insertData);
                    
                    // Başarılı kayıt sonrası temizlik ve güncelleme
                    localStorage.removeItem('pendingAttentionResults');
                    localStorage.removeItem('failedAttentionResults');
                    localStorage.setItem('lastTestedStudent', finalData.student_id);
                    
                    // Role'e göre başarı mesajı
                    if (userRole === 'admin' || userRole === 'temsilci' || userRole === 'beyin_antrenoru') {
                        // Yönetici roller için detaylı bilgi
                        console.log('🎉 DİKKAT TESTİ PRODUCTION\'A KAYDEDILDI!');
                        console.log(`📊 Test ID: ${insertData[0]?.id}`);
                        console.log(`👤 Test Alan Kullanıcı ID: ${finalData.student_id}`);
                        console.log(`👨‍🏫 Test Yöneten: ${userData.first_name} ${userData.last_name} (${this.getDisplayLabel(userRole)})`);
                        console.log(`🔗 Foreign Key İlişkileri Doğrulandı ✅`);
                        console.log(`📊 Test Sonuçları:`, {
                            doğru: finalData.total_correct_answers,
                            toplam: finalData.total_questions_attempted,
                            başarı: `%${finalData.accuracy_percentage}`,
                            hız: `%${finalData.speed_score}`
                        });
                    } else {
                        // Kullanıcı için sınırlı bilgi
                        console.log('✅ Test tamamlandı ve kaydedildi!');
                        console.log('📋 Sonuçlarınız sorumlu kişiniz tarafından değerlendirilecek.');
                    }
                    
                    return true;
                    
                } catch (error) {
                    console.error('❌ Supabase kayıt genel hatası:', error);
                    
                    // Genel hata durumunda localStorage'a kaydet
                    localStorage.setItem('failedAttentionResults', JSON.stringify({
                        data: mappedData,
                        error: error.message,
                        timestamp: new Date().toISOString()
                    }));
                    
                    return false;
                }
            },

           // Test tamamlama
           completeTest() {
               console.log('Test completed, moving to next test...');
               
               // Cleanup
               testState.cleanup();
               
               // Test sonuçlarını kaydet
               try {
                   // localStorage'dan test sonuçlarını al
                   const savedResults = localStorage.getItem('attentionTestResults');
                   let testResults = {};
                   
                   if (savedResults) {
                       testResults = JSON.parse(savedResults);
                   } else {
                       // Fallback - temel sonuçları oluştur
                       testResults = {
                           mainScore: testState.mainAnswers ? testState.mainAnswers.filter(a => a.isCorrect).length : 0,
                           mainTotal: testState.mainAnswers ? testState.mainAnswers.length : 0,
                           completedQuestions: testState.mainIndex || 0,
                           totalQuestions: TEST_DATA?.mainQuestions?.length || 0,
                           testDuration: testState.mainStartTime ? (Date.now() - testState.mainStartTime) : 0
                       };
                   }
                   
                   console.log('✅ Dikkat testi tamamlandı, hafıza testine geçiliyor...');
                   
                   // Aynı pencerede hafıza testini yükle
                   window.location.href = '../hafiza/hafiza.html';
                   
               } catch (error) {
                   console.error('❌ Test completion hatası:', error);
                   // Hata durumunda da ana pencereye hata mesajı gönder
                   if (window.opener) {
                       window.opener.postMessage({
                           type: 'test-complete',
                           testName: 'dikkat',
                           results: { error: 'Test completion hatası' },
                           timestamp: new Date().toISOString()
                       }, window.location.origin);
                   }
               }
           }
       };

       // Sayfa yüklenme olayı
       window.addEventListener('load', async function() {
           try {
               console.log('ForTest Dikkat Algoritması - Sağlam Versiyon v2.1 Yüklendi');
               
               // Önceki yarıda kalmış test kontrolü
               checkPreviousIncompleteTest();
               
               // Audio dosyalarını preload et
               const audioFiles = [
                   '12345.mp3', 'giris.mp3', 'ornek1.mp3', 'ornek2.mp3',
                   'ornekgecis.mp3', 'ornekbasla.mp3', 'ornekok.mp3',
                   'testbasla.mp3', 'testok.mp3'
               ];

               // Background'da preload et
               preloadAudios(audioFiles).catch(e => {
                   console.warn('Audio preloading warning:', e);
               });
               
               // Browser feature check
               if (!window.Audio) {
                   console.warn('Audio API not supported');
               }
               
               if (!window.localStorage) {
                   console.warn('LocalStorage not supported');
               }

           } catch (e) {
               console.error('Initialization error:', e);
               handleError(`Başlatma hatası: ${e.message}`, false);
           }
       });

       // Önceki yarıda kalmış test kontrolü
       function checkPreviousIncompleteTest() {
           try {
               const testStatus = localStorage.getItem('attentionTestStatus');
               const incompleteData = localStorage.getItem('attentionTestResults_INCOMPLETE');
               const progressSave = localStorage.getItem('attentionTestProgressSave');
               const autoSave = localStorage.getItem('attentionTestAutoSave');
               
               if (testStatus === 'interrupted' && incompleteData) {
                   const data = JSON.parse(incompleteData);
                   console.log(`⚠️ YARIDA KALMIŞ TEST BULUNDU:`);
                   console.log(`📋 ${data.completedQuestions}/${data.totalQuestions} soru tamamlanmış`);
                   console.log(`💾 Kayıt tarihi: ${data.savedAt}`);
                   console.log(`🔄 Kesinti nedeni: ${data.interruptReason}`);
                   
                   // Console'da özet bilgi ver
                   if (data.completedQuestions > 0) {
                       const accuracy = Math.round((data.mainScore / data.mainTotal) * 100);
                       console.log(`✅ Doğru cevaplar: ${data.mainScore}/${data.mainTotal} (${accuracy}%)`);
                       console.log(`⏱️ Geçen süre: ${Math.round(data.testDuration / 1000)} saniye`);
                   }
               } else if (testStatus === 'in_progress' && (progressSave || autoSave)) {
                   console.log(`🔄 Devam eden test kayıtları bulundu (periyodik/otomatik kayıt)`);
                   const data = JSON.parse(progressSave || autoSave);
                   console.log(`📋 Son kayıt: ${data.currentQuestion}/50 soru`);
               } else if (testStatus === 'completed') {
                   console.log(`✅ Son test başarıyla tamamlanmış`);
               } else {
                   console.log(`🆕 İlk test - temiz başlangıç`);
               }
               
           } catch (e) {
               console.warn('Previous test check failed:', e);
           }
       }

       // ACIL DURUM KAYDETME - Test yarıda kalırsa veri kaybetme
       function saveEmergencyData() {
           try {
               if (testState.mainStartTime && testState.mainIndex > 0) {
                   // Test devam ederken sayfa kapatılıyor
                   const emergencyData = {
                       // Test durumu
                       isIncomplete: true,
                       interruptedAt: Date.now(),
                       completedQuestions: testState.mainIndex,
                       totalQuestions: TEST_DATA.mainQuestions.length,
                       interruptReason: 'page_unload',
                       
                       // Temel istatistikler
                       practiceScore: testState.practiceAnswers.filter(a => a.isCorrect).length,
                       practiceTotal: testState.practiceAnswers.length,
                       mainScore: testState.mainAnswers.filter(a => a.isCorrect).length,
                       mainTotal: testState.mainAnswers.length,
                       averageReactionTime: testState.reactionTimes.length > 0 ? 
                           testState.reactionTimes.reduce((a, b) => a + b, 0) / testState.reactionTimes.length : 0,
                       testDuration: Date.now() - testState.mainStartTime,
                       
                       // Bölüm durumları
                       currentSection: testState.currentSection ? testState.currentSection.key : null,
                       sectionProgress: {
                           section1: getSectionStats('section1'),
                           section2: getSectionStats('section2'),
                           section3: getSectionStats('section3')
                       },
                       
                       // Tür bazlı hatalar
                       questionTypeMistakes: testState.questionTypeMistakes,
                       wrongSelections: testState.wrongSelections,
                       
                       // Tam cevap listesi (eldeki veriler)
                       questionDetails: testState.mainAnswers,
                       
                       // Acil durum işareti
                       emergency: true,
                       savedAt: new Date().toISOString()
                   };
                   
                   localStorage.setItem('attentionTestResults_INCOMPLETE', JSON.stringify(emergencyData));
                   localStorage.setItem('attentionTestStatus', 'interrupted');
                   console.log(`🚨 ACİL KAYIT: Test ${testState.mainIndex}/${TEST_DATA.mainQuestions.length} soruda kesildi`);
                   
                   return true;
               }
               return false;
           } catch (e) {
               console.error('Emergency save error:', e);
               return false;
           }
       }

       // Sayfa kapanma - UYARI VE ACİL KAYIT
       window.addEventListener('beforeunload', function(e) {
           try {
               // Eğer test devam ediyorsa uyar ve kaydet
               if (testState.mainStartTime && testState.mainIndex > 0 && testState.mainIndex < TEST_DATA.mainQuestions.length) {
                   saveEmergencyData();
                   
                   // Kullanıcıya uyarı (modern tarayıcılarda generic mesaj çıkar)
                   const confirmationMessage = 'Dikkat testi devam ediyor! Sayfayı kapatırsanız test verileri kaydedilecek ancak test yarıda kalacak.';
                   e.returnValue = confirmationMessage; // Chrome
                   return confirmationMessage; // Firefox
               }
               
               testState.cleanup();
               console.log('Normal cleanup completed');
           } catch (e) {
               console.error('Beforeunload error:', e);
           }
       });

       // Visibility change - pause/resume + ara kayıt
       document.addEventListener('visibilitychange', function() {
           if (document.hidden) {
               // Sayfa gizlenince (tab değişimi, minimize, etc.)
               if (testState.currentAudio) {
                   testState.currentAudio.pause();
               }
               
               // Test devam ediyorsa ara kayıt yap
               if (testState.mainStartTime && testState.mainIndex > 0) {
                   try {
                       const autoSave = {
                           type: 'auto_save',
                           savedAt: new Date().toISOString(),
                           currentQuestion: testState.mainIndex + 1, // 1-based
                           completedQuestions: testState.mainIndex,
                           mainAnswers: testState.mainAnswers,
                           reactionTimes: testState.reactionTimes,
                           questionTypeMistakes: testState.questionTypeMistakes,
                           wrongSelections: testState.wrongSelections,
                           testDuration: Date.now() - testState.mainStartTime,
                           reason: 'visibility_hidden'
                       };
                       
                       localStorage.setItem('attentionTestAutoSave', JSON.stringify(autoSave));
                       console.log(`💾 Otomatik kayıt: ${testState.mainIndex}. soru`);
                   } catch (e) {
                       console.warn('Auto save failed:', e);
                   }
               }
           } else {
               // Sayfa tekrar görünür olunca
               if (testState.currentAudio && testState.currentAudio.paused) {
                   testState.currentAudio.play().catch(e => {
                       console.warn('Resume audio failed:', e);
                   });
               }
               
               console.log('📱 Sayfa tekrar aktif');
           }
       });



       // Global namespace - TEK OBJECT ALTINDA TOPLANDI
       window.DikkatTest = DikkatTest;
       
       // Backward compatibility için gerekli olanlar - minimum
       window.safeNavigate = safeNavigate;
       window.retryExampleFromFail = function() {
           DikkatTest.retryExampleFromFail();
       };

       // 🧪 TEST FONKSİYONU - Mapping fonksiyonunu test et
       function testDatabaseMapping() {
           console.log('🧪 DATABASE MAPPING TESTİ BAŞLIYOR...');
           
           // Test verisi oluştur
           const testResults = {
               rawData: {
                   practiceScore: 3,
                   practiceTotal: 3,
                   mainScore: 42,
                   mainTotal: 50,
                   averageReactionTime: 1247,
                   testDuration: 180000, // 3 dakika ms
                   speedScore: 75.50,
                   accuracyScore: 84.00,
                   incompleteAtQuestion: null
               },
               sections: {
                   section1: {
                       correctCount: 11,
                       totalCount: 13,
                       accuracy: 84.62
                   },
                   section2: {
                       correctCount: 16,
                       totalCount: 17,
                       accuracy: 94.12
                   },
                   section3: {
                       correctCount: 15,
                       totalCount: 20,
                       accuracy: 75.00
                   }
               },
               questionTypes: {
                   numberQuestions: {
                       correct: 18,
                       wrong: 3,
                       accuracy: 85.71
                   },
                   letterQuestions: {
                       correct: 16,
                       wrong: 2,
                       accuracy: 88.89
                   },
                   mixedQuestions: {
                       correct: 8,
                       wrong: 3,
                       accuracy: 72.73
                   }
               },
               errorDetails: {
                   wrongSelections: [
                       { question: 2, selectedWrong: "k", correctAnswer: "t", questionType: "h" },
                       { question: 5, selectedWrong: "3", correctAnswer: "4", questionType: "s" }
                   ]
               },
               questionDetails: [
                   { question: 1, content: ["5","6","2","1","5","8"], target: "5", selected: "5", correct: true, type: "s", reactionTime: 1205 },
                   { question: 2, content: ["m","t","k","a","t","h"], target: "t", selected: "k", correct: false, type: "h", reactionTime: 1567 }
               ]
           };
           
           // Test state oluştur
           window.testState = window.testState || {};
           testState.reactionTimes = [1205, 1567, 892, 2341, 1156, 1789, 1423, 1678, 1234, 1890];
           
           // Mapping fonksiyonunu test et
           const mappingResult = testManager.mapResultsToDatabase(testResults);
           
           if (mappingResult) {
               console.log('✅ MAPPING TESTİ BAŞARILI!');
               console.log('📊 Eşleştirme Sonuçları:', mappingResult);
               
               // Kritik alanları kontrol et
               const checks = {
                   'Total Questions': mappingResult.total_questions_attempted === 50,
                   'Correct Answers': mappingResult.total_correct_answers === 42,
                   'Accuracy': mappingResult.accuracy_percentage === 84.00,
                   'Speed Score': mappingResult.speed_score === 75.50,
                   'Duration (seconds)': mappingResult.test_duration_seconds === 180,
                   'Section1 Correct': mappingResult.section1_correct === 11,
                   'Section1 Accuracy': mappingResult.section1_accuracy === 84.62,
                   'Number Questions': mappingResult.number_questions_correct === 18,
                   'Letter Questions': mappingResult.letter_questions_correct === 16,
                   'Mixed Questions': mappingResult.mixed_questions_correct === 8,
                   'Reaction Times': mappingResult.reaction_times.length === 10,
                   'Detailed Answers': mappingResult.detailed_answers.length === 2,
                   'Wrong Answers': mappingResult.wrong_answers.length === 2
               };
               
               console.log('🔍 VALIDATION SONUÇLARI:');
               Object.entries(checks).forEach(([key, passed]) => {
                   console.log(`  ${passed ? '✅' : '❌'} ${key}: ${passed ? 'GEÇTI' : 'BAŞARISIZ'}`);
               });
               
               const allPassed = Object.values(checks).every(check => check);
                               console.log(`\n${allPassed ? '🎉 TÜM TESTLER GEÇTİ!' : '⚠️ BAZI TESTLER BAŞARISIZ!'}`);
                
                // 🚀 SUPABASE KAYIT TESTİ (YENİ UNIFIED SYSTEM)
                if (allPassed && mappingResult) {
                    console.log('🧪 Supabase kayıt testi yapılıyor (Yeni unified users system)...');
                    testManager.saveToSupabaseProduction(mappingResult)
                        .then(success => {
                            if (success) {
                                console.log('✅ SUPABASE KAYIT TESTİ BAŞARILI! (Users tablosu unified system)');
                            } else {
                                console.log('⚠️ SUPABASE KAYIT TESTİ BAŞARISIZ (Authentication gerekli)');
                            }
                        })
                        .catch(error => {
                            console.log('❌ SUPABASE KAYIT TESTİ HATASI:', error);
                        });
                }
                
                return mappingResult;
           } else {
               console.error('❌ MAPPING TESTİ BAŞARISIZ!');
               return null;
           }
       }
       
       // Test fonksiyonunu global olarak erişilebilir yap
       window.testDatabaseMapping = testDatabaseMapping;

   </script>
</body>
</html>