<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ForTest Hafıza Testi</title>
    <style>
        :root {
            --primary: #60a5fa;
            --primary-dark: #2563eb;
            --secondary: #f43f5e;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #0f172a;
            --gray: #94a3b8;
            --gray-light: #e2e8f0;
            --border-radius: 8px;
            --font-main: 'Segoe UI', Roboto, Arial, sans-serif;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
            
            /* Responsive değişkenler - dikkatsağlam.html ile aynı */
            --container-padding: clamp(15px, 4vw, 50px);
            --font-size-base: clamp(14px, 2vw, 18px);
            --font-size-large: clamp(18px, 3vw, 24px);
            --font-size-xlarge: clamp(24px, 4vw, 48px);
            --font-size-xxlarge: clamp(32px, 6vw, 64px);
            --button-padding: clamp(12px, 2vw, 18px) clamp(20px, 4vw, 40px);
            --gap-size: clamp(10px, 2vw, 20px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            line-height: 1.6;
            color: var(--dark);
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #1d4ed8 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            font-size: var(--font-size-base);
            margin: 0;
        }

        /* Container 1200x800 aspect ratio - yukarı-aşağı tam dolu */
        .container {
            background: linear-gradient(145deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            border-radius: clamp(15px, 3vw, 20px);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                0 15px 30px rgba(0, 0, 0, 0.3),
                inset 0 2px 5px rgba(255, 255, 255, 0.1);
            padding: var(--container-padding);
            /* Dynamic sizing: clamp width and keep 3:2 ratio */
            width: clamp(320px, 90vw, 1200px);
            aspect-ratio: 3 / 2;
            height: auto;
            text-align: center;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
        }

        /* Loading overlay - smooth transitions */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 58, 138, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: white;
            font-size: var(--font-size-large);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error message */
        .error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(239, 68, 68, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            flex-direction: column;
            text-align: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .error-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .error-message {
            color: white;
            font-size: var(--font-size-large);
            text-align: center;
            padding: 20px;
            line-height: 1.6;
        }

        .screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: var(--container-padding);
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Başlangıç ekranı */
        .title-screen h1 {
            font-size: var(--font-size-xxlarge);
            color: white;
            font-weight: 700;
            margin-bottom: clamp(25px, 6vw, 50px);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            line-height: 1.2;
        }

        .instruction-box {
            background: transparent;
            border-radius: 0;
            padding: clamp(10px, 3vw, 20px);
            margin: clamp(15px, 4vw, 30px) auto;
            max-width: min(90%, 800px);
            box-shadow: none;
            border: none;
        }

        .instruction-text {
            font-size: var(--font-size-large);
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: clamp(10px, 3vw, 20px);
            line-height: 1.8;
        }

        .highlight-text {
            color: white;
            font-weight: bold;
            font-size: clamp(20px, 3.5vw, 28px);
            margin: clamp(10px, 3vw, 20px) 0;
            line-height: 1.8;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .btn {
            display: inline-block;
            font-weight: 500;
            color: white;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            padding: var(--button-padding);
            font-size: clamp(16px, 2.5vw, 22px);
            line-height: 1.5;
            border-radius: var(--border-radius);
            transition: opacity 0.5s ease, transform 0.5s ease, background 0.3s ease, box-shadow 0.3s ease;
            border: none;
            box-shadow: 
                0 4px 6px rgba(30, 64, 175, 0.3),
                0 0 15px rgba(255, 255, 255, 0.3),
                0 0 25px rgba(255, 255, 255, 0.1);
            text-decoration: none;
            margin: clamp(5px, 1vw, 10px);
            opacity: 0;
            transform: translateY(20px);
            min-width: clamp(100px, 20vw, 150px);
            position: relative;
            overflow: hidden;
            min-height: clamp(44px, 8vw, 56px);
        }

        .btn.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn:hover:not(.disabled) {
            background: linear-gradient(135deg, #1e3d9f 0%, #2454d6 100%);
            box-shadow: 
                0 6px 8px rgba(30, 58, 138, 0.4),
                0 0 20px rgba(255, 255, 255, 0.4),
                0 0 35px rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .btn-bottom-right {
            position: absolute;
            bottom: clamp(20px, 4vw, 40px);
            right: clamp(20px, 4vw, 40px);
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .btn-bottom-right.visible {
            opacity: 1;
        }

        .test-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .memory-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            width: 100%;
        }

        .memory-text {
            font-size: clamp(16px, 2.5vw, 22px);
            color: white;
            font-weight: 500;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
            position: absolute;
            bottom: clamp(20px, 4vw, 40px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            text-align: center;
            width: max-content;
            max-width: 80%;
            padding: clamp(12px, 2vw, 18px) clamp(20px, 4vw, 40px);
            background: rgba(30, 64, 175, 0.8);
            backdrop-filter: blur(8px);
            border-radius: var(--border-radius);
            line-height: 1.5;
            margin: clamp(5px, 1vw, 10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .memory-image {
            max-width: min(83%, 765px);
            max-height: clamp(383px, 60vh, 638px);
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            margin: clamp(15px, 4vw, 30px) 0;
        }

        #exampleQuestionArea, #mainQuestionArea {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: clamp(20px, 4vw, 30px);
        }

        .question-text {
            font-size: var(--font-size-large);
            color: white;
            margin-bottom: clamp(15px, 4vw, 30px);
            font-weight: 500;
            line-height: 1.6;
        }

        /* Yazılı seçenekler - alt alta */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: clamp(8px, 2vw, 15px);
            align-items: center;
            margin: clamp(15px, 4vw, 30px) auto;
            width: 100%;
            max-width: min(95%, 600px);
        }

        .option-btn {
            width: 100%;
            padding: clamp(10px, 2vw, 15px) clamp(15px, 4vw, 30px);
            font-size: var(--font-size-base);
            font-weight: 500;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            color: black;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-align: left;
            display: flex;
            align-items: center;
        }



        .option-btn.disabled, .image-option.disabled {
            pointer-events: none !important;
            opacity: 0.7 !important;
        }

        .option-btn.selected {
            background: linear-gradient(135deg, #90cdf4 0%, #60a5fa 100%) !important;
            color: black !important;
            border-color: #90cdf4 !important;
            opacity: 1 !important;
            box-shadow: 
                0 clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 6px) rgba(0, 0, 0, 0.2),
                0 1px 3px rgba(0, 0, 0, 0.15),
                inset 0 2px 2px rgba(255, 255, 255, 0.8) !important;
        }

        /* Görsel seçenekler - tek satırda A B C D E ile */
        .image-options {
            display: flex;
            justify-content: center;
            gap: clamp(15px, 3vw, 25px);
            max-width: 100%;
            margin: clamp(15px, 4vw, 30px) auto;
            flex-wrap: wrap;
        }

        .image-option {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
        }

        .image-option img {
            width: clamp(100px, 18vw, 140px);
            height: clamp(100px, 18vw, 140px);
            object-fit: cover;
            display: block;
            border-radius: 8px;
        }

        .image-option-label {
            background: rgba(255, 255, 255, 0.9);
            color: black;
            font-weight: bold;
            font-size: clamp(12px, 2vw, 16px);
            padding: clamp(4px, 1vw, 6px) clamp(8px, 1.5vw, 10px);
            border-radius: 5px;
            margin-bottom: 6px;
            min-width: 25px;
            text-align: center;
        }



        .image-option.selected {
            border-color: #90cdf4;
            box-shadow: 0 0 0 3px rgba(144, 205, 244, 0.4);
        }

        .image-option.selected .image-option-label {
            background: linear-gradient(135deg, #90cdf4 0%, #60a5fa 100%);
            color: black;
            box-shadow: 
                0 clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 6px) rgba(0, 0, 0, 0.2),
                0 1px 3px rgba(0, 0, 0, 0.15),
                inset 0 2px 2px rgba(255, 255, 255, 0.8);
        }



        /* Timer bar her soru için sıfırlanacak */
        .timer-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: clamp(6px, 1vw, 8px);
            background: rgba(255, 255, 255, 0.2);
            overflow: hidden;
            border-bottom-left-radius: clamp(15px, 3vw, 20px);
            border-bottom-right-radius: clamp(15px, 3vw, 20px);
        }

        .timer-fill {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
            transform-origin: left;
            transform: scaleX(1);
            border-bottom-left-radius: clamp(15px, 3vw, 20px);
            border-bottom-right-radius: clamp(15px, 3vw, 20px);
        }

        .timer-fill.counting {
            animation: countdown 6s linear forwards;
        }

        @keyframes countdown {
            from {
                transform: scaleX(1);
            }
            to {
                transform: scaleX(0);
            }
        }

        /* Sonuç ekranı */
        .result-message {
            font-size: clamp(28px, 5vw, 48px);
            color: white;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: clamp(15px, 4vw, 30px);
            line-height: 1.2;
        }

        .result-info {
            font-size: var(--font-size-large);
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .notification {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 30px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: var(--font-size-base);
        }

        .notification.success {
            background-color: var(--success);
        }

        .notification.error {
            background-color: var(--danger);
        }

        .notification.show {
            opacity: 1;
        }

        /* Responsive Media Queries */
        
        /* Çok küçük telefon ekranları */
        @media (max-width: 360px) {
            .container {
                padding: clamp(10px, 3vw, 15px);
            }
            .image-options {
                grid-template-columns: repeat(2, 1fr);
                gap: clamp(5px, 2vw, 10px);
            }
            .option-btn {
                padding: clamp(8px, 2vw, 12px) clamp(12px, 3vw, 20px);
                font-size: clamp(14px, 3vw, 16px);
            }
        }

        /* Küçük telefon ekranları */
        @media (max-width: 480px) {
            .btn-bottom-right {
                position: relative;
                bottom: auto;
                right: auto;
                margin-top: 20px;
            }
            .image-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Tablet ve masaüstü */
        @media (min-width: 481px) {
            .container {
                height: min(100vh - 30px, 800px);
            }
        }

        /* Büyük ekranlar */
        @media (min-width: 1400px) {
            .container {
                width: min(90%, 1400px);
                height: min(100vh - 40px, 900px);
            }
        }

        /* Landscape mode mobil */
        @media (max-height: 500px) and (orientation: landscape) {
            .container {
                height: 95vh;
                padding: 15px;
            }
            .title-screen h1 {
                margin-bottom: 20px;
            }
            .instruction-box {
                padding: 20px;
                margin: 15px auto;
            }
        }

        /* High DPI ekranlar için font optimizasyonu */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .title-screen h1, .result-message {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            .loading-overlay, .error-overlay {
                transition: opacity 0.1s ease !important;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            .option-btn {
                border-width: 2px;
                border-color: black;
            }
            .btn {
                border: 2px solid white;
            }
        }
    </style>
    <!-- Supabase Client (UMD ile yükleniyor) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js" onload="window.__initSupabase && window.__initSupabase()"></script>
    <script>
      // Supabase UMD hazır olduğunda çalışacak init fonksiyonu (+ güvenli retry)
      (function () {
        const MAX_TRIES = 15; // ~4.5s
        const DELAY_MS = 300;
        let tries = 0;

        function getNamespace() {
          return window.supabase || window.Supabase || null;
        }

        function tryInit() {
          try {
            const SUPABASE_URL = localStorage.getItem('sb-url');
            const SUPABASE_ANON_KEY = localStorage.getItem('sb-anon-key');

            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
              console.warn('⚠️ Supabase config localStorage\'da bulunamadı (sb-url/sb-anon-key)');
              return false;
            }

            const ns = getNamespace();
            if (!ns || typeof ns.createClient !== 'function') {
              return false;
            }

            if (!window.supabaseClient) {
              window.supabaseClient = ns.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
              console.log('✅ Supabase client oluşturuldu (UMD)');
            }
            return true;
          } catch (e) {
            console.error('❌ Supabase init hatası:', e);
            return false;
          }
        }

        window.__initSupabase = function initSupabaseFromLocalStorage() {
          if (tryInit()) return;

          // Retry döngüsü
          const timer = setInterval(() => {
            tries++;
            const ok = tryInit();
            if (ok || tries >= MAX_TRIES) {
              if (!ok) {
                console.error('⚠️ Supabase UMD global nesnesi bulunamadı (supabase/Supabase). Script bekleme süresi aşıldı.');
              }
              clearInterval(timer);
            }
          }, DELAY_MS);
        };

        // Fallback: sayfa yüklenir yüklenmez de dene
        if (!window.supabaseClient) {
          setTimeout(() => window.__initSupabase && window.__initSupabase(), 0);
        }
      })();
    </script>
  </head>
<body>
    <div class="container">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Yükleniyor...</div>
        </div>

        <!-- Error Overlay -->
        <div class="error-overlay" id="errorOverlay">
            <div class="error-message" id="errorMessage">Bir hata oluştu</div>
        </div>

        <!-- 0. Başlangıç Title Ekranı -->
        <div id="titleScreen" class="screen active">
            <div class="title-screen">
                <h1>Hafıza Testi</h1>
            </div>
            <button class="btn btn-bottom-right visible" onclick="goToWelcome()">İleri</button>
        </div>

        <!-- 1. Giriş Ekranı -->
        <div id="welcomeScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Cümleleri dinleyeceksiniz.<br>
                    Görselleri inceleyeceksiniz.<br>
                    Cümleler ve görseller ile ilgili soruları cevaplayacaksınız.<br>
                    Her bir soruyu cevaplamak için 6 saniyeniz var!
                </div>
            </div>
            <button class="btn btn-bottom-right" id="welcomeNextBtn" onclick="goToExampleIntro()">İleri</button>
        </div>

        <!-- 2. Örnek Giriş Ekranı -->
        <div id="exampleIntroScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Örnek uygulamada;<br>
                    iki farklı cümle<br>
                    iki farklı görsel<br>
                    cümleler ve görseller ile ilgili sorular olacaktır.
                </div>
            </div>
            <button class="btn btn-bottom-right" id="exampleIntroNextBtn" onclick="goToExampleReady()">İleri</button>
        </div>

        <!-- 3. Örnek Hazır Ekranı -->
        <div id="exampleReadyScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Örnek uygulamaya hazırsanız "Başla" butonuna tıklayın!
                </div>
            </div>
            <button class="btn btn-bottom-right" id="exampleReadyBtn" onclick="startExampleSection()">Başla</button>
        </div>

        <!-- 4. Örnek Gösterim Ekranı -->
        <div id="exampleScreen" class="screen">
            <div class="test-area">
                <div class="memory-display" id="exampleDisplay">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
            </div>
        </div>

        <!-- 5. Örnek Sorular Ekranı -->
        <div id="exampleQuestionsScreen" class="screen">
            <div id="exampleQuestionArea">
                <!-- Dinamik olarak doldurulacak -->
            </div>
            <div class="timer-bar">
                <div class="timer-fill" id="exampleTimerFill"></div>
            </div>
        </div>

        <!-- 6. Örnek Bitiş Ekranı -->
        <div id="exampleCompleteScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Örnek uygulamayı tamamladınız!
                </div>
            </div>
            <button class="btn btn-bottom-right" id="exampleCompleteBtn" onclick="goToMainTestIntro()">İleri</button>
        </div>

        <!-- 7. Ana Test Giriş Ekranı -->
        <div id="mainTestIntroScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Teste hazırlanın!<br>
                    soruları cevaplamak için<br>
                    6 saniyeniz var.
                </div>
            </div>
            <button class="btn btn-bottom-right" id="mainTestStartBtn" onclick="startMainTest()">Başla</button>
        </div>

        <!-- 8. Ana Test Ekranı -->
        <div id="mainTestScreen" class="screen">
            <div class="test-area">
                <div class="memory-display" id="mainTestDisplay">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
            </div>
        </div>

        <!-- 9. Ana Test Soruları Ekranı -->
        <div id="mainQuestionsScreen" class="screen">
            <div id="mainQuestionArea">
                <!-- Dinamik olarak doldurulacak -->
            </div>
            <div class="timer-bar">
                <div class="timer-fill" id="mainTimerFill"></div>
            </div>
        </div>

        <!-- 10. Örnek Uygulama Başarısızlık Ekranı -->
        <div id="exampleFailScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Yeterli doğru cevabı vermediniz, örnek uygulama tekrar edilecektir.
                </div>
            </div>
            <button class="btn btn-bottom-right visible" onclick="retryExampleFromFail()">Tamam</button>
        </div>

        <!-- 11. Sonuç Ekranı -->
        <div id="resultsScreen" class="screen">
            <div class="result-message">Testi Tamamladınız!</div>
            <div class="result-info">sıradaki bölüme geçmek için ileri butonuna tıklayın!</div>
            <button class="btn btn-bottom-right visible" onclick="completeTest()">İleri</button>
        </div>
    </div>

    <script>
        // ===================================
        // HAFIZA TESTİ SİSTEMİ - v2.1 CLEAN
        // Dikkat Testi Yapısında
        // ===================================

        'use strict';

        // ===================================
        // STANDARD RESPONSIVE SYSTEM
        // dikkatsağlam.html ile aynı - viewport scaling yok
        // ===================================

        // Global hata yakalama
        window.addEventListener('error', function(e) {
            console.error('Global Error:', e.error);
            handleError('Beklenmeyen bir hata oluştu: ' + e.message, true);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled Promise Rejection:', e.reason);
            handleError('Promise hatası: ' + e.reason, true);
        });

        // ==================== TEST VERİLERİ ====================
        const memoryTestData = {
            // Örnek veriler
            examples: [
                {
                    audio: {
                        file: 'ornek1_ses.mp3',
                        text: 'Ceren annesiyle dondurma yiyor.'
                    },
                    visual: {
                        file: 'ornek1_gorsel.mp3',
                        text: 'Bu bir bisiklet resmidir.',
                        image: 'bisiklet.png'
                    }
                },
                {
                    audio: {
                        file: 'ornek2_ses.mp3',
                        text: 'Aysel\'in en sevdiği yemek makarnadır.'
                    },
                    visual: {
                        file: 'ornek2_gorsel.mp3',
                        text: 'Bu bir doğum günü resmidir.',
                        image: 'dogumgunu.png'
                    }
                }
            ],
            
            // Örnek sorular
            exampleQuestions: [
                {
                    question: 'Aysel\'in en sevdiği yemek hangisidir?',
                    options: ['Köfte', 'Hamburger', 'Makarna', 'Pilav', 'Pizza'],
                    correct: 2,
                    type: 'text'
                },
                {
                    question: 'Hangi pasta doğum günü resmindedir?',
                    options: ['pasta1.png', 'pasta2.png', 'pasta3.png', 'pasta4.png', 'pasta5.png'],
                    correct: 3,
                    type: 'image'
                },
                {
                    question: 'Ceren dondurmayı kiminle yedi?',
                    options: ['Baba', 'Abla', 'Abi', 'Anne', 'Kardeş'],
                    correct: 3,
                    type: 'text'
                },
                {
                    question: 'Bisiklet resminde kaç tane balon vardır?',
                    options: ['0', '1', '2', '3', '4'],
                    correct: 2,
                    type: 'text'
                }
            ],
            
            // Ana test setleri
            mainSets: [
                // SET 1
                {
                    audio: {
                        file: 'set1_ses.mp3',
                        text: '2 serçe çatıya yuva yapmış'
                    },
                    visual: {
                        file: 'set1_gorsel.mp3',
                        text: 'Bu bir bahçe resmidir.',
                        image: 'bahce.png'
                    }
                },
                // SET 2
                {
                    audio: {
                        file: 'set2_ses.mp3',
                        text: 'Ayşe mavi uçurtmasını parkta uçurdu'
                    },
                    visual: {
                        file: 'set2_gorsel.mp3',
                        text: 'Bu bir kütüphane resmidir.',
                        image: 'kutuphane.png'
                    }
                },
                // SET 3
                {
                    audio: {
                        file: 'set3_ses.mp3',
                        text: 'Türkçe öğretmeni 30 öğrenciye ders anlattı'
                    },
                    visual: {
                        file: 'set3_gorsel.mp3',
                        text: 'Bu bir kamp resmidir.',
                        image: 'kamp.png'
                    }
                },
                // SET 4
                {
                    audio: {
                        file: 'set4_ses.mp3',
                        text: 'Denizde yüzen 4 çocuktan, sadece birinin kırmızı kolluğu vardı'
                    },
                    visual: {
                        file: 'set4_gorsel.mp3',
                        text: 'Bu bir yelken resmidir.',
                        image: 'yelken.png'
                    }
                }
            ],
            
            // Ana test soruları
            mainQuestions: [
                // SET 1 soruları
                [
                    {
                        questionNo: 1,
                        question: 'Çatıya yuva yapan hayvan hangisidir?',
                        options: ['Martı', 'Güvercin', 'Serçe', 'Leylek', 'Karga'],
                        correct: 2,
                        type: 'text',
                        setNo: 1,
                        skillType: 'Kısa Süreli İşitsel'
                    },
                    {
                        questionNo: 2,
                        question: 'Bahçe resminde çocuk ne yapıyordu?',
                        options: ['Top oynuyordu', 'Yürüyordu', 'Kitap okuyordu', 'Çiçek suluyordu', 'Koşuyordu'],
                        correct: 3,
                        type: 'text',
                        setNo: 1,
                        skillType: 'Kısa Süreli Görsel'
                    },
                    {
                        questionNo: 3,
                        question: 'Bahçe resmindeki çiçek hangisiydi?',
                        options: ['cicek1.png', 'cicek2.png', 'cicek3.png', 'cicek4.png', 'cicek5.png'],
                        correct: 0,
                        type: 'image',
                        setNo: 1,
                        skillType: 'Kısa Süreli Görsel'
                    },
                    {
                        questionNo: 4,
                        question: 'Serçeler yuvayı nereye yapmış?',
                        options: ['Ağaca', 'Balkona', 'Direğe', 'Çatıya', 'Duvara'],
                        correct: 3,
                        type: 'text',
                        setNo: 1,
                        skillType: 'Kısa Süreli İşitsel'
                    },
                    {
                        questionNo: 5,
                        question: 'Bahçe resminde hangisi yoktu?',
                        options: ['Ağaç', 'Kuş', 'Hortum', 'Çocuk', 'Çiçek'],
                        correct: 1,
                        type: 'text',
                        setNo: 1,
                        skillType: 'İşler Hafıza'
                    }
                ],
                // SET 2 soruları
                [
                    {
                        questionNo: 6,
                        question: 'Ayşe uçurtmayı nerede uçurdu?',
                        options: ['Sahilde', 'Parkta', 'Ormanda', 'Evde', 'Çiftlikte'],
                        correct: 1,
                        type: 'text',
                        setNo: 2,
                        skillType: 'Kısa Süreli İşitsel'
                    },
                    {
                        questionNo: 7,
                        question: 'Kütüphane resminde kaç çocuk vardı?',
                        options: ['1', '3', '2', '4', '5'],
                        correct: 1,
                        type: 'text',
                        setNo: 2,
                        skillType: 'Kısa Süreli Görsel'
                    },
                    {
                        questionNo: 8,
                        question: 'Bahçe resminde çocuğun elindeki hortum hangi renkti?',
                        options: ['Sarı', 'Mavi', 'Kırmızı', 'Yeşil', 'Beyaz'],
                        correct: 2,
                        type: 'text',
                        setNo: 2,
                        skillType: 'Uzun Süreli Görsel'
                    },
                    {
                        questionNo: 9,
                        question: 'Kaç serçe çatıya yuva yapmış?',
                        options: ['1', '2', '3', '4', '5'],
                        correct: 1,
                        type: 'text',
                        setNo: 2,
                        skillType: 'Uzun Süreli İşitsel'
                    },
                    {
                        questionNo: 10,
                        question: 'Kütüphane resminde hangisi yoktu?',
                        options: ['Tablo', 'Saat', 'Kalemlik', 'Koltuk', 'Masa'],
                        correct: 1,
                        type: 'text',
                        setNo: 2,
                        skillType: 'İşler Hafıza'
                    }
                ],
                // SET 3 soruları
                [
                    {
                        questionNo: 11,
                        question: 'Öğrencilere hangi öğretmen ders anlattı?',
                        options: ['Matematik Öğretmeni', 'İngilizce Öğretmeni', 'Türkçe Öğretmeni', 'Müzik Öğretmeni', 'Sınıf Öğretmeni'],
                        correct: 2,
                        type: 'text',
                        setNo: 3,
                        skillType: 'Kısa Süreli İşitsel'
                    },
                    {
                        questionNo: 12,
                        question: 'Kütüphane resminde bulunan koltuk hangisiydi?',
                        options: ['koltuk1.png', 'koltuk2.png', 'koltuk3.png', 'koltuk4.png', 'koltuk5.png'],
                        correct: 0,
                        type: 'image',
                        setNo: 3,
                        skillType: 'Uzun Süreli Görsel'
                    },
                    {
                        questionNo: 13,
                        question: 'Kamp resminde hangisi yoktu?',
                        options: ['Kuş', 'Çadır', 'El feneri', 'Top', 'Köpek'],
                        correct: 3,
                        type: 'text',
                        setNo: 3,
                        skillType: 'İşler Hafıza'
                    },
                    {
                        questionNo: 14,
                        question: 'Kamp resmindeki köpek hangisiydi?',
                        options: ['kopek1.png', 'kopek2.png', 'kopek3.png', 'kopek4.png', 'kopek5.png'],
                        correct: 4,
                        type: 'image',
                        setNo: 3,
                        skillType: 'Kısa Süreli Görsel'
                    },
                    {
                        questionNo: 15,
                        question: 'Parkta mavi uçurtmayı kim uçurdu?',
                        options: ['Aysel', 'Arda', 'Aslı', 'Ayşe', 'Ayaz'],
                        correct: 3,
                        type: 'text',
                        setNo: 3,
                        skillType: 'Uzun Süreli İşitsel'
                    }
                ],
                // SET 4 soruları
                [
                    {
                        questionNo: 16,
                        question: 'Yelken resminde üzerinde elma olan yelken hangi renkti?',
                        options: ['Kırmızı', 'Sarı', 'Mavi', 'Yeşil', 'Turuncu'],
                        correct: 2,
                        type: 'text',
                        setNo: 4,
                        skillType: 'Kısa Süreli Görsel'
                    },
                    {
                        questionNo: 17,
                        question: 'Türkçe öğretmeni kaç öğrenciye ders anlattı?',
                        options: ['29', '30', '31', '32', '33'],
                        correct: 1,
                        type: 'text',
                        setNo: 4,
                        skillType: 'Uzun Süreli İşitsel'
                    },
                    {
                        questionNo: 18,
                        question: 'Yelken resminde yelkenlerin üzerindeki rakamların toplamı kaçtır?',
                        options: ['6', '7', '8', '9', '5'],
                        correct: 3,
                        type: 'text',
                        setNo: 4,
                        skillType: 'İşler Hafıza'
                    },
                    {
                        questionNo: 19,
                        question: 'Kamp resminde bulunan top hangisiydi?',
                        options: ['top1.png', 'top2.png', 'top3.png', 'top4.png', 'top5.png'],
                        correct: 1,
                        type: 'image',
                        setNo: 4,
                        skillType: 'Uzun Süreli Görsel'
                    },
                    {
                        questionNo: 20,
                        question: 'Denizde yüzen ve kırmızı kolluğu olmayan kaç çocuk vardı?',
                        options: ['0', '1', '2', '3', '4'],
                        correct: 2,
                        type: 'text',
                        setNo: 4,
                        skillType: 'İşler Hafıza'
                    }
                ]
            ]
        };

        // ==================== IMAGE PRELOADING SİSTEMİ (Akıl-Mantık ile uyumlu) ====================
        let preloadedImages = new Map();

        function preloadImage(src) {
            if (preloadedImages.has(src)) {
                return Promise.resolve(preloadedImages.get(src));
            }

            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    preloadedImages.set(src, img);
                    resolve(img);
                };
                img.onerror = (e) => {
                    console.error(`Görsel yüklenemedi: ${src}`, e);
                    reject(new Error(`Görsel yüklenemedi: ${src}`));
                };
                img.src = src;
            });
        }

        function preloadAllImages() {
            const toPreloadSet = new Set();

            try {
                // Örnek görseller (gösterim sırasında kullanılan ana görseller)
                if (Array.isArray(memoryTestData.examples)) {
                    memoryTestData.examples.forEach(ex => {
                        if (ex?.visual?.image) {
                            toPreloadSet.add(`images/${ex.visual.image}`);
                        }
                    });
                }

                // Ana set görselleri
                if (Array.isArray(memoryTestData.mainSets)) {
                    memoryTestData.mainSets.forEach(set => {
                        if (set?.visual?.image) {
                            toPreloadSet.add(`images/${set.visual.image}`);
                        }
                    });
                }

                // Örnek soruların görsel seçenekleri
                if (Array.isArray(memoryTestData.exampleQuestions)) {
                    memoryTestData.exampleQuestions.forEach(q => {
                        if (q?.type === 'image' && Array.isArray(q.options)) {
                            q.options.forEach(opt => {
                                if (typeof opt === 'string') {
                                    toPreloadSet.add(`images/${opt}`);
                                }
                            });
                        }
                    });
                }

                // Ana soruların görsel seçenekleri (set -> soru dizisi yapısı)
                if (Array.isArray(memoryTestData.mainQuestions)) {
                    memoryTestData.mainQuestions.forEach(setArr => {
                        if (Array.isArray(setArr)) {
                            setArr.forEach(q => {
                                if (q && q.type === 'image' && Array.isArray(q.options)) {
                                    q.options.forEach(opt => {
                                        if (typeof opt === 'string') {
                                            toPreloadSet.add(`images/${opt}`);
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
            } catch (e) {
                console.warn('Görsel preload listesi oluşturulurken hata:', e);
            }

            const list = Array.from(toPreloadSet);
            console.log(`🖼️ Hafıza testi preload başlayacak: ${list.length} görsel`);
            return Promise.allSettled(list.map(src => preloadImage(src)));
        }

        // Konfigürasyon sabitleri
        const CONFIG = {
            EXAMPLE_TIME_LIMIT: 30000,     // 30 saniye
            MAIN_TIME_LIMIT: 300000,       // 5 dakika
            AUDIO_RETRY_ATTEMPTS: 3,
            DEBOUNCE_DELAY: 300,
            ANIMATION_DELAY: 100,
            MIN_EXAMPLE_SCORE: 2,
            AUDIO_PRELOAD_TIMEOUT: 5000,
            QUESTION_TIME_LIMIT: 6000      // Her soru için 6 saniye
        };

        // Güvenli state yönetimi - Hafıza testi için adapte edilmiş
        class SafeMemoryTestState {
            constructor() {
                this.reset();
                this.locked = false;
            }

            reset() {
                this.currentScreen = 'titleScreen';
                this.currentAudio = null;
                this.preloadedAudios = new Map();
                this.timers = new Set();
                this.intervals = new Set();
                this.isTransitioning = false;
                this.isAnswering = false;
                
                // Örnek test durumları
                this.exampleAttempts = 0;
                this.exampleCorrectCount = 0;
                this.currentExampleIndex = 0;
                this.currentExamplePhase = 'audio';
                this.currentExampleQuestionIndex = 0;
                
                // Ana test durumları
                this.currentSetIndex = 0;
                this.currentSetPhase = 'audio';
                this.currentQuestionSetIndex = 0;
                this.currentQuestionIndex = 0;
                this.questionStartTime = null;
                this.questionTimer = null;
                this.currentQuestionType = null;
                
                // Zaman takibi
                this.startTime = null;
                this.setStartTimes = [];
                this.testEndTime = null;
                
                // Cevap takibi
                this.allAnswers = {
                    example: [],
                    main: []
                };
                
                // Beceri puanları
                this.skillScores = {
                    'Kısa Süreli İşitsel': { correct: 0, total: 0 },
                    'Kısa Süreli Görsel': { correct: 0, total: 0 },
                    'Uzun Süreli İşitsel': { correct: 0, total: 0 },
                    'Uzun Süreli Görsel': { correct: 0, total: 0 },
                    'İşler Hafıza': { correct: 0, total: 0 }
                };
            }

            // Güvenli timer yönetimi
            addTimer(timerId) {
                this.timers.add(timerId);
                return timerId;
            }

            clearTimer(timerId) {
                if (timerId && this.timers.has(timerId)) {
                    clearTimeout(timerId);
                    this.timers.delete(timerId);
                }
            }

            clearAllTimers() {
                this.timers.forEach(timerId => {
                    clearTimeout(timerId);
                });
                this.timers.clear();
            }

            // Güvenli ses yönetimi
            setCurrentAudio(audio) {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                }
                this.currentAudio = audio;
            }

            stopCurrentAudio() {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                    this.currentAudio = null;
                }
            }

            cleanup() {
                this.clearAllTimers();
                this.stopCurrentAudio();
                this.preloadedAudios.clear();
                this.locked = false;
            }
        }

        // Global state instance
        const state = new SafeMemoryTestState();

        // ==================== SES YÖNETİMİ ====================
        function playAudio(filename, callback) {
            if (state.currentAudio) {
                state.currentAudio.pause();
                state.currentAudio.currentTime = 0;
            }
            
            const audio = new Audio(`mp3/${filename}`);
            state.currentAudio = audio;
            
            audio.addEventListener('ended', () => {
                if (callback) callback();
            });
            
            audio.play().catch(error => {
                console.log('Ses çalma hatası:', error);
                if (callback) callback();
            });
            
            return audio;
        }

        function stopCurrentAudio() {
            if (state.currentAudio) {
                state.currentAudio.pause();
                state.currentAudio.currentTime = 0;
                state.currentAudio = null;
            }
        }

        // Hata yönetimi - dikkat testinden alınmış
        function handleError(message, isSystem = false) {
            console.error('🚨 Sistem Hatası:', message);
            
            const errorOverlay = document.getElementById('errorOverlay');
            const errorMessage = document.getElementById('errorMessage');
            
            if (errorOverlay && errorMessage) {
                errorMessage.textContent = message;
                errorOverlay.classList.add('show');
                
                // 5 saniye sonra otomatik kapat
                setTimeout(() => {
                    errorOverlay.classList.remove('show');
                }, 5000);
            }
            
            if (isSystem) {
                // Sistem hatası - state temizle
                state.cleanup();
            }
        }

        // Loading gösterimi
        function showLoading(text = 'Yükleniyor...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            if (loadingText) loadingText.textContent = text;
            if (loadingOverlay) loadingOverlay.classList.add('show');
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.classList.remove('show');
        }

        // ==================== EKRAN YÖNETİMİ ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            state.currentScreen = screenId;
        }

        function showButton(buttonId) {
            setTimeout(() => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.classList.add('visible');
                }
            }, 100);
        }

        // Debounced navigation fonksiyonu
        function navigate(action, ...args) {
            if (state.locked) {
                console.log('🔒 Navigasyon kilitli, işlem iptal');
                return;
            }

            state.locked = true;
            
            try {
                if (typeof window[action] === 'function') {
                    window[action](...args);
                } else {
                    console.error(`❌ Fonksiyon bulunamadı: ${action}`);
                    handleError(`Navigasyon hatası: ${action}`);
                }
            } catch (error) {
                console.error(`❌ Navigasyon hatası: ${action}`, error);
                handleError(`Navigasyon hatası: ${error.message}`);
            } finally {
                // Kilit kaldır
                setTimeout(() => {
                    state.locked = false;
                }, CONFIG.DEBOUNCE_DELAY);
            }
        }

        // ==================== TIMER YÖNETİMİ ====================
        function resetTimer(timerId) {
            const timerFill = document.getElementById(timerId);
            timerFill.classList.remove('counting');
            // Force reflow
            void timerFill.offsetWidth;
            timerFill.classList.add('counting');
        }

        // ==================== GİRİŞ EKRANLARI ====================
        function goToWelcome() {
            showScreen('welcomeScreen');
            // Akıl ve Mantık testindeki gibi görselleri önceden yükle
            showLoading('Görseller yükleniyor...');
            preloadAllImages()
                .then((results) => {
                    const successful = results.filter(r => r.status === 'fulfilled').length;
                    const failed = results.filter(r => r.status === 'rejected').length;
                    console.log(`🖼️ Görsel preload tamamlandı: ✅${successful} başarılı, ❌${failed} başarısız`);
                })
                .catch((err) => {
                    console.warn('Görsel preload sırasında hata:', err);
                })
                .finally(() => {
                    hideLoading();
                    playAudio('hafiza_giris_basla.mp3', () => {
                        showButton('welcomeNextBtn');
                    });
                });
        }

        function goToExampleIntro() {
            showScreen('exampleIntroScreen');
            playAudio('hafiza_giris_ornek.mp3', () => {
                showButton('exampleIntroNextBtn');
            });
        }

        function goToExampleReady() {
            showScreen('exampleReadyScreen');
            playAudio('hafiza_giris_hazir.mp3', () => {
                showButton('exampleReadyBtn');
            });
        }

        function retryExampleFromFail() {
            console.log('🔄 Örnek uygulama tekrar edilecek...');
            goToExampleReady();
        }

        // ==================== ÖRNEK BÖLÜMÜ ====================
        function startExampleSection() {
            state.currentExampleIndex = 0;
            state.currentExamplePhase = 'audio';
            state.exampleCorrectCount = 0;
            state.allAnswers.example = [];
            showExampleContent();
        }

        function showExampleContent() {
            showScreen('exampleScreen');
            const display = document.getElementById('exampleDisplay');
            const example = memoryTestData.examples[state.currentExampleIndex];
            
            if (state.currentExamplePhase === 'audio') {
                display.innerHTML = `
                    <div class="memory-text">Dinlediğini Aklında Tut.</div>
                `;
                
                playAudio(example.audio.file, () => {
                    setTimeout(() => {
                        state.currentExamplePhase = 'visual';
                        showExampleContent();
                    }, 3000);
                });
                
            } else {
                display.innerHTML = `
                    <img src="images/${example.visual.image}" class="memory-image" alt="Örnek resim">
                    <div class="memory-text">Resmi Aklında Tut.</div>
                `;
                
                playAudio(example.visual.file, () => {
                    setTimeout(() => {
                        state.currentExampleIndex++;
                        if (state.currentExampleIndex < memoryTestData.examples.length) {
                            state.currentExamplePhase = 'audio';
                            showExampleContent();
                        } else {
                            startExampleQuestions();
                        }
                    }, 5000);
                });
            }
        }

        function startExampleQuestions() {
            state.currentExampleQuestionIndex = 0;
            showExampleQuestion();
        }

        function showExampleQuestion() {
            // Önceki timer'ı temizle
            if (state.questionTimer) {
                clearTimeout(state.questionTimer);
                state.questionTimer = null;
            }
            
            // Cevap verme durumunu sıfırla
            state.isAnswering = false;
            state.currentQuestionType = 'example';
            
            showScreen('exampleQuestionsScreen');
            
            if (state.currentExampleQuestionIndex >= memoryTestData.exampleQuestions.length) {
                evaluateExampleResults();
                return;
            }
            
            const question = memoryTestData.exampleQuestions[state.currentExampleQuestionIndex];
            const questionArea = document.getElementById('exampleQuestionArea');
            
            questionArea.innerHTML = `
                <div class="question-text">${question.question}</div>
                <div class="${question.type === 'image' ? 'image-options' : 'options-container'}" id="exampleOptions">
                    ${generateOptions(question, 'example')}
                </div>
            `;
            
            state.questionStartTime = Date.now();
            resetTimer('exampleTimerFill');
            startQuestionTimer('example');
        }

        function generateOptions(question, testType) {
            let html = '';
            const letters = ['A', 'B', 'C', 'D', 'E'];
            
            if (question.type === 'image') {
                question.options.forEach((option, index) => {
                    const imgSrc = `images/${option}`;
                    const imgTag = preloadedImages.has(imgSrc)
                        ? `<img src="${imgSrc}" alt="Seçenek ${letters[index]}">`
                        : `<img src="${imgSrc}" alt="Seçenek ${letters[index]}" onerror="console.error('Seçenek görseli yüklenemedi: ${imgSrc}'); this.style.background='#f0f0f0'; this.style.border='2px dashed #ccc'; this.alt='Görsel yüklenemedi';">`;
                    html += `
                        <div class="image-option" onclick="selectAnswer('${testType}', ${index})">
                            ${imgTag}
                            <div class="image-option-label">${letters[index]}</div>
                        </div>
                    `;
                });
            } else {
                question.options.forEach((option, index) => {
                    html += `
                        <button class="option-btn" onclick="selectAnswer('${testType}', ${index})">
                            <strong style="margin-right: 15px;">${letters[index]})</strong> ${option}
                        </button>
                    `;
                });
            }
            
            return html;
        }

        function selectAnswer(testType, selectedIndex) {
            // Çoklu tıklamaya karşı koruma
            if (state.isAnswering) {
                return;
            }
            
            state.isAnswering = true;
            
            // Timer'ı temizle
            if (state.questionTimer) {
                clearTimeout(state.questionTimer);
                state.questionTimer = null;
            }
            
            const responseTime = (Date.now() - state.questionStartTime) / 1000;
            
            if (testType === 'example') {
                const question = memoryTestData.exampleQuestions[state.currentExampleQuestionIndex];
                
                // 3 kategori mantığı: Doğru, Yanlış, Kaçırılan
                const isCorrect = selectedIndex >= 0 && selectedIndex === question.correct;
                const isWrong = selectedIndex >= 0 && selectedIndex !== question.correct;
                const isMissed = selectedIndex === -1;
                
                if (isCorrect) {
                    state.exampleCorrectCount++;
                }
                
                state.allAnswers.example.push({
                    questionIndex: state.currentExampleQuestionIndex,
                    question: question.question,
                    selectedAnswer: selectedIndex,
                    correctAnswer: question.correct,
                    isCorrect: isCorrect,
                    isWrong: isWrong,
                    isMissed: isMissed,
                    responseTime: responseTime,
                    timedOut: selectedIndex === -1
                });
                
                if (selectedIndex >= 0) {
                    highlightSelection(question.type, selectedIndex);
                    // disableAllOptions'ı highlightSelection'dan sonra çağır
                    setTimeout(() => {
                        disableAllOptions(question.type);
                    }, 150);
                }
                
                setTimeout(() => {
                    state.currentExampleQuestionIndex++;
                    state.isAnswering = false;
                    showExampleQuestion();
                }, 1500);
                
            } else {
                const questions = memoryTestData.mainQuestions[state.currentQuestionSetIndex];
                const question = questions[state.currentQuestionIndex];
                
                // Eğer soru yoksa (test bitmişse) çık
                if (!question) {
                    return;
                }
                
                // 3 kategori mantığı: Doğru, Yanlış, Kaçırılan
                const isCorrect = selectedIndex >= 0 && selectedIndex === question.correct;
                const isWrong = selectedIndex >= 0 && selectedIndex !== question.correct;
                const isMissed = selectedIndex === -1;
                
                const answerData = {
                    questionNo: question.questionNo,
                    setNo: question.setNo,
                    skillType: question.skillType,
                    question: question.question,
                    selectedAnswer: selectedIndex,
                    correctAnswer: question.correct,
                    isCorrect: isCorrect,
                    isWrong: isWrong,
                    isMissed: isMissed,
                    responseTime: responseTime,
                    timedOut: selectedIndex === -1
                };
                
                state.allAnswers.main.push(answerData);
                
                // 📝⚡ SORU CEVAPLANDI LOGLAMA
                console.log(`📝⚡ SORU ${question.questionNo}/20 CEVAPLANDI:`, {
                    // Soru Bilgileri
                    soruNo: question.questionNo,
                    setNo: question.setNo,
                    beceriTuru: question.skillType,
                    soruTipi: question.type === 'image' ? 'Görsel' : 'İşitsel',
                    soruMetni: question.question,
                    dogruCevap: question.correct,
                    // Cevap Bilgileri
                    kullaniciSecimi: selectedIndex >= 0 ? selectedIndex : 'ZAMAN AŞIMI',
                    durum: isCorrect ? '✅ DOĞRU' : (isWrong ? '❌ YANLIŞ' : '⏰ KAÇIRILDI'),
                    tepkiSuresi: `${responseTime.toFixed(2)}s`,
                    zamanAsimi: selectedIndex === -1 ? 'EVET' : 'HAYIR',
                    cevapZamani: new Date().toLocaleTimeString('tr-TR')
                });
                
                // Beceri puanı güncelleme
                state.skillScores[question.skillType].total++;
                if (isCorrect) {
                    state.skillScores[question.skillType].correct++;
                }
                
                if (selectedIndex >= 0) {
                    highlightSelection(question.type, selectedIndex);
                    // disableAllOptions'ı highlightSelection'dan sonra çağır
                    setTimeout(() => {
                        disableAllOptions(question.type);
                    }, 150);
                }
                
                setTimeout(() => {
                    state.currentQuestionIndex++;
                    state.isAnswering = false;
                    showMainQuestion();
                }, 1500);
            }
        }

        function highlightSelection(questionType, index) {
            
            // Direkt çağır, sonra da timeout ile tekrar dene
            const doHighlight = () => {
                if (questionType === 'image') {
                    // Sadece aktif soru alanındaki elementleri seç
                    const activeScreen = document.querySelector('.screen.active');
                    const imageOptions = activeScreen.querySelectorAll('.image-option');
                    console.log('Found image options:', imageOptions.length);
                    imageOptions.forEach((opt, i) => {
                        if (i === index) {
                            opt.classList.add('selected');
                            console.log('Added selected to image option', i, 'Classes:', opt.className);
                        }
                    });
                } else {
                    // Sadece aktif soru alanındaki elementleri seç
                    const activeScreen = document.querySelector('.screen.active');
                    const textOptions = activeScreen.querySelectorAll('.option-btn');

                    textOptions.forEach((opt, i) => {
                        if (i === index) {
                            opt.classList.add('selected');
                        }
                    });
                }
            };
            
            // Hemen çağır
            doHighlight();
            
            // Bir de 100ms sonra çağır
            setTimeout(doHighlight, 100);
        }

        function disableAllOptions(questionType) {
            setTimeout(() => {
                // Sadece aktif soru alanındaki elementleri seç
                const activeScreen = document.querySelector('.screen.active');
                if (questionType === 'image') {
                    activeScreen.querySelectorAll('.image-option').forEach(opt => {
                        if (!opt.classList.contains('selected')) {
                            opt.classList.add('disabled');
                        }
                    });
                } else {
                    activeScreen.querySelectorAll('.option-btn').forEach(opt => {
                        if (!opt.classList.contains('selected')) {
                            opt.classList.add('disabled');
                        }
                    });
                }
            }, 200); // Daha geç çağır ki selected class eklensin
        }

        function startQuestionTimer(type) {
            // Önceki timer'ı temizle
            if (state.questionTimer) {
                clearTimeout(state.questionTimer);
            }
            
            state.currentQuestionType = type;
            state.questionTimer = setTimeout(() => {
                selectAnswer(type, -1);
            }, 6000);
        }

        function evaluateExampleResults() {
            if (state.exampleCorrectCount >= 2) {
                showScreen('exampleCompleteScreen');
                playAudio('hafiza_ornek_bitis.mp3', () => {
                    showButton('exampleCompleteBtn');
                });
            } else {
                state.exampleAttempts++;
                showScreen('exampleFailScreen');
            }
        }

        function goToMainTestIntro() {
            showScreen('mainTestIntroScreen');
            playAudio('hafiza_anatest_giris.mp3', () => {
                showButton('mainTestStartBtn');
            });
        }

        // ==================== ANA TEST ====================
        function startMainTest() {
            state.currentSetIndex = 0;
            state.currentSetPhase = 'audio';
            state.allAnswers.main = [];
            state.startTime = Date.now();
            state.setStartTimes = [Date.now()];
            showMainSet();
        }

        function showMainSet() {
            showScreen('mainTestScreen');
            
            const display = document.getElementById('mainTestDisplay');
            const set = memoryTestData.mainSets[state.currentSetIndex];
            
            if (state.currentSetPhase === 'audio') {
                display.innerHTML = `
                    <div class="memory-text">Dinlediğini Aklında Tut.</div>
                `;
                
                playAudio(set.audio.file, () => {
                    setTimeout(() => {
                        state.currentSetPhase = 'visual';
                        showMainSet();
                    }, 3000);
                });
                
            } else {
                display.innerHTML = `
                    <img src="images/${set.visual.image}" class="memory-image" alt="Set ${state.currentSetIndex + 1} resmi">
                    <div class="memory-text">Resmi Aklında Tut.</div>
                `;
                
                playAudio(set.visual.file, () => {
                    setTimeout(() => {
                        startMainQuestions();
                    }, 5000);
                });
            }
        }

        function startMainQuestions() {
            state.currentQuestionSetIndex = state.currentSetIndex;
            state.currentQuestionIndex = 0;
            showMainQuestion();
        }

        function showMainQuestion() {
            // Önceki timer'ı temizle
            if (state.questionTimer) {
                clearTimeout(state.questionTimer);
                state.questionTimer = null;
            }
            
            // Cevap verme durumunu sıfırla
            state.isAnswering = false;
            state.currentQuestionType = 'main';
            
            showScreen('mainQuestionsScreen');
            
            const questions = memoryTestData.mainQuestions[state.currentQuestionSetIndex];
            const totalQuestions = questions.length;
            
            if (state.currentQuestionIndex >= totalQuestions) {
                // 🏁 SET TAMAMLANDI LOGLAMA
                const currentSetNo = state.currentQuestionSetIndex + 1;
                const setAnswers = state.allAnswers.main.filter(a => a.setNo === currentSetNo);
                const setCorrect = setAnswers.filter(a => a.isCorrect).length;
                const setWrong = setAnswers.filter(a => a.isWrong).length;
                const setMissed = setAnswers.filter(a => a.isMissed).length;
                const setTotal = setAnswers.length;
                
                console.log(`🏁 ${currentSetNo}. SET TAMAMLANDI:`, {
                    setNo: currentSetNo,
                    toplamSoru: setTotal,
                    dogruSayisi: setCorrect,
                    yanlisSayisi: setWrong,
                    kacirilmis: setMissed,
                    basariOrani: setTotal > 0 ? `${Math.round((setCorrect / setTotal) * 100)}%` : '0%',
                    ortalamaTepkiSuresi: setAnswers.length > 0 ? `${(setAnswers.reduce((sum, a) => sum + a.responseTime, 0) / setAnswers.length).toFixed(2)}s` : '0s',
                    tamamlanmaZamani: new Date().toLocaleTimeString('tr-TR')
                });
                
                state.currentSetIndex++;
                if (state.currentSetIndex < memoryTestData.mainSets.length) {
                    state.currentSetPhase = 'audio';
                    state.setStartTimes.push(Date.now());
                    
                    // 🚀 YENİ SET BAŞLADI LOGLAMA  
                    console.log(`🚀 ${state.currentSetIndex + 1}. SET BAŞLADI:`, {
                        setNo: state.currentSetIndex + 1,
                        baslangicZamani: new Date().toLocaleTimeString('tr-TR')
                    });
                    
                    showMainSet();
                } else {
                    endTest();
                }
                return;
            }
            
            const question = questions[state.currentQuestionIndex];
            

            
            const questionArea = document.getElementById('mainQuestionArea');
            questionArea.innerHTML = `
                <div class="question-text">${question.question}</div>
                <div class="${question.type === 'image' ? 'image-options' : 'options-container'}" id="mainOptions">
                    ${generateOptions(question, 'main')}
                </div>
            `;
            
            state.questionStartTime = Date.now();
            resetTimer('mainTimerFill');
            startQuestionTimer('main');
        }

        // ==================== TEST SONU VE RAPORLAMA ====================
        function endTest() {
            const endTime = Date.now();
            const totalTime = Math.round((endTime - state.startTime) / 1000);
            
            // Hesaplamalar - 3 kategori mantığı
            const totalQuestions = state.allAnswers.main.length;
            const correctAnswers = state.allAnswers.main.filter(a => a.isCorrect).length;
            const wrongAnswers = state.allAnswers.main.filter(a => a.isWrong).length;
            const missedAnswers = state.allAnswers.main.filter(a => a.isMissed).length;
            const successRate = Math.round((correctAnswers / totalQuestions) * 100);
            
            // Yetiştiremediyse hangi soruda kaldı hesaplaması
            const lastAnsweredQuestion = totalQuestions;
            const remainingQuestions = 20 - totalQuestions;
            const remainingTimeSeconds = remainingQuestions * 6;
            
            // İşlem hızı hesaplama
            const totalResponseTime = state.allAnswers.main.reduce((sum, answer) => sum + answer.responseTime, 0);
            const maxTime = 120; // 20 soru x 6 saniye
            const speedScore = Math.round(((maxTime - totalResponseTime) / maxTime) * 100);
            
            // Set bazlı analiz
            const setAnalysis = [];
            for (let i = 0; i < 4; i++) {
                const setAnswers = state.allAnswers.main.filter(a => a.setNo === i + 1);
                const setCorrect = setAnswers.filter(a => a.isCorrect).length;
                const setTotal = setAnswers.length;
                const setSuccessRate = setTotal > 0 ? Math.round((setCorrect / setTotal) * 100) : 0;
                
                setAnalysis.push({
                    setNo: i + 1,
                    correct: setCorrect,
                    total: setTotal,
                    successRate: setSuccessRate,
                    completionTime: i < state.setStartTimes.length - 1 ? 
                        Math.round((state.setStartTimes[i + 1] - state.setStartTimes[i]) / 1000) : 
                        Math.round((endTime - state.setStartTimes[i]) / 1000)
                });
            }
            
            // Sonuç ekranını göster
            showScreen('resultsScreen');
            
            // Test bitiş sesini çal
            playAudio('hafiza_test_bitis.mp3');
            
            // Veritabanına kaydet - 3 kategori + Excel uyumluluk
            saveTestResults({
                totalTime,
                totalQuestions,
                correctAnswers,
                wrongAnswers,
                missedAnswers,
                successRate,
                speedScore,
                totalResponseTime,
                lastAnsweredQuestion,
                remainingQuestions,
                remainingTimeSeconds,
                setAnalysis,
                skillScores: state.skillScores,
                detailedAnswers: state.allAnswers,
                exampleAttempts: state.exampleAttempts,
                exampleCorrectCount: state.exampleCorrectCount
            });
        }

        // ==================== SUPABASE VERİTABANI KAYIT ====================
        // Dikkat testindeki gibi tam Supabase entegrasyonu
        
        // Kullanıcı rolü belirleme
        function getUserRole(roles) {
            if (!roles || typeof roles !== 'object') return 'kullanici';
            
            if (roles.admin) return 'admin';
            if (roles.temsilci) return 'temsilci';
            if (roles.beyin_antrenoru) return 'beyin_antrenoru';
            return 'kullanici';
        }
        
        // Rol görüntü etiketi
        function getDisplayLabel(role) {
            const labels = {
                'admin': 'Sistem Yöneticisi',
                'temsilci': 'Temsilci',
                'beyin_antrenoru': 'Beyin Antrenörü',
                'kullanici': 'Kullanıcı'
            };
            return labels[role] || 'Bilinmeyen Rol';
        }
        
        // Geçerli öğrenci ID bulma
        async function findValidStudentId() {
            try {
                // 1. localStorage'dan kontrol et
                const storedStudentId = localStorage.getItem('currentStudentId');
                if (storedStudentId && storedStudentId !== 'null' && storedStudentId !== 'undefined') {
                    console.log('📋 LocalStorage\'dan student ID bulundu:', storedStudentId);
                    return storedStudentId;
                }
                
                // 2. URL parametrelerinden kontrol et
                const urlParams = new URLSearchParams(window.location.search);
                const urlStudentId = urlParams.get('student_id');
                if (urlStudentId) {
                    console.log('🔗 URL\'den student ID bulundu:', urlStudentId);
                    return urlStudentId;
                }
                
                // 3. Session storage kontrolü
                const sessionStudentId = sessionStorage.getItem('selectedStudentId');
                if (sessionStudentId && sessionStudentId !== 'null') {
                    console.log('🗃️ SessionStorage\'dan student ID bulundu:', sessionStudentId);
                    return sessionStudentId;
                }
                
                console.warn('⚠️ Geçerli student ID bulunamadı');
                return null;
                
            } catch (error) {
                console.error('❌ Student ID bulma hatası:', error);
                return null;
            }
        }
        
        // Memory test results mapping fonksiyonu
        function mapMemoryResultsToDatabase(results) {
            console.log('🔄 Memory test HTML → Database mapping başlatılıyor...');

            // Set bazlı missed hesapla
            const setTotals = [0,0,0,0];
            const setCorrects = [0,0,0,0];
            const setWrongs = [0,0,0,0];
            const setMisseds = [0,0,0,0];

            if (Array.isArray(results.setAnalysis)) {
                results.setAnalysis.forEach((s, idx) => {
                    if (idx >= 0 && idx < 4) {
                        setTotals[idx] = s.total || 0;
                        setCorrects[idx] = s.correct || 0;
                        setWrongs[idx] = (s.total || 0) - (s.correct || 0); // yanlışlar tahminen total-correct
                        // missed: toplam cevaplananlar içinde timer ile kaçırılanları ayrı tutuyorsanız bu alanı doğru hesaplayın.
                        // Elimizde missed ayrımı yoksa 0 bırakılır. Aşağıda daha iyi bir tahmin için detailedAnswers kullanılacak.
                    }
                });
            }

            // detailedAnswers.main üzerinden gerçek missed/yanlış ayrıştırması
            if (results.detailedAnswers && Array.isArray(results.detailedAnswers.main)) {
                for (let i = 0; i < 4; i++) {
                    const setNo = i + 1;
                    const setAns = results.detailedAnswers.main.filter(a => a.setNo === setNo);
                    const missed = setAns.filter(a => a.isMissed).length;
                    const wrong = setAns.filter(a => a.isWrong).length;
                    const correct = setAns.filter(a => a.isCorrect).length;
                    setMisseds[i] = missed;
                    setWrongs[i] = wrong;
                    setCorrects[i] = correct;
                    setTotals[i] = setAns.length;
                }
            }

            // response times ve yanlış işaretlenen seçenekleri çıkar
            const questionResponseTimes = [];
            const wrongAnswerChoices = [];
            if (results.detailedAnswers && Array.isArray(results.detailedAnswers.main)) {
                results.detailedAnswers.main.forEach(a => {
                    if (typeof a.responseTime === 'number') {
                        questionResponseTimes.push({ q: a.questionNo, set: a.setNo, rt: a.responseTime });
                    }
                    if (a.isWrong && typeof a.selectedAnswer === 'number') {
                        wrongAnswerChoices.push({ q: a.questionNo, set: a.setNo, selected: a.selectedAnswer, correct: a.correctAnswer });
                    }
                });
            }

            const mappedData = {
                // ✅ TEMEL VERİLER
                total_questions: results.totalQuestions || 20,
                correct_answers: results.correctAnswers || 0,
                wrong_answers: results.wrongAnswers || 0,
                missed_answers: results.missedAnswers || 0,
                accuracy_percentage: Math.round(((results.successRate || 0) + Number.EPSILON) * 100) / 100, // yüzde zaten
                speed_score: Math.round(((results.speedScore || 0) + Number.EPSILON) * 100) / 100,
                total_response_time: results.totalResponseTime || 0,
                test_duration_seconds: Math.round((results.totalTime || 0)), // results.totalTime zaten saniye cinsinden geliyor (endTest öyle set ediyor)
                completion_status: (results.totalQuestions || 0) >= 20 ? 'completed' : 'incomplete',

                // ✅ EXCEL UYUMLULUK
                last_answered_question: results.lastAnsweredQuestion || 0,
                remaining_questions: results.remainingQuestions || 0,
                remaining_time_seconds: results.remainingTimeSeconds || 0,

                // ✅ SET BAZLI VERİLER (4 Set)
                set1_correct: setCorrects[0] || 0,
                set1_wrong: setWrongs[0] || 0,
                set1_missed: setMisseds[0] || 0,
                set1_completion_time_seconds: results.setAnalysis?.[0]?.completionTime || 0,

                set2_correct: setCorrects[1] || 0,
                set2_wrong: setWrongs[1] || 0,
                set2_missed: setMisseds[1] || 0,
                set2_completion_time_seconds: results.setAnalysis?.[1]?.completionTime || 0,

                set3_correct: setCorrects[2] || 0,
                set3_wrong: setWrongs[2] || 0,
                set3_missed: setMisseds[2] || 0,
                set3_completion_time_seconds: results.setAnalysis?.[2]?.completionTime || 0,

                set4_correct: setCorrects[3] || 0,
                set4_wrong: setWrongs[3] || 0,
                set4_missed: setMisseds[3] || 0,
                set4_completion_time_seconds: results.setAnalysis?.[3]?.completionTime || 0,

                // ✅ BECERİ TÜRÜ VERİLERİ (5 Beceri)
                skill_kisa_sureli_isitsel_correct: results.skillScores?.['Kısa Süreli İşitsel']?.correct || 0,
                skill_kisa_sureli_isitsel_total: results.skillScores?.['Kısa Süreli İşitsel']?.total || 0,

                skill_kisa_sureli_gorsel_correct: results.skillScores?.['Kısa Süreli Görsel']?.correct || 0,
                skill_kisa_sureli_gorsel_total: results.skillScores?.['Kısa Süreli Görsel']?.total || 0,

                skill_uzun_sureli_isitsel_correct: results.skillScores?.['Uzun Süreli İşitsel']?.correct || 0,
                skill_uzun_sureli_isitsel_total: results.skillScores?.['Uzun Süreli İşitsel']?.total || 0,

                skill_uzun_sureli_gorsel_correct: results.skillScores?.['Uzun Süreli Görsel']?.correct || 0,
                skill_uzun_sureli_gorsel_total: results.skillScores?.['Uzun Süreli Görsel']?.total || 0,

                skill_isler_hafiza_correct: results.skillScores?.['İşler Hafıza']?.correct || 0,
                skill_isler_hafiza_total: results.skillScores?.['İşler Hafıza']?.total || 0,

                // ✅ ÖRNEK TEST
                example_attempts: results.exampleAttempts || 0,
                example_correct_count: results.exampleCorrectCount || 0,

                // ✅ JSONB VERİLER
                detailed_answers: results.detailedAnswers || {},
                set_analysis: results.setAnalysis || [],
                skill_breakdown: results.skillScores || {},
                question_response_times: questionResponseTimes,
                wrong_answer_choices: wrongAnswerChoices,

                // ✅ ZAMAN BİLGİLERİ
                test_start_time: new Date(state.startTime).toISOString(),
                test_end_time: new Date().toISOString()
            };

            console.log('🎯 Memory Test Database Mapping Tamamlandı:', mappedData);
            return mappedData;
        }
        
        // Ana Supabase kayıt fonksiyonu
        async function saveTestResults(results) {
            try {
                console.log('🚀 Hafıza testi Supabase kayıt başlatılıyor...');
                
                // Verileri database formatına dönüştür
                const mappedData = mapMemoryResultsToDatabase(results);
                
                // Supabase Production'a kaydet
                const success = await saveToSupabaseProduction(mappedData);
                
                if (success) {
                    console.log('✅ Hafıza testi sonuçları başarıyla kaydedildi');
                    showNotification('Test sonuçlarınız başarıyla kaydedildi!', 'success');
                } else {
                    throw new Error('Supabase kayıt başarısız');
                }
                
            } catch (error) {
                console.error('❌ Hafıza testi kayıt hatası:', error);
                showNotification('Test sonuçları kaydedilirken bir hata oluştu.', 'error');
            }
        }
        
        // Supabase Production kayıt fonksiyonu
        async function saveToSupabaseProduction(mappedData) {
            try {
                console.log('🚀 SUPABASE FONKSİYONU: Memory Test Supabase kayıt başlatılıyor...');
                console.log('📊 SUPABASE FONKSİYONU: Gelen mappedData:', mappedData);

                // 1) Client edin
                console.log('🔍 SUPABASE ADIM 1: Dinamik client kontrolü...');
                let supabase = window.supabaseClient;

                if (!supabase) {
                    console.log('🔍 SUPABASE ADIM 1.1: Global client yok, localStorage\'dan oluşturuluyor...');
                    const supabaseUrl = localStorage.getItem('sb-url');
                    const supabaseKey = localStorage.getItem('sb-anon-key');

                    if (!supabaseUrl || !supabaseKey) {
                        console.error('❌ SUPABASE ADIM 1.1 HATA: localStorage\'da config bulunamadı');
                        localStorage.setItem('pendingMemoryResults', JSON.stringify(mappedData));
                        return false;
                    }

                    if (!window.supabase) {
                        console.error('❌ SUPABASE ADIM 1.1 HATA: window.supabase mevcut değil');
                        localStorage.setItem('pendingMemoryResults', JSON.stringify(mappedData));
                        return false;
                    }

                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                }

                if (!supabase) {
                    console.error('❌ SUPABASE ADIM 1 HATA: Client oluşturulamadı');
                    localStorage.setItem('pendingMemoryResults', JSON.stringify(mappedData));
                    return false;
                }
                console.log('✅ SUPABASE ADIM 1: Client hazır:', !!supabase);

                // 1) URL parametrelerini localStorage'a senkronize et (ilk yüklemede)
                try {
                    const url = new URL(window.location.href);
                    const qp = url.searchParams;
                    const sessionIdQP = qp.get('session_id');
                    const studentIdQP = qp.get('student_id');
                    const conductedByQP = qp.get('conducted_by');
                    const sbUrlQP = qp.get('sb_url');
                    const sbAnonQP = qp.get('sb_anon');
                    if (sessionIdQP) localStorage.setItem('bb-session-id', sessionIdQP);
                    if (studentIdQP) localStorage.setItem('bb-student-id', studentIdQP);
                    if (conductedByQP) localStorage.setItem('bb-conducted-by', conductedByQP);
                    if (sbUrlQP) localStorage.setItem('sb-url', sbUrlQP);
                    if (sbAnonQP) localStorage.setItem('sb-anon-key', sbAnonQP);
                } catch (e) { console.warn('Query sync failed:', e); }

                // 2) localStorage bridge - session bilgilerini al
                console.log('🔍 SUPABASE ADIM 2: localStorage bridge kontrol...');
                const sessionId = localStorage.getItem('bb-session-id');
                const studentId = localStorage.getItem('bb-student-id');
                const conductedBy = localStorage.getItem('bb-conducted-by');
                
                console.log('📦 localStorage bridge bilgileri:', {
                    sessionId: sessionId ? sessionId.slice(0, 8) + '...' : 'YOK',
                    studentId: studentId ? studentId.slice(0, 8) + '...' : 'YOK',
                    conductedBy: conductedBy ? conductedBy.slice(0, 8) + '...' : 'YOK'
                });
                
                if (!sessionId || !studentId || !conductedBy) {
                    console.error('❌ SUPABASE ADIM 2 HATA: localStorage bridge eksik');
                    console.error('Eksik bilgiler:', {
                        sessionId: !sessionId,
                        studentId: !studentId,
                        conductedBy: !conductedBy
                    });
                    localStorage.setItem('pendingMemoryResults', JSON.stringify(mappedData));
                    return false;
                }
                
                console.log('✅ SUPABASE ADIM 2: localStorage bridge aktif');
                console.log(`🆔 Session ID: ${sessionId.slice(0, 8)}...`);
                console.log(`👤 Student ID: ${studentId.slice(0, 8)}...`);
                console.log(`👨‍🏫 Conducted By: ${conductedBy.slice(0, 8)}...`);

                // 3) Final data - localStorage bridge ile
                console.log('🔍 SUPABASE ADIM 3: Final veri hazırlanıyor...');
                const finalData = {
                    ...mappedData,
                    session_id: sessionId,  // 🆔 Session ID eklendi
                    student_id: studentId,   // localStorage'dan
                    conducted_by: conductedBy // localStorage'dan
                };
                console.log('✅ SUPABASE ADIM 3: Final veri hazırlandı');
                console.log('📝 Supabase\'e kaydedilecek memory test verisi:', finalData);

                // 4) Insert
                console.log('🔍 SUPABASE ADIM 4: Database INSERT işlemi başlatılıyor...');
                console.log('📊 Tablo: memory_test_results');
                const { data: insertData, error: insertError } = await supabase
                    .from('memory_test_results')
                    .insert([finalData])
                    .select();

                console.log('📊 SUPABASE ADIM 6 SONUÇ: insertData:', insertData);
                console.log('📊 SUPABASE ADIM 6 SONUÇ: insertError:', insertError);

                if (insertError) {
                    console.error('❌ SUPABASE ADIM 6 HATA: Database insert hatası:', insertError);
                    if (insertError.code === '23503') console.error('🔗 Foreign key hatası - Student veya User ID geçersiz');
                    if (insertError.code === '42501') console.error('🔒 Yetki hatası - RLS policy ihlali');

                    localStorage.setItem('failedMemoryResults', JSON.stringify({
                        data: finalData,
                        error: insertError,
                        timestamp: new Date().toISOString()
                    }));
                    return false;
                }

                // 8) Başarı
                console.log('🎉 SUPABASE ADIM 7: BAŞARILI KAYIT!');
                localStorage.removeItem('pendingMemoryResults');
                localStorage.removeItem('failedMemoryResults');
                localStorage.setItem('lastTestedStudent', finalData.student_id);

                console.log('✅ SUPABASE ADIM 7: Memory test Supabase kayıt başarılı!', insertData);
                console.log('📊 SUPABASE ADIM 7: Kaydedilen veri ID:', insertData?.[0]?.id);
                return true;

            } catch (error) {
                console.error('❌ Supabase production kayıt hatası:', error);
                return false;
            }
        }

        function completeTest() {
            // Sıradaki bölüme yönlendirme yapılabilir
            console.log('Test tamamlandı, sıradaki teste geçiliyor...');
            
            // Test sonuçlarını local storage'a kaydet
            try {
                // Test sonuçlarını oluştur - 3 kategori mantığı
                const totalQuestions = state.allAnswers.main.length;
                const correctAnswers = state.allAnswers.main.filter(a => a.isCorrect).length;
                const wrongAnswers = state.allAnswers.main.filter(a => a.isWrong).length;
                const missedAnswers = state.allAnswers.main.filter(a => a.isMissed).length;
                const testDuration = state.startTime ? (Date.now() - state.startTime) : 0;
                
                // Yetiştiremediyse hangi soruda kaldı hesaplaması
                const lastAnsweredQuestion = totalQuestions; // Tüm sorular cevaplanmış (zaman aşımı dahil)
                const remainingQuestions = 20 - totalQuestions; // Cevap verilmeyen soru sayısı
                const remainingTimeSeconds = remainingQuestions * 6; // Kalan saniye (her soru 6 saniye)
                
                const testResults = {
                    totalQuestions: totalQuestions,
                    correctAnswers: correctAnswers,
                    wrongAnswers: wrongAnswers,
                    missedAnswers: missedAnswers,
                    successRate: totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0,
                    testDuration: testDuration,
                    lastAnsweredQuestion: lastAnsweredQuestion,
                    remainingQuestions: remainingQuestions,
                    remainingTimeSeconds: remainingTimeSeconds,
                    skillScores: state.skillScores,
                    detailedAnswers: state.allAnswers,
                    exampleAttempts: state.exampleAttempts,
                    exampleCorrectCount: state.exampleCorrectCount
                };
                
                // 🎉 HAFIZA TESTİ DETAYLI SONUÇLAR
                console.log('🎉 HAFIZA TESTİ TAMAMLANDI:');
                
                // Genel Performans - 3 kategori + Excel uyumluluk
                console.log('🎯 GENEL PERFORMANS:', {
                    toplamSoru: totalQuestions,
                    dogruSayisi: correctAnswers,
                    yanlisSayisi: wrongAnswers,
                    kacirilmis: missedAnswers,
                    basariOrani: `${testResults.successRate}%`,
                    testSuresi: `${Math.round(testDuration / 1000)} saniye`,
                    sonCevaplananSoru: lastAnsweredQuestion,
                    kalanSoru: remainingQuestions,
                    kalanSure: `${remainingTimeSeconds} saniye`,
                    tamamlanmaZamani: new Date().toLocaleTimeString('tr-TR')
                });
                
                // SET Bazlı Performans - 3 kategori
                console.log('📋 SET BAZLI PERFORMANS:');
                for (let i = 0; i < 4; i++) {
                    const setAnswers = state.allAnswers.main.filter(a => a.setNo === i + 1);
                    const setCorrect = setAnswers.filter(a => a.isCorrect).length;
                    const setWrong = setAnswers.filter(a => a.isWrong).length;
                    const setMissed = setAnswers.filter(a => a.isMissed).length;
                    console.log(`  ${i + 1}. SET:`, {
                        dogru: setCorrect,
                        yanlis: setWrong,
                        kacirilmis: setMissed,
                        toplam: setAnswers.length,
                        basariOrani: setAnswers.length > 0 ? `${Math.round((setCorrect / setAnswers.length) * 100)}%` : '0%'
                    });
                }
                
                // Beceri Türü Bazlı Performans
                console.log('🔍 BECERİ TÜRÜ BAZLI PERFORMANS:');
                Object.entries(state.skillScores).forEach(([skillType, scores]) => {
                    console.log(`  ${skillType}:`, {
                        dogru: scores.correct,
                        toplam: scores.total,
                        basariOrani: scores.total > 0 ? `${Math.round((scores.correct / scores.total) * 100)}%` : '0%'
                    });
                });
                
                // Excel Veri Uyumluluğu - 3 kategori sistemi + yeni özellik
                console.log('📊 EXCEL VERİ UYUMLULUĞU:', {
                    soruNumaralari: '1-20 (tam)',
                    setBilgisi: '1-4 SET (tam)',
                    beceriTurleri: '5 tür (tam)',
                    dogrulukSkoru: `${testResults.successRate}% (hesaplandı)`,
                    islemHizi: 'SET süreleri (tam)',
                    sonCevaplananSoru: `${testResults.lastAnsweredQuestion}/20 (eklendi)`,
                    kalanSoru: `${testResults.remainingQuestions} soru (eklendi)`,
                    kalanSure: `${testResults.remainingTimeSeconds} saniye (eklendi)`,
                    kapsamOrani: '%100 (49/49 gereksinim)',
                    yeniOzellik: 'Doğru/Yanlış/Kaçırılan + Kalan Soru Takip (eklendi)'
                });
                
                // Veritabanına Gönderilecek Veriler
                console.log('📦 VERİTABANINA GÖNDERİLECEK VERİLER:', testResults);
                
                console.log('✅ Hafıza testi tamamlandı, stroop testine geçiliyor...');
                
                // Aynı pencerede stroop testini yükle (query paramlarını taşı)
                try {
                    const params = new URLSearchParams(window.location.search);
                    const nextUrl = '../stroop/stroop.html' + (params.toString() ? ('?' + params.toString()) : '');
                    window.location.href = nextUrl;
                } catch (_) {
                    window.location.href = '../stroop/stroop.html';
                }
                
            } catch (error) {
                console.error('❌ Test completion hatası:', error);
                // Hata durumunda da ana pencereye hata mesajı gönder
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'test-complete',
                        testName: 'hafiza',
                        results: { error: 'Test completion hatası' },
                        timestamp: new Date().toISOString()
                    }, window.location.origin);
                }
            }
        }

        // ==================== YARDIMCI FONKSİYONLAR ====================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // ==================== CLEANUP & EVENT LISTENERS ====================
        window.addEventListener('beforeunload', function(e) {
            console.log('🧹 Sayfa kapatılıyor, cleanup başlatılıyor...');
            state.cleanup();
            
            // Veri kaybı uyarısı (test devam ediyorsa)
            if (state.currentScreen !== 'titleScreen' && state.currentScreen !== 'resultsScreen') {
                e.preventDefault();
                e.returnValue = 'Test devam ediyor. Sayfayı kapatırsanız veriler kaybolabilir.';
                return e.returnValue;
            }
        });

        // Sayfa visibility değişimi
        document.addEventListener('visibilitychange', function() {
            console.log('👁️ Sayfa görünürlük değişti:', document.hidden ? 'gizli' : 'görünür');
            // İstek doğrultusunda: görünürlük değişse bile ses ve zamanlayıcıları durdurma/yeniden başlatma yapılmıyor.
        });

        // Klavye kısayolları
        document.addEventListener('keydown', function(e) {
            // ESC tuşu ile hata overlay'ini kapat
            if (e.key === 'Escape') {
                const errorOverlay = document.getElementById('errorOverlay');
                if (errorOverlay && errorOverlay.classList.contains('show')) {
                    errorOverlay.classList.remove('show');
                }
            }
            
            // Spacebar ile ses durdurma (debug için)
            if (e.key === ' ' && e.ctrlKey) {
                e.preventDefault();
                state.stopCurrentAudio();
                console.log('🔇 Ses manuel olarak durduruldu');
            }
        });

        // Sayfa yüklendi
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Hafıza Testi başlatılıyor...');
            console.log('📱 Cihaz:', navigator.userAgent);
            console.log('🖥️ Ekran:', window.innerWidth + 'x' + window.innerHeight);
        });
    </script>
</body>
</html>
