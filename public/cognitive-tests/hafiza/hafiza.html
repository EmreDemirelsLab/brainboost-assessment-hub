<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ForTest HafÄ±za Testi</title>
    <style>
        :root {
            --primary: #60a5fa;
            --primary-dark: #2563eb;
            --secondary: #f43f5e;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #0f172a;
            --gray: #94a3b8;
            --gray-light: #e2e8f0;
            --border-radius: 8px;
            --font-main: 'Segoe UI', Roboto, Arial, sans-serif;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
            
            /* Responsive deÄŸiÅŸkenler - dikkatsaÄŸlam.html ile aynÄ± */
            --container-padding: clamp(15px, 4vw, 50px);
            --font-size-base: clamp(14px, 2vw, 18px);
            --font-size-large: clamp(18px, 3vw, 24px);
            --font-size-xlarge: clamp(24px, 4vw, 48px);
            --font-size-xxlarge: clamp(32px, 6vw, 64px);
            --button-padding: clamp(12px, 2vw, 18px) clamp(20px, 4vw, 40px);
            --gap-size: clamp(10px, 2vw, 20px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            line-height: 1.6;
            color: var(--dark);
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #1d4ed8 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            font-size: var(--font-size-base);
            margin: 0;
        }

        /* Container 1200x800 aspect ratio - yukarÄ±-aÅŸaÄŸÄ± tam dolu */
        .container {
            background: linear-gradient(145deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            border-radius: clamp(15px, 3vw, 20px);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                0 15px 30px rgba(0, 0, 0, 0.3),
                inset 0 2px 5px rgba(255, 255, 255, 0.1);
            padding: var(--container-padding);
            /* Dynamic sizing: clamp width and keep 3:2 ratio */
            width: clamp(320px, 90vw, 1200px);
            aspect-ratio: 3 / 2;
            height: auto;
            text-align: center;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
        }

        /* Loading overlay - smooth transitions */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 58, 138, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: white;
            font-size: var(--font-size-large);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error message */
        .error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(239, 68, 68, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            flex-direction: column;
            text-align: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .error-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .error-message {
            color: white;
            font-size: var(--font-size-large);
            text-align: center;
            padding: 20px;
            line-height: 1.6;
        }

        .screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: var(--container-padding);
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* BaÅŸlangÄ±Ã§ ekranÄ± */
        .title-screen h1 {
            font-size: var(--font-size-xxlarge);
            color: white;
            font-weight: 700;
            margin-bottom: clamp(25px, 6vw, 50px);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            line-height: 1.2;
        }

        .instruction-box {
            background: transparent;
            border-radius: 0;
            padding: clamp(10px, 3vw, 20px);
            margin: clamp(15px, 4vw, 30px) auto;
            max-width: min(90%, 800px);
            box-shadow: none;
            border: none;
        }

        .instruction-text {
            font-size: var(--font-size-large);
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: clamp(10px, 3vw, 20px);
            line-height: 1.8;
        }

        .highlight-text {
            color: white;
            font-weight: bold;
            font-size: clamp(20px, 3.5vw, 28px);
            margin: clamp(10px, 3vw, 20px) 0;
            line-height: 1.8;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .btn {
            display: inline-block;
            font-weight: 500;
            color: white;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            padding: var(--button-padding);
            font-size: clamp(16px, 2.5vw, 22px);
            line-height: 1.5;
            border-radius: var(--border-radius);
            transition: opacity 0.5s ease, transform 0.5s ease, background 0.3s ease, box-shadow 0.3s ease;
            border: none;
            box-shadow: 
                0 4px 6px rgba(30, 64, 175, 0.3),
                0 0 15px rgba(255, 255, 255, 0.3),
                0 0 25px rgba(255, 255, 255, 0.1);
            text-decoration: none;
            margin: clamp(5px, 1vw, 10px);
            opacity: 0;
            transform: translateY(20px);
            min-width: clamp(100px, 20vw, 150px);
            position: relative;
            overflow: hidden;
            min-height: clamp(44px, 8vw, 56px);
        }

        .btn.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn:hover:not(.disabled) {
            background: linear-gradient(135deg, #1e3d9f 0%, #2454d6 100%);
            box-shadow: 
                0 6px 8px rgba(30, 58, 138, 0.4),
                0 0 20px rgba(255, 255, 255, 0.4),
                0 0 35px rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .btn-bottom-right {
            position: absolute;
            bottom: clamp(20px, 4vw, 40px);
            right: clamp(20px, 4vw, 40px);
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .btn-bottom-right.visible {
            opacity: 1;
        }

        .test-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .memory-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            width: 100%;
        }

        .memory-text {
            font-size: clamp(16px, 2.5vw, 22px);
            color: white;
            font-weight: 500;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
            position: absolute;
            bottom: clamp(20px, 4vw, 40px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            text-align: center;
            width: max-content;
            max-width: 80%;
            padding: clamp(12px, 2vw, 18px) clamp(20px, 4vw, 40px);
            background: rgba(30, 64, 175, 0.8);
            backdrop-filter: blur(8px);
            border-radius: var(--border-radius);
            line-height: 1.5;
            margin: clamp(5px, 1vw, 10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .memory-image {
            max-width: min(83%, 765px);
            max-height: clamp(383px, 60vh, 638px);
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            margin: clamp(15px, 4vw, 30px) 0;
        }

        #exampleQuestionArea, #mainQuestionArea {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: clamp(20px, 4vw, 30px);
        }

        .question-text {
            font-size: var(--font-size-large);
            color: white;
            margin-bottom: clamp(15px, 4vw, 30px);
            font-weight: 500;
            line-height: 1.6;
        }

        /* YazÄ±lÄ± seÃ§enekler - alt alta */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: clamp(8px, 2vw, 15px);
            align-items: center;
            margin: clamp(15px, 4vw, 30px) auto;
            width: 100%;
            max-width: min(95%, 600px);
        }

        .option-btn {
            width: 100%;
            padding: clamp(10px, 2vw, 15px) clamp(15px, 4vw, 30px);
            font-size: var(--font-size-base);
            font-weight: 500;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            color: black;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-align: left;
            display: flex;
            align-items: center;
        }



        .option-btn.disabled, .image-option.disabled {
            pointer-events: none !important;
            opacity: 0.7 !important;
        }

        .option-btn.selected {
            background: linear-gradient(135deg, #90cdf4 0%, #60a5fa 100%) !important;
            color: black !important;
            border-color: #90cdf4 !important;
            opacity: 1 !important;
            box-shadow: 
                0 clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 6px) rgba(0, 0, 0, 0.2),
                0 1px 3px rgba(0, 0, 0, 0.15),
                inset 0 2px 2px rgba(255, 255, 255, 0.8) !important;
        }

        /* GÃ¶rsel seÃ§enekler - tek satÄ±rda A B C D E ile */
        .image-options {
            display: flex;
            justify-content: center;
            gap: clamp(15px, 3vw, 25px);
            max-width: 100%;
            margin: clamp(15px, 4vw, 30px) auto;
            flex-wrap: wrap;
        }

        .image-option {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
        }

        .image-option img {
            width: clamp(100px, 18vw, 140px);
            height: clamp(100px, 18vw, 140px);
            object-fit: cover;
            display: block;
            border-radius: 8px;
        }

        .image-option-label {
            background: rgba(255, 255, 255, 0.9);
            color: black;
            font-weight: bold;
            font-size: clamp(12px, 2vw, 16px);
            padding: clamp(4px, 1vw, 6px) clamp(8px, 1.5vw, 10px);
            border-radius: 5px;
            margin-bottom: 6px;
            min-width: 25px;
            text-align: center;
        }



        .image-option.selected {
            border-color: #90cdf4;
            box-shadow: 0 0 0 3px rgba(144, 205, 244, 0.4);
        }

        .image-option.selected .image-option-label {
            background: linear-gradient(135deg, #90cdf4 0%, #60a5fa 100%);
            color: black;
            box-shadow: 
                0 clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 6px) rgba(0, 0, 0, 0.2),
                0 1px 3px rgba(0, 0, 0, 0.15),
                inset 0 2px 2px rgba(255, 255, 255, 0.8);
        }



        /* Timer bar her soru iÃ§in sÄ±fÄ±rlanacak */
        .timer-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: clamp(6px, 1vw, 8px);
            background: rgba(255, 255, 255, 0.2);
            overflow: hidden;
            border-bottom-left-radius: clamp(15px, 3vw, 20px);
            border-bottom-right-radius: clamp(15px, 3vw, 20px);
        }

        .timer-fill {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
            transform-origin: left;
            transform: scaleX(1);
            border-bottom-left-radius: clamp(15px, 3vw, 20px);
            border-bottom-right-radius: clamp(15px, 3vw, 20px);
        }

        .timer-fill.counting {
            animation: countdown 6s linear forwards;
        }

        @keyframes countdown {
            from {
                transform: scaleX(1);
            }
            to {
                transform: scaleX(0);
            }
        }

        /* SonuÃ§ ekranÄ± */
        .result-message {
            font-size: clamp(28px, 5vw, 48px);
            color: white;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: clamp(15px, 4vw, 30px);
            line-height: 1.2;
        }

        .result-info {
            font-size: var(--font-size-large);
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .notification {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 30px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: var(--font-size-base);
        }

        .notification.success {
            background-color: var(--success);
        }

        .notification.error {
            background-color: var(--danger);
        }

        .notification.show {
            opacity: 1;
        }

        /* Responsive Media Queries */
        
        /* Ã‡ok kÃ¼Ã§Ã¼k telefon ekranlarÄ± */
        @media (max-width: 360px) {
            .container {
                padding: clamp(10px, 3vw, 15px);
            }
            .image-options {
                grid-template-columns: repeat(2, 1fr);
                gap: clamp(5px, 2vw, 10px);
            }
            .option-btn {
                padding: clamp(8px, 2vw, 12px) clamp(12px, 3vw, 20px);
                font-size: clamp(14px, 3vw, 16px);
            }
        }

        /* KÃ¼Ã§Ã¼k telefon ekranlarÄ± */
        @media (max-width: 480px) {
            .btn-bottom-right {
                position: relative;
                bottom: auto;
                right: auto;
                margin-top: 20px;
            }
            .image-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Tablet ve masaÃ¼stÃ¼ */
        @media (min-width: 481px) {
            .container {
                height: min(100vh - 30px, 800px);
            }
        }

        /* BÃ¼yÃ¼k ekranlar */
        @media (min-width: 1400px) {
            .container {
                width: min(90%, 1400px);
                height: min(100vh - 40px, 900px);
            }
        }

        /* Landscape mode mobil */
        @media (max-height: 500px) and (orientation: landscape) {
            .container {
                height: 95vh;
                padding: 15px;
            }
            .title-screen h1 {
                margin-bottom: 20px;
            }
            .instruction-box {
                padding: 20px;
                margin: 15px auto;
            }
        }

        /* High DPI ekranlar iÃ§in font optimizasyonu */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .title-screen h1, .result-message {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            .loading-overlay, .error-overlay {
                transition: opacity 0.1s ease !important;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            .option-btn {
                border-width: 2px;
                border-color: black;
            }
            .btn {
                border: 2px solid white;
            }
        }
    </style>
    <!-- Supabase Client (UMD ile yÃ¼kleniyor) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js" onload="window.__initSupabase && window.__initSupabase()"></script>
    <script>
      // Supabase UMD hazÄ±r olduÄŸunda Ã§alÄ±ÅŸacak init fonksiyonu (+ gÃ¼venli retry)
      (function () {
        const MAX_TRIES = 15; // ~4.5s
        const DELAY_MS = 300;
        let tries = 0;

        function getNamespace() {
          return window.supabase || window.Supabase || null;
        }

        function tryInit() {
          try {
            const SUPABASE_URL = localStorage.getItem('sb-url');
            const SUPABASE_ANON_KEY = localStorage.getItem('sb-anon-key');

            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
              console.warn('âš ï¸ Supabase config localStorage\'da bulunamadÄ± (sb-url/sb-anon-key)');
              return false;
            }

            const ns = getNamespace();
            if (!ns || typeof ns.createClient !== 'function') {
              return false;
            }

            if (!window.supabaseClient) {
              window.supabaseClient = ns.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
              console.log('âœ… Supabase client oluÅŸturuldu (UMD)');
            }
            return true;
          } catch (e) {
            console.error('âŒ Supabase init hatasÄ±:', e);
            return false;
          }
        }

        window.__initSupabase = function initSupabaseFromLocalStorage() {
          if (tryInit()) return;

          // Retry dÃ¶ngÃ¼sÃ¼
          const timer = setInterval(() => {
            tries++;
            const ok = tryInit();
            if (ok || tries >= MAX_TRIES) {
              if (!ok) {
                console.error('âš ï¸ Supabase UMD global nesnesi bulunamadÄ± (supabase/Supabase). Script bekleme sÃ¼resi aÅŸÄ±ldÄ±.');
              }
              clearInterval(timer);
            }
          }, DELAY_MS);
        };

        // Fallback: sayfa yÃ¼klenir yÃ¼klenmez de dene
        if (!window.supabaseClient) {
          setTimeout(() => window.__initSupabase && window.__initSupabase(), 0);
        }
      })();
    </script>
  </head>
<body>
    <div class="container">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">YÃ¼kleniyor...</div>
        </div>

        <!-- Error Overlay -->
        <div class="error-overlay" id="errorOverlay">
            <div class="error-message" id="errorMessage">Bir hata oluÅŸtu</div>
        </div>

        <!-- 0. BaÅŸlangÄ±Ã§ Title EkranÄ± -->
        <div id="titleScreen" class="screen active">
            <div class="title-screen">
                <h1>HafÄ±za Testi</h1>
            </div>
            <button class="btn btn-bottom-right visible" onclick="goToWelcome()">Ä°leri</button>
        </div>

        <!-- 1. GiriÅŸ EkranÄ± -->
        <div id="welcomeScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    CÃ¼mleleri dinleyeceksiniz.<br>
                    GÃ¶rselleri inceleyeceksiniz.<br>
                    CÃ¼mleler ve gÃ¶rseller ile ilgili sorularÄ± cevaplayacaksÄ±nÄ±z.<br>
                    Her bir soruyu cevaplamak iÃ§in 6 saniyeniz var!
                </div>
            </div>
            <button class="btn btn-bottom-right" id="welcomeNextBtn" onclick="goToExampleIntro()">Ä°leri</button>
        </div>

        <!-- 2. Ã–rnek GiriÅŸ EkranÄ± -->
        <div id="exampleIntroScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Ã–rnek uygulamada;<br>
                    iki farklÄ± cÃ¼mle<br>
                    iki farklÄ± gÃ¶rsel<br>
                    cÃ¼mleler ve gÃ¶rseller ile ilgili sorular olacaktÄ±r.
                </div>
            </div>
            <button class="btn btn-bottom-right" id="exampleIntroNextBtn" onclick="goToExampleReady()">Ä°leri</button>
        </div>

        <!-- 3. Ã–rnek HazÄ±r EkranÄ± -->
        <div id="exampleReadyScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Ã–rnek uygulamaya hazÄ±rsanÄ±z "BaÅŸla" butonuna tÄ±klayÄ±n!
                </div>
            </div>
            <button class="btn btn-bottom-right" id="exampleReadyBtn" onclick="startExampleSection()">BaÅŸla</button>
        </div>

        <!-- 4. Ã–rnek GÃ¶sterim EkranÄ± -->
        <div id="exampleScreen" class="screen">
            <div class="test-area">
                <div class="memory-display" id="exampleDisplay">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
            </div>
        </div>

        <!-- 5. Ã–rnek Sorular EkranÄ± -->
        <div id="exampleQuestionsScreen" class="screen">
            <div id="exampleQuestionArea">
                <!-- Dinamik olarak doldurulacak -->
            </div>
            <div class="timer-bar">
                <div class="timer-fill" id="exampleTimerFill"></div>
            </div>
        </div>

        <!-- 6. Ã–rnek BitiÅŸ EkranÄ± -->
        <div id="exampleCompleteScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Ã–rnek uygulamayÄ± tamamladÄ±nÄ±z!
                </div>
            </div>
            <button class="btn btn-bottom-right" id="exampleCompleteBtn" onclick="goToMainTestIntro()">Ä°leri</button>
        </div>

        <!-- 7. Ana Test GiriÅŸ EkranÄ± -->
        <div id="mainTestIntroScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Teste hazÄ±rlanÄ±n!<br>
                    sorularÄ± cevaplamak iÃ§in<br>
                    6 saniyeniz var.
                </div>
            </div>
            <button class="btn btn-bottom-right" id="mainTestStartBtn" onclick="startMainTest()">BaÅŸla</button>
        </div>

        <!-- 8. Ana Test EkranÄ± -->
        <div id="mainTestScreen" class="screen">
            <div class="test-area">
                <div class="memory-display" id="mainTestDisplay">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
            </div>
        </div>

        <!-- 9. Ana Test SorularÄ± EkranÄ± -->
        <div id="mainQuestionsScreen" class="screen">
            <div id="mainQuestionArea">
                <!-- Dinamik olarak doldurulacak -->
            </div>
            <div class="timer-bar">
                <div class="timer-fill" id="mainTimerFill"></div>
            </div>
        </div>

        <!-- 10. Ã–rnek Uygulama BaÅŸarÄ±sÄ±zlÄ±k EkranÄ± -->
        <div id="exampleFailScreen" class="screen">
            <div class="instruction-box">
                <div class="highlight-text">
                    Yeterli doÄŸru cevabÄ± vermediniz, Ã¶rnek uygulama tekrar edilecektir.
                </div>
            </div>
            <button class="btn btn-bottom-right visible" onclick="retryExampleFromFail()">Tamam</button>
        </div>

        <!-- 11. SonuÃ§ EkranÄ± -->
        <div id="resultsScreen" class="screen">
            <div class="result-message">Testi TamamladÄ±nÄ±z!</div>
            <div class="result-info">sÄ±radaki bÃ¶lÃ¼me geÃ§mek iÃ§in ileri butonuna tÄ±klayÄ±n!</div>
            <button class="btn btn-bottom-right visible" onclick="completeTest()">Ä°leri</button>
        </div>
    </div>

    <script>
        // ===================================
        // HAFIZA TESTÄ° SÄ°STEMÄ° - v2.1 CLEAN
        // Dikkat Testi YapÄ±sÄ±nda
        // ===================================

        'use strict';

        // ===================================
        // STANDARD RESPONSIVE SYSTEM
        // dikkatsaÄŸlam.html ile aynÄ± - viewport scaling yok
        // ===================================

        // Global hata yakalama
        window.addEventListener('error', function(e) {
            console.error('Global Error:', e.error);
            handleError('Beklenmeyen bir hata oluÅŸtu: ' + e.message, true);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled Promise Rejection:', e.reason);
            handleError('Promise hatasÄ±: ' + e.reason, true);
        });

        // ==================== TEST VERÄ°LERÄ° ====================
        const memoryTestData = {
            // Ã–rnek veriler
            examples: [
                {
                    audio: {
                        file: 'ornek1_ses.mp3',
                        text: 'Ceren annesiyle dondurma yiyor.'
                    },
                    visual: {
                        file: 'ornek1_gorsel.mp3',
                        text: 'Bu bir bisiklet resmidir.',
                        image: 'bisiklet.png'
                    }
                },
                {
                    audio: {
                        file: 'ornek2_ses.mp3',
                        text: 'Aysel\'in en sevdiÄŸi yemek makarnadÄ±r.'
                    },
                    visual: {
                        file: 'ornek2_gorsel.mp3',
                        text: 'Bu bir doÄŸum gÃ¼nÃ¼ resmidir.',
                        image: 'dogumgunu.png'
                    }
                }
            ],
            
            // Ã–rnek sorular
            exampleQuestions: [
                {
                    question: 'Aysel\'in en sevdiÄŸi yemek hangisidir?',
                    options: ['KÃ¶fte', 'Hamburger', 'Makarna', 'Pilav', 'Pizza'],
                    correct: 2,
                    type: 'text'
                },
                {
                    question: 'Hangi pasta doÄŸum gÃ¼nÃ¼ resmindedir?',
                    options: ['pasta1.png', 'pasta2.png', 'pasta3.png', 'pasta4.png', 'pasta5.png'],
                    correct: 3,
                    type: 'image'
                },
                {
                    question: 'Ceren dondurmayÄ± kiminle yedi?',
                    options: ['Baba', 'Abla', 'Abi', 'Anne', 'KardeÅŸ'],
                    correct: 3,
                    type: 'text'
                },
                {
                    question: 'Bisiklet resminde kaÃ§ tane balon vardÄ±r?',
                    options: ['0', '1', '2', '3', '4'],
                    correct: 2,
                    type: 'text'
                }
            ],
            
            // Ana test setleri
            mainSets: [
                // SET 1
                {
                    audio: {
                        file: 'set1_ses.mp3',
                        text: '2 serÃ§e Ã§atÄ±ya yuva yapmÄ±ÅŸ'
                    },
                    visual: {
                        file: 'set1_gorsel.mp3',
                        text: 'Bu bir bahÃ§e resmidir.',
                        image: 'bahce.png'
                    }
                },
                // SET 2
                {
                    audio: {
                        file: 'set2_ses.mp3',
                        text: 'AyÅŸe mavi uÃ§urtmasÄ±nÄ± parkta uÃ§urdu'
                    },
                    visual: {
                        file: 'set2_gorsel.mp3',
                        text: 'Bu bir kÃ¼tÃ¼phane resmidir.',
                        image: 'kutuphane.png'
                    }
                },
                // SET 3
                {
                    audio: {
                        file: 'set3_ses.mp3',
                        text: 'TÃ¼rkÃ§e Ã¶ÄŸretmeni 30 Ã¶ÄŸrenciye ders anlattÄ±'
                    },
                    visual: {
                        file: 'set3_gorsel.mp3',
                        text: 'Bu bir kamp resmidir.',
                        image: 'kamp.png'
                    }
                },
                // SET 4
                {
                    audio: {
                        file: 'set4_ses.mp3',
                        text: 'Denizde yÃ¼zen 4 Ã§ocuktan, sadece birinin kÄ±rmÄ±zÄ± kolluÄŸu vardÄ±'
                    },
                    visual: {
                        file: 'set4_gorsel.mp3',
                        text: 'Bu bir yelken resmidir.',
                        image: 'yelken.png'
                    }
                }
            ],
            
            // Ana test sorularÄ±
            mainQuestions: [
                // SET 1 sorularÄ±
                [
                    {
                        questionNo: 1,
                        question: 'Ã‡atÄ±ya yuva yapan hayvan hangisidir?',
                        options: ['MartÄ±', 'GÃ¼vercin', 'SerÃ§e', 'Leylek', 'Karga'],
                        correct: 2,
                        type: 'text',
                        setNo: 1,
                        skillType: 'KÄ±sa SÃ¼reli Ä°ÅŸitsel'
                    },
                    {
                        questionNo: 2,
                        question: 'BahÃ§e resminde Ã§ocuk ne yapÄ±yordu?',
                        options: ['Top oynuyordu', 'YÃ¼rÃ¼yordu', 'Kitap okuyordu', 'Ã‡iÃ§ek suluyordu', 'KoÅŸuyordu'],
                        correct: 3,
                        type: 'text',
                        setNo: 1,
                        skillType: 'KÄ±sa SÃ¼reli GÃ¶rsel'
                    },
                    {
                        questionNo: 3,
                        question: 'BahÃ§e resmindeki Ã§iÃ§ek hangisiydi?',
                        options: ['cicek1.png', 'cicek2.png', 'cicek3.png', 'cicek4.png', 'cicek5.png'],
                        correct: 0,
                        type: 'image',
                        setNo: 1,
                        skillType: 'KÄ±sa SÃ¼reli GÃ¶rsel'
                    },
                    {
                        questionNo: 4,
                        question: 'SerÃ§eler yuvayÄ± nereye yapmÄ±ÅŸ?',
                        options: ['AÄŸaca', 'Balkona', 'DireÄŸe', 'Ã‡atÄ±ya', 'Duvara'],
                        correct: 3,
                        type: 'text',
                        setNo: 1,
                        skillType: 'KÄ±sa SÃ¼reli Ä°ÅŸitsel'
                    },
                    {
                        questionNo: 5,
                        question: 'BahÃ§e resminde hangisi yoktu?',
                        options: ['AÄŸaÃ§', 'KuÅŸ', 'Hortum', 'Ã‡ocuk', 'Ã‡iÃ§ek'],
                        correct: 1,
                        type: 'text',
                        setNo: 1,
                        skillType: 'Ä°ÅŸler HafÄ±za'
                    }
                ],
                // SET 2 sorularÄ±
                [
                    {
                        questionNo: 6,
                        question: 'AyÅŸe uÃ§urtmayÄ± nerede uÃ§urdu?',
                        options: ['Sahilde', 'Parkta', 'Ormanda', 'Evde', 'Ã‡iftlikte'],
                        correct: 1,
                        type: 'text',
                        setNo: 2,
                        skillType: 'KÄ±sa SÃ¼reli Ä°ÅŸitsel'
                    },
                    {
                        questionNo: 7,
                        question: 'KÃ¼tÃ¼phane resminde kaÃ§ Ã§ocuk vardÄ±?',
                        options: ['1', '3', '2', '4', '5'],
                        correct: 1,
                        type: 'text',
                        setNo: 2,
                        skillType: 'KÄ±sa SÃ¼reli GÃ¶rsel'
                    },
                    {
                        questionNo: 8,
                        question: 'BahÃ§e resminde Ã§ocuÄŸun elindeki hortum hangi renkti?',
                        options: ['SarÄ±', 'Mavi', 'KÄ±rmÄ±zÄ±', 'YeÅŸil', 'Beyaz'],
                        correct: 2,
                        type: 'text',
                        setNo: 2,
                        skillType: 'Uzun SÃ¼reli GÃ¶rsel'
                    },
                    {
                        questionNo: 9,
                        question: 'KaÃ§ serÃ§e Ã§atÄ±ya yuva yapmÄ±ÅŸ?',
                        options: ['1', '2', '3', '4', '5'],
                        correct: 1,
                        type: 'text',
                        setNo: 2,
                        skillType: 'Uzun SÃ¼reli Ä°ÅŸitsel'
                    },
                    {
                        questionNo: 10,
                        question: 'KÃ¼tÃ¼phane resminde hangisi yoktu?',
                        options: ['Tablo', 'Saat', 'Kalemlik', 'Koltuk', 'Masa'],
                        correct: 1,
                        type: 'text',
                        setNo: 2,
                        skillType: 'Ä°ÅŸler HafÄ±za'
                    }
                ],
                // SET 3 sorularÄ±
                [
                    {
                        questionNo: 11,
                        question: 'Ã–ÄŸrencilere hangi Ã¶ÄŸretmen ders anlattÄ±?',
                        options: ['Matematik Ã–ÄŸretmeni', 'Ä°ngilizce Ã–ÄŸretmeni', 'TÃ¼rkÃ§e Ã–ÄŸretmeni', 'MÃ¼zik Ã–ÄŸretmeni', 'SÄ±nÄ±f Ã–ÄŸretmeni'],
                        correct: 2,
                        type: 'text',
                        setNo: 3,
                        skillType: 'KÄ±sa SÃ¼reli Ä°ÅŸitsel'
                    },
                    {
                        questionNo: 12,
                        question: 'KÃ¼tÃ¼phane resminde bulunan koltuk hangisiydi?',
                        options: ['koltuk1.png', 'koltuk2.png', 'koltuk3.png', 'koltuk4.png', 'koltuk5.png'],
                        correct: 0,
                        type: 'image',
                        setNo: 3,
                        skillType: 'Uzun SÃ¼reli GÃ¶rsel'
                    },
                    {
                        questionNo: 13,
                        question: 'Kamp resminde hangisi yoktu?',
                        options: ['KuÅŸ', 'Ã‡adÄ±r', 'El feneri', 'Top', 'KÃ¶pek'],
                        correct: 3,
                        type: 'text',
                        setNo: 3,
                        skillType: 'Ä°ÅŸler HafÄ±za'
                    },
                    {
                        questionNo: 14,
                        question: 'Kamp resmindeki kÃ¶pek hangisiydi?',
                        options: ['kopek1.png', 'kopek2.png', 'kopek3.png', 'kopek4.png', 'kopek5.png'],
                        correct: 4,
                        type: 'image',
                        setNo: 3,
                        skillType: 'KÄ±sa SÃ¼reli GÃ¶rsel'
                    },
                    {
                        questionNo: 15,
                        question: 'Parkta mavi uÃ§urtmayÄ± kim uÃ§urdu?',
                        options: ['Aysel', 'Arda', 'AslÄ±', 'AyÅŸe', 'Ayaz'],
                        correct: 3,
                        type: 'text',
                        setNo: 3,
                        skillType: 'Uzun SÃ¼reli Ä°ÅŸitsel'
                    }
                ],
                // SET 4 sorularÄ±
                [
                    {
                        questionNo: 16,
                        question: 'Yelken resminde Ã¼zerinde elma olan yelken hangi renkti?',
                        options: ['KÄ±rmÄ±zÄ±', 'SarÄ±', 'Mavi', 'YeÅŸil', 'Turuncu'],
                        correct: 2,
                        type: 'text',
                        setNo: 4,
                        skillType: 'KÄ±sa SÃ¼reli GÃ¶rsel'
                    },
                    {
                        questionNo: 17,
                        question: 'TÃ¼rkÃ§e Ã¶ÄŸretmeni kaÃ§ Ã¶ÄŸrenciye ders anlattÄ±?',
                        options: ['29', '30', '31', '32', '33'],
                        correct: 1,
                        type: 'text',
                        setNo: 4,
                        skillType: 'Uzun SÃ¼reli Ä°ÅŸitsel'
                    },
                    {
                        questionNo: 18,
                        question: 'Yelken resminde yelkenlerin Ã¼zerindeki rakamlarÄ±n toplamÄ± kaÃ§tÄ±r?',
                        options: ['6', '7', '8', '9', '5'],
                        correct: 3,
                        type: 'text',
                        setNo: 4,
                        skillType: 'Ä°ÅŸler HafÄ±za'
                    },
                    {
                        questionNo: 19,
                        question: 'Kamp resminde bulunan top hangisiydi?',
                        options: ['top1.png', 'top2.png', 'top3.png', 'top4.png', 'top5.png'],
                        correct: 1,
                        type: 'image',
                        setNo: 4,
                        skillType: 'Uzun SÃ¼reli GÃ¶rsel'
                    },
                    {
                        questionNo: 20,
                        question: 'Denizde yÃ¼zen ve kÄ±rmÄ±zÄ± kolluÄŸu olmayan kaÃ§ Ã§ocuk vardÄ±?',
                        options: ['0', '1', '2', '3', '4'],
                        correct: 2,
                        type: 'text',
                        setNo: 4,
                        skillType: 'Ä°ÅŸler HafÄ±za'
                    }
                ]
            ]
        };

        // ==================== IMAGE PRELOADING SÄ°STEMÄ° (AkÄ±l-MantÄ±k ile uyumlu) ====================
        let preloadedImages = new Map();

        function preloadImage(src) {
            if (preloadedImages.has(src)) {
                return Promise.resolve(preloadedImages.get(src));
            }

            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    preloadedImages.set(src, img);
                    resolve(img);
                };
                img.onerror = (e) => {
                    console.error(`GÃ¶rsel yÃ¼klenemedi: ${src}`, e);
                    reject(new Error(`GÃ¶rsel yÃ¼klenemedi: ${src}`));
                };
                img.src = src;
            });
        }

        function preloadAllImages() {
            const toPreloadSet = new Set();

            try {
                // Ã–rnek gÃ¶rseller (gÃ¶sterim sÄ±rasÄ±nda kullanÄ±lan ana gÃ¶rseller)
                if (Array.isArray(memoryTestData.examples)) {
                    memoryTestData.examples.forEach(ex => {
                        if (ex?.visual?.image) {
                            toPreloadSet.add(`images/${ex.visual.image}`);
                        }
                    });
                }

                // Ana set gÃ¶rselleri
                if (Array.isArray(memoryTestData.mainSets)) {
                    memoryTestData.mainSets.forEach(set => {
                        if (set?.visual?.image) {
                            toPreloadSet.add(`images/${set.visual.image}`);
                        }
                    });
                }

                // Ã–rnek sorularÄ±n gÃ¶rsel seÃ§enekleri
                if (Array.isArray(memoryTestData.exampleQuestions)) {
                    memoryTestData.exampleQuestions.forEach(q => {
                        if (q?.type === 'image' && Array.isArray(q.options)) {
                            q.options.forEach(opt => {
                                if (typeof opt === 'string') {
                                    toPreloadSet.add(`images/${opt}`);
                                }
                            });
                        }
                    });
                }

                // Ana sorularÄ±n gÃ¶rsel seÃ§enekleri (set -> soru dizisi yapÄ±sÄ±)
                if (Array.isArray(memoryTestData.mainQuestions)) {
                    memoryTestData.mainQuestions.forEach(setArr => {
                        if (Array.isArray(setArr)) {
                            setArr.forEach(q => {
                                if (q && q.type === 'image' && Array.isArray(q.options)) {
                                    q.options.forEach(opt => {
                                        if (typeof opt === 'string') {
                                            toPreloadSet.add(`images/${opt}`);
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
            } catch (e) {
                console.warn('GÃ¶rsel preload listesi oluÅŸturulurken hata:', e);
            }

            const list = Array.from(toPreloadSet);
            console.log(`ðŸ–¼ï¸ HafÄ±za testi preload baÅŸlayacak: ${list.length} gÃ¶rsel`);
            return Promise.allSettled(list.map(src => preloadImage(src)));
        }

        // KonfigÃ¼rasyon sabitleri
        const CONFIG = {
            EXAMPLE_TIME_LIMIT: 30000,     // 30 saniye
            MAIN_TIME_LIMIT: 300000,       // 5 dakika
            AUDIO_RETRY_ATTEMPTS: 3,
            DEBOUNCE_DELAY: 300,
            ANIMATION_DELAY: 100,
            MIN_EXAMPLE_SCORE: 2,
            AUDIO_PRELOAD_TIMEOUT: 5000,
            QUESTION_TIME_LIMIT: 6000      // Her soru iÃ§in 6 saniye
        };

        // GÃ¼venli state yÃ¶netimi - HafÄ±za testi iÃ§in adapte edilmiÅŸ
        class SafeMemoryTestState {
            constructor() {
                this.reset();
                this.locked = false;
            }

            reset() {
                this.currentScreen = 'titleScreen';
                this.currentAudio = null;
                this.preloadedAudios = new Map();
                this.timers = new Set();
                this.intervals = new Set();
                this.isTransitioning = false;
                this.isAnswering = false;
                
                // Ã–rnek test durumlarÄ±
                this.exampleAttempts = 0;
                this.exampleCorrectCount = 0;
                this.currentExampleIndex = 0;
                this.currentExamplePhase = 'audio';
                this.currentExampleQuestionIndex = 0;
                
                // Ana test durumlarÄ±
                this.currentSetIndex = 0;
                this.currentSetPhase = 'audio';
                this.currentQuestionSetIndex = 0;
                this.currentQuestionIndex = 0;
                this.questionStartTime = null;
                this.questionTimer = null;
                this.currentQuestionType = null;
                
                // Zaman takibi
                this.startTime = null;
                this.setStartTimes = [];
                this.testEndTime = null;
                
                // Cevap takibi
                this.allAnswers = {
                    example: [],
                    main: []
                };
                
                // Beceri puanlarÄ±
                this.skillScores = {
                    'KÄ±sa SÃ¼reli Ä°ÅŸitsel': { correct: 0, total: 0 },
                    'KÄ±sa SÃ¼reli GÃ¶rsel': { correct: 0, total: 0 },
                    'Uzun SÃ¼reli Ä°ÅŸitsel': { correct: 0, total: 0 },
                    'Uzun SÃ¼reli GÃ¶rsel': { correct: 0, total: 0 },
                    'Ä°ÅŸler HafÄ±za': { correct: 0, total: 0 }
                };
            }

            // GÃ¼venli timer yÃ¶netimi
            addTimer(timerId) {
                this.timers.add(timerId);
                return timerId;
            }

            clearTimer(timerId) {
                if (timerId && this.timers.has(timerId)) {
                    clearTimeout(timerId);
                    this.timers.delete(timerId);
                }
            }

            clearAllTimers() {
                this.timers.forEach(timerId => {
                    clearTimeout(timerId);
                });
                this.timers.clear();
            }

            // GÃ¼venli ses yÃ¶netimi
            setCurrentAudio(audio) {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                }
                this.currentAudio = audio;
            }

            stopCurrentAudio() {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                    this.currentAudio = null;
                }
            }

            cleanup() {
                this.clearAllTimers();
                this.stopCurrentAudio();
                this.preloadedAudios.clear();
                this.locked = false;
            }
        }

        // Global state instance
        const state = new SafeMemoryTestState();

        // ==================== SES YÃ–NETÄ°MÄ° ====================
        function playAudio(filename, callback) {
            if (state.currentAudio) {
                state.currentAudio.pause();
                state.currentAudio.currentTime = 0;
            }
            
            const audio = new Audio(`mp3/${filename}`);
            state.currentAudio = audio;
            
            audio.addEventListener('ended', () => {
                if (callback) callback();
            });
            
            audio.play().catch(error => {
                console.log('Ses Ã§alma hatasÄ±:', error);
                if (callback) callback();
            });
            
            return audio;
        }

        function stopCurrentAudio() {
            if (state.currentAudio) {
                state.currentAudio.pause();
                state.currentAudio.currentTime = 0;
                state.currentAudio = null;
            }
        }

        // Hata yÃ¶netimi - dikkat testinden alÄ±nmÄ±ÅŸ
        function handleError(message, isSystem = false) {
            console.error('ðŸš¨ Sistem HatasÄ±:', message);
            
            const errorOverlay = document.getElementById('errorOverlay');
            const errorMessage = document.getElementById('errorMessage');
            
            if (errorOverlay && errorMessage) {
                errorMessage.textContent = message;
                errorOverlay.classList.add('show');
                
                // 5 saniye sonra otomatik kapat
                setTimeout(() => {
                    errorOverlay.classList.remove('show');
                }, 5000);
            }
            
            if (isSystem) {
                // Sistem hatasÄ± - state temizle
                state.cleanup();
            }
        }

        // Loading gÃ¶sterimi
        function showLoading(text = 'YÃ¼kleniyor...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            if (loadingText) loadingText.textContent = text;
            if (loadingOverlay) loadingOverlay.classList.add('show');
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.classList.remove('show');
        }

        // ==================== EKRAN YÃ–NETÄ°MÄ° ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            state.currentScreen = screenId;
        }

        function showButton(buttonId) {
            setTimeout(() => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.classList.add('visible');
                }
            }, 100);
        }

        // Debounced navigation fonksiyonu
        function navigate(action, ...args) {
            if (state.locked) {
                console.log('ðŸ”’ Navigasyon kilitli, iÅŸlem iptal');
                return;
            }

            state.locked = true;
            
            try {
                if (typeof window[action] === 'function') {
                    window[action](...args);
                } else {
                    console.error(`âŒ Fonksiyon bulunamadÄ±: ${action}`);
                    handleError(`Navigasyon hatasÄ±: ${action}`);
                }
            } catch (error) {
                console.error(`âŒ Navigasyon hatasÄ±: ${action}`, error);
                handleError(`Navigasyon hatasÄ±: ${error.message}`);
            } finally {
                // Kilit kaldÄ±r
                setTimeout(() => {
                    state.locked = false;
                }, CONFIG.DEBOUNCE_DELAY);
            }
        }

        // ==================== TIMER YÃ–NETÄ°MÄ° ====================
        function resetTimer(timerId) {
            const timerFill = document.getElementById(timerId);
            timerFill.classList.remove('counting');
            // Force reflow
            void timerFill.offsetWidth;
            timerFill.classList.add('counting');
        }

        // ==================== GÄ°RÄ°Åž EKRANLARI ====================
        function goToWelcome() {
            showScreen('welcomeScreen');
            // AkÄ±l ve MantÄ±k testindeki gibi gÃ¶rselleri Ã¶nceden yÃ¼kle
            showLoading('GÃ¶rseller yÃ¼kleniyor...');
            preloadAllImages()
                .then((results) => {
                    const successful = results.filter(r => r.status === 'fulfilled').length;
                    const failed = results.filter(r => r.status === 'rejected').length;
                    console.log(`ðŸ–¼ï¸ GÃ¶rsel preload tamamlandÄ±: âœ…${successful} baÅŸarÄ±lÄ±, âŒ${failed} baÅŸarÄ±sÄ±z`);
                })
                .catch((err) => {
                    console.warn('GÃ¶rsel preload sÄ±rasÄ±nda hata:', err);
                })
                .finally(() => {
                    hideLoading();
                    playAudio('hafiza_giris_basla.mp3', () => {
                        showButton('welcomeNextBtn');
                    });
                });
        }

        function goToExampleIntro() {
            showScreen('exampleIntroScreen');
            playAudio('hafiza_giris_ornek.mp3', () => {
                showButton('exampleIntroNextBtn');
            });
        }

        function goToExampleReady() {
            showScreen('exampleReadyScreen');
            playAudio('hafiza_giris_hazir.mp3', () => {
                showButton('exampleReadyBtn');
            });
        }

        function retryExampleFromFail() {
            console.log('ðŸ”„ Ã–rnek uygulama tekrar edilecek...');
            goToExampleReady();
        }

        // ==================== Ã–RNEK BÃ–LÃœMÃœ ====================
        function startExampleSection() {
            state.currentExampleIndex = 0;
            state.currentExamplePhase = 'audio';
            state.exampleCorrectCount = 0;
            state.allAnswers.example = [];
            showExampleContent();
        }

        function showExampleContent() {
            showScreen('exampleScreen');
            const display = document.getElementById('exampleDisplay');
            const example = memoryTestData.examples[state.currentExampleIndex];
            
            if (state.currentExamplePhase === 'audio') {
                display.innerHTML = `
                    <div class="memory-text">DinlediÄŸini AklÄ±nda Tut.</div>
                `;
                
                playAudio(example.audio.file, () => {
                    setTimeout(() => {
                        state.currentExamplePhase = 'visual';
                        showExampleContent();
                    }, 3000);
                });
                
            } else {
                display.innerHTML = `
                    <img src="images/${example.visual.image}" class="memory-image" alt="Ã–rnek resim">
                    <div class="memory-text">Resmi AklÄ±nda Tut.</div>
                `;
                
                playAudio(example.visual.file, () => {
                    setTimeout(() => {
                        state.currentExampleIndex++;
                        if (state.currentExampleIndex < memoryTestData.examples.length) {
                            state.currentExamplePhase = 'audio';
                            showExampleContent();
                        } else {
                            startExampleQuestions();
                        }
                    }, 5000);
                });
            }
        }

        function startExampleQuestions() {
            state.currentExampleQuestionIndex = 0;
            showExampleQuestion();
        }

        function showExampleQuestion() {
            // Ã–nceki timer'Ä± temizle
            if (state.questionTimer) {
                clearTimeout(state.questionTimer);
                state.questionTimer = null;
            }
            
            // Cevap verme durumunu sÄ±fÄ±rla
            state.isAnswering = false;
            state.currentQuestionType = 'example';
            
            showScreen('exampleQuestionsScreen');
            
            if (state.currentExampleQuestionIndex >= memoryTestData.exampleQuestions.length) {
                evaluateExampleResults();
                return;
            }
            
            const question = memoryTestData.exampleQuestions[state.currentExampleQuestionIndex];
            const questionArea = document.getElementById('exampleQuestionArea');
            
            questionArea.innerHTML = `
                <div class="question-text">${question.question}</div>
                <div class="${question.type === 'image' ? 'image-options' : 'options-container'}" id="exampleOptions">
                    ${generateOptions(question, 'example')}
                </div>
            `;
            
            state.questionStartTime = Date.now();
            resetTimer('exampleTimerFill');
            startQuestionTimer('example');
        }

        function generateOptions(question, testType) {
            let html = '';
            const letters = ['A', 'B', 'C', 'D', 'E'];
            
            if (question.type === 'image') {
                question.options.forEach((option, index) => {
                    const imgSrc = `images/${option}`;
                    const imgTag = preloadedImages.has(imgSrc)
                        ? `<img src="${imgSrc}" alt="SeÃ§enek ${letters[index]}">`
                        : `<img src="${imgSrc}" alt="SeÃ§enek ${letters[index]}" onerror="console.error('SeÃ§enek gÃ¶rseli yÃ¼klenemedi: ${imgSrc}'); this.style.background='#f0f0f0'; this.style.border='2px dashed #ccc'; this.alt='GÃ¶rsel yÃ¼klenemedi';">`;
                    html += `
                        <div class="image-option" onclick="selectAnswer('${testType}', ${index})">
                            ${imgTag}
                            <div class="image-option-label">${letters[index]}</div>
                        </div>
                    `;
                });
            } else {
                question.options.forEach((option, index) => {
                    html += `
                        <button class="option-btn" onclick="selectAnswer('${testType}', ${index})">
                            <strong style="margin-right: 15px;">${letters[index]})</strong> ${option}
                        </button>
                    `;
                });
            }
            
            return html;
        }

        function selectAnswer(testType, selectedIndex) {
            // Ã‡oklu tÄ±klamaya karÅŸÄ± koruma
            if (state.isAnswering) {
                return;
            }
            
            state.isAnswering = true;
            
            // Timer'Ä± temizle
            if (state.questionTimer) {
                clearTimeout(state.questionTimer);
                state.questionTimer = null;
            }
            
            const responseTime = (Date.now() - state.questionStartTime) / 1000;
            
            if (testType === 'example') {
                const question = memoryTestData.exampleQuestions[state.currentExampleQuestionIndex];
                
                // 3 kategori mantÄ±ÄŸÄ±: DoÄŸru, YanlÄ±ÅŸ, KaÃ§Ä±rÄ±lan
                const isCorrect = selectedIndex >= 0 && selectedIndex === question.correct;
                const isWrong = selectedIndex >= 0 && selectedIndex !== question.correct;
                const isMissed = selectedIndex === -1;
                
                if (isCorrect) {
                    state.exampleCorrectCount++;
                }
                
                state.allAnswers.example.push({
                    questionIndex: state.currentExampleQuestionIndex,
                    question: question.question,
                    selectedAnswer: selectedIndex,
                    correctAnswer: question.correct,
                    isCorrect: isCorrect,
                    isWrong: isWrong,
                    isMissed: isMissed,
                    responseTime: responseTime,
                    timedOut: selectedIndex === -1
                });
                
                if (selectedIndex >= 0) {
                    highlightSelection(question.type, selectedIndex);
                    // disableAllOptions'Ä± highlightSelection'dan sonra Ã§aÄŸÄ±r
                    setTimeout(() => {
                        disableAllOptions(question.type);
                    }, 150);
                }
                
                setTimeout(() => {
                    state.currentExampleQuestionIndex++;
                    state.isAnswering = false;
                    showExampleQuestion();
                }, 1500);
                
            } else {
                const questions = memoryTestData.mainQuestions[state.currentQuestionSetIndex];
                const question = questions[state.currentQuestionIndex];
                
                // EÄŸer soru yoksa (test bitmiÅŸse) Ã§Ä±k
                if (!question) {
                    return;
                }
                
                // 3 kategori mantÄ±ÄŸÄ±: DoÄŸru, YanlÄ±ÅŸ, KaÃ§Ä±rÄ±lan
                const isCorrect = selectedIndex >= 0 && selectedIndex === question.correct;
                const isWrong = selectedIndex >= 0 && selectedIndex !== question.correct;
                const isMissed = selectedIndex === -1;
                
                const answerData = {
                    questionNo: question.questionNo,
                    setNo: question.setNo,
                    skillType: question.skillType,
                    question: question.question,
                    selectedAnswer: selectedIndex,
                    correctAnswer: question.correct,
                    isCorrect: isCorrect,
                    isWrong: isWrong,
                    isMissed: isMissed,
                    responseTime: responseTime,
                    timedOut: selectedIndex === -1
                };
                
                state.allAnswers.main.push(answerData);
                
                // ðŸ“âš¡ SORU CEVAPLANDI LOGLAMA
                console.log(`ðŸ“âš¡ SORU ${question.questionNo}/20 CEVAPLANDI:`, {
                    // Soru Bilgileri
                    soruNo: question.questionNo,
                    setNo: question.setNo,
                    beceriTuru: question.skillType,
                    soruTipi: question.type === 'image' ? 'GÃ¶rsel' : 'Ä°ÅŸitsel',
                    soruMetni: question.question,
                    dogruCevap: question.correct,
                    // Cevap Bilgileri
                    kullaniciSecimi: selectedIndex >= 0 ? selectedIndex : 'ZAMAN AÅžIMI',
                    durum: isCorrect ? 'âœ… DOÄžRU' : (isWrong ? 'âŒ YANLIÅž' : 'â° KAÃ‡IRILDI'),
                    tepkiSuresi: `${responseTime.toFixed(2)}s`,
                    zamanAsimi: selectedIndex === -1 ? 'EVET' : 'HAYIR',
                    cevapZamani: new Date().toLocaleTimeString('tr-TR')
                });
                
                // Beceri puanÄ± gÃ¼ncelleme
                state.skillScores[question.skillType].total++;
                if (isCorrect) {
                    state.skillScores[question.skillType].correct++;
                }
                
                if (selectedIndex >= 0) {
                    highlightSelection(question.type, selectedIndex);
                    // disableAllOptions'Ä± highlightSelection'dan sonra Ã§aÄŸÄ±r
                    setTimeout(() => {
                        disableAllOptions(question.type);
                    }, 150);
                }
                
                setTimeout(() => {
                    state.currentQuestionIndex++;
                    state.isAnswering = false;
                    showMainQuestion();
                }, 1500);
            }
        }

        function highlightSelection(questionType, index) {
            
            // Direkt Ã§aÄŸÄ±r, sonra da timeout ile tekrar dene
            const doHighlight = () => {
                if (questionType === 'image') {
                    // Sadece aktif soru alanÄ±ndaki elementleri seÃ§
                    const activeScreen = document.querySelector('.screen.active');
                    const imageOptions = activeScreen.querySelectorAll('.image-option');
                    console.log('Found image options:', imageOptions.length);
                    imageOptions.forEach((opt, i) => {
                        if (i === index) {
                            opt.classList.add('selected');
                            console.log('Added selected to image option', i, 'Classes:', opt.className);
                        }
                    });
                } else {
                    // Sadece aktif soru alanÄ±ndaki elementleri seÃ§
                    const activeScreen = document.querySelector('.screen.active');
                    const textOptions = activeScreen.querySelectorAll('.option-btn');

                    textOptions.forEach((opt, i) => {
                        if (i === index) {
                            opt.classList.add('selected');
                        }
                    });
                }
            };
            
            // Hemen Ã§aÄŸÄ±r
            doHighlight();
            
            // Bir de 100ms sonra Ã§aÄŸÄ±r
            setTimeout(doHighlight, 100);
        }

        function disableAllOptions(questionType) {
            setTimeout(() => {
                // Sadece aktif soru alanÄ±ndaki elementleri seÃ§
                const activeScreen = document.querySelector('.screen.active');
                if (questionType === 'image') {
                    activeScreen.querySelectorAll('.image-option').forEach(opt => {
                        if (!opt.classList.contains('selected')) {
                            opt.classList.add('disabled');
                        }
                    });
                } else {
                    activeScreen.querySelectorAll('.option-btn').forEach(opt => {
                        if (!opt.classList.contains('selected')) {
                            opt.classList.add('disabled');
                        }
                    });
                }
            }, 200); // Daha geÃ§ Ã§aÄŸÄ±r ki selected class eklensin
        }

        function startQuestionTimer(type) {
            // Ã–nceki timer'Ä± temizle
            if (state.questionTimer) {
                clearTimeout(state.questionTimer);
            }
            
            state.currentQuestionType = type;
            state.questionTimer = setTimeout(() => {
                selectAnswer(type, -1);
            }, 6000);
        }

        function evaluateExampleResults() {
            if (state.exampleCorrectCount >= 2) {
                showScreen('exampleCompleteScreen');
                playAudio('hafiza_ornek_bitis.mp3', () => {
                    showButton('exampleCompleteBtn');
                });
            } else {
                state.exampleAttempts++;
                showScreen('exampleFailScreen');
            }
        }

        function goToMainTestIntro() {
            showScreen('mainTestIntroScreen');
            playAudio('hafiza_anatest_giris.mp3', () => {
                showButton('mainTestStartBtn');
            });
        }

        // ==================== ANA TEST ====================
        function startMainTest() {
            state.currentSetIndex = 0;
            state.currentSetPhase = 'audio';
            state.allAnswers.main = [];
            state.startTime = Date.now();
            state.setStartTimes = [Date.now()];
            showMainSet();
        }

        function showMainSet() {
            showScreen('mainTestScreen');
            
            const display = document.getElementById('mainTestDisplay');
            const set = memoryTestData.mainSets[state.currentSetIndex];
            
            if (state.currentSetPhase === 'audio') {
                display.innerHTML = `
                    <div class="memory-text">DinlediÄŸini AklÄ±nda Tut.</div>
                `;
                
                playAudio(set.audio.file, () => {
                    setTimeout(() => {
                        state.currentSetPhase = 'visual';
                        showMainSet();
                    }, 3000);
                });
                
            } else {
                display.innerHTML = `
                    <img src="images/${set.visual.image}" class="memory-image" alt="Set ${state.currentSetIndex + 1} resmi">
                    <div class="memory-text">Resmi AklÄ±nda Tut.</div>
                `;
                
                playAudio(set.visual.file, () => {
                    setTimeout(() => {
                        startMainQuestions();
                    }, 5000);
                });
            }
        }

        function startMainQuestions() {
            state.currentQuestionSetIndex = state.currentSetIndex;
            state.currentQuestionIndex = 0;
            showMainQuestion();
        }

        function showMainQuestion() {
            // Ã–nceki timer'Ä± temizle
            if (state.questionTimer) {
                clearTimeout(state.questionTimer);
                state.questionTimer = null;
            }
            
            // Cevap verme durumunu sÄ±fÄ±rla
            state.isAnswering = false;
            state.currentQuestionType = 'main';
            
            showScreen('mainQuestionsScreen');
            
            const questions = memoryTestData.mainQuestions[state.currentQuestionSetIndex];
            const totalQuestions = questions.length;
            
            if (state.currentQuestionIndex >= totalQuestions) {
                // ðŸ SET TAMAMLANDI LOGLAMA
                const currentSetNo = state.currentQuestionSetIndex + 1;
                const setAnswers = state.allAnswers.main.filter(a => a.setNo === currentSetNo);
                const setCorrect = setAnswers.filter(a => a.isCorrect).length;
                const setWrong = setAnswers.filter(a => a.isWrong).length;
                const setMissed = setAnswers.filter(a => a.isMissed).length;
                const setTotal = setAnswers.length;
                
                console.log(`ðŸ ${currentSetNo}. SET TAMAMLANDI:`, {
                    setNo: currentSetNo,
                    toplamSoru: setTotal,
                    dogruSayisi: setCorrect,
                    yanlisSayisi: setWrong,
                    kacirilmis: setMissed,
                    basariOrani: setTotal > 0 ? `${Math.round((setCorrect / setTotal) * 100)}%` : '0%',
                    ortalamaTepkiSuresi: setAnswers.length > 0 ? `${(setAnswers.reduce((sum, a) => sum + a.responseTime, 0) / setAnswers.length).toFixed(2)}s` : '0s',
                    tamamlanmaZamani: new Date().toLocaleTimeString('tr-TR')
                });
                
                state.currentSetIndex++;
                if (state.currentSetIndex < memoryTestData.mainSets.length) {
                    state.currentSetPhase = 'audio';
                    state.setStartTimes.push(Date.now());
                    
                    // ðŸš€ YENÄ° SET BAÅžLADI LOGLAMA  
                    console.log(`ðŸš€ ${state.currentSetIndex + 1}. SET BAÅžLADI:`, {
                        setNo: state.currentSetIndex + 1,
                        baslangicZamani: new Date().toLocaleTimeString('tr-TR')
                    });
                    
                    showMainSet();
                } else {
                    endTest();
                }
                return;
            }
            
            const question = questions[state.currentQuestionIndex];
            

            
            const questionArea = document.getElementById('mainQuestionArea');
            questionArea.innerHTML = `
                <div class="question-text">${question.question}</div>
                <div class="${question.type === 'image' ? 'image-options' : 'options-container'}" id="mainOptions">
                    ${generateOptions(question, 'main')}
                </div>
            `;
            
            state.questionStartTime = Date.now();
            resetTimer('mainTimerFill');
            startQuestionTimer('main');
        }

        // ==================== TEST SONU VE RAPORLAMA ====================
        function endTest() {
            const endTime = Date.now();
            const totalTime = Math.round((endTime - state.startTime) / 1000);
            
            // Hesaplamalar - 3 kategori mantÄ±ÄŸÄ±
            const totalQuestions = state.allAnswers.main.length;
            const correctAnswers = state.allAnswers.main.filter(a => a.isCorrect).length;
            const wrongAnswers = state.allAnswers.main.filter(a => a.isWrong).length;
            const missedAnswers = state.allAnswers.main.filter(a => a.isMissed).length;
            const successRate = Math.round((correctAnswers / totalQuestions) * 100);
            
            // YetiÅŸtiremediyse hangi soruda kaldÄ± hesaplamasÄ±
            const lastAnsweredQuestion = totalQuestions;
            const remainingQuestions = 20 - totalQuestions;
            const remainingTimeSeconds = remainingQuestions * 6;
            
            // Ä°ÅŸlem hÄ±zÄ± hesaplama
            const totalResponseTime = state.allAnswers.main.reduce((sum, answer) => sum + answer.responseTime, 0);
            const maxTime = 120; // 20 soru x 6 saniye
            const speedScore = Math.round(((maxTime - totalResponseTime) / maxTime) * 100);
            
            // Set bazlÄ± analiz
            const setAnalysis = [];
            for (let i = 0; i < 4; i++) {
                const setAnswers = state.allAnswers.main.filter(a => a.setNo === i + 1);
                const setCorrect = setAnswers.filter(a => a.isCorrect).length;
                const setTotal = setAnswers.length;
                const setSuccessRate = setTotal > 0 ? Math.round((setCorrect / setTotal) * 100) : 0;
                
                setAnalysis.push({
                    setNo: i + 1,
                    correct: setCorrect,
                    total: setTotal,
                    successRate: setSuccessRate,
                    completionTime: i < state.setStartTimes.length - 1 ? 
                        Math.round((state.setStartTimes[i + 1] - state.setStartTimes[i]) / 1000) : 
                        Math.round((endTime - state.setStartTimes[i]) / 1000)
                });
            }
            
            // SonuÃ§ ekranÄ±nÄ± gÃ¶ster
            showScreen('resultsScreen');
            
            // Test bitiÅŸ sesini Ã§al
            playAudio('hafiza_test_bitis.mp3');
            
            // VeritabanÄ±na kaydet - 3 kategori + Excel uyumluluk
            saveTestResults({
                totalTime,
                totalQuestions,
                correctAnswers,
                wrongAnswers,
                missedAnswers,
                successRate,
                speedScore,
                totalResponseTime,
                lastAnsweredQuestion,
                remainingQuestions,
                remainingTimeSeconds,
                setAnalysis,
                skillScores: state.skillScores,
                detailedAnswers: state.allAnswers,
                exampleAttempts: state.exampleAttempts,
                exampleCorrectCount: state.exampleCorrectCount
            });
        }

        // ==================== SUPABASE VERÄ°TABANI KAYIT ====================
        // Dikkat testindeki gibi tam Supabase entegrasyonu
        
        // KullanÄ±cÄ± rolÃ¼ belirleme
        function getUserRole(roles) {
            if (!roles || typeof roles !== 'object') return 'kullanici';
            
            if (roles.admin) return 'admin';
            if (roles.temsilci) return 'temsilci';
            if (roles.beyin_antrenoru) return 'beyin_antrenoru';
            return 'kullanici';
        }
        
        // Rol gÃ¶rÃ¼ntÃ¼ etiketi
        function getDisplayLabel(role) {
            const labels = {
                'admin': 'Sistem YÃ¶neticisi',
                'temsilci': 'Temsilci',
                'beyin_antrenoru': 'Beyin AntrenÃ¶rÃ¼',
                'kullanici': 'KullanÄ±cÄ±'
            };
            return labels[role] || 'Bilinmeyen Rol';
        }
        
        // GeÃ§erli Ã¶ÄŸrenci ID bulma
        async function findValidStudentId() {
            try {
                // 1. localStorage'dan kontrol et
                const storedStudentId = localStorage.getItem('currentStudentId');
                if (storedStudentId && storedStudentId !== 'null' && storedStudentId !== 'undefined') {
                    console.log('ðŸ“‹ LocalStorage\'dan student ID bulundu:', storedStudentId);
                    return storedStudentId;
                }
                
                // 2. URL parametrelerinden kontrol et
                const urlParams = new URLSearchParams(window.location.search);
                const urlStudentId = urlParams.get('student_id');
                if (urlStudentId) {
                    console.log('ðŸ”— URL\'den student ID bulundu:', urlStudentId);
                    return urlStudentId;
                }
                
                // 3. Session storage kontrolÃ¼
                const sessionStudentId = sessionStorage.getItem('selectedStudentId');
                if (sessionStudentId && sessionStudentId !== 'null') {
                    console.log('ðŸ—ƒï¸ SessionStorage\'dan student ID bulundu:', sessionStudentId);
                    return sessionStudentId;
                }
                
                console.warn('âš ï¸ GeÃ§erli student ID bulunamadÄ±');
                return null;
                
            } catch (error) {
                console.error('âŒ Student ID bulma hatasÄ±:', error);
                return null;
            }
        }
        
        // Memory test results mapping fonksiyonu
        function mapMemoryResultsToDatabase(results) {
            console.log('ðŸ”„ Memory test HTML â†’ Database mapping baÅŸlatÄ±lÄ±yor...');

            // Set bazlÄ± missed hesapla
            const setTotals = [0,0,0,0];
            const setCorrects = [0,0,0,0];
            const setWrongs = [0,0,0,0];
            const setMisseds = [0,0,0,0];

            if (Array.isArray(results.setAnalysis)) {
                results.setAnalysis.forEach((s, idx) => {
                    if (idx >= 0 && idx < 4) {
                        setTotals[idx] = s.total || 0;
                        setCorrects[idx] = s.correct || 0;
                        setWrongs[idx] = (s.total || 0) - (s.correct || 0); // yanlÄ±ÅŸlar tahminen total-correct
                        // missed: toplam cevaplananlar iÃ§inde timer ile kaÃ§Ä±rÄ±lanlarÄ± ayrÄ± tutuyorsanÄ±z bu alanÄ± doÄŸru hesaplayÄ±n.
                        // Elimizde missed ayrÄ±mÄ± yoksa 0 bÄ±rakÄ±lÄ±r. AÅŸaÄŸÄ±da daha iyi bir tahmin iÃ§in detailedAnswers kullanÄ±lacak.
                    }
                });
            }

            // detailedAnswers.main Ã¼zerinden gerÃ§ek missed/yanlÄ±ÅŸ ayrÄ±ÅŸtÄ±rmasÄ±
            if (results.detailedAnswers && Array.isArray(results.detailedAnswers.main)) {
                for (let i = 0; i < 4; i++) {
                    const setNo = i + 1;
                    const setAns = results.detailedAnswers.main.filter(a => a.setNo === setNo);
                    const missed = setAns.filter(a => a.isMissed).length;
                    const wrong = setAns.filter(a => a.isWrong).length;
                    const correct = setAns.filter(a => a.isCorrect).length;
                    setMisseds[i] = missed;
                    setWrongs[i] = wrong;
                    setCorrects[i] = correct;
                    setTotals[i] = setAns.length;
                }
            }

            // response times ve yanlÄ±ÅŸ iÅŸaretlenen seÃ§enekleri Ã§Ä±kar
            const questionResponseTimes = [];
            const wrongAnswerChoices = [];
            if (results.detailedAnswers && Array.isArray(results.detailedAnswers.main)) {
                results.detailedAnswers.main.forEach(a => {
                    if (typeof a.responseTime === 'number') {
                        questionResponseTimes.push({ q: a.questionNo, set: a.setNo, rt: a.responseTime });
                    }
                    if (a.isWrong && typeof a.selectedAnswer === 'number') {
                        wrongAnswerChoices.push({ q: a.questionNo, set: a.setNo, selected: a.selectedAnswer, correct: a.correctAnswer });
                    }
                });
            }

            const mappedData = {
                // âœ… TEMEL VERÄ°LER
                total_questions: results.totalQuestions || 20,
                correct_answers: results.correctAnswers || 0,
                wrong_answers: results.wrongAnswers || 0,
                missed_answers: results.missedAnswers || 0,
                accuracy_percentage: Math.round(((results.successRate || 0) + Number.EPSILON) * 100) / 100, // yÃ¼zde zaten
                speed_score: Math.round(((results.speedScore || 0) + Number.EPSILON) * 100) / 100,
                total_response_time: results.totalResponseTime || 0,
                test_duration_seconds: Math.round((results.totalTime || 0)), // results.totalTime zaten saniye cinsinden geliyor (endTest Ã¶yle set ediyor)
                completion_status: (results.totalQuestions || 0) >= 20 ? 'completed' : 'incomplete',

                // âœ… EXCEL UYUMLULUK
                last_answered_question: results.lastAnsweredQuestion || 0,
                remaining_questions: results.remainingQuestions || 0,
                remaining_time_seconds: results.remainingTimeSeconds || 0,

                // âœ… SET BAZLI VERÄ°LER (4 Set)
                set1_correct: setCorrects[0] || 0,
                set1_wrong: setWrongs[0] || 0,
                set1_missed: setMisseds[0] || 0,
                set1_completion_time_seconds: results.setAnalysis?.[0]?.completionTime || 0,

                set2_correct: setCorrects[1] || 0,
                set2_wrong: setWrongs[1] || 0,
                set2_missed: setMisseds[1] || 0,
                set2_completion_time_seconds: results.setAnalysis?.[1]?.completionTime || 0,

                set3_correct: setCorrects[2] || 0,
                set3_wrong: setWrongs[2] || 0,
                set3_missed: setMisseds[2] || 0,
                set3_completion_time_seconds: results.setAnalysis?.[2]?.completionTime || 0,

                set4_correct: setCorrects[3] || 0,
                set4_wrong: setWrongs[3] || 0,
                set4_missed: setMisseds[3] || 0,
                set4_completion_time_seconds: results.setAnalysis?.[3]?.completionTime || 0,

                // âœ… BECERÄ° TÃœRÃœ VERÄ°LERÄ° (5 Beceri)
                skill_kisa_sureli_isitsel_correct: results.skillScores?.['KÄ±sa SÃ¼reli Ä°ÅŸitsel']?.correct || 0,
                skill_kisa_sureli_isitsel_total: results.skillScores?.['KÄ±sa SÃ¼reli Ä°ÅŸitsel']?.total || 0,

                skill_kisa_sureli_gorsel_correct: results.skillScores?.['KÄ±sa SÃ¼reli GÃ¶rsel']?.correct || 0,
                skill_kisa_sureli_gorsel_total: results.skillScores?.['KÄ±sa SÃ¼reli GÃ¶rsel']?.total || 0,

                skill_uzun_sureli_isitsel_correct: results.skillScores?.['Uzun SÃ¼reli Ä°ÅŸitsel']?.correct || 0,
                skill_uzun_sureli_isitsel_total: results.skillScores?.['Uzun SÃ¼reli Ä°ÅŸitsel']?.total || 0,

                skill_uzun_sureli_gorsel_correct: results.skillScores?.['Uzun SÃ¼reli GÃ¶rsel']?.correct || 0,
                skill_uzun_sureli_gorsel_total: results.skillScores?.['Uzun SÃ¼reli GÃ¶rsel']?.total || 0,

                skill_isler_hafiza_correct: results.skillScores?.['Ä°ÅŸler HafÄ±za']?.correct || 0,
                skill_isler_hafiza_total: results.skillScores?.['Ä°ÅŸler HafÄ±za']?.total || 0,

                // âœ… Ã–RNEK TEST
                example_attempts: results.exampleAttempts || 0,
                example_correct_count: results.exampleCorrectCount || 0,

                // âœ… JSONB VERÄ°LER
                detailed_answers: results.detailedAnswers || {},
                set_analysis: results.setAnalysis || [],
                skill_breakdown: results.skillScores || {},
                question_response_times: questionResponseTimes,
                wrong_answer_choices: wrongAnswerChoices,

                // âœ… ZAMAN BÄ°LGÄ°LERÄ°
                test_start_time: new Date(state.startTime).toISOString(),
                test_end_time: new Date().toISOString()
            };

            console.log('ðŸŽ¯ Memory Test Database Mapping TamamlandÄ±:', mappedData);
            return mappedData;
        }
        
        // Ana Supabase kayÄ±t fonksiyonu
        async function saveTestResults(results) {
            try {
                console.log('ðŸš€ HafÄ±za testi Supabase kayÄ±t baÅŸlatÄ±lÄ±yor...');
                
                // Verileri database formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
                const mappedData = mapMemoryResultsToDatabase(results);
                
                // Supabase Production'a kaydet
                const success = await saveToSupabaseProduction(mappedData);
                
                if (success) {
                    console.log('âœ… HafÄ±za testi sonuÃ§larÄ± baÅŸarÄ±yla kaydedildi');
                    showNotification('Test sonuÃ§larÄ±nÄ±z baÅŸarÄ±yla kaydedildi!', 'success');
                } else {
                    throw new Error('Supabase kayÄ±t baÅŸarÄ±sÄ±z');
                }
                
            } catch (error) {
                console.error('âŒ HafÄ±za testi kayÄ±t hatasÄ±:', error);
                showNotification('Test sonuÃ§larÄ± kaydedilirken bir hata oluÅŸtu.', 'error');
            }
        }
        
        // Supabase Production kayÄ±t fonksiyonu
        async function saveToSupabaseProduction(mappedData) {
            try {
                console.log('ðŸš€ SUPABASE FONKSÄ°YONU: Memory Test Supabase kayÄ±t baÅŸlatÄ±lÄ±yor...');
                console.log('ðŸ“Š SUPABASE FONKSÄ°YONU: Gelen mappedData:', mappedData);

                // 1) Client edin
                console.log('ðŸ” SUPABASE ADIM 1: Dinamik client kontrolÃ¼...');
                let supabase = window.supabaseClient;

                if (!supabase) {
                    console.log('ðŸ” SUPABASE ADIM 1.1: Global client yok, localStorage\'dan oluÅŸturuluyor...');
                    const supabaseUrl = localStorage.getItem('sb-url');
                    const supabaseKey = localStorage.getItem('sb-anon-key');

                    if (!supabaseUrl || !supabaseKey) {
                        console.error('âŒ SUPABASE ADIM 1.1 HATA: localStorage\'da config bulunamadÄ±');
                        localStorage.setItem('pendingMemoryResults', JSON.stringify(mappedData));
                        return false;
                    }

                    if (!window.supabase) {
                        console.error('âŒ SUPABASE ADIM 1.1 HATA: window.supabase mevcut deÄŸil');
                        localStorage.setItem('pendingMemoryResults', JSON.stringify(mappedData));
                        return false;
                    }

                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                }

                if (!supabase) {
                    console.error('âŒ SUPABASE ADIM 1 HATA: Client oluÅŸturulamadÄ±');
                    localStorage.setItem('pendingMemoryResults', JSON.stringify(mappedData));
                    return false;
                }
                console.log('âœ… SUPABASE ADIM 1: Client hazÄ±r:', !!supabase);

                // 1) URL parametrelerini localStorage'a senkronize et (ilk yÃ¼klemede)
                try {
                    const url = new URL(window.location.href);
                    const qp = url.searchParams;
                    const sessionIdQP = qp.get('session_id');
                    const studentIdQP = qp.get('student_id');
                    const conductedByQP = qp.get('conducted_by');
                    const sbUrlQP = qp.get('sb_url');
                    const sbAnonQP = qp.get('sb_anon');
                    if (sessionIdQP) localStorage.setItem('bb-session-id', sessionIdQP);
                    if (studentIdQP) localStorage.setItem('bb-student-id', studentIdQP);
                    if (conductedByQP) localStorage.setItem('bb-conducted-by', conductedByQP);
                    if (sbUrlQP) localStorage.setItem('sb-url', sbUrlQP);
                    if (sbAnonQP) localStorage.setItem('sb-anon-key', sbAnonQP);
                } catch (e) { console.warn('Query sync failed:', e); }

                // 2) localStorage bridge - session bilgilerini al
                console.log('ðŸ” SUPABASE ADIM 2: localStorage bridge kontrol...');
                const sessionId = localStorage.getItem('bb-session-id');
                const studentId = localStorage.getItem('bb-student-id');
                const conductedBy = localStorage.getItem('bb-conducted-by');
                
                console.log('ðŸ“¦ localStorage bridge bilgileri:', {
                    sessionId: sessionId ? sessionId.slice(0, 8) + '...' : 'YOK',
                    studentId: studentId ? studentId.slice(0, 8) + '...' : 'YOK',
                    conductedBy: conductedBy ? conductedBy.slice(0, 8) + '...' : 'YOK'
                });
                
                if (!sessionId || !studentId || !conductedBy) {
                    console.error('âŒ SUPABASE ADIM 2 HATA: localStorage bridge eksik');
                    console.error('Eksik bilgiler:', {
                        sessionId: !sessionId,
                        studentId: !studentId,
                        conductedBy: !conductedBy
                    });
                    localStorage.setItem('pendingMemoryResults', JSON.stringify(mappedData));
                    return false;
                }
                
                console.log('âœ… SUPABASE ADIM 2: localStorage bridge aktif');
                console.log(`ðŸ†” Session ID: ${sessionId.slice(0, 8)}...`);
                console.log(`ðŸ‘¤ Student ID: ${studentId.slice(0, 8)}...`);
                console.log(`ðŸ‘¨â€ðŸ« Conducted By: ${conductedBy.slice(0, 8)}...`);

                // 3) Final data - localStorage bridge ile
                console.log('ðŸ” SUPABASE ADIM 3: Final veri hazÄ±rlanÄ±yor...');
                const finalData = {
                    ...mappedData,
                    session_id: sessionId,  // ðŸ†” Session ID eklendi
                    student_id: studentId,   // localStorage'dan
                    conducted_by: conductedBy // localStorage'dan
                };
                console.log('âœ… SUPABASE ADIM 3: Final veri hazÄ±rlandÄ±');
                console.log('ðŸ“ Supabase\'e kaydedilecek memory test verisi:', finalData);

                // 4) Insert
                console.log('ðŸ” SUPABASE ADIM 4: Database INSERT iÅŸlemi baÅŸlatÄ±lÄ±yor...');
                console.log('ðŸ“Š Tablo: memory_test_results');
                const { data: insertData, error: insertError } = await supabase
                    .from('memory_test_results')
                    .insert([finalData])
                    .select();

                console.log('ðŸ“Š SUPABASE ADIM 6 SONUÃ‡: insertData:', insertData);
                console.log('ðŸ“Š SUPABASE ADIM 6 SONUÃ‡: insertError:', insertError);

                if (insertError) {
                    console.error('âŒ SUPABASE ADIM 6 HATA: Database insert hatasÄ±:', insertError);
                    if (insertError.code === '23503') console.error('ðŸ”— Foreign key hatasÄ± - Student veya User ID geÃ§ersiz');
                    if (insertError.code === '42501') console.error('ðŸ”’ Yetki hatasÄ± - RLS policy ihlali');

                    localStorage.setItem('failedMemoryResults', JSON.stringify({
                        data: finalData,
                        error: insertError,
                        timestamp: new Date().toISOString()
                    }));
                    return false;
                }

                // 8) BaÅŸarÄ±
                console.log('ðŸŽ‰ SUPABASE ADIM 7: BAÅžARILI KAYIT!');
                localStorage.removeItem('pendingMemoryResults');
                localStorage.removeItem('failedMemoryResults');
                localStorage.setItem('lastTestedStudent', finalData.student_id);

                console.log('âœ… SUPABASE ADIM 7: Memory test Supabase kayÄ±t baÅŸarÄ±lÄ±!', insertData);
                console.log('ðŸ“Š SUPABASE ADIM 7: Kaydedilen veri ID:', insertData?.[0]?.id);
                return true;

            } catch (error) {
                console.error('âŒ Supabase production kayÄ±t hatasÄ±:', error);
                return false;
            }
        }

        function completeTest() {
            // SÄ±radaki bÃ¶lÃ¼me yÃ¶nlendirme yapÄ±labilir
            console.log('Test tamamlandÄ±, sÄ±radaki teste geÃ§iliyor...');
            
            // Test sonuÃ§larÄ±nÄ± local storage'a kaydet
            try {
                // Test sonuÃ§larÄ±nÄ± oluÅŸtur - 3 kategori mantÄ±ÄŸÄ±
                const totalQuestions = state.allAnswers.main.length;
                const correctAnswers = state.allAnswers.main.filter(a => a.isCorrect).length;
                const wrongAnswers = state.allAnswers.main.filter(a => a.isWrong).length;
                const missedAnswers = state.allAnswers.main.filter(a => a.isMissed).length;
                const testDuration = state.startTime ? (Date.now() - state.startTime) : 0;
                
                // YetiÅŸtiremediyse hangi soruda kaldÄ± hesaplamasÄ±
                const lastAnsweredQuestion = totalQuestions; // TÃ¼m sorular cevaplanmÄ±ÅŸ (zaman aÅŸÄ±mÄ± dahil)
                const remainingQuestions = 20 - totalQuestions; // Cevap verilmeyen soru sayÄ±sÄ±
                const remainingTimeSeconds = remainingQuestions * 6; // Kalan saniye (her soru 6 saniye)
                
                const testResults = {
                    totalQuestions: totalQuestions,
                    correctAnswers: correctAnswers,
                    wrongAnswers: wrongAnswers,
                    missedAnswers: missedAnswers,
                    successRate: totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0,
                    testDuration: testDuration,
                    lastAnsweredQuestion: lastAnsweredQuestion,
                    remainingQuestions: remainingQuestions,
                    remainingTimeSeconds: remainingTimeSeconds,
                    skillScores: state.skillScores,
                    detailedAnswers: state.allAnswers,
                    exampleAttempts: state.exampleAttempts,
                    exampleCorrectCount: state.exampleCorrectCount
                };
                
                // ðŸŽ‰ HAFIZA TESTÄ° DETAYLI SONUÃ‡LAR
                console.log('ðŸŽ‰ HAFIZA TESTÄ° TAMAMLANDI:');
                
                // Genel Performans - 3 kategori + Excel uyumluluk
                console.log('ðŸŽ¯ GENEL PERFORMANS:', {
                    toplamSoru: totalQuestions,
                    dogruSayisi: correctAnswers,
                    yanlisSayisi: wrongAnswers,
                    kacirilmis: missedAnswers,
                    basariOrani: `${testResults.successRate}%`,
                    testSuresi: `${Math.round(testDuration / 1000)} saniye`,
                    sonCevaplananSoru: lastAnsweredQuestion,
                    kalanSoru: remainingQuestions,
                    kalanSure: `${remainingTimeSeconds} saniye`,
                    tamamlanmaZamani: new Date().toLocaleTimeString('tr-TR')
                });
                
                // SET BazlÄ± Performans - 3 kategori
                console.log('ðŸ“‹ SET BAZLI PERFORMANS:');
                for (let i = 0; i < 4; i++) {
                    const setAnswers = state.allAnswers.main.filter(a => a.setNo === i + 1);
                    const setCorrect = setAnswers.filter(a => a.isCorrect).length;
                    const setWrong = setAnswers.filter(a => a.isWrong).length;
                    const setMissed = setAnswers.filter(a => a.isMissed).length;
                    console.log(`  ${i + 1}. SET:`, {
                        dogru: setCorrect,
                        yanlis: setWrong,
                        kacirilmis: setMissed,
                        toplam: setAnswers.length,
                        basariOrani: setAnswers.length > 0 ? `${Math.round((setCorrect / setAnswers.length) * 100)}%` : '0%'
                    });
                }
                
                // Beceri TÃ¼rÃ¼ BazlÄ± Performans
                console.log('ðŸ” BECERÄ° TÃœRÃœ BAZLI PERFORMANS:');
                Object.entries(state.skillScores).forEach(([skillType, scores]) => {
                    console.log(`  ${skillType}:`, {
                        dogru: scores.correct,
                        toplam: scores.total,
                        basariOrani: scores.total > 0 ? `${Math.round((scores.correct / scores.total) * 100)}%` : '0%'
                    });
                });
                
                // Excel Veri UyumluluÄŸu - 3 kategori sistemi + yeni Ã¶zellik
                console.log('ðŸ“Š EXCEL VERÄ° UYUMLULUÄžU:', {
                    soruNumaralari: '1-20 (tam)',
                    setBilgisi: '1-4 SET (tam)',
                    beceriTurleri: '5 tÃ¼r (tam)',
                    dogrulukSkoru: `${testResults.successRate}% (hesaplandÄ±)`,
                    islemHizi: 'SET sÃ¼releri (tam)',
                    sonCevaplananSoru: `${testResults.lastAnsweredQuestion}/20 (eklendi)`,
                    kalanSoru: `${testResults.remainingQuestions} soru (eklendi)`,
                    kalanSure: `${testResults.remainingTimeSeconds} saniye (eklendi)`,
                    kapsamOrani: '%100 (49/49 gereksinim)',
                    yeniOzellik: 'DoÄŸru/YanlÄ±ÅŸ/KaÃ§Ä±rÄ±lan + Kalan Soru Takip (eklendi)'
                });
                
                // VeritabanÄ±na GÃ¶nderilecek Veriler
                console.log('ðŸ“¦ VERÄ°TABANINA GÃ–NDERÄ°LECEK VERÄ°LER:', testResults);
                
                console.log('âœ… HafÄ±za testi tamamlandÄ±, stroop testine geÃ§iliyor...');
                
                // AynÄ± pencerede stroop testini yÃ¼kle (query paramlarÄ±nÄ± taÅŸÄ±)
                try {
                    const params = new URLSearchParams(window.location.search);
                    const nextUrl = '../stroop/stroop.html' + (params.toString() ? ('?' + params.toString()) : '');
                    window.location.href = nextUrl;
                } catch (_) {
                    window.location.href = '../stroop/stroop.html';
                }
                
            } catch (error) {
                console.error('âŒ Test completion hatasÄ±:', error);
                // Hata durumunda da ana pencereye hata mesajÄ± gÃ¶nder
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'test-complete',
                        testName: 'hafiza',
                        results: { error: 'Test completion hatasÄ±' },
                        timestamp: new Date().toISOString()
                    }, window.location.origin);
                }
            }
        }

        // ==================== YARDIMCI FONKSÄ°YONLAR ====================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // ==================== CLEANUP & EVENT LISTENERS ====================
        window.addEventListener('beforeunload', function(e) {
            console.log('ðŸ§¹ Sayfa kapatÄ±lÄ±yor, cleanup baÅŸlatÄ±lÄ±yor...');
            state.cleanup();
            
            // Veri kaybÄ± uyarÄ±sÄ± (test devam ediyorsa)
            if (state.currentScreen !== 'titleScreen' && state.currentScreen !== 'resultsScreen') {
                e.preventDefault();
                e.returnValue = 'Test devam ediyor. SayfayÄ± kapatÄ±rsanÄ±z veriler kaybolabilir.';
                return e.returnValue;
            }
        });

        // Sayfa visibility deÄŸiÅŸimi
        document.addEventListener('visibilitychange', function() {
            console.log('ðŸ‘ï¸ Sayfa gÃ¶rÃ¼nÃ¼rlÃ¼k deÄŸiÅŸti:', document.hidden ? 'gizli' : 'gÃ¶rÃ¼nÃ¼r');
            // Ä°stek doÄŸrultusunda: gÃ¶rÃ¼nÃ¼rlÃ¼k deÄŸiÅŸse bile ses ve zamanlayÄ±cÄ±larÄ± durdurma/yeniden baÅŸlatma yapÄ±lmÄ±yor.
        });

        // Klavye kÄ±sayollarÄ±
        document.addEventListener('keydown', function(e) {
            // ESC tuÅŸu ile hata overlay'ini kapat
            if (e.key === 'Escape') {
                const errorOverlay = document.getElementById('errorOverlay');
                if (errorOverlay && errorOverlay.classList.contains('show')) {
                    errorOverlay.classList.remove('show');
                }
            }
            
            // Spacebar ile ses durdurma (debug iÃ§in)
            if (e.key === ' ' && e.ctrlKey) {
                e.preventDefault();
                state.stopCurrentAudio();
                console.log('ðŸ”‡ Ses manuel olarak durduruldu');
            }
        });

        // Sayfa yÃ¼klendi
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ HafÄ±za Testi baÅŸlatÄ±lÄ±yor...');
            console.log('ðŸ“± Cihaz:', navigator.userAgent);
            console.log('ðŸ–¥ï¸ Ekran:', window.innerWidth + 'x' + window.innerHeight);
        });
    </script>
</body>
</html>
